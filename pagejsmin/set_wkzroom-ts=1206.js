M.Page.set_wkzroom=M.createClass();M.extend(M.Page.set_wkzroom.prototype,{context:{},target_tpl:null,typelist:{},tag_target:null,openstatus:2,innid:1175,sendstatus:'0',roomtypetarget:null,wkzroomtypelist:{},img:null,operate:'',imgid:0,wkzinfo:'',cache_selectnotday:[],cache_selectnotweek:[],cache_confirmselectnotday:'',cache_confirmselectnotweek:'',cache_ele:'',dis_roomtype_tpl:'<label tag="rt" class="mr10" style="display:inline-block;"><input name="roomtype" value="${id}" tag="roomtypeselect" type="checkbox" checked="checked">${roomtypename}</label> ',roomtype:'<option value="${id}" tag="${tag}" style="${style}">${roomtypename}</option>',roomtype_tpl:' <li roomtypeid="${id}" roomtypename="${roomtypename}">'
+'<input id="roomtype_${id}" type="file" tag="file" t="roomtype" style="display:none" name="file[]">'
+'<div class="pic" tag="loading" style="display:none"><span class="loading" tag="prcosess">上传中...10.55%</span></div>'
+'<div class="pic" tag="img"><a href="#?" class="${style}"><img style="${show}" src="${img}" /><i style="${show}" tag="upload">修改图片</i></a></div>'
+'<div class="bar clx">'
+' <div class="name">${roomtypename}</div>'
+' <div class="status"><a href="#?" class="open" tag="status" t="${opentowkz}">${openstatus}</a></div>'
+' </div>'
+' <div class="discount">'
+' <a href="#?" tag="setdiscount" price="${price}" discount="${discount}">价格设置</a>'
+' <a href="#?" tag="setroomdesc" class="ml10" desc="${description}">房型特色</a>'
+' <a href="#?" tag="setroomalbum"  class="ml10" style="">房型相册</a>'
+' </div>'
+' <div class="ribbon" style="${discountstyle}" tag="discount">${discount}折</div>'
+'</li>',roomtype_img:'<li class="${imgcover}" t="img" rid="${roomtypeid}" imgid="${id}" tag="roomtype">'
+'<img src="${url}" />'
+'<a href="#?" class="delete" tag="delete"></a>'
+'<a href="#?" class="setCover" tag="setCover">设为封面图</a>'
+'<i class="cover">封面</i>'
+'</li>',upload_btn_tpl:'<li class="ui-state-disabled" tag="loading" style="display: none">'
+'<div class="pic"><span class="loading" tag="process">上传中...10.55%</span></div>'
+'</li>'
+'<li class="ui-state-disabled" tag="upload_li">'
+'<div class="pic"><a href="#?" class="add" tag="upload_btn" type=""></a></div>'
+'</li>',tpl_use_roomtype:' <label class="mr10" style="display:inline-block;"><input name="checkbox" type="checkbox" tag="selectroomtype" rtid="${id}">${roomtypename}</label>',timer:null,init:function(){this.initDOM();this.initEvent();this.initfileupload();this.innlist_change();},initDOM:function(){this.context.maincontent=$("body");this.context.innlist=$("#innlist");this.context.inndetail=$("#inndetail");this.context.savepaytype=$("#savepaytype");this.context.paytypelist=$("#paytype");this.context.roomsetlist=$("#roomsetlist");this.context.roomSetting=$("#roomSetting");this.context.roomtype_load=$('#roomtype_load');this.context.pic_load=$('#pic_load');this.context.settablist=$("#settablist");this.context.divminnight=$("#divminnight");this.context.paytypelist=$("#paytype");this.context.cancleruleform=$("#cancleruleform");this.context.cancletip=$("#cancletip");this.context.discountsaleSetting=$("#discountsaleSetting");this.context.cancelrulesdays=$("#cancelrulesdays");this.context.cancelrule=$("#cancelrule");this.context.discountPop=$("#discountPop");this.context.save_discount=$("#save_discount");this.context.setroomtypedesc=$("#setroomtypedesc");this.context.wkzroomalbum=$("#wkzroomalbum");this.context.roomalbum=$("#roomalbum");this.context.loading32=$("#loading32");this.context.hoteldiscountlist=$("#hoteldiscountlist");this.context.discountform=$("#discountform");this.context.hoteldiscountbtn=$("#hoteldiscountbtn");this.context.addCouponPop=$("#addCouponPop");this.context.savedesc=$("#savedesc");this.context.save_wkzroomresize=$('#save_wkzroomresize');this.context.wkzroomresize=$('#wkzroomresize');this.context.upform=$("#upform");this.context.pop_addimg=$("#pop_addimg");this.context.singleToggle=$("#singleToggle");this.context.save_status=$("#save_status");this.context.setdatepop=$("#setdatepop");},initEvent:function(){this.context.maincontent.bind("click",this.body_click.toEventHandler(this));this.context.innlist.bind("change",this.innlist_change.toEventHandler(this));this.context.settablist.bind("click",this.settablist_click.toEventHandler(this));this.context.savedesc.bind('click',this.savedesc_click.toEventHandler(this));this.context.save_wkzroomresize.bind('click',this.save_wkzroomresize_click.toEventHandler(this));this.context.save_status.bind('click',this.save_status_click.toEventHandler(this));this.context.singleToggle.find("div[class='switch has-switch']").bind('click',this.wkzstatus_toggle.toEventHandler(this));this.context.savepaytype.bind('click',this.savepaytype.toEventHandler(this));this.context.paytypelist.bind('click',this.paytypelist_click.toEventHandler(this));this.context.cancelrule.children("div").children("a").bind('click',this.cancelrule_click.toEventHandler(this));this.context.cancelrulesdays.bind('input propertychange',this.cancelrulesdays_change.toEventHandler(this));this.context.roomsetlist.bind('click',this.roomtypelist_click.toEventHandler(this));this.context.save_discount.bind('click',this.save_discount_click.toEventHandler(this));this.context.roomalbum.bind('click',this.roomalbum_click.toEventHandler(this));this.context.discountsaleSetting.bind('click',this.discountsaleSetting_click.toEventHandler(this));this.context.discountform.bind('click',this.discountform_click.toEventHandler(this));this.context.discountform.find("input[name=nights]").bind('keyup',this.only_inputnum.toEventHandler(this));this.context.discountform.find("input[name=discount]").bind('keyup',this.only_inputnum.toEventHandler(this));this.context.cancleruleform.bind('click',this.cancleruleform_click.toEventHandler(this));this.context.hoteldiscountlist.bind('click',this.hoteldiscountlist_click.toEventHandler(this));this.context.addCouponPop.bind('click',this.addcouponpop_click.toEventHandler(this));this.context.addCouponPop.find('select[tag=couponselecttype]').bind('change',this.couponselecttype_change.toEventHandler(this));this.context.addCouponPop.find('div[tag=zhe]').find('input[name=discount]').bind('input propertychange',this.zhe_change.toEventHandler(this));this.context.addCouponPop.find('div[tag=jian]').find('input[name=discount]').bind('input propertychange',this.jian_change.toEventHandler(this));this.context.setdatepop.bind('click',this.setdatepop_click.toEventHandler(this));this.context.settablist.children("li:first").addClass("on");},body_click:function(e){var ele=M.EventEle(e);var t=ele.attr("tag");if((M.isEmpty(t)||t!='dropdownlist')){var tpl=ele.parents("div[t=minnightdata]");if(tpl.length==0&&t!='minnightdata'){this.context.divminnight.children("div[t=minnightdata]").children("div").hide();}}},_clearSelectNotDateCache:function(){this.cache_selectnotweek='';this.cache_selectnotday='';this.cache_confirmselectnotday='';this.cache_confirmselectnotweek='';},settablist_click:function(e){var ele=M.EventEle(e);var t=ele.attr("tag");if(M.isEmpty(t)){return false;}
this.context.roomSetting.hide();this.context.discountsaleSetting.hide();this.context.settablist.children("li").removeClass("on");ele.parent("li").addClass("on");if(t=='setRoom'){this.context.roomSetting.show();}else if(t=='setDiscount'){this.context.loading32.show();}
this._getmodeldata();},_getmodeldata:function(){this.context.roomsetlist.hide();var type=this.context.settablist.children("li[class=on]").children("a").attr("tag");var innid=this.context.innlist.val();this.innid=innid;if(M.isEmpty(type)){type='setRoom';}
if(type=='settablist'){this._resetloadstatus("load");}
this.context.roomtype_load.show();this.context.pic_load.show();M._getjson("/Microinn/getWkzInfo",{"innid":innid,"type":type},this.getwkzinfo_finished.toEventHandler(this));},getwkzinfo_finished:function(d){if(d.status=='success'){this.wkzinfo=d.data;var type=d.type;if(type=="setDiscount"){var html_selecttpl=this.context.divminnight.children('div').val(this.wkzinfo.mininights);this.context.divminnight.children('input[name=fromdate]').val(this.wkzinfo.fromdate).datepicker({showOtherMonths:true,selectOtherMonths:true});this.context.divminnight.children('input[name=enddate]').val(this.wkzinfo.enddate).datepicker({showOtherMonths:true,selectOtherMonths:true});M.DropdownList(html_selecttpl,null);this._setdiscount(d.discountdata);this.context.loading32.hide();this.context.discountsaleSetting.show();}
if(type=='setRoom'){var wkzpaytype=d.paytype;if(!M.isEmpty(wkzpaytype)){if(wkzpaytype.paytype==1){this.context.paytypelist.children("li").eq(0).find("input[name=wkzpayment]").attr("checked","checked");this.context.paytypelist.children("li").eq(1).children("div[class=part]").hide();}
if(wkzpaytype.paytype==2){this.context.paytypelist.children("li").eq(1).find("input[name=wkzpayment]").attr("checked","checked");this.context.paytypelist.children("li").eq(1).children("div[class=part]").show();if(wkzpaytype.type_first=='yes'){this.context.paytypelist.find("div[class=part]").children("label").eq(0).children("input[type=radio]").attr("checked","checked");}
if(wkzpaytype.type_first=='no'){var everymoney=wkzpaytype.type_every;var obj=this.context.paytypelist.find("div[class=part]").children("label[class=ml20]");obj.children("input[type=radio]").attr("checked","checked");obj.children("input[type=text]").val(everymoney);}}
this._setcanclerule(wkzpaytype,d.miotapply);}
this.context.cancelrule.children("textarea").val(d.cancelrule);this.context.roomtype_load.hide();this.context.roomsetlist.show();this._setRoom(d.img_roomtype_data);if(M.isEmpty(d.img_roomtype_data)){this.context.roomsetlist.hide();}}}else{if(d.status=='hasswitch'){M.confirmmessage(d.msg,this.reload.toEventHandler(this));}else if(d.msg){alert(d.msg);}else{alert('数据加载失败，刷新页面重新加载');}}},_setRoom:function(roomtypelist){this.context.roomsetlist.empty();var roomtype_html=$.tmpl(this.roomtype_tpl,roomtypelist);this.context.roomsetlist.append(roomtype_html);this.context.roomsetlist.find('a[tag=status][t=0]').attr('class','closed').html('<i></i>已关闭');var status_obj=this.context.roomsetlist.find("div[name='status'] a");status_obj.bind('click',this.wkzstatus_change.toEventHandler(this));var pic_obj=this.context.roomsetlist.find("div[class='pic'] a");pic_obj.bind('click',this.roomtype_pic_upload.toEventHandler(this));this.initfileupload();},innlist_change:function(){this._getmodeldata();},roomtypelist_click:function(e){var ele=M.EventEle(e);var t=ele.attr("tag");if(t=="setdiscount"){this.setdiscount(ele);}
if(t=="setroomdesc"){this.setdescription(ele);}
if(t=="status"){this.wkzstatus_change(ele);}
if(t=="upload"){this.roomtypetarget=ele.parents("li");ele.parents("li").children("input[tag=roomtype]").click();this.target_tpl=this.context.wkzroomresize.attr("tag","roomtype");}
if(t=="setroomalbum"){this.setroomalbum(ele);}},_checknum:function(num){var num_arr=num.toString().split(".");if(!M.isEmpty(num_arr[1])&&num_arr[1].length>1){return false;}else{return true;}},savedesc_click:function(){var rid=this.context.setroomtypedesc.attr("rid");var desc=M.getVal(this.context.setroomtypedesc.children().find("textarea[name=description]"));M._getjson('/Microinn/save_Desc',{'rid':rid,'desc':desc},this.save_desc_finished.toEventHandler(this));},save_desc_finished:function(d){if(d.status=="success"){var rid=d.req.rid;this.context.roomsetlist.children("li[roomtypeid="+rid+"]").children().find("a[tag=setroomdesc]").attr("desc",d.req.desc);this._closepopup();}else{M.error(d.msg);}},save_wkzroomresize_click:function(e){var eventEle=M.EventEle(e);var style=eventEle.attr("class");if(style.indexOf('btn-cancel')!=-1){return;}
var roomtypeid=eventEle.attr('roomtypeid');var goodid=eventEle.attr('goodid');var innid=this.context.innlist.val();var type=this.context.wkzroomresize.attr("type");var x1=this.context.upform.children("input[id='x1']").val();var y1=this.context.upform.children("input[id='y1']").val();var x2=this.context.upform.children("input[id='x2']").val();var y2=this.context.upform.children("input[id='y2']").val();var w=this.context.upform.children("input[id='w']").val();var h=this.context.upform.children("input[id='h']").val();var picurl=eventEle.attr('pic_path');var description='';var sendstatus=this.context.wkzroomresize.attr("sendstatus");this.context.wkzroomresize.attr("sendstatus","1");if(sendstatus==1){return;}
var data={"type":type,"innid":innid,"picurl":picurl,"roomtypeid":roomtypeid,"goodid":goodid,"description":description,"x1":x1,"x2":x2,"y1":y1,"y2":y2,"w":w,"h":h};M._getjson("/Microinn/saveImage",data,this.save_wkzroomresize_click_finished.toEventHandler(this));$("#save_wkzroomresize").attr("id","saveload");},save_wkzroomresize_click_finished:function(d){if(d.status=='success'){var target=d.img.target;if(target=='roomtype'){$("#saveload").attr("id","save_wkzroomresize");M.CloseLast();this.context.wkzroomalbum.next("div[class=graylayer]").eq(0).remove();var roomtypeid=d.req.roomtypeid;var target=this.target_tpl;var t=target.attr("tag");var data={"imgcover":d.img.imgcover,"roomtypeid":d.img.roomtypeid,"url":d.path,"id":d.img.id};var html=$.tmpl(this.roomtype_img,data);this.context.roomalbum.children("li").removeClass("hasCover").find("i[class=cover]").css("display","none");this.context.roomalbum.children("li[tag=add]").before(html);this.context.pop_addimg.val('');target.children("li[tag=add]").show();if(t=='roomtype'){this.roomtypetarget.children("div[tag=img]").children("a").removeClass("add").addClass("edit").children("img").show();this.roomtypetarget.children("div[tag=img]").children("a").children("i").attr("style","");}
this.context.roomsetlist.children("li[roomtypeid="+roomtypeid+"]").find("div[tag=img]").children("a").removeClass("add").addClass("edit")
var tpl_img=this.context.roomsetlist.children("li[roomtypeid="+roomtypeid+"]").find("img").show();tpl_img.parent().find("i[tag=upload]").attr("style","");var img=tpl_img.attr("src");tpl_img.attr("src",d.path);}
if(target=="goodimg"){M.CloseLast();var imgid=d.img.id;var data={"imgcover":d.img.imgcover,"roomtypeid":d.img.goodid,"url":d.path,"id":d.img.id};var html=$.tmpl(this.good_img,data);this.context.addGoodsPop.find("ul[tag=pic]").find("ul[tag=goodimg]").children("li").removeClass("hasCover").find("i[class=cover]").css("display","none");this.context.addGoodsPop.find("ul[tag=pic]").find("ul[tag=goodimg]").children("li[tag=add]").before(html);this.context.goodsSetting.find("li[id="+d.img.goodid+"]").children("div[class=pic]").children("img").attr("src",d.path);var goodid=d.req.goodid;if(M.isEmpty(goodid)){this.context.addGoodsPop.find("ul[tag=pic]").find("ul[tag=goodimg]").children("li").children("a[tag=setCover]").hide();}
var imgidstr="";var oldimgid=this.context.addGoodsPop.find("a[tag=savegood]").attr("imgid");if(M.isEmpty(oldimgid)){this.context.addGoodsPop.find("a[tag=savegood]").attr("imgid",imgid);}else{imgidstr=oldimgid+","+imgid;this.context.addGoodsPop.find("a[tag=savegood]").attr("imgid",imgidstr);}
var rid=d.req.goodid;this.context.addGoodsPop.find("ul[tag=pic]").find("ul[tag=goodimg]").children("li[rid='']").attr('rid',rid);}
var innid=d.img.innid;M._getjson("/Microinn/flushInnClear",{"innid":innid});}else{alert('网络错误，请重新上传');}},cutImage2:function(src,target){var src=this.context.wkzroomresize.find("img[name='preview']").show().attr('src');this.context.wkzroomresize.find("img[name='photo']").show();var target=this.context.wkzroomresize.find("div[name='wkzcanvas']");var img=new Image();img.src=src;if($.browser.msie){img.onreadystatechange=function(){if(img.readyState=="complete"||img.readyState=="loaded"){imgOnLoad2(img,target);}};}else{img.onload=function(){if(img.complete==true){imgOnLoad2(img,target);};};}},save_status_click:function(e){var ele=M.EventEle(e);var roomtypeid=ele.attr('roomtypeid');var classname=ele.attr('class');if(classname!='btn btn-primary'){return false;}
var opentowkz=this.context.singleToggle.find("div[name='switch']").attr('status');M._getjson("/Microinn/save_wkzstatus",{"roomtypeid":roomtypeid,"opentowkz":opentowkz},this.save_wkzstatus_finished.toEventHandler(this));},save_wkzstatus_finished:function(d){if(d.status=='success'){var opentowkz=d.opentowkz;var id=d.id;if(opentowkz==1){this.context.roomsetlist.find("li[roomtypeid="+id+"]").find("a[tag=status]").attr('class','open').attr('t',opentowkz).text('已打开');}else{this.context.roomsetlist.find("li[roomtypeid="+id+"]").find("a[tag=status]").attr('class','closed').attr('t',opentowkz).html('<i></i>已关闭');}
this._closepopup();}else if(!M.isEmpty(d.msg)){this.wkzstatus_toggle();alert(d.msg);}else{alert('保存失败，检查网络问题');}},wkzstatus_toggle:function(e){var switch_obj=this.context.singleToggle.find("div[name='switch']");var status=switch_obj.attr('status');var classname=switch_obj.attr('classname');if(status==1){switch_obj.attr("class","switch-animate switch-off").attr('status',0);}else{switch_obj.attr("class","switch-animate switch-on").attr('status',1);}
if(classname=='btn-primary'){switch_obj.attr('classname','btn-no');this.context.save_status.removeClass('btn-primary').addClass('btn-no');}else{switch_obj.attr('classname','btn-primary');this.context.save_status.removeClass('btn-no').addClass('btn-primary');}},savepaytype:function(ele){var paytype;var deposittype='';var everymoney='';paytype=this.context.paytypelist.find("input[name=wkzpayment]:checked").val();if(paytype==2){deposittype=this.context.paytypelist.find("input[name=wkzpayment-part]:checked").val();if(deposittype=='pay_every'){everymoney=this.context.paytypelist.find("input[name=everydeposit]").val();if(M.isEmpty(everymoney)){M.error("请填写预付定金的金额！");return false;}
var m=everymoney.length-everymoney.replace(/\./g,"").length;if(m>0){M.error("订金金额只能输入整数喔");return false;}
if(!$.isNumeric(everymoney)){M.error("订金金额只能输入数字喔");return false;}
if(everymoney<0){M.error("订金金额不能为负数哦");return false;}
if(everymoney==0){M.error("订金金额不能为0哦");return false;}}
if(M.isEmpty(deposittype)){M.error("请选择预付订金的方式！");return false;}}
M._getjson("/Microinn/setPayType",{"paytype":paytype,"deposittype":deposittype,"everymoney":everymoney},this.setPaytype_finished.toEventHandler(this));},setPaytype_finished:function(d){if(d.status=="success"){M.success(d.msg);this.clearwkzcache();}else{M.error(d.msg);}},paytypelist_click:function(e){var ele=M.EventEle(e);var t=ele.attr("tag");if(t=='type_all'){this.context.paytypelist.children("li").eq(1).children("div[class=part]").hide();this.context.paytypelist.find("input[name=everydeposit]").val("");}
if(t=='pay_first'){this.context.paytypelist.find("input[name=everydeposit]").val("");}
if(t=='type_deposit'){this.context.paytypelist.children("li").eq(1).children("div[class=part]").show();$("#payfirst").attr("checked","checked");}},clearwkzcache:function(){var innid=this.context.innlist.val();M._getjson('/Microinn/clearwkzcache',{'type':'hotel','innid':innid},this.clearwkzcache_finished.toEventHandler(this));},clearwkzcache_finished:function(){},cancelrule_click:function(e){var title=this.context.cancelrule.children("textarea").attr("title");var cancelrule=M.getVal(this.context.cancelrule.children("textarea"));var totalLength=0;var i;var charCode;for(i=0;i<cancelrule.length;i++){charCode=cancelrule.charCodeAt(i);if(charCode<0x007f){totalLength+=1;}else if(charCode>=0x0080&charCode<=0x07ff){totalLength+=2;}else if(charCode>=0x0800&charCode<=0xffff){totalLength+=3;}}
if(totalLength>300){this.context.cancelrule.children("span").show();this.context.cancelrule.children("div").children("a").attr("class","btn btn-cancel");return false;}
if(title==cancelrule){return false;}
if(M.isEmpty(cancelrule)){return false;}
M._getjson("/Microinn/cancelRule",{"rule":cancelrule},this.cancel_finished.toEventHandler(this));},cancel_finished:function(d){if(d.status=="success"){var rule=d.rule;if(!M.isEmpty(rule)){this.context.cancelrule.children("textarea").html(rule);this.context.cancelrule.children("textarea").attr("title",rule);this.context.cancelrule.children("span").hide();}
M.success(d.msg);}else{M.error(d.msg);}},setdiscount:function(ele){var typeid=ele.parents("li").attr('roomtypeid');var roomtypename=ele.parents("li").attr('roomtypename');var price=ele.attr('price');var discount=ele.attr('discount');var saleprice=price*discount/10;saleprice=M.math_format(saleprice);this.context.discountPop.find("div[class='modal-header'] h4").text("<"+roomtypename+">价格设置");this.context.discountPop.find("span[name='roomprice']").text(price);this.context.discountPop.find("span[name='sale_price']").text(saleprice);if(discount==null){this.context.discountPop.find("input[name='roomdiscount']").val(0);}else{this.context.discountPop.find("input[name='roomdiscount']").val(discount);}
this.context.save_discount.attr('roomtypeid',typeid);M.Popup(this.context.discountPop,{"hideclass":"modal sm fade","showclass":"modal sm fade in"},function(){}.toEventHandler(this));},save_discount_click:function(ele){var eventEle=M.EventEle(ele);var roomtypeid=eventEle.attr('roomtypeid');var discount=this.context.discountPop.find("input[name='roomdiscount']").val();discount=parseFloat(discount);if(isNaN(discount)){alert('请输入0-10之间的折扣数字');return;}
if(discount<=0||discount>10){alert('请输入0-10之间的折扣数字');return;}
if(!this._checknum(discount)){alert('折扣最多只支持1位小数喔');return;}
M._getjson('/Microinn/save_Discount',{'roomtypeid':roomtypeid,'discount':discount},this.save_discount_finished.toEventHandler(this));},save_discount_finished:function(d){if(d.status=='success'){var roomtypeid=d.id;var tpl=this.context.roomsetlist.find("li[roomtypeid="+roomtypeid+"]");var discount=parseInt(d.discount*10)/100;tpl.children("div[tag=discount]").html(discount+"折");tpl.children().find("a[tag=setdiscount]").attr("discount",discount);if(discount==10){tpl.children("div[tag=discount]").hide();}else{tpl.children("div[tag=discount]").show();}
this._closepopup();}else{alert('保存失败，请检查网络问题');}},setdescription:function(ele){var id=ele.parents("li").attr('roomtypeid');var name=ele.parents("li").attr('roomtypename');var desc=ele.attr('desc');if(!M.isEmpty(desc)){this.context.setroomtypedesc.children().find("textarea[name=description]").val(desc);}else{M.emptyVal(this.context.setroomtypedesc.children().find("textarea[name=description]"));}
this.context.setroomtypedesc.attr("rid",id).children("div").children("h4[tag=roomtypename]").html('&lt;'+name+'&gt;房型特色');M.Popup(this.context.setroomtypedesc,{"hideclass":"modal sm fade","showclass":"modal sm fade in","dragable":true},function(){}.toEventHandler(this));},wkzstatus_change:function(ele){var opentowkz=ele.attr('t');var roomtypename=ele.parents("li").attr('roomtypename');var roomtypeid=ele.parents("li").attr('roomtypeid');var modal_header="开启/关闭  "+roomtypename+" ";if(opentowkz==1){this.context.singleToggle.find("div[name='switch']").attr("class","switch-animate switch-on").attr('status',1);this.context.save_status.attr('roomtypeid',roomtypeid);}else{this.context.singleToggle.find("div[name='switch']").attr("class","switch-animate switch-off").attr('status',0);this.context.save_status.attr('roomtypeid',roomtypeid);}
this.context.singleToggle.find("div[class='modal-header'] h4").text(modal_header);this.context.save_status.removeClass('btn-primary').addClass('btn-no');this.context.singleToggle.find("div[name='switch']").attr('classname','btn-no');M.Popup(this.context.singleToggle,{"hideclass":"modal sm fade","showclass":"modal sm fade in"},function(){}.toEventHandler(this));},setroomalbum:function(ele){var rid=ele.parents("li").attr('roomtypeid');this.context.wkzroomalbum.attr("roomtypeid",rid);var roomname=ele.parents("li").attr('roomtypename');var innid=this.context.innlist.val();this.context.wkzroomalbum.children("div").children("h4").html("&lt;"+roomname+"&gt;<span class='t12'>(建议保持在5张以内)</span>");M._getjson('/Microinn/getRoomAlbum',{'rid':rid,'innid':innid},this.getroomalbum_finished.toEventHandler(this));M.Popup(this.context.wkzroomalbum,{"hideclass":"modal wkzroomresize fade","showclass":"modal wkzroomresize fade in"},function(){}.toEventHandler(this));},getroomalbum_finished:function(d){this.context.roomalbum.children("li[t=img]").remove();if(d.status=="success"){var list=d.list;var img_html=$.tmpl(this.roomtype_img,list);this.context.roomalbum.children("li[tag=add]").before(img_html);}else{M.error(d.msg);}},roomtype_pic_upload:function(e){var eventEle=M.EventEle(e);var classname=eventEle.attr('class');if(classname=='add'){var file_input=eventEle.parent().parent().find("input[type='file'][tag='file']");}else{var file_input=eventEle.parent().parent().parent().find("input[type='file'][tag='file']")}
this.roomtypetarget=eventEle.parents("li");this.target_tpl=eventEle.parents("div[id=roomSetting]");var roomtypeid=eventEle.parents("li").attr('roomtypeid');this.context.save_wkzroomresize.attr('roomtypeid',roomtypeid);file_input.click();},roomalbum_click:function(e){var ele=M.EventEle(e);var t=ele.attr("tag");if(t=="delete"){this.roomalum_delete(ele);}
if(t=="setCover"){this.setCover(ele);}
if(t=="add"){this.target_tpl=ele.parents("ul").attr("tag","pop_roomtype");var roomtypeid=this.context.wkzroomalbum.attr("roomtypeid");this.context.save_wkzroomresize.attr('roomtypeid',roomtypeid);this.context.roomsetlist.children("li[roomtypeid="+roomtypeid+"]").children("input[tag=file]").click();this.context.wkzroomresize.find("div[tag=save_btn]").addClass("btn-cancel").removeClass("btn-primary");}},setCover:function(ele){var id=ele.parents("li").attr("imgid");var rid=ele.parents("li").attr("rid");var tag=ele.parents("li").attr("tag");var innid=this.context.innlist.val();M._getjson("/Microinn/setCover",{"id":id,"innid":innid,"rid":rid,"tag":tag},this.setCover_finished.toEventHandler(this));},setCover_finished:function(d){if(d.status=="success"){var id=d.req.id;var rid=d.req.rid;var innid=d.req.innid;var tag=d.req.tag;if(tag=='roomtype'){this.context.roomalbum.children("li").removeClass("hasCover");var img=this.context.roomalbum.children("li[imgid="+id+"]").addClass("hasCover").children("img").attr("src");this.context.roomalbum.children("li[imgid="+id+"]").children("i").show();this.context.roomsetlist.children("li[roomtypeid="+rid+"]").children().find("img").attr("src",img);}
M._getjson("/Microinn/flushInnClear",{"innid":innid});}else{M.error(d.msg);}},roomalum_delete:function(ele){var style=ele.parents("li").attr("class");if(style.indexOf("hasCover")>0||style=="hasCover"){M.error("如要删除此图片，请先设置一张封面图");return;}
var res=confirm("确认删除吗");if(!res){return;}
var id=ele.parents("li").attr("imgid");var innid=this.context.innlist.val();var type=ele.parents('li').attr('tag');M._getjson("/Microinn/deleteImg",{"id":id,"innid":innid,'type':type},this.roomalum_delete_finished.toEventHandler(this));},roomalum_delete_finished:function(d){if(d.status=="success"){var id=d.req.id;var target=d.target;if(target=="roomtype"){this.context.roomalbum.children("li[imgid="+id+"]").remove();}
if(target=="goodimg"){this.context.addGoodsPop.find("ul[tag=pic]").find("ul[tag=goodimg]").find("li[imgid="+id+"]").remove();}}else{M.error(d.msg);}},_setdiscount:function(discountdata){this.wkzroomtypelist=discountdata.roomtypelist;this.context.discountsaleSetting.find('ul[tag=couponlist]').html('');if(!M.isEmpty(discountdata.couponlist)){var couponlist=discountdata.couponlist;var len=couponlist.length;for(var i=0;i<len;i++){var coupon=couponlist[i];this._coupontpl(coupon);}}
var hoteldiscount=discountdata.hoteldiscountlist;this._handlehoteldiscount(hoteldiscount);},_handlehoteldiscount:function(list){if(M.isEmpty(list)||list.length==0){this.context.hoteldiscountlist.html('');this.context.discountsaleSetting.find("input[tag=adddiscount]").show();return;}
var index=1;var html='';for(var i=0;i<list.length;i++){var item=list[i];var msg=' 规则'+index+'：'+item.fromdate+'至'+item.enddate+'入住，连住'+item.nights+'晚享'+item.discount+'折优惠价，参与活动房型：'+item.roomtypename+'。 ';html+='<li class="" i="'+index+'" hid="'+item.id+'">'+msg+'<a class="deleterule" href="#?" tag="delete">删除规则</a><a class="modifyrule" href="#?" tag="edit">修改规则</a> </li>';index++;}
this.context.hoteldiscountlist.html(html);if(list.length>=5){this.context.discountsaleSetting.find("input[tag=adddiscount]").hide();}else{this.context.discountsaleSetting.find("input[tag=adddiscount]").show();}},_coupontpl:function(coupon,addposition){var coupontpl='';var thistime=M.strtotime(M.timeformat(M.getTime(),'Y-m-d'));var classtyle='coupon';var coupontypename='可用';var coupontag='可领取';var tagstyle='';if(thistime>M.strtotime(coupon.endtime)){classtyle='coupon c-used';coupontypename='已过期';}
if(coupon.frequency>0&&coupon.frequency==coupon.runtimes){classtyle='coupon c-used';coupontypename='已使用';}
if(coupon.frequency>0&&coupon.frequency==coupon.drawtimes){tagstyle="lighttype";}
coupontpl+='<li class="'+classtyle+'" cid="'+coupon.id+'">';coupontpl+='<div class="item sum">';if(coupon.category==2){coupontpl+=coupon.coumoney+'<dfn>折</dfn>';}else{coupontpl+='<dfn>&yen;</dfn>'+coupon.coumoney;}
if(coupon.frequency>0&&thistime<=M.strtotime(coupon.endtime)){if(coupon.shareable==1){coupontpl+='<i class="type" tag="number">'+coupontypename+' '+coupon.runtimes+'/'+coupon.frequency+'</i><i class="type '+tagstyle+'" tag="times">'+coupontag+' '+coupon.drawtimes+'/'+coupon.frequency+'</i>';}else{coupontpl+='<i class="type" tag="number">'+coupontypename+' '+coupon.runtimes+'/'+coupon.frequency+'</i>';}}else{if(coupon.shareable==1){coupontpl+='<i class="type" tag="number">'+coupontypename+'</i><i class="type'+tagstyle+'" tag="times">'+coupontag+'</i>';}else{coupontpl+='<i class="type" tag="number">'+coupontypename+'</i>';}}
if(coupon.exclusion!=0){coupontpl+='<i class="type" tag="exclusion">互斥卷</i>';}
coupontpl+='</div>';coupontpl+='<div class="item code">券号：<strong>'+coupon.counum+'</strong></div>';coupontpl+='<div class="item validity" tag="date">可用入住日期：<strong>'+coupon.starttime+'至'+coupon.endtime+'</strong></div>';coupontpl+='<a href="#?" class="delete" tag="delCoupon"></a>';coupontpl+='<a href="#?" class="modify" tag="modifyCoupon">修改</a>';coupontpl+='</li>';if(addposition=='prepend'){this.context.discountsaleSetting.find('ul[tag=couponlist]').prepend(coupontpl);}else{this.context.discountsaleSetting.find('ul[tag=couponlist]').append(coupontpl);}},_modifyCouponTpl:function(coupon){var html_ul=this.context.discountsaleSetting.find('ul[tag=couponlist]').children('li[cid='+coupon.id+']');html_ul.children('div[tag=date]').children('strong').html(coupon.starttime+'至'+coupon.endtime);if(coupon.frequency>=1){html_ul.find('i[tag=number]').html('可用 '+coupon.runtimes+'/'+coupon.frequency);if(coupon.shareable==1){if(html_ul.find('i[tag=times]').length<=0){html_ul.find('i[tag=number]').after('</i><i class="type " tag="times">可领取 '+coupon.drawtimes+'/'+coupon.frequency+'</i>');}}else{html_ul.find('i[tag=times]').remove();}}else{html_ul.find('i[tag=number]').html('可用');if(coupon.shareable==1){if(html_ul.find('i[tag=times]').length<=0){html_ul.find('i[tag=number]').after('</i><i class="type " tag="times">可领取</i>');}}else{html_ul.find('i[tag=times]').remove();}}},_setcanclerule:function(setting,miotapply){if(M.isEmpty(miotapply)){this.context.cancleruleform.hide();this.context.cancletip.hide();return;}
this.context.cancleruleform.show();this.context.cancletip.show();if(M.isEmpty(setting.canlerule_type)){setting.canlerule_type=1;}
var target=this.context.cancleruleform;this.context.cancelrulesdays.val(setting.canclerule_days);target.find("input[name=miotcancelway][value="+setting.canlerule_type+"]").attr("checked","checked");target.find("input[id=percents]").val(setting.canclerule_discount);if(setting.canlerule_type==1){target.find("span[tag=nights]").html(setting.canclerule_days);target.find("span[tag=typemsg]").html('首晚房费');}else{target.find("span[tag=typemsg]").html(setting.canclerule_discount+'% 房费');}},discountsaleSetting_click:function(e){var ele=M.EventEle(e);var t=ele.attr("tag");switch(t){case'adddiscount':this.adddiscount();break;case'addCoupon':this.init_coupon_pop();break;case'delCoupon':this.delnewcoupon(ele);break;case'modifyCoupon':this.getcoupondetail(ele);break;case'saveminnight':this.divminnight_save(ele);break;}},init_coupon_pop:function(){if(!this._checkwkzroomtype()){return false;}
var todaytime=M.getTime();var endtime=M.getTime();endtime.setDate(endtime.getDate()+30);var startdate=M.timeformat(todaytime);var enddate=M.timeformat(endtime);this.context.addCouponPop.find('div[tag=loading]').hide();this.context.addCouponPop.find('form').show();this.context.addCouponPop.attr('cid',0);this.context.addCouponPop.find('h4').html('添加优惠券');this.context.addCouponPop.find('input').val('').removeAttr('disabled');this.context.addCouponPop.find('span[tag=roundcouponcode]').show();this.context.addCouponPop.find('select[tag=couponselecttype]').removeAttr('disabled');this.context.addCouponPop.find('select[tag=couponselecttype]').find('option').eq(0).attr('selected','selected');this.context.addCouponPop.find('div[tag=zhe]').hide();this.context.addCouponPop.find('div[tag=jian]').show();this.context.addCouponPop.find("input[name=shareable]").removeAttr('checked');this.context.addCouponPop.find("input[name=exclusion]").removeAttr('checked');var html_couponusedate=this.context.addCouponPop.find('li[tag=coupon_use_date]');html_couponusedate.children('input[name=startdate]').val(startdate).datepicker({showOtherMonths:true,selectOtherMonths:true});html_couponusedate.children('input[name=enddate]').val(enddate).datepicker({showOtherMonths:true,selectOtherMonths:true});M.Popup(this.context.addCouponPop,{"hideclass":"wkz-coupons-pop modal fade","showclass":"wkz-coupons-pop modal fade in"},function(){}.toEventHandler(this));var roomtypelist=this.wkzroomtypelist;this.context.addCouponPop.find('li[tag=roomtype]').find('div[tag=roomtypelist]').html('');for(var key in roomtypelist){var roomtype=roomtypelist[key];var roomtypename=M.htmlspecialchars_decode(roomtype.roomtypename);var data={'id':roomtype.id,'roomtypename':roomtypename};this.context.addCouponPop.find('li[tag=roomtype]').find('div[tag=roomtypelist]').append($.tmpl(this.tpl_use_roomtype,data));}
this._allroomtype('all');this._clearSelectNotDateCache();},getcoupondetail:function(ele){if(!this._checkwkzroomtype()){return false;}
M.Popup(this.context.addCouponPop,{"hideclass":"wkz-coupons-pop modal fade","showclass":"wkz-coupons-pop modal fade in"},function(){}.toEventHandler(this));this.context.addCouponPop.find('form').hide();this.context.addCouponPop.find('div[tag=loading]').show();var innid=this.context.innlist.val();var cid=ele.parent().attr('cid');var data={'innid':innid,'cid':cid};M._getjson('/Microinn/getcoupondetail',data,this.getcoupondetail_finished.toEventHandler(this));},getcoupondetail_finished:function(d){if(d.status!='success'){alert(d.msg);return;}
var coupondetail=d.data;var html_ul=this.context.addCouponPop.find('ul');this.context.addCouponPop.find('div[tag=loading]').hide();this.context.addCouponPop.find('form').show();this.context.addCouponPop.attr('cid',coupondetail.id);this.context.addCouponPop.find('h4').html('修改优惠券');html_ul.find('span[tag=roundcouponcode]').hide();html_ul.find('input[name=couponcode]').val(coupondetail.counum).attr('disabled','disabled');html_ul.find('input[name=money]').val(coupondetail.fullcut).attr('disabled','disabled');html_ul.find('input[name=discount]').val(coupondetail.coumoney).attr('disabled','disabled');html_ul.find('select[tag=couponselecttype]').attr('disabled','disabled');html_ul.find('div[tag=zhe]').hide();html_ul.find('div[tag=jian]').hide();if(coupondetail.category==2){html_ul.find('div[tag=zhe]').css('display','inline-block');html_ul.find('select[tag=couponselecttype]').find('option[value=2]').attr('selected','selected');}else{html_ul.find('div[tag=jian]').css('display','inline-block');html_ul.find('select[tag=couponselecttype]').find('option[value=1]').attr('selected','selected');}
html_ul.find('input[name=couponnum]').val(coupondetail.frequency).attr('disabled','disabled');html_ul.find('input[name=startdate]').val(coupondetail.starttime).datepicker({showOtherMonths:true,selectOtherMonths:true});html_ul.find('input[name=enddate]').val(coupondetail.endtime).datepicker({showOtherMonths:true,selectOtherMonths:true});var roomtypelist=this.wkzroomtypelist;var htmldiv_roomtypelist=this.context.addCouponPop.find('li[tag=roomtype]').find('div[tag=roomtypelist]');htmldiv_roomtypelist.html('');htmldiv_roomtypelist.find('input').removeAttr('checked');var roomtype_list=[];if(!M.isEmpty(coupondetail.roomtypestr)){roomtype_list=coupondetail.roomtypestr.split(',');}
for(var key in roomtypelist){var roomtype=roomtypelist[key];var roomtypename=M.htmlspecialchars_decode(roomtype.roomtypename);var data={'id':roomtype.id,'roomtypename':roomtypename};htmldiv_roomtypelist.append($.tmpl(this.tpl_use_roomtype,data));if(M.in_array(roomtype.id,roomtype_list)){htmldiv_roomtypelist.find('input[rtid='+roomtype.id+']').attr('checked','checked');}}
if(M.isEmpty(roomtype_list)){this._allroomtype('all');}else{this.selectroomtype();}
this.cache_confirmselectnotday=coupondetail.notdaylist;this.cache_confirmselectnotweek=coupondetail.notweeklist;html_ul.find("input[name=shareable]").removeAttr('checked');if(coupondetail.shareable==1){html_ul.find("input[name=shareable]").attr('checked','checked');}
html_ul.find("input[name=exclusion]").removeAttr('checked');if(coupondetail.exclusion==1){html_ul.find("input[name=exclusion]").attr('checked','checked');}},discountform_click:function(e){var ele=M.EventEle(e);var t=ele.attr("tag");switch(t){case'checkall':var checkstatus=ele.attr("checked");if(checkstatus=="checked"){this.context.discountform.find("li[tag=roomtypelist]").find("input[name=roomtype]").attr("checked","checked");}else{this.context.discountform.find("li[tag=roomtypelist]").find("input[name=roomtype]").attr("checked",false);}
break;case'savediscount':this.savediscount();break;case'editsavediscount':this.editsavehoteldiscount();break;case'roomtypeselect':var checkedlength=this.context.discountform.find("li[tag=roomtypelist]").find("input[name=roomtype]:checked").length;var alllength=this.context.discountform.find("li[tag=roomtypelist]").find("input[name=roomtype]").length;if(checkedlength==alllength){this.context.discountform.find("input[tag=checkall]").attr("checked","checked");}else{this.context.discountform.find("input[tag=checkall]").attr("checked",false);}
break;}},savediscount:function(){var fromdate=this.context.discountform.find("input[name=startdate]").val();var enddate=this.context.discountform.find("input[name=enddate]").val();var nights=M.getVal(this.context.discountform.find("input[name=nights]"));var discount=M.getVal(this.context.discountform.find("input[name=discount]"));var roomtypelist=[];this.context.discountform.find("li[tag=roomtypelist]").find("input[name=roomtype]").each(function(){var tpl=$(this);var checkedstatus=tpl.attr("checked");if(checkedstatus=="checked"){roomtypelist.push(tpl.val());}});var innid=this.context.innlist.val();var data={"innid":innid,"fromdate":fromdate,"enddate":enddate,"nights":nights,"discount":discount,"roomtypestr":roomtypelist.toString()};M._getjson('/Microinn/addHotelDiscount',data,this.adddiscount_finished.toEventHandler(this));},adddiscount_finished:function(d){if(d.status=="success"){var item=d.data;var length=item.length+1;var msg=' 规则'+length+'：'+item.fromdate+'至'+item.enddate+'入住，连住'+item.nights+'晚享'+item.discount+'折优惠价，参与活动房型：'+item.roomtypenamestr+'。 ';var html='<li class="" i="'+length+'" hid="'+item.id+'">'+msg+'<a class="deleterule" href="#?" tag="delete">删除规则</a><a class="modifyrule" href="#?" tag="edit">修改规则</a> </li>';this.context.hoteldiscountlist.append(html);if(length>=5){this.context.discountsaleSetting.find("input[tag=adddiscount]").hide();}
M.success('保存成功');this._closepopup();}else{alert(d.msg);}},adddiscount:function(){if(!this._checkwkzroomtype()){return false;}
this.context.discountform.find("input[tag=checkall]").attr("checked","checked");this.context.discountform.find("input[name=nights]").val('');this.context.discountform.find("input[name=discount]").val('');var rt_html=$.tmpl(this.dis_roomtype_tpl,this.wkzroomtypelist);this.context.discountform.find("li[tag=roomtypelist]").find("label[tag=rt]").remove();this.context.discountform.find("li[tag=roomtypelist]").find("div[tag=rtlist]").append(rt_html);var timedate=M.timeformat(M.getTime(),'Y-m-d');this.context.hoteldiscountbtn.attr("tag","savediscount");this.context.discountform.attr("hid",'').find("h4[tag=title]").html('添加连住优惠规则');this.context.discountform.find("input[name=startdate]").val(timedate).datepicker({showOtherMonths:true,selectOtherMonths:true});this.context.discountform.find("input[name=enddate]").val(timedate).datepicker({showOtherMonths:true,selectOtherMonths:true});M.Popup(this.context.discountform,{"hideclass":"wkz-salerule-pop modal fade","showclass":"wkz-salerule-pop modal fade in"});},_checkwkzroomtype:function(){if(M.isEmpty(this.wkzroomtypelist)||this.wkzroomtypelist.length==0){alert("您已关闭所有房型，需要在“房型与价格”中开启至少一个房型后才可修改优惠券信息");return false;}
return true;},editsavehoteldiscount:function(){var fromdate=this.context.discountform.find("input[name=startdate]").val();var enddate=this.context.discountform.find("input[name=enddate]").val();var nights=M.getVal(this.context.discountform.find("input[name=nights]"));var discount=M.getVal(this.context.discountform.find("input[name=discount]"));var roomtypelist=[];this.context.discountform.find("li[tag=roomtypelist]").find("input[name=roomtype]").each(function(){var tpl=$(this);var checkedstatus=tpl.attr("checked");if(checkedstatus=="checked"){roomtypelist.push(tpl.val());}});var innid=this.context.innlist.val();var hid=this.context.discountform.attr("hid");var data={"innid":innid,"hid":hid,"fromdate":fromdate,"enddate":enddate,"nights":nights,"discount":discount,"roomtypestr":roomtypelist.toString()};M._getjson('/Microinn/editSaveHotelDiscount',data,this.editSaveHotelDiscount_finished.toEventHandler(this));},editSaveHotelDiscount_finished:function(d){if(d.status=="success"){var item=d.data;var hid=item.id;var target=this.context.hoteldiscountlist.children("li[hid="+hid+"]");var index=target.attr("i");var length=item.length+1;var msg=' 规则'+index+'：'+item.fromdate+'至'+item.enddate+'入住，连住'+item.nights+'晚享'+item.discount+'折优惠价，参与活动房型：'+item.roomtypenamestr+'。 ';var html=msg+'<a class="deleterule" href="#?" tag="delete">删除规则</a><a class="modifyrule" href="#?" tag="edit">修改规则</a>';target.html(html);if(length>=5){this.context.discountsaleSetting.find("input[tag=adddiscount]").hide();}
M.success('保存成功');this._closepopup();}else{alert(d.msg);}},couponselecttype_change:function(e){var ele=M.EventEle(e);if(parseInt(ele.val())==2){this.context.addCouponPop.find('li[tag=coupontype]').find('div[tag=jian]').hide();this.context.addCouponPop.find('li[tag=coupontype]').find('div[tag=zhe]').css('display','inline-block');}else{this.context.addCouponPop.find('li[tag=coupontype]').find('div[tag=zhe]').hide();this.context.addCouponPop.find('li[tag=coupontype]').find('div[tag=jian]').css('display','inline-block');}
this.context.addCouponPop.find('li[tag=coupontype]').find('input[name=discount]').val('');this.context.addCouponPop.find('li[tag=coupontype]').find('input[name=money]').val('');},cancelrulesdays_change:function(){var value=this.context.cancelrulesdays.val();this.context.cancleruleform.find("span[tag=nights]").html(value);this.context.cancleruleform.find("span[tag=typemsg]").html('首晚房费');},percents_change:function(){var cancelrulesdays=this.context.cancelrulesdays.val();var value=this.context.percents.val();this.context.cancleruleform.find("span[tag=nights]").html(cancelrulesdays);this.context.cancleruleform.find("span[tag=typemsg]").html(value+'% 房费');this.context.cancleruleform.find("input[name=miotcancelway]").attr("checked","checked");},divminnight_save:function(ele){var night=this.context.divminnight.find('div[t=minnightdata]').children('span').attr('value');var fromdate=this.context.divminnight.children('input[name=fromdate]').val();var enddate=this.context.divminnight.children('input[name=enddate]').val();var innid=this.context.innlist.val();var data={'innid':innid,'sid':this.wkzinfo.settingid,'night':night,'fromdate':fromdate,'enddate':enddate};this.cache_ele=ele;this.cache_ele.attr('ptag',ele.attr('tag')).attr('tag','no'+ele.attr('tag'));M._getjson('/Microinn/salenightsave',data,this.salenightsave_finished.toEventHandler(this));},salenightsave_finished:function(d){this.cache_ele.attr('tag',this.cache_ele.attr('ptag'));if(d.status!='success'){alert(d.msg);return;}
M.success('设置成功');},hoteldiscountlist_click:function(e){var ele=M.EventEle(e);var t=ele.attr("tag");switch(t){case'delete':this.deletehoteldiscount(ele);break;case'edit':this.edithoteldiscount(ele);break;}},deletehoteldiscount:function(ele){var hid=ele.parent().attr("hid");if(!confirm('该操作不可恢复，您确定要删除吗？')){return false;}
var innid=this.context.innlist.val();M._getjson("/Microinn/deletehoteldiscount",{"innid":innid,"hid":hid},this.deletehoteldiscount_finished.toEventHandler(this));},deletehoteldiscount_finished:function(d){if(d.status=="success"){var hid=d.req.hid;this.context.hoteldiscountlist.find("li[hid="+hid+"]").remove();this.context.discountsaleSetting.find("input[tag=adddiscount]").show();M.success('删除成功');}else{alert(d.msg);}},edithoteldiscount:function(ele){if(!this._checkwkzroomtype()){return false;}
var hid=ele.parent().attr("hid");var innid=this.context.innlist.val();M._getjson("/Microinn/gethoteldiscountdetail",{"innid":innid,"hid":hid},this.gethoteldiscountdetail_finished.toEventHandler(this));},gethoteldiscountdetail_finished:function(d){if(d.status=="success"){var data=d.data;this.context.discountform.find("input[name=nights]").val(data.nights);this.context.discountform.find("input[name=discount]").val(data.discount);var rt_html=$.tmpl(this.dis_roomtype_tpl,this.wkzroomtypelist);this.context.discountform.find("li[tag=roomtypelist]").find("label[tag=rt]").remove();this.context.discountform.find("li[tag=roomtypelist]").find("div[tag=rtlist]").append(rt_html);var rtlist=data.roomtypestr.split(',');var target=this.context.discountform.find("div[tag=rtlist]");target.find("input[name=roomtype]").attr("checked",false);for(var i=0;i<rtlist.length;i++){var rtid=rtlist[i];target.find("input[name=roomtype][value="+rtid+"]").attr("checked","checked");}
this.context.discountform.find("input[tag=checkall]").attr("checked",false);this.context.discountform.attr("hid",data.id).find("h4[tag=title]").html('修改连住优惠规则');var timedate=M.timeformat(M.getTime(),'Y-m-d');this.context.hoteldiscountbtn.attr("tag","editsavediscount");this.context.discountform.find("input[name=startdate]").val(data.fromdate).datepicker({showOtherMonths:true,selectOtherMonths:true});this.context.discountform.find("input[name=enddate]").val(data.enddate).datepicker({showOtherMonths:true,selectOtherMonths:true});var checkedlength=this.context.discountform.find("li[tag=roomtypelist]").find("input[name=roomtype]:checked").length;var alllength=this.context.discountform.find("li[tag=roomtypelist]").find("input[name=roomtype]").length;if(checkedlength==alllength){this.context.discountform.find("input[tag=checkall]").attr("checked","checked");}else{this.context.discountform.find("input[tag=checkall]").attr("checked",false);}
M.Popup(this.context.discountform,{"hideclass":"wkz-salerule-pop modal fade","showclass":"wkz-salerule-pop modal fade in"});}else{alert(d.msg);}},cancleruleform_click:function(e){var ele=M.EventEle(e);var t=ele.attr("tag");switch(t){case'roomrate':this.percents_change();break;case'firstnights':this.cancelrulesdays_change();break;case'save':this.savecanclerule();break;}},savecanclerule:function(){var cancelrulesdays=this.context.cancelrulesdays.val();var type=this.context.cancleruleform.find("input[name=miotcancelway]:checked").val();if(M.isEmpty(cancelrulesdays)&&cancelrulesdays!=0){alert('请设置订单取消日期');return false;}
var reg=/^[0-9]*$/;if(!reg.test(cancelrulesdays)){alert('订单取消日期只能设置为整天');return false;}
var percents=this.context.percents.val();if(type==2&&!reg.test(percents)){alert('房费扣款只能输入数字');return false;}
var innid=this.context.innlist.val();var data={"innid":innid,"cancelrulesdays":cancelrulesdays,"percents":percents,"type":type};M._getjson('/Microinn/savecanclerule',data,this.savecanclerule_finished.toEventHandler(this));},savecanclerule_finished:function(d){if(d.status=="success"){M.success('保存成功');}else{M.error(d.msg);}},only_inputnum:function(e){var e=e||window.event;var target=M.EventEle(e);var n=M.getVal(target);if(n=='.'){target.val(n.replace(/\D/gi,""));return;}
var list=n.split('.');var num1=list[0].replace(/\D/gi,"");var num2='';var numtype=target.attr("numtype");if(!M.isEmpty(numtype)&&numtype=='int'){target.val(n.replace(/\D/gi,""));}else{if(list.length==2){num2=list[1].replace(/\D/gi,"");target.val(num1+'.'+num2);}else{target.val(num1);}}},addcouponpop_click:function(e){var ele=M.EventEle(e);var t=ele.attr("tag");switch(t){case'savenewcoupon':this.savenewcoupon(ele);break;case'selectroomtype':this.selectroomtype();break;case'all':this._allroomtype();break;case'setdate':this.setdateroomtype(ele);break;case'roundcouponcode':this.getCouponCode(ele);break;}},savenewcoupon:function(ele){var cid=this.context.addCouponPop.attr('cid');var html_ul=this.context.addCouponPop.find('ul');var couponcode=html_ul.find('input[name=couponcode]').val().trim();var couponselecttype=html_ul.find('select[tag=couponselecttype]').val().trim();var money=0;var discount=0;if(couponselecttype==2){money=html_ul.find('div[tag=zhe]').children('input[name=money]').val().trim();discount=html_ul.find('div[tag=zhe]').children('input[name=discount]').val().trim();if(cid<1&&!this._checknum(discount)){alert('折扣最多只支持1位小数喔');return;}}else{money=html_ul.find('div[tag=jian]').children('input[name=money]').val().trim();discount=html_ul.find('div[tag=jian]').children('input[name=discount]').val().trim();}
var couponnum=html_ul.find('input[name=couponnum]').val().trim();var startdate=html_ul.find('input[name=startdate]').val().trim();var enddate=html_ul.find('input[name=enddate]').val().trim();var str_selectroomtype=this._getSelectRoomType();var max_couponnum=9999;var shareable=2;if(html_ul.find('input[name=shareable]').attr('checked')){shareable=1;}
exclusion=0;if(html_ul.find('input[name=exclusion]').attr('checked')){exclusion=1;}
if(cid<1){if(M.isEmpty(couponcode)){alert('券号不能为空');return false;}
if(M.isEmpty(money)||M.isEmpty(discount)){if(couponselecttype==2){alert('打折不能为空');}else{alert('满减不能为空');}
return false;}}
if(couponnum>max_couponnum){alert('使用次数最大为'+max_couponnum);return false;}
if(M.isEmpty(str_selectroomtype)){alert('可用房型至少选择一个');return false;}
var innid=this.context.innlist.val();var data={'cid':cid,'innid':innid,'couponcode':couponcode,'coupontype':couponselecttype,'couponnum':couponnum,'money':money,'discount':discount,'startdate':startdate,'enddate':enddate,'roomtypestr':str_selectroomtype,'notdatedaystr':this.cache_confirmselectnotday.toString(),'notdateweekstr':this.cache_confirmselectnotweek.toString(),'shareable':shareable,'exclusion':exclusion,};this.cache_ele=ele;ele.attr('tag','nosavenewcoupon').removeClass('btn-primary').addClass('btn-no');M._getjson("/Microinn/savecoupon",data,this._savenewcoupon_finished.toEventHandler(this));},_savenewcoupon_finished:function(d){if(d.status!='success'){alert(d.msg);this.cache_ele.attr('tag','savenewcoupon').removeClass('btn-no').addClass('btn-primary');return;}
var cid=d.req.cid;if(cid>0){this._modifyCouponTpl(d.data);}else{this._coupontpl(d.data,'prepend');}
M.ClosePopup();this.cache_ele.attr('tag','savenewcoupon').removeClass('btn-no').addClass('btn-primary');this._clearSelectNotDateCache();},zhe_change:function(e){var ele=M.EventEle(e);var value=parseInt(ele.val());if(value<1||value>=10){alert('请输入大于0小于10的数字');}},jian_change:function(e){var ele=M.EventEle(e);var value=parseInt(ele.val());var money=parseInt(ele.parent().children('input[name=money]').val());if(value>money){alert('立减金额必须小于条件金额');}},selectroomtype:function(){var num=0;var html_div_roomtypelist=this.context.addCouponPop.find('li[tag=roomtype]').find('div[tag=roomtypelist]');html_div_roomtypelist.children().each(function(i){if($(this).find('input[tag=selectroomtype]').is(':checked')){num++;}});if(html_div_roomtypelist.children().length==num){this.context.addCouponPop.find('li[tag=roomtype]').find('input[tag=all]').attr('checked','checked');}else{this.context.addCouponPop.find('li[tag=roomtype]').find('input[tag=all]').removeAttr('checked');}},_allroomtype:function(type){var tag=1;if(!M.isEmpty(type)&&type=='all'){tag=0;this.context.addCouponPop.find('li[tag=roomtype]').find('input[tag=all]').attr('checked','checked');}else if(this.context.addCouponPop.find('li[tag=roomtype]').find('input[tag=all]').is(':checked')){tag=0;}
if(tag==1){this.context.addCouponPop.find('li[tag=roomtype]').find('input').removeAttr('checked');}else{this.context.addCouponPop.find('li[tag=roomtype]').find('input').attr('checked','checked');}},setdateroomtype:function(ele){var mindate=ele.parent().children('input[name=startdate]').val();var maxdate=ele.parent().children('input[name=enddate]').val();this.context.setdatepop.attr('mindate',mindate);this.context.setdatepop.attr('maxdate',maxdate);if(mindate>maxdate){alert('可用入住开始日期不能大于结束日期');return;}
M.Popup(this.context.setdatepop,{"hideclass":"modal selecteddate fade","showclass":"modal selecteddate fade in"},function(){}.toEventHandler(this));this._getDate(M.getTime());this.cache_selectnotday=this.cache_confirmselectnotday;this.cache_selectnotweek=this.cache_confirmselectnotweek;var selectnotweek=this.cache_selectnotweek;var htmlul_selectweek=this.context.setdatepop.find('ul[tag=selectweek]');htmlul_selectweek.find('input').removeAttr('checked');if(!M.isEmpty(selectnotweek)){for(var k in selectnotweek){var week=selectnotweek[k];htmlul_selectweek.find('input[value='+week+']').attr('checked','checked');}}
this._handleDateData();},getCouponCode:function(ele){var innid=this.context.innlist.val();this.cache_ele=ele;ele.attr('tag','noroundcouponcode').addClass('random_shake');M._getjson('/Microinn/getcouponcode',{'innid':innid},this.getcouponcode_finished.toEventHandler(this));},getcouponcode_finished:function(d){if(d.status!='success'){alert(d.msg);this.cache_ele.attr('tag','roundcouponcode').removeClass('random_shake');return;}
var html_ul=this.context.addCouponPop.find('ul');html_ul.find('input[name=couponcode]').val(d.couponcode);this.cache_ele.attr('tag','roundcouponcode').removeClass('random_shake');},delnewcoupon:function(ele){var cid=ele.parent("li").attr("cid");var cclass=ele.parent("li");if(M.isEmpty(cid)){return false;}
var innid=this.context.innlist.val();if(cclass.hasClass('c-used')){M._getjson("/Microinn/delCoupon",{'innid':innid,"cid":cid},this.delnewcoupon_finish.toEventHandler(this));}else{if(window.confirm('确定删除这张优惠券吗？')){M._getjson("/Microinn/delCoupon",{'innid':innid,"cid":cid},this.delnewcoupon_finish.toEventHandler(this));}else{return false;}}},delnewcoupon_finish:function(d){if(d.status=="success"){var cid=d.cid;this.context.discountsaleSetting.find("ul[tag=couponlist]").children("li[cid="+cid+"]").remove();}else{M.error(d.msg);}},setdatepop_click:function(e){var ele=M.EventEle(e);var t=ele.attr('tag');switch(t){case'save':this.saveSelectNotDayCoupon();break;case'day':this._thisdaynot(ele);break;case'prevmonth':this._getprevmonth(ele);break;case'nextmonth':this._getnextmonth(ele);break;case'week':this._selectWeek(ele);break;default:if(ele.parent('li[tag=day]').attr('tag')=='day'){var ele=ele.parent('li[tag=day]');this._thisdaynot(ele);}else if(ele.parent('label[tag=week]').attr('tag')=='week'){var ele=ele.parent('label[tag=week]');this._selectWeek(ele);}
break;}},saveSelectNotDayCoupon:function(){this.cache_confirmselectnotday=this.cache_selectnotday;this.cache_confirmselectnotweek=this.cache_selectnotweek;M.CloseLast();},_handleDateData:function(){var selectday=this.cache_selectnotday;var selectnotweek=this.cache_selectnotweek;this.context.setdatepop.find('ul[tag=datelist]').children().each(function(){var this_li=$(this);if(this_li.attr('tag')=='day_no'){return true;}
var mark='radio';var classstyle='';var week=this_li.attr('week');var date=this_li.attr('date');if(!M.isEmpty(selectnotweek)&&M.in_array(week,selectnotweek)){mark='all';classstyle='ideepgray';}else if(!M.isEmpty(selectday)&&M.in_array(date,selectday)){classstyle='ideepgray';}
this_li.attr('mark',mark).attr('class',classstyle);});},_notBubbleClick:function(ele){var tag=ele.attr('tag');ele.attr('tag','no'+tag);setTimeout(function(){ele.attr('tag',tag);},400);},getnotdaycoupon:function(cid,time){this._getDate(time);var data=this._getStartAndEndDate(time);data['cid']=cid;data['innid']=this.context.innlist.val();M._getjson('/Microinn/getnotdaycoupon',data,this._getnotdaycoupon_finished.toEventHandler(this));},_getnotdaycoupon_finished:function(d){if(d.status!='success'){alert(d.msg);return;}
this.cache_selectnotday=d.coupondatestr;this._handleDateData();},_thisdaynot:function(ele){if(ele.attr('mark')=='all'){return;}
this._notBubbleClick(ele);var date=ele.attr('date');if(ele.hasClass('ideepgray')){ele.removeClass('ideepgray');var cache_selectday=this.cache_selectnotday;var new_selectday=[];for(var k in cache_selectday){var va=cache_selectday[k];if(va!=date){new_selectday.push(va);}}
this.cache_selectnotday=new_selectday;}else{ele.addClass('ideepgray');if(M.isEmpty(this.cache_selectnotday)){this.cache_selectnotday=[];}
this.cache_selectnotday.push(date);}},_getprevmonth:function(ele){var timenow=ele.attr('value');var time=M.strtotime(timenow);var cid=this.context.setdatepop.attr('cid');if(cid>0){this.getnotdaycoupon(cid,time);}else{this._getDate(time);this._handleDateData();}},_getnextmonth:function(ele){var timenow=ele.attr('value');var time=M.strtotime(timenow);var cid=this.context.setdatepop.attr('cid');this._getDate(time);this._handleDateData();},_selectWeek:function(ele){var week=ele.children('input').val();if(ele.children('input').is(':checked')){this.context.setdatepop.find('ul[tag=datelist]').children('li[tag=day][week='+week+']').attr('mark','all').addClass('ideepgray');}else{this.context.setdatepop.find('ul[tag=datelist]').children('li[tag=day][week='+week+']').attr('mark','radio').removeClass('ideepgray');}
var selectweek=[];this.context.setdatepop.find('ul[tag=selectweek]').children('li').children().each(function(){if($(this).find('input').is(':checked')){selectweek.push($(this).find('input').val());}});this.cache_selectnotweek=selectweek;},_getStartAndEndDate:function(time){if(M.isEmpty(time)){time=M.getTime();}
var datenow=M.timeformat(time);var prev_time=this._getPreMonth(time);var next_time=this._getNextMonth(time);var prev_date=M.timeformat(prev_time,'Y-m')+'-21';var next_date=M.timeformat(next_time,'Y-m')+'-07';var data={'date':datenow,'datestart':prev_date,'dateend':next_date};return data;},_getDate:function(time){this.context.setdatepop.find('ul[tag=datelist]').html('');var mindate=this.context.setdatepop.attr('mindate');var maxdate=this.context.setdatepop.attr('maxdate');var mintime=M.strtotime(mindate);var maxtime=M.strtotime(maxdate);if(M.isEmpty(time)){time=mintime;}
var weekname_arr={'0':'周日','1':'周一','2':'周二','3':'周三','4':'周四','5':'周五','6':'周六','7':'周日'};var week=0;var prev_time=this._getPreMonth(time);var prev_date=M.timeformat(prev_time);var prev_days=this._getDays(prev_time);var prevMonthEndDay=this._getTodayWeek(prev_time,prev_days);var days=this._getDays(time);var monthEndDay=this._getTodayWeek(time,days);var prevmonthdays=prev_days-prevMonthEndDay;var html_li='';var firstdate=M.timeformat(time,'Y-m')+'-'+1;var firsttime=M.strtotime(firstdate);for(var i=1;i<=prevMonthEndDay;i++){prevmonthdays++;var thisdate=M.timeformat(prev_time,'Y-m')+'-'+prevmonthdays;var thistime=M.strtotime(thisdate);week=this._getTodayWeek(prev_time,prevmonthdays);if(mintime>firsttime||maxtime<thistime){html_li+='<li tag="day_no" date="'+thisdate+'" week="'+week+'" day="'+prevmonthdays+'" class="igray"><i>&nbsp;</i><b>'+prevmonthdays+'</b></li>';}else{html_li+='<li tag="day" date="'+thisdate+'" week="'+week+'" day="'+prevmonthdays+'"><i>&nbsp;</i><b>'+prevmonthdays+'</b></li>';}}
for(var i=1;i<=days;i++){var thisdate=M.timeformat(time,'Y-m')+'-'+i;var thistime=M.strtotime(thisdate);week=this._getTodayWeek(time,i);if(mintime>thistime||maxtime<thistime){html_li+='<li tag="day_no" date="'+thisdate+'" week="'+week+'" day="'+i+'" class="igray"><i>&nbsp;</i><b>'+i+'</b></li>';}else{html_li+='<li tag="day" date="'+thisdate+'" week="'+week+'" day="'+i+'"><i>&nbsp;</i><b>'+i+'</b></li>';}}
var j=1;var next_time=this._getNextMonth(time);var nextmaxday=7-monthEndDay;for(var i=1;i<=nextmaxday;i++){var thisdate=M.timeformat(next_time,'Y-m')+'-'+i;if(maxtime<M.strtotime(thisdate)){html_li+='<li tag="day_no" date="'+thisdate+'" day="'+i+'" class="igray"><i>&nbsp;</i><b>'+i+'</b></li>';}else{week=this._getTodayWeek(next_time,i);html_li+='<li tag="day" date="'+thisdate+'" week="'+week+'" day="'+j+'"><i>&nbsp;</i><b>'+j+'</b></li>';}
j++;}
var monthtime=M.strtotime(thisdate);if(mintime>firsttime){this.context.setdatepop.find('ul[tag=selectmonth]').find('a[tag=prevmonth]').addClass('no-allow').attr('tag','noprevmonth');this.context.setdatepop.find('ul[tag=selectmonth]').find('li[tag=prevmonth]').attr('tag','noprevmonth');}else{this.context.setdatepop.find('ul[tag=selectmonth]').find('a[tag=noprevmonth]').removeClass('no-allow').attr('tag','prevmonth');this.context.setdatepop.find('ul[tag=selectmonth]').find('li[tag=noprevmonth]').attr('tag','prevmonth');}
if(maxtime<=monthtime){this.context.setdatepop.find('ul[tag=selectmonth]').find('a[tag=nextmonth]').addClass('no-allow').attr('tag','nonextmonth');this.context.setdatepop.find('ul[tag=selectmonth]').find('li[tag=nextmonth]').attr('tag','nonextmonth');}else{this.context.setdatepop.find('ul[tag=selectmonth]').find('a[tag=nonextmonth]').removeClass('no-allow').attr('tag','nextmonth');this.context.setdatepop.find('ul[tag=selectmonth]').find('li[tag=nonextmonth]').attr('tag','nextmonth');}
var this_date=M.timeformat(time,'Y年m月');this.context.setdatepop.find('ul[tag=selectmonth]').find('a[tag=prevmonth]').attr('value',prev_date);this.context.setdatepop.find('ul[tag=selectmonth]').find('a[tag=nextmonth]').attr('value',M.timeformat(next_time));this.context.setdatepop.find('ul[tag=selectmonth]').find('a[tag=month]').html(this_date);this.context.setdatepop.find('ul[tag=datelist]').html(html_li);var Holiday=M.Holiday();var i=0;var holidayname='';this.context.setdatepop.find('ul[tag=datelist]').children().each(function(){var value='';if(i<7){week=$(this).attr('week');value=weekname_arr[week];}
var date=$(this).attr('date');if(!M.isEmpty(date)&&(holidayname=Holiday.getholiday(date))){value=holidayname;}
$(this).children('i').html(value);i++;});},_getPreMonth:function(date){var now=new Date(date.getFullYear(),date.getMonth()-1,date.getDate());return now;},_getNextMonth:function(date){var now=new Date(date.getFullYear(),date.getMonth()+1,date.getDate()-1);return now;},_getTodayWeek:function(date,day){var year=date.getFullYear();var month=date.getMonth()+1;var fromdate=year+'-'+month+'-'+day;var time=M.strtotime(fromdate);var week=time.getDay();if(week==0){week=7;}
return week;},_getDays:function(date){var year=date.getFullYear();var mouth=date.getMonth()+1;var days;if(mouth==2){days=year%4==0?29:28;}
else if(mouth==1||mouth==3||mouth==5||mouth==7||mouth==8||mouth==10||mouth==12){days=31;}
else{days=30;}
return days;},_getSelectRoomType:function(){var selectroomtype=[];var html_div_roomtypelist=this.context.addCouponPop.find('li[tag=roomtype]').find('div[tag=roomtypelist]');html_div_roomtypelist.children().each(function(i){if($(this).find('input[tag=selectroomtype]').is(':checked')){selectroomtype.push($(this).find('input[tag=selectroomtype]').attr('rtid'));}});var str_selectroomtype=selectroomtype.toString();return str_selectroomtype;},initfileupload:function(){var tpl=this.context.maincontent.children().find("input[type=file][tag=file]");var innid=this.context.innlist.val();tpl.each(function(){var type=$(this).attr("t");var url='/Microinn/uploadImg?type='+type;$(this).fileupload({url:url,dataType:'json',autoUpload:true,maxFileSize:1000000000,previewMaxWidth:100,previewMaxHeight:100,limitMultiFileUploadSize:5,previewCrop:true,beforeSend:function(e,data){var size=data.files[0].size;var limit=5*1024*1024;if(limit<size){M.error('您上传的图片太大了，请将图片压缩至5MB以下');return false;}
var limittype=new Array('JPG','JPEG','PNG','GIF','BMP','jpg','jpeg','png','gif','bmp');var type=data.files[0].type;var has=0;for(var i=0;i<limittype.length;i++){var item=limittype[i];if(type.indexOf(item)!=-1){has=1;}}
if(has==0){M.error('暂不支持这种格式的图片，请上传JPG/JPEG/PNG/GIF/BMP等格式');return false;}},done:function(e,data){var d=data.result;if(d.status=="success"){page._finishedupload(d);}else{M.error(d.msg);page._handleerror(d);}},fail:function(jqXHR,textStatus,errorThrown,options){},progressall:function(e,data){var progress=parseInt(data.loaded/data.total*100,10);page._processhandle(progress);}});});$("#video").fileupload({url:'/Microinn/uploadvideo',dataType:'json',autoUpload:true,maxFileSize:1000000000,limitMultiFileUploadSize:5,beforeSend:function(e,data){var size=data.files[0].size;$("body").find('div[tag=innvideo]').find('p[tag=videoname]').html(data.files[0].name);},done:function(e,data){var ele=M.EventEle(e);var target=ele.parents('div[tag=innvideo]');var d=data.result;if(d.status=="success"){target.find('p[tag=videostatus]').html('视频已上传，优酷正在审核中，请稍候').show();target.find('tr[tag=vidoinfo]').hide();}else{M.error(d.msg);target.find('div[tag=progress]').css('width','0%').html('0 %');target.find('p[tag=videosize]').html('0 MB / 0 MB').parent().hide();}},fail:function(jqXHR,textStatus,errorThrown,options){},progressall:function(e,data){var progress=parseInt(data.loaded/data.total*100,10);var videosize=parseInt(data.total/(1024*1024)*100)/100;var laodsize=parseInt(data.loaded/(1024*1024)*100)/100;var ele=M.EventEle(e);var target=ele.parents('div[tag=innvideo]');target.find('tr[tag=vidoinfo]').show();target.find('div[tag=progress]').css('width',progress+'%').html(progress+' %');target.find('p[tag=videosize]').html(laodsize+' MB / '+videosize+' MB').parent().show();}});},_handleerror:function(d){var target=this.target_tpl;var t=target.attr("tag");if(t=="roomtype"||t=="pop_roomtype"||t=="goodimg"){if(t=="pop_roomtype"||t=="goodimg"){target.children("li[tag=add]").show().children("input[tag=file]").val('');target.children("li[tag=loading]").hide().children("div").children("span").text("上传中...0%");}
if(t=="roomtype"){this.roomtypetarget.children("div[tag=img]").show();this.roomtypetarget.children("div[tag=loading]").hide();this.roomtypetarget.children("div[tag=loading]").children("span").text("上传中...0%");target.children("li[tag=add]").show().children("input[tag=file]").val('');target.children("li[tag=loading]").hide().children("div").children("span").text("上传中...0%");}}else if(t=='imglist'||t=='shopkeepersay'||t=='innavatar'){target.find('li[tag=loading]').hide();}else if(t=='uploadimagepage'){target.html(target.attr('title')).attr('upstatus',0);}},_finishedupload:function(d){var target=this.target_tpl;var t=target.attr("tag");if(t=="roomtype"||t=="pop_roomtype"||t=="goodimg"){this.roomtype_upload_finished(d);if(t=="pop_roomtype"||t=="goodimg"){target.children("li[tag=add]").show().children("input[tag=file]").val('');target.children("li[tag=loading]").hide().children("div").children("span").text("上传中...0%");}
if(t=="roomtype"){this.roomtypetarget.children("div[tag=img]").show();this.roomtypetarget.children("div[tag=loading]").hide();this.roomtypetarget.children("div[tag=loading]").children("span").text("上传中...0%");target.children("li[tag=add]").show().children("input[tag=file]").val('');target.children("li[tag=loading]").hide().children("div").children("span").text("上传中...0%");}}else if(t=='uploadimagepage'){target.html(target.attr('title')).attr('upstatus',0);var tpl=this.context.setfeature.find('dl[tag=image]').show();tpl.find("div[tag=firstupload]").hide();tpl.find("div[tag=hasupload]").show().find('img').attr('src',d.path);M.confirmmessage('形象页设定成功，在手机上刷新微官网看看效果吧！');this.clearwkzcache();}else{page.upload_finished(d);}},roomtype_upload_finished:function(d){var target=this.target_tpl;var t=target.attr("tag");if(t=="roomtype"||t=="pop_roomtype"||t=="goodimg"){var photo=this.context.wkzroomresize.find("div[name='wkzcanvas']").children().find("img[name=photo]");photo.imgAreaSelect({remove:true});}else{var photo=target.children().find("img[name=photo]");photo.imgAreaSelect({remove:true});}
this.context.wkzroomresize.find("img[name='photo']").attr('src','');this.context.wkzroomresize.find("img[name='preview']").attr('src','');this.context.wkzroomresize.children("div[tag=save_btn]").show();var pic_path=d.path;this.context.wkzroomresize.find("h4[name='progress_title']").show().text('请按比例裁剪图片');this.context.wkzroomresize.find("div[name='progress']").hide();this.context.wkzroomresize.find("div[class='before']").show();this.context.wkzroomresize.find("div[class='after']").show();this.context.wkzroomresize.find("div[class='modal-footer']").show();this.context.save_wkzroomresize.attr('pic_path',pic_path);this.context.wkzroomresize.find("img[name='photo']").attr('src',pic_path).hide();this.context.wkzroomresize.find("img[name='preview']").attr('src',pic_path).hide();var target=this.context.wkzroomresize.find("div[name='wkzcanvas']");if(t=="pop_roomtype"||t=="roomtype"){this.context.wkzroomresize.css("z-index","9999");this.context.wkzroomresize.attr("type","roomtype");}
if(t=="goodimg"){this.context.wkzroomresize.attr("type","goodimg");}
this.context.wkzroomresize.attr("sendstatus",0);this.context.wkzroomresize.find("div[tag=save_btn]").children("a").addClass("btn-cancel").removeClass("btn-primary");M.Popup(this.context.wkzroomresize,{"hideclass":"modal wkzroomresize fade","showclass":"modal wkzroomresize fade in"});setTimeout(this.cutImage2.toEventHandler(this),100);},_processhandle:function(process){var target=this.target_tpl;var t=target.attr("tag");if(t=="pop_roomtype"||t=="goodimg"){target.children("li[tag=add]").hide();var tpl=target.children("li[tag=loading]").show();tpl.children("div").children("span").html('上传中...'+process+'%');}
else if(t=="roomtype"){var target=this.roomtypetarget;target.children("div[tag=img]").hide();var tpl=target.children("div[tag=loading]").show();tpl.children("span").html('上传中...'+process+'%');}else if(t=="uploadimagepage"){var target=this.target_tpl;target.html('上传中...'+process+'%');}else{if(this.operate=='modify'){var tpl_li=target.find('li').children('a[imgid='+this.imgid+']').parent();tpl_li.children('img').hide();tpl_li.children('div[tag=operate]').hide();tpl_li.children('div[tag=desc]').hide();tpl_li.children('div[tag=description]').hide();tpl_li.children('div[tag=loading]').find("span").html('上传中...'+process+'%');tpl_li.children('div[tag=loading]').show();if(process>=100){tpl_li.children('div[tag=loading]').hide();tpl_li.children('img').show();tpl_li.children('div[tag=operate]').show();tpl_li.children('div[tag=desc]').show();}
if(process>=100&&t=='innimg'){tpl_li.children('div[tag=description]').show();}}else{target.find('li[tag=loading]').find("span").html('上传中...'+process+'%');target.find('li[tag=upload_li]').hide();target.find('li[tag=loading]').show();if(process>=100){target.find('li[tag=upload_li]').show();}}}},upload_finished:function(d){var target=this.target_tpl;var photo=target.children().find("img[name=photo]");photo.imgAreaSelect({remove:true});target.children().find("img[name=photo]").attr("src",'');target.children().find("div[tag=preview]").children("img").attr("src",'');target.children().find("li[tag=loading]").hide().children("span").html('0%');var uploadform=target.parent("form[name=upform]");var type=uploadform.attr('type');if(type=='roomtype'){target.children("div[tag=roomtype]").slideDown("fast");}
target.children("div[tag=show_img]").slideDown("fast");target.children("a[tag=save_img]").slideDown("fast");target.children("div[tag=div_save]").slideDown("fast");target.children("div[tag=inn_description]").slideDown("fast");target.children().find("img[name=photo]").attr("src",d.path);target.children().find("div[tag=preview]").children("img").attr("src",d.path);M.emptyVal(target.children().find("textarea[name='pic_content']"));this.context.picurl.val(d.path);this.cutImage(d.path);if(type=='shopkeepersay'){if(this.imgid>0){var title=target.find('li[imgid='+this.imgid+']').find('div[tag=desc]').attr('title');target.find('div[tag=div_save]').find('textarea').val(title);}else{target.find('div[tag=div_save]').find('textarea').val('');}}},reqbusy:function()
{alert("请求处理中，请稍后再试");},req_before:function(btn)
{var busy=btn.attr("busy");if(busy=="1")
{this.reqbusy();return false;}
btn.html(this.submittext).attr("busy","1");btn.attr("class",btn.attr("tempclass")+" disabled");return true;},req_end:function(btn)
{btn.html(btn.attr("text")).attr("busy","");btn.attr("class",btn.attr("tempclass"));},NoUndefined:function(str)
{return M.isEmpty(str)?"":str;},_closepopup:function()
{M.ClosePopup();},destroy:function(){}});var target_tpl=null;var typelist={"innavatar":"35:24","innweixin":"9:5","shopkeepersay":"1:1","inn":"35:24","roomtype":"35:24"};function imgOnLoad(img,target){target_tpl=target;var width=img.width;var height=img.height;var r=height/width;var imgOrgBox=target_tpl.children().find("div[tag=imgOrgBox]");var photo=target_tpl.children().find("img[name=photo]");if(r>1.5){imgActualHeight=imgOrgBox.height();imgActualWidth=imgActualHeight/r;photo.attr("style","height:100%");$('#s').val(height/imgActualHeight);$('#s1').val(imgActualHeight/height);}else{imgActualWidth=imgOrgBox.width();imgActualHeight=imgActualWidth*r;photo.attr("style","width:100%");$('#s').val(width/imgActualWidth);$('#s1').val(imgActualWidth/width);}
var uploadform=target.parent("form[name=upform]");var type=uploadform.attr('type');var raido=typelist[type];photo.imgAreaSelect({remove:true});var raidoarr=raido.split(":");var imgwidth=imgActualWidth-10;var imgheight=parseInt(imgwidth*raidoarr[1]/raidoarr[0]);if(imgheight>imgActualHeight){imgheight=imgActualHeight-10;imgwidth=parseInt(imgheight*raidoarr[0]/raidoarr[1])-10;}
photo.imgAreaSelect({x1:0,y1:0,x2:imgwidth,y2:imgheight,onInit:preview,instance:true,aspectRatio:raido,handles:true,parent:imgOrgBox,onSelectEnd:preview});target_tpl.find("a[tag=save_img]").removeClass("btn-cancel").addClass("btn-info");}
function imgOnLoad2(img,target){target_tpl=target;var width=img.width;var height=img.height;var r=height/width;var imgOrgBox=target_tpl.children().find("div[tag=imgOrgBox]");var photo=target_tpl.children().find("img[name=photo]");photo.imgAreaSelect({remove:true});if(r>1.5){imgActualHeight=imgOrgBox.height();imgActualWidth=imgActualHeight/r;photo.attr("style","height:100%");$('#s').val(height/imgActualHeight);$('#s1').val(imgActualHeight/height);}else{imgActualWidth=imgOrgBox.width();imgActualHeight=imgActualWidth*r;photo.attr("style","width:100%");$('#s').val(width/imgActualWidth);$('#s1').val(imgActualWidth/width);}
var uploadform=target.parent("form[name=upform]");var type=uploadform.attr('type');var raido=typelist['roomtype'];var raidoarr=raido.split(":");var imgwidth=imgActualWidth-10;var imgheight=parseInt(imgwidth*raidoarr[1]/raidoarr[0]);if(imgheight>imgActualHeight){imgheight=imgActualHeight-10;imgwidth=parseInt(imgheight*raidoarr[0]/raidoarr[1])-10;}
photo.imgAreaSelect({x1:0,y1:0,x2:imgwidth,y2:imgheight,onInit:preview2,instance:true,aspectRatio:"35:24",handles:true,parent:imgOrgBox,onSelectEnd:preview2});$("#wkzroomresize").find("div[tag=save_btn]").children("a").removeClass("btn-cancel").addClass("btn-primary");}
function preview(img,selection){if(!selection.width||!selection.height)
return;var selectionDiv=target_tpl.children().find("div[tag=preview]");var preview_img=target_tpl.children().find("img[tag=preview_img]");var scaleX=selectionDiv.width()/selection.width;var scaleY=selectionDiv.height()/selection.height;preview_img.css({width:Math.round(scaleX*imgActualWidth),height:Math.round(scaleY*imgActualHeight),marginLeft:-Math.round(scaleX*selection.x1),marginTop:-Math.round(scaleY*selection.y1)});var s=$("#s").val();var x1=selection.x1*s;$('#x1').val(x1);var y1=selection.y1*s;$('#y1').val(y1);$('#x2').val(selection.x2);$('#y2').val(selection.y2);var w=selection.width*s;$('#w').val(w);var h=selection.height*s;$('#h').val(h);}
function preview2(img,selection){if(!selection.width||!selection.height)
return;var selectionDiv=target_tpl.children().find("div[tag=preview]");var preview_img=target_tpl.children().find("img[tag=preview_img]");var scaleX=selectionDiv.width()/selection.width;var scaleY=selectionDiv.height()/selection.height;preview_img.css({width:Math.round(scaleX*imgActualWidth),height:Math.round(scaleY*imgActualHeight),marginLeft:-Math.round(scaleX*selection.x1),marginTop:-Math.round(scaleY*selection.y1)});var s=$("#s").val();var x1=selection.x1*s;$('#x1').val(x1);var y1=selection.y1*s;$('#y1').val(y1);$('#x2').val(selection.x2);$('#y2').val(selection.y2);var w=selection.width*s;$('#w').val(w);var h=selection.height*s;$('#h').val(h);}
M.ready(function(){page=new M.Page.set_wkzroom();return page;});