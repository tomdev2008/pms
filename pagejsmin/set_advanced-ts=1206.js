M.Page.set_advanced=M.createClass();M.extend(M.Page.set_advanced.prototype,{context:{},mobile_tpl:'<li mid="${mid}"><label>${mobile}</label><a tag="del" href="#?" title="删除该手机" class="delete"></a></li>',alicert_tip:'未完成实名认证的支付宝账户，<br>收款额度限制为5000元/年',tpl_smartconsumetype:'<li tag="smartproject"><input type="text" name="typename" id="${id}" value="${name}"/><span class="del" tag="del" title="删除该小项"></span></li>',tpl_consumetype:'<li id="${id}"><label>${name}</label><a class="edit" tag="modify" title="修改" href="javascript:;">修改</a><a class="delete" tag="del" title="删除" href="javascript:;"></a></li>',smart_project_idstr:'',ele_cache:'',subBankInfo:[],timer:null,needBranchBankCodeArr:['HXBANK','RCB','RCC','CCD'],init:function(){this.initDOM();this.initEvent();this.initsort();},initDOM:function(){this.context.main=$('.main');this.context.paytypelist=$('#paytypelist');this.context.paytypename=$('#paytypename');this.context.addnewpaytype=$("#addnew");this.context.editPop=$('#editPop');this.context.incometypeitem=$('#incometypeitem');this.context.paytypeitem=$('#paytypeitem');this.context.add_incomeitem=$("#add_incomeitem");this.context.add_payitem=$("#add_payitem");this.context.incometypelist=$("#incometypelist");this.context.editpaycard=$("#editpaycard");this.context.paycardform=$("#paycardform");this.context.tooltip_alicert=$("#tooltip-alicert");this.context.tooltip_alicert.attr("title",'').tooltip({position:{my:"left+15 top+20",at:"left bottom"},track:1,content:this.alicert_tip,show:{duration:100}});this.context.mobilelist=$("#mobilelist");this.context.innlist=$("#innlist");this.context.cashierdetailBox=$("#cashierdetailBox");this.context.showcashierbox=$("#showcashierbox");this.context.hangacount=$('#hangacount');this.context.hangacountpop=$('#hangacountpop');this.context.settlementBox=$('#settlementBox');this.context.chooseSubBank=$("#chooseSubBank");this.context.bankBox=$('#bankBox');this.context.provinceBox=$('#provinceBox');this.context.cityBox=$('#cityBox');this.context.subBankBox=$('#subBankBox');this.context.bankinnlist=$('#bankinnlist');this.context.accountmobilenum=$("#accountmobilenum");this.context.accountmobilelist=$("#accountmobilelist");this.context.checkouttipmsg=$("#checkouttipmsg");this.context.editaccounttip=$("#editaccounttip");var tipmsg='- 收银台订单，按照交易日期T+2进行结算，需要扣除1%的交易结算费用<br/>- 微官网订单， 按照交易日期T+2进行结算，需要扣除<br/>1.2%交易结算费用<br/>- 代销订单，每月15日结算上月所有离店订单';this.context.checkouttipmsg.attr("title",'').tooltip({position:{my:"left+15 top+20",at:"left bottom"},track:1,content:tipmsg,show:{duration:100}});var img="<img src='/pic/weixinkefu.jpg?ret=1'></img>";this.context.editaccounttip.attr("title",'').tooltip({position:{my:"left+15 top+20",at:"left bottom"},track:1,content:img,show:{duration:100}});},initEvent:function(){this.context.main.bind("click",this.main_click.toEventHandler(this));this.context.addnewpaytype.bind("click",this.addnewpaytype.toEventHandler(this));this.context.paytypelist.bind("click",this.paytypelist_click.toEventHandler(this));this.context.editPop.bind("click",this.editPop.toEventHandler(this));this.context.editpaycard.bind("click",this.editpaycard_click.toEventHandler(this));this.context.mobilelist.bind('click',this.mobilelist_click.toEventHandler(this));this.context.innlist.bind("change",this.innlist_change.toEventHandler(this));this.context.showcashierbox.bind('click',this.showcashierbox_click.toEventHandler(this));this.context.hangacount.bind('click',this.hangacount_click.toEventHandler(this));this.context.hangacountpop.bind('click',this.hangacountpop_click.toEventHandler(this));this.context.settlementBox.bind('click',this.settlementBox_click.toEventHandler(this));this.context.bankBox.bind('click',this.bankBox_click.toEventHandler(this));this.context.provinceBox.bind('click',this.provinceBox_click.toEventHandler(this));this.context.cityBox.bind('click',this.cityBox_click.toEventHandler(this));this.context.subBankBox.bind('click',this.subBankBox_click.toEventHandler(this));this.context.chooseSubBank.bind('keyup',this.chooseSubBank_change.toEventHandler(this));this.context.chooseSubBank.bind('keydown',this.chooseSubBankList_handler.toEventHandler(this));this.context.bankinnlist.bind("change",this.bankinnlist_change.toEventHandler(this));this.context.accountmobilelist.bind('click',this.settlemobilelist_click.toEventHandler(this));$(".main-content").scroll(this._scroll.toEventHandler(this));},main_click:function(e){var ele=M.EventEle(e);var t=ele.attr("tag");if(t!=='chooseBank'){this.context.bankBox.hide();}
if(t!=='chooseProvince'){this.context.provinceBox.hide();}
if(t!=='chooseCity'){this.context.cityBox.hide();}
if(t!=='chooseSubBank'){this.context.subBankBox.hide();this.renderSubBanch(this.subBankInfo);}},bankinnlist_change:function(){var innid=this.context.bankinnlist.val();this.innid=innid;M._getjson("/Advanced/getBankInfo",{"innid":innid},this.bankinnlistchange_finished.toEventHandler(this),'',true);},bankinnlistchange_finished:function(d){var bankinfo=d.bankInfo;if(!M.isEmpty(bankinfo)){if(!M.isEmpty(bankinfo.bankname)){this.context.settlementBox.find("input[tag=chooseBank]").val(bankinfo.bankname).attr("disabled","disabled");}else{this.context.settlementBox.find("input[tag=chooseBank]").val("").removeAttr("bankcode");}
this.context.settlementBox.find("input[name=banktype]").removeAttr("checked");if(!M.isEmpty(bankinfo.banktype)){this.context.settlementBox.find("input[name=banktype][value="+bankinfo.banktype+"]").attr("checked","checked");this.context.settlementBox.find("input[name=banktype]").attr("disabled","disabled");if(bankinfo.banktype=='private'){this.context.settlementBox.find("dt[tag=accountnameText]").text("开户人姓名");}
if(bankinfo.banktype=='public'){this.context.settlementBox.find("dt[tag=accountnameText]").text("公司名称");}}else{this.context.settlementBox.find("input[name=banktype]:first").attr("checked","checked");}
if(!M.isEmpty(bankinfo.cardname)){this.context.settlementBox.find("input[name=accountname]").val(bankinfo.cardname).attr("disabled","disabled");}else{this.context.settlementBox.find("input[name=accountname]").val("");}
if(!M.isEmpty(bankinfo.cardnumber)){this.context.settlementBox.find("input[name=cardnumber]").val(bankinfo.cardnumber).attr("disabled","disabled");}else{this.context.settlementBox.find("input[name=cardnumber]").val("");}
if(!M.isEmpty(bankinfo.bankprovinces)){this.context.settlementBox.find("dl[tag=bankProvinces]").show();this.context.settlementBox.find("input[name=bankprovinces]").val(bankinfo.bankprovinces).removeAttr("provincetag").attr("disabled","disabled");}else{this.context.settlementBox.find("dl[tag=bankProvinces]").hide();this.context.settlementBox.find("input[name=bankprovinces]").val("").removeAttr("provincetag");}
if(!M.isEmpty(bankinfo.bankcity)){this.context.settlementBox.find("dl[tag=bankCity]").show();this.context.settlementBox.find("input[name=bankcity]").val(bankinfo.bankcity).removeAttr("branchtag").attr("disabled","disabled");}else{this.context.settlementBox.find("dl[tag=bankCity]").hide();this.context.settlementBox.find("input[name=bankcity]").val("").removeAttr("branchtag");}
if(!M.isEmpty(bankinfo.branchname)){this.context.settlementBox.find("dl[tag=branchName]").show();this.context.settlementBox.find("input[name=branchname]").val(bankinfo.branchname).removeAttr("citytag").attr("disabled","disabled");}else{this.context.settlementBox.find("dl[tag=branchName]").hide();this.context.settlementBox.find("input[name=branchname]").val("").removeAttr("citytag");}
if(!M.isEmpty(bankinfo.bankname)&&!M.isEmpty(bankinfo.banktype)&&!M.isEmpty(bankinfo.cardname)&&!M.isEmpty(bankinfo.cardnumber)){this.context.settlementBox.find("dl[tag=repeatCode]").hide();this.context.settlementBox.find("dl[tag=saveBtn]").hide();var edittip_length=this.context.settlementBox.find('dl[tag=edittip]').length;if(edittip_length==1){this.context.settlementBox.find('dl[tag=edittip]').show();}else{this.context.settlementBox.find("dl[tag=successTip]").show();}}else{this.context.bankBox.children("ul").children("li").children("a").removeClass("ico-selected");M.emptyVal(this.context.settlementBox.find("dl[tag=repeatCode]").find("input[name=confirmcardnumber]"));this.context.settlementBox.find("input[tag=chooseBank]").val("").removeAttr("disabled");this.context.settlementBox.find("input[name=banktype]:first").attr("checked","checked");this.context.settlementBox.find("dt[tag=accountnameText]").text("开户人姓名");this.context.settlementBox.find("input[name=banktype]").removeAttr("disabled");this.context.settlementBox.find("input[name=accountname]").val("").removeAttr("disabled");this.context.settlementBox.find("input[name=cardnumber]").val("").removeAttr("disabled");this.context.settlementBox.find("input[name=bankprovinces]").val("").removeAttr("disabled");this.context.settlementBox.find("input[name=bankcity]").val("").removeAttr("disabled");this.context.settlementBox.find("input[name=branchname]").val("").removeAttr("disabled");this.context.settlementBox.find("dl[tag=repeatCode]").show();this.context.settlementBox.find("dl[tag=saveBtn]").show();this.context.settlementBox.find("dl[tag=successTip]").hide();this.context.settlementBox.find('dl[tag=edittip]').hide();this.context.settlementBox.find("dl[tag=bankProvinces]").hide();this.context.settlementBox.find("dl[tag=bankCity]").hide();this.context.settlementBox.find("dl[tag=branchName]").hide();}}else{this.context.bankBox.children("ul").children("li").children("a").removeClass("ico-selected");this.context.settlementBox.find("input[tag=chooseBank]").val("").removeAttr("disabled").removeAttr("bankcode");this.context.settlementBox.find("input[name=banktype]:first").attr("checked","checked");this.context.settlementBox.find("input[name=banktype]").removeAttr("disabled");this.context.settlementBox.find("input[name=accountname]").val("").removeAttr("disabled");this.context.settlementBox.find("input[name=cardnumber]").val("").removeAttr("disabled");this.context.settlementBox.find("input[name=bankprovinces]").val("").removeAttr("disabled").removeAttr("provinceTag");this.context.settlementBox.find("input[name=bankcity]").val("").removeAttr("disabled").removeAttr("cityTag");this.context.provinceBox.children("ul").children("li").find("a").removeClass("on");this.context.cityBox.children("ul").children("li").find("a").removeClass("on");this.context.settlementBox.find("input[name=branchname]").val("").removeAttr("disabled").removeAttr("branchTag");M.emptyVal(this.context.settlementBox.find("dl[tag=repeatCode]").find("input[name=confirmcardnumber]"));this.context.settlementBox.find("dl[tag=repeatCode]").show();this.context.settlementBox.find("dl[tag=saveBtn]").show();this.context.settlementBox.find("dl[tag=successTip]").hide();this.context.settlementBox.find("dl[tag=bankProvinces]").hide();this.context.settlementBox.find("dl[tag=bankCity]").hide();this.context.settlementBox.find("dl[tag=branchName]").hide();}
this.context.provinceBox.children("ul").children("li").find("a").removeClass("on");this.context.cityBox.children("ul").children("li").find("a").removeClass("on");var accountmobilelist=d.accountmobile;if(!M.isEmpty(accountmobilelist)){this.context.accountmobilelist.children("li[class=addnew]").html('<input type="text" id="accountmobilenum" class="tname" placeholder="+新增手机" setplaceholder="" value=""><input type="button" flag="account" tag="add" value="+" class="btn btn-success tbtn">');for(var j=0;j<accountmobilelist.length;j++){var accountmobilelistval=accountmobilelist[j];tpl=$.tmpl(this.mobile_tpl,{"mid":accountmobilelistval.id,"mobile":accountmobilelistval.mobile});this.context.accountmobilelist.children("li[class=addnew]").prevAll().remove();this.context.accountmobilelist.children("li[class=addnew]").before(tpl);}
if(accountmobilelist.length==1){this.context.accountmobilelist.children("li[class=addnew]").hide();}else{this.context.accountmobilelist.children("li[class=addnew]").show();}}else{M.emptyVal(this.context.accountmobilenum);this.context.accountmobilelist.children("li[class=addnew]").children("input[tag=add]").attr("value","+");this.context.accountmobilelist.children("li[class=addnew]").prevAll().remove();this.context.accountmobilelist.children("li[class=addnew]").show();}},settlemobilelist_click:function(e){var ele=M.EventEle(e);var t=ele.attr("tag");if(t=='add'){this.addaccountmobile(e);}
if(t=='del'){this.delaccountmobile(ele);}},addaccountmobile:function(e){var ele=M.EventEle(e);var flag=ele.attr("flag");var size=this.context.accountmobilelist.children("li").size();var mobile=M.getVal(this.context.accountmobilelist.children("li").children("input[id=accountmobilenum]"));if(!M.isEmpty(mobile)){var re=/^(13|14|15|18|17)[0-9]{9}$/;if(!re.test(mobile)){alert("请输入正确的手机号");return false;}}else{alert('手机号不能为空');return;}
if(size<4){M._getjson("/Microinn/setMobile",{"mobile":mobile,"flag":flag},this.addaccountmobile_finished.toEventHandler(this));}else{alert('最多可设置3个手机号码');}},addaccountmobile_finished:function(d){if(d.status=="success"){var mid=d.id;var mobile=d.mobile;var flag=d.flag;tpl=$.tmpl(this.mobile_tpl,{"mid":mid,"mobile":mobile});if(flag==2){this.context.accountmobilelist.children("li[class=addnew]").before(tpl);var size=this.context.accountmobilelist.children("li").size();if(size==2){this.context.accountmobilelist.children("li[class=addnew]").hide();}}}else{M.error(d.msg);}
M.emptyVal(this.context.mobilelist.children("li[class=addnew]").children("input[class=tname]"));},delaccountmobile:function(ele){var res=confirm("确认删除吗？");if(!res){return;}
var id=ele.parent("li").attr("mid");var flag=ele.parent("li").parent("ul").attr("flag");if(M.isEmpty(id)){return;}
M._getjson("/Microinn/deleteMobile",{"id":id},this.delaccountmobile_finished.toEventHandler(this,flag));},delaccountmobile_finished:function(d,flag){if(d.status=="success"){var mid=d.id;if(flag=='account'){this.context.accountmobilelist.find("li[mid="+mid+"]").remove();var size=this.context.accountmobilelist.children("li").size();if(size<2){this.context.accountmobilelist.children("li[class=addnew]").show();this.context.accountmobilelist.children("li[class=addnew]").children("input[tag=add]").attr("flag","account");this.context.accountmobilelist.children("li[class=addnew]").children("input[class=tname]").val("");}}}else{M.error(d.msg);}},settlementBox_click:function(e){var ele=M.EventEle(e);var tag=ele.attr('tag');if(tag=="chooseBank"){var x=ele.offset().left;var y=ele.offset().top+ele.outerHeight();var status=ele.attr("disabled");if(status=="disabled"){this.context.bankBox.hide();}else{this.context.bankBox.css({'top':y,'left':x}).show();}}
if(tag=="chooseProvince"){var x=ele.offset().left;var y=ele.offset().top+ele.outerHeight();var status=ele.attr("disabled");if(status=="disabled"){this.context.provinceBox.hide();}else{this.context.provinceBox.css({'top':y,'left':x}).show();}}
if(tag=="chooseCity"){var provinceTag=this.context.settlementBox.find("input[tag=chooseProvince]").attr('provinceTag');if(provinceTag){var x=ele.offset().left;var y=ele.offset().top+ele.outerHeight();var status=ele.attr("disabled");if(status=="disabled"){this.context.cityBox.hide();}else{this.context.cityBox.css({'top':y,'left':x}).show();}}}
if(tag=="chooseSubBank"){var bankTag=this.context.settlementBox.find("input[tag=chooseBank]").attr('bankcode');var cityTag=this.context.settlementBox.find("input[tag=chooseCity]").attr('cityTag');this.context.settlementBox.find("input[tag=chooseSubBank]").attr('readonly','readonly');if(bankTag&&cityTag){this.context.settlementBox.find("input[tag=chooseSubBank]").removeAttr('readonly');var x=ele.offset().left;var y=ele.offset().top+ele.outerHeight();var status=ele.attr("disabled");if(status=="disabled"){this.context.subBankBox.hide();}else{this.context.subBankBox.css({'top':y,'left':x}).show();}}}
if(tag=="banktype"){var value=ele.val();if(value=="public"){this.context.settlementBox.find("dt[tag=accountnameText]").text("公司名称");this.context.settlementBox.find("dl[tag=bankProvinces]").show();this.context.settlementBox.find("dl[tag=bankCity]").show();this.context.settlementBox.find("dl[tag=branchName]").show();}
if(value=="private"){this.context.settlementBox.find("dt[tag=accountnameText]").text("开户人姓名");this.context.settlementBox.find("dl[tag=bankProvinces]").hide();this.context.settlementBox.find("dl[tag=bankCity]").hide();this.context.settlementBox.find("dl[tag=branchName]").hide();}
this.context.settlementBox.find("input[tag=chooseBank]").val("").removeAttr('bankcode');this.context.settlementBox.find("input[name=bankprovinces]").val("").removeAttr('provinceTag');this.context.settlementBox.find("input[name=bankcity]").val("").removeAttr('cityTag');this.context.provinceBox.children("ul").children("li").find("a").removeClass("on");this.context.cityBox.children("ul").children("li").find("a").removeClass("on");this.context.settlementBox.find("input[name=accountname]").val("");this.context.settlementBox.find("input[name=cardnumber]").val("");this.context.settlementBox.find("input[name=confirmcardnumber]").val("");this.delSubBankInfo();this.context.bankBox.children("ul").children("li").children("a").removeClass("ico-selected");}
if(tag=="saveBankCode"){var confirmnumber=this.context.settlementBox.find("dl[tag=repeatCode]").css("display");if(confirmnumber=='none'){this.context.settlementBox.find("dl[tag=repeatCode]").show();return;}
var bankname=this.context.settlementBox.find("input[tag=chooseBank]").val();var bankcode=this.context.settlementBox.find("input[tag=chooseBank]").attr("bankcode");var banktype=this.context.settlementBox.find("input[name=banktype]:checked").val();var accountname=this.context.settlementBox.find("input[name=accountname]").val();var cardnumber=this.context.settlementBox.find("input[name=cardnumber]").val();var confirmcardnumber=this.context.settlementBox.find("input[name=confirmcardnumber]").val();var bankprovinces=this.context.settlementBox.find("input[name=bankprovinces]").val();var bankcity=this.context.settlementBox.find("input[name=bankcity]").val();var branchname=this.context.settlementBox.find("input[name=branchname]").val();var needBranch=false;var needBranchArr=this.needBranchBankCodeArr;needBranch=needBranchArr.indexOf(bankcode)>-1;if(banktype=='public'){needBranch=true;}
if(M.isEmpty(bankname)){alert("开户行不能为空！");return;}
if(needBranch){if(M.isEmpty(bankprovinces)){alert("所在省份不能为空！");return;}
if(M.isEmpty(bankcity)){alert("所在城市不能为空！");return;}
if(M.isEmpty(branchname)){alert("支行名称不能为空！");return;}}
if(M.isEmpty(accountname)){if(banktype=='private'){alert("开户人姓名不能为空！");return;}
if(banktype=='public'){alert("公司名称不能为空！");return;}}
if(M.isEmpty(cardnumber)){alert("银行卡号不能为空！");return;}else{cardnumber=cardnumber.replace(/[ ]/g,"");if(!$.isNumeric(cardnumber)){alert("银行卡号不能为非数字！");return;}
if(cardnumber.length<9||cardnumber.length>22){alert("目前只支持9至22位的银行卡号，如有疑问请联系您的客户经理。");return;}}
if(confirmcardnumber!==cardnumber){alert("确认卡号和银行卡号不一致！");return;}
var data={'bankname':bankname,"bankcode":bankcode,"banktype":banktype,"cardname":accountname,"cardnumber":cardnumber,"confirmcardnumber":confirmcardnumber};if(needBranch){data.bankprovinces=bankprovinces;data.bankcity=bankcity;data.branchname=branchname;}
M._getjson('/Advanced/savebank',data,this.saveBankCode_finished.toEventHandler(this),'',true);}else if(tag=="editbank"){this.editbank(ele)}else if(tag=='sendvcode'){this.sendvcode();}else if(tag=="editbanksave"){this.editsavebank();}},editsavebank:function(){var confirmnumber=this.context.settlementBox.find("dl[tag=repeatCode]").css("display");if(confirmnumber=='none'){this.context.settlementBox.find("dl[tag=repeatCode]").show();return;}
var bankname=this.context.settlementBox.find("input[tag=chooseBank]").val();var bankcode=this.context.settlementBox.find("input[tag=chooseBank]").attr("bankcode");var banktype=this.context.settlementBox.find("input[name=banktype]:checked").val();var accountname=this.context.settlementBox.find("input[name=accountname]").val();var cardnumber=this.context.settlementBox.find("input[name=cardnumber]").val();var confirmcardnumber=this.context.settlementBox.find("input[name=confirmcardnumber]").val();var bankprovinces=this.context.settlementBox.find("input[name=bankprovinces]").val();var bankcity=this.context.settlementBox.find("input[name=bankcity]").val();var branchname=this.context.settlementBox.find("input[name=branchname]").val();var needBranch=false;var needBranchArr=this.needBranchBankCodeArr;needBranch=needBranchArr.indexOf(bankcode)>-1;if(banktype=='public'){needBranch=true;}
if(M.isEmpty(bankname)){alert("开户行不能为空！");return;}
if(needBranch){if(M.isEmpty(bankprovinces)){alert("所在省份不能为空！");return;}
if(M.isEmpty(bankcity)){alert("所在城市不能为空！");return;}
if(M.isEmpty(branchname)){alert("支行名称不能为空！");return;}}
if(M.isEmpty(accountname)){if(banktype=='private'){alert("开户人姓名不能为空！");return;}
if(banktype=='public'){alert("公司名称不能为空！");return;}}
if(M.isEmpty(cardnumber)){alert("银行卡号不能为空！");return;}else{cardnumber=cardnumber.replace(/[ ]/g,"");if(!$.isNumeric(cardnumber)){alert("银行卡号不能为非数字！");return;}
if(cardnumber.length<9||cardnumber.length>22){alert("目前只支持9至22位的银行卡号，如有疑问请联系您的客户经理。");return;}}
if(confirmcardnumber!==cardnumber){alert("确认卡号和银行卡号不一致！");return;}
var data={'bankname':bankname,"bankcode":bankcode,"banktype":banktype,"cardname":accountname,"cardnumber":cardnumber,"confirmcardnumber":confirmcardnumber};if(needBranch){data.bankprovinces=bankprovinces;data.bankcity=bankcity;data.branchname=branchname;}
var vcode=this.context.settlementBox.find('input[name=vcode]').val();data['vcode']=vcode;M._getjson('/Advanced/editsavebank',data,this.editsavebanks_finished.toEventHandler(this),'',true);},editsavebanks_finished:function(d){if(d.status=="success"){this.context.settlementBox.find('input').attr('disabled','disabled');this.context.settlementBox.find('dl[tag=signphone]').hide();this.context.settlementBox.find('dl[tag=vcode]').hide();this.context.settlementBox.find('input[name=vcode]').val('');this.context.settlementBox.find('dl[tag=editsave]').hide();this.context.settlementBox.find('dl[tag=edittip]').show();}else{alert(d.msg);}},sendvcode:function(){M._getjson("/Advanced/sendvcode",{},this.sendvcode_finished.toEventHandler(this),'',true);},sendvcode_finished:function(d){if(d.status=="success"){this.context.settlementBox.find('a[tag=sendvcode]').hide();this.context.settlementBox.find('span[tag=timecount]').attr('count',120).html(120+'秒后可重发').show();this.timer=window.setInterval(this.run.toEventHandler(this),1000);}else{alert(d.msg);}},run:function(){var text=this.context.settlementBox.find('span[tag=timecount]').attr('count');var num=parseInt(text);if(num==0){this.context.settlementBox.find('a[tag=sendvcode]').show();this.context.settlementBox.find('span[tag=timecount]').attr('count',120).hide();window.clearInterval(this.timer);}else{num=num-1;this.context.settlementBox.find('span[tag=timecount]').attr('count',num).html(num+'秒后可重发');}},editbank:function(ele){ele.parents('dl').hide();this.context.settlementBox.find('input').attr('disabled',false);this.context.settlementBox.find('dl[tag=signphone]').show();this.context.settlementBox.find("dl[tag=repeatCode]").show()
this.context.settlementBox.find('dl[tag=vcode]').show();this.context.settlementBox.find('input[name=vcode]').val('');this.context.settlementBox.find('dl[tag=editsave]').show();},_scroll:function(e){this.context.bankBox.hide();this.context.provinceBox.hide();this.context.cityBox.hide();this.context.subBankBox.hide();},saveBankCode_finished:function(d){if(d.status=='success'){M.success("保存成功");var data=d.data;if(!M.isEmpty(data.bankname)){this.context.settlementBox.find("input[tag=chooseBank]").attr("disabled","disabled");}
if(!M.isEmpty(data.banktype)){this.context.settlementBox.find("input[name=banktype]").attr("disabled","disabled");if(data.banktype=='public'){this.context.settlementBox.find("input[name=bankprovinces]").attr("disabled","disabled");this.context.settlementBox.find("input[name=bankcity]").attr("disabled","disabled");this.context.settlementBox.find("input[name=branchname]").attr("disabled","disabled");}}
if(!M.isEmpty(data.cardname)){this.context.settlementBox.find("input[name=accountname]").attr("disabled","disabled");}
if(!M.isEmpty(data.cardnumber)){this.context.settlementBox.find("input[name=cardnumber]").attr("disabled","disabled");}
this.context.settlementBox.find("dl[tag=repeatCode]").hide();this.context.settlementBox.find("dl[tag=saveBtn]").hide();this.context.settlementBox.find("dl[tag=successTip]").show();}else{M.error(d.msg);}},bankBox_click:function(e){var ele=M.EventEle(e);var tag=ele.attr('tag');if(tag=="close"){this.context.bankBox.hide();}
if(tag=="bank"){var bank=ele.attr("title");var bankcode=ele.attr("code");this.context.settlementBox.find("input[tag=chooseBank]").val(bank).attr("bankcode",bankcode);this.context.bankBox.children("ul").children("li").children("a").removeClass("ico-selected");var currentclass=ele.attr("class");ele.attr("class",currentclass+" ico-selected");this.context.bankBox.hide();var bankType=this.context.settlementBox.find("input[name='banktype']:checked").val();if(bankType=="private"){var needBranchArr=this.needBranchBankCodeArr;$needBranch=needBranchArr.indexOf(bankcode);if($needBranch>-1){this.context.settlementBox.find("dl[tag=bankProvinces]").show();this.context.settlementBox.find("dl[tag=bankCity]").show();this.context.settlementBox.find("dl[tag=branchName]").show();this.context.settlementBox.find("input[name=branchname]").val('');this.refreshSubBankData();}else{this.context.settlementBox.find("dl[tag=bankProvinces]").hide();this.context.settlementBox.find("dl[tag=bankCity]").hide();this.context.settlementBox.find("dl[tag=branchName]").hide();this.context.settlementBox.find("input[tag=chooseCity]").val("").removeAttr("CityTag");this.context.settlementBox.find("input[tag=chooseProvince]").val('').removeAttr("provinceTag");this.context.provinceBox.children("ul").children("li").find("a").removeClass("on");this.context.cityBox.children("ul").children("li").find("a").removeClass("on");}}else if(bankType=="public"){this.refreshSubBankData();}}},provinceBox_click:function(e){var ele=M.EventEle(e);var tag=ele.attr('tag');if(tag=="close"){this.context.provinceBox.hide();}
if(tag=="province"){var province=ele.attr("title");var provinceTag=ele.attr("provinceTag");this.context.settlementBox.find("input[tag=chooseProvince]").val(province).attr("provinceTag",provinceTag);this.context.provinceBox.children("ul").children("li").find("a").removeClass("on");var currentclass=ele.attr("class");ele.attr("class",currentclass+" on");this.context.provinceBox.hide();this.refreshCityData();this.delSubBankInfo();}},cityBox_click:function(e){var ele=M.EventEle(e);var tag=ele.attr('tag');if(tag=="close"){this.context.cityBox.hide();}
if(tag=="city"){var city=ele.attr("title");var cityTag=ele.attr("cityTag");this.context.settlementBox.find("input[tag=chooseCity]").val(city).attr("cityTag",cityTag);this.context.cityBox.children("ul").children("li").find("a").removeClass("on");var currentclass=ele.attr("class");ele.attr("class",currentclass+" on");this.context.cityBox.hide();this.refreshSubBankData();}},subBankBox_click:function(e){var ele=M.EventEle(e);var parentTag=ele.parent().attr('tag');var tag=ele.attr('tag');if(tag=="close"){this.context.subBankBox.hide();}
if(tag=="subBank"||parentTag=='subBank'){if(parentTag=='subBank'){ele=ele.parent();}
var branchName=ele.attr("title");var branchTag=ele.attr("branchTag");this.context.settlementBox.find("input[tag=chooseSubBank]").val(branchName).attr("branchTag",branchTag);this.context.subBankBox.hide();this.renderSubBanch(this.subBankInfo);}},initsort:function(){this.context.paytypelist.sortable({placeholder:"placeHolder",stop:this.savepaytypesort.toEventHandler(this)});this.context.editPop.find("ul[tag=sort]").sortable({placeholder:"placeHolder",stop:this.savewatertypesort.toEventHandler(this)});this.context.hangacount.find("ul[tag=list]").sortable({placeholder:"placeHolder",stop:this.saveconsumesort.toEventHandler(this)});},saveconsumesort:function(e){var list=this.context.hangacount.find('ul[tag=list]').children("li");var data={};var index=0;var sort=[];list.each(function(){var tpl=$(this);var cid=tpl.attr('id');sort.push(cid);});data.sortdata=sort.toString();M._getjson('/Advanced/sortconsume',data,this.sort_callback.toEventHandler(this));},checkchangestatus:function(list){var status=0;var index=1;list.each(function(){if($(this).attr("index")!=index){status=1;}
index++;});return status;},setlistindex:function(list){var index=1;list.each(function(){$(this).attr("index",index);index++;});},savewatertypesort:function(e){var target_ul=M.EventEle(e);var typename=target_ul.attr("t");var type=1;if(typename!='income'){type=2;}
var list=target_ul.children("li");var changestatus=this.checkchangestatus(list);if(changestatus==0){return;}
this.setlistindex(list);var sortlist=[];list.each(function(){var wid=$(this).attr("id");sortlist.push(wid);});var data={'sortstr':sortlist.toString(),"type":type};M._getjson('/Advanced/sortrecodesumtype',data,this.sort_callback.toEventHandler(this));},savepaytypesort:function(){var list=this.context.paytypelist.children("li");var data={};var index=0;var sort=[];list.each(function(){var tpl=$(this);var cid=tpl.attr('cid');sort.push(cid);});data.sortdata=sort.toString();M._getjson('/Advanced/sortpaytype',data,this.sort_callback.toEventHandler(this));},sort_callback:function(d){if(d.status=="success"){if(d.ischange==1){M.success('保存成功');}}else{M.error(d.msg);}},hangacount_click:function(e){var ele=M.EventEle(e);var tag=ele.attr('tag');if(tag=='create'){this._handacountinit();M.Popup(this.context.hangacountpop,{"hideclass":"modal sm fade","showclass":"modal sm fade in"});}else if(tag=='modify'){this.consumemodify(ele);}else if(tag=='del'){this.ele_cache=ele;var id=ele.parent().attr('id');var parentid=0;this.consumedel(id,parentid);}},consumedel:function(id,parentid){var type=2;if(M.isEmpty(parentid)){type=1;}
var data={'id':id,'parentid':parentid,'type':type};M._getjson('/Advanced/getacountdelverify',data,this.consumedel_callback.toEventHandler(this));},consumedel_callback:function(d){if(d.status=='success'){var data=d.data;if(data.iscode==1){if(data.type==1){M.confirm('您已有消费挂账到该项，删除后可能导致统计出错，该操作不可恢复，确认删除吗？',this.consume_confirm.toEventHandler(this),this.consume_cancle.toEventHandler(this));}else if(data.type==2){M.confirm('您已有消费挂账到该项，删除后可能导致统计出错，该操作不可恢复，确认删除吗？',this.smartproject_del.toEventHandler(this),this.consume_cancle.toEventHandler(this));}}else{if(data.type==1){this.consume_confirm();}else if(data.type==2){this.smartproject_del();}}}else{M.error(d.msg);}},consumemodify:function(ele){var id=ele.parent().attr('id');if(M.isEmpty(id)){M.error('参数错误');return false;}
var data={'id':id};M._getjson('/Advanced/getacountproject',data,this.consumemodify_callback.toEventHandler(this));},consumemodify_callback:function(d){if(d.status=='success'){var data=d.data;M.Popup(this.context.hangacountpop,{"hideclass":"modal sm fade","showclass":"modal sm fade in"});var ul_ptn=this.context.hangacountpop.find('div[tag=smartprojectlist]').children('ul');this.context.hangacountpop.find('input[name=projectname]').attr('id',data.id).val(data.name);ul_ptn.empty();if(!M.isEmpty(data.list)){ul_ptn.append($.tmpl(this.tpl_smartconsumetype,data.list));}
this._hide_delbtn();this.smart_project_idstr='';}else{M.error(d.msg);}},consume_confirm:function(){M.closeMessage();var id=this.ele_cache.parent().attr('id');if(M.isEmpty(id)){M.error('参数错误');return false;}
var data={'id':id};this.ele_cache.attr('tag','nodel');M._getjson('/Advanced/acountprojectdel',data,this.hangacount_del_callback.toEventHandler(this));},consume_cancle:function(){M.closeMessage();},hangacount_del_callback:function(d){var data=d.data;if(d.status=='success'){this.context.hangacount.find('li[id='+data.id+']').remove();}else{M.error(d.msg);this.ele_cache.attr('tag','del');}
this.ele_cache='';return true;},_handacountinit:function(){var ul_ptn=this.context.hangacountpop.find('div[tag=smartprojectlist]').children('ul');this.context.hangacountpop.find('input[name=projectname]').attr('id','').val('');ul_ptn.empty().append($.tmpl(this.tpl_smartconsumetype,{'id':'','name':''}));this._hide_delbtn();},hangacountpop_click:function(e){var ele=M.EventEle(e);var tag=ele.attr('tag');switch(tag){case'create':this.smartproject_add(ele);break;case'del':this.ele_cache=ele;var id=ele.parent().children('input[name=typename]').attr('id');var parentid=this.context.hangacountpop.find('ul').find('input[name=projectname]').attr('id');if(M.isEmpty(id)){this.smartproject_del()}else{this.consumedel(id,parentid);}
break;case'save':this.project_save(ele);break;}},smartproject_add:function(ele){var ul_ptn=ele.parents('div[tag=smartprojectlist]').children('ul');ul_ptn.append($.tmpl(this.tpl_smartconsumetype,{'id':'','name':''}));ul_ptn.find('span[tag=del]').show();},smartproject_del:function(){var id=this.ele_cache.prev().attr('id');if(!M.isEmpty(id)){this.smart_project_idstr=this.smart_project_idstr+id+',';}
this.ele_cache.parent('li').remove();this.ele_cache='';this._hide_delbtn();M.closeMessage();},_hide_delbtn:function(){var smartprojectlist=this.context.hangacountpop.find('div[tag=smartprojectlist]');var len=smartprojectlist.children('ul').children('li').length;if(len==1){smartprojectlist.find('span[tag=del]').hide();}},project_save:function(ele){var projectname=this.context.hangacountpop.find('input[name=projectname]').val().trim();var projectid=this.context.hangacountpop.find('input[name=projectname]').attr('id');var li_ptn=this.context.hangacountpop.find('div[tag=smartprojectlist]').children('ul').children('li');if(M.isEmpty(projectname)){M.error('项目名称不能为空');return false;}
var data={'projectid':projectid,'projectname':projectname};var index=0;li_ptn.each(function(){var input=li_ptn.eq(index).find('input[name=typename]');var typename=input.val().trim();var id=input.attr("id");if(!M.isEmpty(typename)){data["typename"+index]=typename;data["id"+index]=id;index++;}});if(index<1){this.smart_project_idstr='';M.error('请至少添加一个小项');return false;}
data['length']=index;data['delidstr']=this.smart_project_idstr;ele.attr('tag','nosave');M._getjson('/Advanced/acountprojectsave',data,this.project_callback.toEventHandler(this));},project_callback:function(d){if(d.status=='success'){var data=d.data;if(data.act=='add'){var ul_ptn=this.context.hangacount.children('div').children('ul[tag=list]');ul_ptn.append($.tmpl(this.tpl_consumetype,{'id':data.id,'name':data.name}));}else{this.context.hangacount.find('li[id='+data.id+']').children('label').html(data.name);}
M.success('保存成功');M.ClosePopup();}else{M.error(d.msg);}
this._hide_delbtn();this.context.hangacountpop.children('div').children('a[tag=nosave]').attr('tag','save');this.smart_project_idstr='';},showcashierbox_click:function(){M.Popup(this.context.cashierdetailBox,{"hideclass":"modal fade","showclass":"modal fade in"});},innlist_change:function(){var innid=this.context.innlist.val();this.innid=innid;M._getjson("/Advanced/getCashier",{"cinnid":innid},this.innlist_finished.toEventHandler(this));},innlist_finished:function(d){M.emptyVal(this.context.mobilelist.children("li[class=addnew]").children('input[class=tname]'));var account=d.account;var mobilelist=d.mobile;if(!M.isEmpty(account.alipay)){this.context.paycardform.find("input[name=paycard]").val(account.alipay).attr("disabled","disabled");}else{this.context.paycardform.find("input[name=paycard]").val("").removeAttr("disabled");}
if(!M.isEmpty(account.alipayname)){this.context.paycardform.find("input[name=alipayname]").val(account.alipayname).attr("disabled","disabled");}else{this.context.paycardform.find("input[name=alipayname]").val("").removeAttr("disabled");}
if(!M.isEmpty(account.tenpay)){this.context.paycardform.find("input[name=tenpay]").val(account.tenpay).attr("disabled","disabled");}else{this.context.paycardform.find("input[name=tenpay]").val("").removeAttr("disabled");}
if(!M.isEmpty(account.tenpayname)){this.context.paycardform.find("input[name=tenpayname]").val(account.tenpayname).attr("disabled","disabled");}else{this.context.paycardform.find("input[name=tenpayname]").val("").removeAttr("disabled");}
if(!M.isEmpty(account.alipay)&&!M.isEmpty(account.alipayname)&&!M.isEmpty(account.tenpay)&&!M.isEmpty(account.tenpayname)){this.context.paycardform.find("dl[tag=save_btn]").hide();}else{this.context.paycardform.find("dl[tag=save_btn]").show();}
var li="";if(!M.isEmpty(mobilelist)){for(var i=0;i<mobilelist.length;i++){var obj=mobilelist[i];li+="<li mid='"+obj.id+"'><label>"+obj.mobile+"</label><a href='#?' title='删除该手机' class='delete' tag='del'></a></li>";}
this.context.mobilelist.children("li[class!=addnew]").remove();this.context.mobilelist.children("li[class=addnew]").before(li);if(mobilelist.length==3){this.context.mobilelist.children("li[class=addnew]").hide();}else{this.context.mobilelist.children("li[class=addnew]").show();}}else{this.context.mobilelist.children("li[class!=addnew]").remove();this.context.mobilelist.children("li[class=addnew]").show();}},addnewpaytype:function(e){var ele=M.EventEle(e);var t=ele.attr("tag");if(t=='addnew'){this.addnew(e);}},paytypelist_click:function(e){var ele=M.EventEle(e);var t=ele.attr("tag");if(t=='del'){this.delpaytype(ele);}},addnew:function(e){var payname=M.getVal(this.context.paytypename);if(M.isEmpty(payname)){alert('支付方式不能为空');return;}
var length=M.getstrlength(payname);if(length>16){alert("支付方式不能超过16个字符，当前已输入"+length+"个字符");return false;}
M._getjson("/Advanced/addPayMethod",{"payname":payname},this.addnew_finished.toEventHandler(this));},addnew_finished:function(d){if(d.status=="success"){var paytypecode=d.paytypecode;var id=d.id;var paytyppname=d.paytyppname;var channel_tpl='<li cid="${id}" paytypecode="${paytypecode}"><label>${paytyppname}</label><a tag="del" href="#?" title="删除该支付方式" class="delete"></a></li>';var tpl=$.tmpl(channel_tpl,{"id":id,"paytyppname":paytyppname,"paytypecode":paytypecode});this.context.paytypelist.append(tpl);M.emptyVal(this.context.paytypename);}
else{if(!M.isEmpty(d.msg)){alert(d.msg);}}},delpaytype:function(ele){var res=confirm("删除支付方式，有可能会引起您房费流水统计出错，确认删除吗？");if(!res){return;}
var id=ele.parent("li").attr("cid");var code=ele.parent("li").attr("paytypecode");if(M.isEmpty(id)){return;}
M._getjson("/Advanced/deletePayMethod",{"id":id,"code":code},this.delpaytype_finished.toEventHandler(this));},delpaytype_finished:function(d){if(d.status=="success"){var id=d.id;this.context.paytypelist.find("li[cid="+id+"]").remove();}
else{if(!M.isEmpty(d.msg)){alert(d.msg);}}},editPop:function(e){var ele=M.EventEle(e);var t=ele.attr("tag");if(t=='incomeitem'){this.incomeBoxShow();}
if(t=='payitem'){this.payBoxShow();}
if(t=="addincomeitem"){this.addincome();}
if(t=="addpayitem"){this.addpay();}
if(t=="incomedelete"){this.delincomeitem(ele);}
if(t=="paydelete"){this.delpayitem(ele);}
if(t=="incomeedit"){this.editincomeitem(ele);}
if(t=="payedit"){this.editpayitem(ele);}
if(t=="saveincome"){this.saveincome(ele);}
if(t=="savepay"){this.savepay(ele);}},incomeBoxShow:function(){this.context.editPop.find("ul[class=nav-tabs]").children("li:first").attr("class","active");this.context.editPop.find("ul[class=nav-tabs]").children().eq(1).attr("class","");this.context.paytypeitem.css("display","none");this.context.incometypeitem.css("display","block");},payBoxShow:function(){this.context.editPop.find("ul[class=nav-tabs]").children("li:first").attr("class","");this.context.editPop.find("ul[class=nav-tabs]").children().eq(1).attr("class","active");this.context.incometypeitem.css("display","none");this.context.paytypeitem.css("display","block");},addincome:function(){var incomeitem=M.getVal(this.context.add_incomeitem);var type=this.context.add_incomeitem.attr("itemtype");if(M.isEmpty(incomeitem)){alert("请输入新增项目名称");return;}
if(/.*[\u4e00-\u9fa5]+.*$/.test(incomeitem)){var length=incomeitem.length;if(length>6){alert("中文名称不能超过6个字");return false;}}
if(/.*[a-z]+.*$/.test(incomeitem)){var length=incomeitem.length;if(length>12){alert("英文名称不能超过12个字符");return false;}}
M.emptyVal(this.context.add_incomeitem);M._getjson("/Advanced/addUserWaterType",{"typename":incomeitem,"type":type},this.addincomeitem_finished.toEventHandler(this));},addincomeitem_finished:function(e){if(e.status=="success"){var data=e.data;var id=data.typeid;var html='<li id="'+data.typeid+'"><label>'+data.typename+'</label><a href="javascript:;" tag="incomeedit" title="修改" class="edit">修改</a><a href="javascript:;"  tag="incomedelete" title="删除" class="delete"></a></li>';this.context.incometypeitem.children("ul[tag=sort]").append(html);M.emptyVal(this.context.add_incomeitem);this.context.add_incomeitem.next().focus();}else{alert(e.msg);}},addpay:function(){var payitem=M.getVal(this.context.add_payitem);var type=this.context.add_payitem.attr("itemtype");if(M.isEmpty(payitem)){alert("请输入新增项目名称");return;}
M.emptyVal(this.context.add_payitem);M._getjson("/Advanced/addUserPayType",{"typename":payitem,"type":type},this.addpayitem_finished.toEventHandler(this));},addpayitem_finished:function(e){if(e.status=="success"){var data=e.data;var id=data.typeid;var html='<li id="'+data.typeid+'"><label>'+data.typename+'</label><a href="javascript:;"  tag="payedit" title="修改" class="edit">修改</a><a href="javascript:;"  tag="paydelete" title="删除" class="delete"></a></li>';this.context.paytypeitem.children("ul[tag=sort]").append(html);M.emptyVal(this.context.add_payitem);this.context.add_payitem.next().focus();}else{alert(e.msg);}},delincomeitem:function(ele){var res=confirm("确认删除吗");if(!res){return;}
var id=ele.parents("li").attr("id");if(M.isEmpty(id)){return;}
M._getjson("/Advanced/deleteWaterType",{"id":id},this.delincomeitem_finished.toEventHandler(this));},delincomeitem_finished:function(d){if(d.status=="success"){var olddata=d.olddata;var id=olddata.id;this.context.incometypeitem.children("ul").find("li[id="+id+"]").remove();this.context.incometypelist.children("ul").find("li[id="+id+"]").remove();var list=this.context.incometypeitem.children("ul[tag=sort]").children("li");this.setlistindex(list);}else{alert(d.msg);}},delpayitem:function(ele){var res=confirm("确认删除吗");if(!res){return;}
var id=ele.parents("li").attr("id");if(M.isEmpty(id)){return;}
M._getjson("/Advanced/deleteWaterType",{"id":id},this.delpayitem_finished.toEventHandler(this));},delpayitem_finished:function(d){if(d.status=="success"){var olddata=d.olddata;var id=olddata.id;this.context.paytypeitem.children("ul").find("li[id="+id+"]").remove();this.context.paytypelist.children("ul").find("li[id="+id+"]").remove();var list=this.context.paytypeitem.children("ul[tag=sort]").children("li");this.setlistindex(list);}else{alert(d.msg);}},editincomeitem:function(ele){var id=ele.parents("li").attr("id");var obj=this.context.incometypeitem.children("ul").find("li[id="+id+"]").children("label");var text=obj.text();var input=$("<input class='txt' type='text' value='"+text+"'>");obj.html(input);this.context.incometypeitem.children("ul").find("li[id="+id+"]").find("a[class=edit]").html("确认");this.context.incometypeitem.children("ul").find("li[id="+id+"]").find("a[class=edit]").attr("tag","saveincome");},saveincome:function(ele){var id=ele.parents("li").attr("id");var obj=this.context.incometypeitem.children("ul").find("li[id="+id+"]").children("label").children();var name=obj.val();var itemtype=1;if(/.*[\u4e00-\u9fa5]+.*$/.test(name)){var length=name.length;if(length>6){alert("中文名称不能超过6个字");return false;}}
if(/.*[a-z]+.*$/.test(name)){var length=name.length;if(length>12){alert("英文名称不能超过12个字符");return false;}}
M._getjson("/Advanced/saveIncome",{"id":id,"name":name,"type":itemtype},this.saveincome_finished.toEventHandler(this));},saveincome_finished:function(d){if(d.status=="success"){var olddata=d.olddata;var id=olddata.id;var name=d.newname;this.context.incometypeitem.children("ul").find("li[id="+id+"]").find("a[class=edit]").html("修改");this.context.incometypeitem.children("ul").find("li[id="+id+"]").children("label").html(name);this.context.incometypeitem.children("ul").find("li[id="+id+"]").find("a[class=edit]").attr("tag","incomeedit");this.context.incometypelist.children("ul").find("li[id="+id+"]").children("a").html(name);}else{alert(d.msg);}},editpayitem:function(ele){var id=ele.parents("li").attr("id");var obj=this.context.paytypeitem.children("ul").find("li[id="+id+"]").children("label");var text=obj.text();var input=$("<input class='txt' type='text' value='"+text+"'>");obj.html(input);this.context.paytypeitem.children("ul").find("li[id="+id+"]").find("a[class=edit]").html("确认");this.context.paytypeitem.children("ul").find("li[id="+id+"]").find("a[class=edit]").attr("tag","savepay");},savepay:function(ele){var id=ele.parents("li").attr("id");var objs=this.context.paytypeitem.children("ul").find("li[id="+id+"]").children("label").children();var name=objs.val();var itemtype=2;if(/.*[\u4e00-\u9fa5]+.*$/.test(name)){var length=name.length;if(length>6){alert("中文名称不能超过6个字");return false;}}
if(/.*[a-z]+.*$/.test(name)){var length=name.length;if(length>12){alert("英文名称不能超过12个字符");return false;}}
M._getjson("/Advanced/saveIncome",{"id":id,"name":name,"type":itemtype},this.savepay_finished.toEventHandler(this));},savepay_finished:function(d){if(d.status=="success"){var olddata=d.olddata;var id=olddata.id;var name=d.newname;this.context.paytypeitem.children("ul").find("li[id="+id+"]").find("a[class=edit]").html("修改");this.context.paytypeitem.children("ul").find("li[id="+id+"]").children("label").html(name);this.context.paytypeitem.children("ul").find("li[id="+id+"]").find("a[class=edit]").attr("tag","payedit");this.context.paytypelist.children("ul").find("li[id="+id+"]").children("a").html(name);}else{alert(d.msg);}},editpaycard_click:function(){var innid=this.context.innlist.val();var paycard=this.context.paycardform.children().find("input[name=paycard]").val();var alipayname=this.context.paycardform.children().find("input[name=alipayname]").val();var tenpay=this.context.paycardform.children().find("input[name=tenpay]").val();var tenpayname=this.context.paycardform.children().find("input[name=tenpayname]").val();M._getjson("/Advanced/editPayCard",{"innid":innid,"paycard":paycard,"alipayname":alipayname,"tenpay":tenpay,"tenpayname":tenpayname},this.editpaycard_finished.toEventHandler(this));},editpaycard_finished:function(d){if(d.status=='success'){var alipay=d.alipay;var alipayname=d.alipayname;var tenpay=d.tenpay;var tenpayname=d.tenpayname;if(!M.isEmpty(alipay)){this.context.paycardform.children().find("input[name=paycard]").attr("disabled",true);}
if(!M.isEmpty(alipayname)){this.context.paycardform.children().find("input[name=alipayname]").attr("disabled",true);}
if(!M.isEmpty(tenpay)){this.context.paycardform.children().find("input[name=tenpay]").attr("disabled",true);}
if(!M.isEmpty(tenpayname)){this.context.paycardform.children().find("input[name=tenpayname]").attr("disabled",true);}
if(!M.isEmpty(alipay)&&!M.isEmpty(alipayname)&&!M.isEmpty(tenpay)&&!M.isEmpty(tenpayname)){this.context.paycardform.find("dl[tag=save_btn]").hide();}
M.success("保存成功");}else{if(M.isEmpty(d.msg)){M.error("网络错误");}else{M.error(d.msg);}}},mobilelist_click:function(e){var ele=M.EventEle(e);var t=ele.attr("tag");if(t=='add'){this.addnewmobile(e);}
if(t=='del'){this.delmobile(ele);}},addnewmobile:function(e){var innid=this.context.innlist.val();var size=this.context.mobilelist.children("li").size();var mobile=M.getVal(this.context.mobilelist.children("li").children("input[id=mobilenum]"));if(!M.isEmpty(mobile)){var re=/^(13|14|15|18|17)[0-9]{9}$/;if(!re.test(mobile)){alert("请输入正确的手机号");return false;}}else{alert('手机号不能为空');return;}
if(size<4){M._getjson("/Advanced/setMobile",{"innid":innid,"mobile":mobile},this.addnewmobile_finished.toEventHandler(this));}else{alert('最多可设置3个手机号码');}},addnewmobile_finished:function(d){if(d.status=="success"){var mid=d.id;var mobile=d.mobile;tpl=$.tmpl(this.mobile_tpl,{"mid":mid,"mobile":mobile});this.context.mobilelist.children("li[class=addnew]").before(tpl);var size=this.context.mobilelist.children("li").size();if(size==4){this.context.mobilelist.children("li[class=addnew]").hide();}}else{M.error(d.msg);}
M.emptyVal(this.context.mobilelist.children("li[class=addnew]").children("input[class=tname]"));},delmobile:function(ele){var res=confirm("确认删除吗？");if(!res){return;}
var id=ele.parent("li").attr("mid");if(M.isEmpty(id)){return;}
M._getjson("/Advanced/deleteMobile",{"id":id},this.delmobile_finished.toEventHandler(this));},delmobile_finished:function(d){if(d.status=="success"){var mid=d.id;this.context.mobilelist.find("li[mid="+mid+"]").remove();var size=this.context.mobilelist.children("li").size();if(size<4){this.context.mobilelist.children("li[class=addnew]").show();this.context.mobilelist.children("li[class=addnew]").children("input[class=tname]").val("");}}else{M.error(d.msg);}},refreshCityData:function(){this.context.settlementBox.find("input[tag=chooseCity]").val("");this.context.settlementBox.find("input[tag=chooseCity]").removeAttr("CityTag");this.context.cityBox.children("ul").children("li").children("div").empty();provinceTag=this.context.settlementBox.find("input[tag=chooseProvince]").attr('provinceTag');if(provinceTag){M._getjson("/Advanced/getcity",{"provinceTag":provinceTag},this.refreshCity_finished.toEventHandler(this));}},refreshSubBankData:function(){this.delSubBankInfo();bankCode=this.context.settlementBox.find("input[tag=chooseBank]").attr('bankCode');cityTag=this.context.settlementBox.find("input[tag=chooseCity]").attr('cityTag');if(bankCode&&cityTag){M._getjson("/Advanced/getSubBank",{"bankCode":bankCode,"cityTag":cityTag},this.refreshSubBank_finished.toEventHandler(this));}},delSubBankInfo:function(){this.context.settlementBox.find("input[tag=chooseSubBank]").val("");this.context.settlementBox.find("input[tag=chooseSubBank]").removeAttr("branchTag");this.context.subBankBox.children("div").children("ul").empty();this.subBankInfo=[];this.context.subBankBox.children("div").children("ul").html('<li class="error">对不起，找不到该支行信息</li>');},refreshCity_finished:function(d){if(d.status=='success'){html="";cityList=d.d;for(var cityIndex in cityList){cityName=cityList[cityIndex]['cityName'];cityTag=cityList[cityIndex]['cityTag'];html+=' <a href="javascript:;" tag="city" cityTag="'+cityTag+'" title="'+cityName+'">'+cityName+'</a>';}
this.context.cityBox.children("ul").children("li").children("div").html(html);}else{}},refreshSubBank_finished:function(d){if(d.status=='success'){this.subBankInfo=d.d;this.renderSubBanch(this.subBankInfo);}else{}},chooseSubBankList_handler:function(e){var isError=this.context.subBankBox.children("div").children("ul").children('li[class*=error]');if(isError.length)return;var currentOnEle=this.context.subBankBox.children("div").children("ul").children('li[class*=on]');var currentScrollTop=this.context.subBankBox.scrollTop();var stepHeight=this.context.subBankBox.children("div").children("ul").children('li').outerHeight();switch(e.which){case 38:{var innerHeight=this.context.subBankBox.children("div").children("ul").innerHeight();if(!currentOnEle.length){this.context.subBankBox.children("div").children("ul").children("li").last().addClass('on');this.context.subBankBox.scrollTop(innerHeight-stepHeight);}else{if(currentOnEle.prev()){currentOnEle.removeClass('on');currentOnEle.prev().addClass("on");this.context.subBankBox.scrollTop(currentScrollTop-stepHeight);}else{this.context.subBankBox.children("div").children("ul").children("li").last().addClass('on');this.context.subBankBox.scrollTop(innerHeight-stepHeight);}}}
break;case 40:{if(!currentOnEle.length){this.context.subBankBox.children("div").children("ul").children("li").first().addClass('on');this.context.subBankBox.scrollTop(0);}else{if(currentOnEle.next()){currentOnEle.removeClass('on');currentOnEle.next().addClass("on");this.context.subBankBox.scrollTop(currentScrollTop+stepHeight);}else{this.context.subBankBox.children("div").children("ul").children("li").first().addClass('on');this.context.subBankBox.scrollTop(0);}}}
break;case 13:{if(currentOnEle.length){currentOnEle.trigger("click");}}
break;default:break;}},chooseSubBank_change:function(e){if(e.which==38||e.which==40||e.which==13)return;var ele=M.EventEle(e);var keyword=ele.val();var keywordArr=keyword.split(' ');var keywordNoEmptyArr=[];for(var keywordindex in keywordArr){if(keywordArr[keywordindex]){keywordNoEmptyArr.push(keywordArr[keywordindex]);}}
keywords=keywordNoEmptyArr.join('|');var needsubBankInfoList=[];if(keywords){for(var index in this.subBankInfo){var subBank=this.subBankInfo[index]['branchName'];var subBankTag=this.subBankInfo[index]['subBranchTag'];var haveAllKeyword=true;for(var keywordIndex in keywordNoEmptyArr){if(subBank.indexOf(keywordNoEmptyArr[keywordIndex])<0){haveAllKeyword=false;}}
if(haveAllKeyword){var subBankAfter=subBank.replace(new RegExp(keywords,'ig'),"<b>$&</b>");var subBanktemp={"branchName":subBankAfter,"subBranchTag":subBankTag,"subBranchTitle":subBank};needsubBankInfoList.push(subBanktemp);}}}else{needsubBankInfoList=this.subBankInfo;}
this.renderSubBanch(needsubBankInfoList);},renderSubBanch:function(subBankList){this.context.subBankBox.children("div").children("ul").empty();html="";for(var subBankIndex in subBankList){branchName=subBankList[subBankIndex]['branchName'];branchTag=subBankList[subBankIndex]['subBranchTag'];branchTitle=branchName;if(subBankList[subBankIndex]['subBranchTitle']){branchTitle=subBankList[subBankIndex]['subBranchTitle'];}
html+=' <li title="'+branchTitle+'" tag="subBank" branchTag="'+branchTag+'">'+branchName+'</li>';}
this.context.subBankBox.children("div").children("ul").html(html);if(!html){this.context.subBankBox.children("div").children("ul").empty();this.context.subBankBox.children("div").children("ul").html('<li class="error">对不起，找不到该支行信息</li>');}}});var page=null;M.ready(function(){page=new M.Page.set_advanced();return page;});