M.Page.OtaYZGPage=M.createClass();M.extend(M.Page.OtaYZGPage.prototype,{context:{},cache_ele:'',getinnid:0,channelprice:{},pricemonth:6,cache_orgprice:0,timer:'',signed:0,batchpricelist:{},unselectedrtid:0,rtid:0,dx_model:1,tpl_loading:'<div class="tc" style="padding: 78px 0px;" tag="loading"><i class="loading32"></i></div>',tpl_roomtype:'<div class="item" rtid="${rtid}" pid="${pid}">'
+'<div class="name">${roomtypename}</div>'
+'<div class="wrapper">'
+'<input type="text" value="" style="width:100px; margin-right:0;">'
+'</div>'
+'</div>',weektext:{"1":"一","2":"二","3":"三","4":"四","5":"五","6":"六","0":"日"},fromdate:'',enddate:'',commission:1,betauserstatus:0,roomtypepricetarget:{},dx_model_text:{'price':{'1':'底价','2':'价格'},'defaultprice':{'1':'底价','2':'价'}},betauserstatus_text:{'price':{'2':'底价','1':'价格'},'defaultprice':{'2':'底价','1':'价'}},init:function(){this.initDOM();this.initEvent();this.initchannelpricecontent();this.initData();this.initpicker();},initDOM:function(){this.context.setChannelPrice=$("#setChannelPrice");this.context.channellist=$("#channellist");this.context.channelpriceform=$("#channelpriceform");this.context.channelprice=$("#channelprice");this.context.channelmonthtab=$("#channelmonthtab");this.context.inputchannelprice=$("#inputchannelprice");this.context.newchannelprice=$("#newchannelprice");this.context.setchannelprice=$("#setchannelprice");this.context.applyzg=$("#applyzg");this.context.innnlist=$("#innnlist");this.context.datainfo=$("#datainfo");this.context.batchPricePop=$("#batchPricePop");this.context.maincontent=$("#maincontent");this.commission=this.context.maincontent.attr('commission');this.dx_model=this.context.maincontent.attr('dxm');this.betauserstatus=this.context.maincontent.attr('betauserstatus');var now=M.getTime();var fromdate=new Date(now.getFullYear(),now.getMonth(),now.getDate());var enddate=new Date(fromdate.getFullYear(),fromdate.getMonth(),fromdate.getDate()+13);this.fromdate=M.timeformat(fromdate);this.enddate=M.timeformat(enddate);this.context.pickerdate=$("#pickerdate");this.context.pickerarea=$("#pickerarea");this.context.roomtypelist=$("#roomtypelist");this.context.page=$("#page");this.context.daterange=$("#daterange");this.context.selecttime=$("#selecttime");var maxdate=new Date(now.getFullYear(),now.getMonth()+6,now.getDate());var mindate=M.timeformat(now);var datestr=M.timeformat(maxdate);this.context.selecttime.datepicker({onSelect:this.onselect.toEventHandler(this),'minDate':mindate,'maxDate':datestr});this.context.setdefaultpricefrom=$("#setdefaultpricefrom");this.context.batchsetprice=$("#batchsetprice");this.context.setcanclerule=$("#setcancelrule");this.context.cancleruleform=$("#cancleruleform");this.context.salecanclerule=$("#salecanclerule");this.context.flashsaleform=$("#flashsaleform");this.context.setflashsale=$("#setflashsale");this.context.batchsefaultpriceform=$("#batchsefaultpriceform");this.context.batchsetdefaultprice=$("#batchsetdefaultprice");this.context.header=$("#header");this.context.fixhead=$(".roomthumb .date");this.context.scroll=$('.main-content');this.context.ruletip=$('#ruletip');this.context.setroomtypedatepricefrom=$('#setroomtypedatepricefrom');},initEvent:function(){this.context.setchannelprice.bind("click",this.setchannelprice_click.toEventHandler(this));this.context.newchannelprice.bind('keyup',this.newchannelprice_keyup.toEventHandler(this));this.context.channelpriceform.bind("click",this.channelpriceform_click.toEventHandler(this));this.context.inputchannelprice.bind("keyup",this.inputchannelprice_change.toEventHandler(this));this.context.channelmonthtab.bind("click",this.channlmonthtab_click.toEventHandler(this));this.context.channellist.bind("click",this.channellist_click.toEventHandler(this));this.context.batchPricePop.bind("click",this.batchPricePop_click.toEventHandler(this));this.context.page.bind("click",this.page_click.toEventHandler(this));this.context.daterange.bind("click",this.daterange_click.toEventHandler(this));this.context.maincontent.bind("click",this.main_click.toEventHandler(this));this.context.pickerarea.bind("click",this.pickerareas_click.toEventHandler(this));this.context.batchsetprice.bind("click",this.batchsetprice_click.toEventHandler(this));this.context.setcanclerule.bind("click",this.setcanclerule_click.toEventHandler(this));this.context.salecanclerule.bind("click",this.salecanclerule_click.toEventHandler(this));this.context.setflashsale.bind("click",this.setflashsale_click.toEventHandler(this));this.context.setdefaultpricefrom.bind("click",this.setdefaultpricefrom_click.toEventHandler(this));this.context.cancleruleform.find('select[name=rulelist]').bind("change",this.rulelist_change.toEventHandler(this));this.context.flashsaleform.find('input[name=discount]').bind("input propertychange",this.flashsaleform_moneychange.toEventHandler(this));this.context.setroomtypedatepricefrom.find('input[name=price]').bind("input propertychange",this.dateprice_change.toEventHandler(this));this.context.setdefaultpricefrom.find('input[name=price]').bind("input propertychange",this.defaultprice_change.toEventHandler(this));this.context.flashsaleform.bind("click",this.flashsaleform_click.toEventHandler(this));this.context.batchsefaultpriceform.bind("click",this.batchsefaultpriceform_click.toEventHandler(this));this.context.batchsetdefaultprice.bind("click",this.batchsetdefaultprice_click.toEventHandler(this));this.context.setroomtypedatepricefrom.bind("click",this.setroomtypedatepricefrom_click.toEventHandler(this));this.context.scroll.scroll(this.win_resize.toEventHandler(this));this.context.pickerarea.scroll(this.pickerarea_scroll.toEventHandler(this));$(window).resize(this.win_resize.toEventHandler(this));},dateprice_change:function(e){var ele=M.EventEle(e);var baseprice=ele.val();if(M.isEmpty(baseprice)){this.context.setroomtypedatepricefrom.find('strong[tag=baseprice]').html('');return;}
var reg=/^[0-9]*$/;if(M.math_isnumber(baseprice)===false)
{return;}
var price=M.math_format(baseprice*this.commission);ele.attr('price',price);if(this.betauserstatus==1){this.context.setroomtypedatepricefrom.find('strong[tag=baseprice]').html(price).parent('span').show();}},setroomtypedatepricefrom_click:function(e){var ele=M.EventEle(e);var t=ele.attr('tag');switch(t){case'saveprice':this.savepdaterice();break;}},canclerulelist_change:function(){var value=this.context.rulelist.val();if(value==3){this.context.ruletip.show();}else{this.context.ruletip.hide();}},pickerarea_scroll:function(){var top=this.context.pickerarea.scrollTop();var left=this.context.pickerarea.scrollLeft();this.context.pickerdate.scrollLeft(left);this.context.pickerdate.scrollTop(top);},win_resize:function(){this.context.fixhead.removeClass('posfixed');var height=this.context.header.outerHeight();var top=this.context.pickerdate.offset().top;if(top<=height)
{this.context.fixhead.addClass('posfixed');}
else
{this.context.fixhead.removeClass('posfixed');}
var width=70*14-13;var pickerarea_width=this.context.pickerarea.width();this.context.pickerdate.width(this.context.pickerarea.width());if(pickerarea_width<=(width+25+6)){this.context.pickerarea.css("overflow-x","scroll");this.context.roomtypelist.parents('div.leftbox').css("overflow-x","scroll");var w=this.context.pickerarea.width()/14;this.context.pickerarea.find("td.canselected").width(w);this.context.pickerdate.find('th').width(w);}else{this.context.pickerarea.css("overflow-x","hidden");this.context.roomtypelist.parents('div.leftbox').css("overflow-x","hidden");var width=this.context.pickerarea.find('td.canselected:first').width();this.context.pickerdate.find('th').width(width);}},batchsetdefaultprice_click:function(){M._getjson('/Ota/getdxroomtypelist',{'innid':this._getinnid()},this.batchsetdefaultprice_click_finished.toEventHandler(this));},batchsetdefaultprice_click_finished:function(d){if(d.status=="success"){var rtlist=d.data;var html='';for(var i in rtlist){var item=rtlist[i];var price='';var baseprice='';if(!M.isEmpty(item.price)){baseprice=item.price;price=M.math_division(item.price,this.commission);}
html+='<div class="item" tag="rt" rtid="'+item.id+'" pid="'+item.planid+'">';html+='<div class="name">'+item.roomtypename+'</div>';html+='<div class="wrapper"><input type="text" value="'+price+'" name="price" style="width:100px; margin-right:0;"></div>';if(this.betauserstatus==1){html+='<div class="wrapper">结算价：<strong class="red" tag="price">'+baseprice+'</strong></div>';}
html+='</div>';}
this.context.batchsefaultpriceform.find("li[tag=roomtypelist]").children('div').html(html);if(this.betauserstatus==1){this.context.batchsefaultpriceform.find("span[tag=commissiontip]").html('佣金率：'+M.math_min(1,this.commission)*100+'%');}else{this.context.batchsefaultpriceform.find("span[tag=commissiontip]").html('');}
this.context.batchsefaultpriceform.find('input[name=price]').bind("input propertychange",this.batchdefaultprice_change.toEventHandler(this));M.Popup(this.context.batchsefaultpriceform,{"hideclass":"modal pricebatch fade","showclass":"modal pricebatch fade in"});}else{alert(d.msg);}},batchdefaultprice_change:function(e){var ele=M.EventEle(e);var baseprice=ele.val();if(M.isEmpty(baseprice)){ele.parents('div.item').find('strong[tag=price]').html('');return;}
if(M.math_isnumber(baseprice)===false)
{return;}
var price=M.math_format(baseprice*this.commission);ele.attr('price',price);ele.parents('div.item').find('strong[tag=price]').html(price);},batchsefaultpriceform_click:function(e){var ele=M.EventEle(e);var t=ele.attr('tag');switch(t){case'saveprice':this.batchsavedefaultprice();break;}},batchsavedefaultprice:function(){var tpllist=this.context.batchsefaultpriceform.find("li[tag=roomtypelist]").find('div[tag=rt]');var rtlist=[];tpllist.each(function(){var tpl=$(this);var rtid=tpl.attr('rtid');var planid=tpl.attr('pid');if(M.isEmpty(planid)){planid=0;}
var price=tpl.find('input[name=price]').val();if(!M.isEmpty(price)||price===0){var str=rtid+'_'+planid+'_'+price;rtlist.push(str);}});if(rtlist.length==0){alert('请先设置默认价');return;}
var innid=this._getinnid();M._getjson('/Ota/batchsetdxdefaultprice',{'innid':innid,'rtliststr':rtlist.toString()},this.batchsetdxdefaultprice_finished.toEventHandler(this),'',true);},batchsetdxdefaultprice_finished:function(d){if(d.status=="success"){M.success('保存成功');M.CloseLast();var planidlist=d.planidlist;for(var i in planidlist){var item=planidlist[i];this._setrtdata(item);}
this.getpricestatus();}else{alert(d.msg);}},setflashsale_click:function(){M._getjson('/Ota/getdxroomtypelist',{'innid':this._getinnid(),'sort':1},this.getdxroomtypelist_finished.toEventHandler(this),'post',true);},getdxroomtypelist_finished:function(d){if(d.status=="success"){var rtlist=d.data;var today=M.timeformat(M.getTime());var html='',mark=0,html_list='';for(var i in rtlist){var item=rtlist[i];if(item['dxstatus']==1){var start_date=M.timeformat(M.strtotime(item.starttime));var end_date=M.timeformat(M.strtotime(item.endtime));var html_statusname='<a href="#？" class="red" tag="del">删除</a>';var class_style='';if(today>end_date||item.starttime=='0000-00-00 00:00:00'){html+='<option value="'+item.roomtypeid+'">'+item.roomtypename+'</option>';html_statusname='<span>已过期</span>';class_style='style="color:#c1c1c1;" ';}else{mark=1;html+='<option value="'+item.roomtypeid+'" disabled style="display:none;">'+item.roomtypename+'</option>';}
if(item.discount>0){html_list+='<tr tag="list" rtid="'+item.roomtypeid+'" '+class_style+'><td>'+item.roomtypename+'</td><td>'+item.discount+'元</td><td>'+start_date+'至'+end_date+'</td><td>'+item.starthour+':00</td><td>'+html_statusname+'</td></tr>';}}}
this.context.flashsaleform.children().hide();var div_salesadd=this.context.flashsaleform.children('div[id=sales-add]');div_salesadd.find('select[name=rtlist]').html(html);if(mark==1){var div_saleslist=this.context.flashsaleform.children('div[id=sales-list]');div_saleslist.find('table').children('tbody').children('tr[tag=list]').remove();div_saleslist.find('table').children('tbody').append(html_list);M.Popup(div_saleslist,{"hideclass":"modal larger-greater fade","showclass":"modal larger-greater fade in"});}else{this.addTplPop();}}else{alert(d.msg);}},flashsaleform_click:function(e){var ele=M.EventEle(e);var t=ele.attr('tag');switch(t){case'savediscount':this.savediscount();break;case'del':this.deldiscount(ele);break;case'add':this.addTplPop();break;}},addTplPop:function(){M.ClosePopup();var div_salesadd=this.context.flashsaleform.children('div[id=sales-add]');div_salesadd.find('input[name=discount]').val('');div_salesadd.find('select[name=rtlist]').children('option[disabled!=disabled]').eq(0).attr('selected','selected');div_salesadd.find('select[name=onhour]').children().eq(0).attr('selected','selected');var ontime=M.getTime();var ondate=M.timeformat(ontime);if(!M.isEmpty(div_salesadd.find('input[name=fromdate]').attr('id'))){div_salesadd.find('input[name=fromdate]').val(ondate);div_salesadd.find('input[name=enddate]').val(ondate);}else{var maxdate=M.timeformat(new Date(ontime.getFullYear(),ontime.getMonth()+12,ontime.getDate()-1));div_salesadd.find('input[name=fromdate]').val(ondate).datepicker({'minDate':ondate,'maxDate':maxdate});div_salesadd.find('input[name=enddate]').val(ondate).datepicker({'minDate':ondate,'maxDate':maxdate});}
M.Popup(div_salesadd,{"hideclass":"modal view fade","showclass":"modal view fade in"});return true;},deldiscount:function(ele){var rtid=ele.parent().parent().attr('rtid');var innid=this._getinnid();if(!confirm('是否确认删除？')){return false;}
M._getjson('/Ota/yzgdxdelpromotion',{'innid':innid,'rtid':rtid},this.delpromotion_finished.toEventHandler(this),'post',true);},delpromotion_finished:function(d){if(d.status!='success'){alert(d.msg);return;}
var data=d.data;var rtid=d.req.rtid;var div_saleslist=this.context.flashsaleform.children('div[id=sales-list]');var div_salesadd=this.context.flashsaleform.children('div[id=sales-add]');div_saleslist.find('table').find('tr[tag=list][rtid='+rtid+']').remove();div_salesadd.find('select[name=rtlist]').children('option[value='+rtid+']').removeAttr('disabled').show();if(div_saleslist.find('table').find('tr[tag=list]').length<1){M.ClosePopup();}
var start_time=M.strtotime(data.starttime);var end_time=M.strtotime(data.endtime);var discount=data.discount;var starthour=data.starthour;var target=this.context.pickerarea.find('tr[rtid='+rtid+']');var this_fun=this;target.children('td').each(function(){var ondate=$(this).attr('time');var thistime=M.strtotime(ondate);if(end_time<thistime){return false;}
if(start_time>thistime){return true;}
$(this).children('div').children('i').remove();if($(this).attr('data-type')!=1){$(this).children('div').removeClass('iorange');}
$(this).children('div').attr("title","").removeAttr('discountmsg').tooltip("destroy");var is_discount=this_fun.isDiscount(ondate,discount,data.starttime,data.endtime,starthour);if(is_discount==1){var price=$(this).children('div').children('p[tag=price]').attr('p');var price=M.math_add(price,discount);$(this).children('div').children('p[tag=price]').attr('p',price).html('&yen;'+price);}});M.success('删除成功');},savediscount:function(){var money=this.context.flashsaleform.find('input[name=discount]').val();var fromdate=this.context.flashsaleform.find('input[name=fromdate]').val();var enddate=this.context.flashsaleform.find('input[name=enddate]').val();var onhour=this.context.flashsaleform.find('select[name=onhour]').val();var rtid=this.context.flashsaleform.find('select[name=rtlist]').val();if(M.isEmpty(money)||money<1){alert('价格直降至少大于0');return;}
var is_res=this._handlediscounttip(rtid,fromdate,money);if(!is_res){return false;}
var innid=this._getinnid();M._getjson('/Ota/yzgdxsavepromotion',{'innid':innid,'price':money,'fromdate':fromdate,'enddate':enddate,'rtid':rtid,'onhour':onhour},this.yzgdxsavepromotion_finished.toEventHandler(this),'post',true);},yzgdxsavepromotion_finished:function(d){if(d.status=="success"){M.success('保存成功');M.CloseLast();var data=d.data;var start_time=M.strtotime(data.starttime);var end_time=M.strtotime(data.endtime);var discount=data.discount;var starthour=data.starthour;var this_fun=this;var target=this.context.pickerarea.find('tr[rtid='+data.roomtypeid+']');target.children('td').each(function(){var thistime=M.strtotime($(this).attr('time'));if(end_time<thistime){return false;}
if(start_time>thistime){return true;}
var ondate=$(this).attr('time');var promotionstr='<i class="ico-flashsale"></i>';$(this).children('div').addClass('iorange').append(promotionstr);var msg=ondate+' 已设置促销, <br/>'+starthour+':00生效此价格立减 '+discount+'元';var is_discount=this_fun.isDiscount(ondate,discount,data.starttime,data.endtime,starthour);if(is_discount==1){msg=ondate+' 已设置促销, <br/>此价格已减 '+discount+'元';var price=$(this).children('div').children('p[tag=price]').attr('p');price=M.math_min(price,discount);$(this).children('div').children('p[tag=price]').attr('p',price).attr('bp',price).html('&yen;'+price);}
$(this).children('div').attr("title","").tooltip({position:{my:"left+15 top+20",at:"left bottom"},track:1,content:msg,show:{delay:100},hide:false});});M.czcstatistics('尾房特卖','尾房特卖保存',data.innid);}else{alert(d.msg)}},defaultprice_change:function(){var price=this.context.setdefaultpricefrom.find('input[name=price]').val();if(M.isEmpty(price)){this.context.setdefaultpricefrom.find('strong[tag=baseprice]').parent().hide();return;}
if(M.math_isnumber(price)===false)
{return;}
var baseprice=M.math_format(price*this.commission);this.context.setdefaultpricefrom.find('input[name=price]').attr('baseprice',baseprice);if(this.betauserstatus==1){this.context.setdefaultpricefrom.find('strong[tag=baseprice]').html(baseprice+'元').parent().show();}},setdefaultpricefrom_click:function(e){var ele=M.EventEle(e);var t=ele.attr('tag');switch(t){case'saveprice':this.savedefaultprice();break;}},savedefaultprice:function(){var rtid=this.context.setdefaultpricefrom.attr("rtid");var innid=this._getinnid();var price=this.context.setdefaultpricefrom.find('input[name=price]').val();var planid=this.context.roomtypelist.find('tr[tag=rt][rtid='+rtid+']').attr('planid');var data={"price":price,"roomtypeid":rtid,"innid":innid,"act":"setdefaultprice","planid":planid};M._getjson("/Ota/channelpricemanage",data,this.setplandefaultprice_finished.toEventHandler(this));},setplandefaultprice_finished:function(d){if(d.status=="success"){M.success('保存成功');M.CloseLast();var data=d.plan;data.planid=data.id;var html=this._showpickerprice(data);this._setrtdata(data);var target=this.context.pickerarea.find('tr[rtid='+data.roomtypeid+']');target.html(html);}else{alert(d.msg);}},salecanclerule_click:function(){var canclerule=this.context.cancleruleform.find('select[name=rulelist]').val();if(canclerule<0){alert('请选择取消规则');return false;}
M._getjson("/Ota/setdxcanclerule",{'canclerule':canclerule},this.setcanclerule_finished.toEventHandler(this),null,true);},setcanclerule_finished:function(d){if(d.status=="success"){alert('设置成功');M.CloseLast();}else{alert(d.msg);}},rulelist_change:function(){var value=this.context.cancleruleform.find('select[name=rulelist]').val();if(value==3){this.context.cancleruleform.find('div[tag=ruletip]').show();}else{this.context.cancleruleform.find('div[tag=ruletip]').hide();}},setcanclerule_click:function(){M._getjson('/Ota/getdxcanclerule',{},this.getdxcanclerule_finished.toEventHandler(this));},getdxcanclerule_finished:function(d){if(d.status=="success"){var data=d.data;this.context.cancleruleform.find('select[name=rulelist]').val(data.canclerule);if(data.canclerule==3){this.context.cancleruleform.find('div[tag=ruletip]').show();}else{this.context.cancleruleform.find('div[tag=ruletip]').hide();}
M.Popup(this.context.cancleruleform,{"hideclass":"modal view fade","showclass":"modal view fade in"});}},batchsetprice_click:function(){this.bathsetroomtypeprice('set');},pickerareas_click:function(e){},setdxdefaultprice:function(){var rtid=this.unselectedrtid;var innid=this._getinnid();M._getjson('/Ota/getdxroomtypedetail',{'innid':innid,'rtid':rtid},this.getdxroomtypedetail_finished.toEventHandler(this));},getdxroomtypedetail_finished:function(d){if(d.status=="success"){var data=d.data;this.context.setdefaultpricefrom.find('input[name=price]').val('');this.context.setdefaultpricefrom.find('strong[tag=baseprice]').html('').parent().hide();if(!M.isEmpty(data.roomtypechannel)){var html=this._showpickerprice(data.roomtypechannel);var target=this.context.pickerarea.find('tr[rtid='+data.id+']').html(html);}
this.context.setdefaultpricefrom.attr("rtid",data.id);this.context.setdefaultpricefrom.find('h4[tag=title]').html('设置默认价-'+data.roomtypename);if(this.betauserstatus==1){this.context.setdefaultpricefrom.find('h4[tag=title]').append('<span>佣金率：'+M.math_min(1,this.commission)*100+'%</span>');}
M.Popup(this.context.setdefaultpricefrom,{"hideclass":"modal sm fade","showclass":"modal sm fade in"});}else{alert(d.msg);}},main_click:function(e)
{var ele=M.EventEle(e);var t=ele.attr("tag");if(t=='range'||t=='year')
{return;}
var display=this.context.selecttime.css('display');if(display=='block')
{this.context.selecttime.hide();}},daterange_click:function(){var offset=this.context.daterange.offset();this.context.selecttime.css({'left':offset.left,'top':offset.top+40}).show().datepicker("setDate",this.fromdate);},onselect:function(date){var fromtime=M.strtotime(date);var fromdate=new Date(fromtime.getFullYear(),fromtime.getMonth(),fromtime.getDate());var enddate=new Date(fromtime.getFullYear(),fromtime.getMonth(),fromtime.getDate()+14);this.fromdate=M.timeformat(fromdate);this.enddate=M.timeformat(enddate);this.context.selecttime.hide();this.initpicker();},page_click:function(e){var ele=M.EventEle(e);var t=ele.attr('tag');switch(t){case'prev':this.prevrange();break;case'next':this.nextrange();break;}},nextrange:function(){var endtime=M.strtotime(this.enddate);var fromdate=new Date(endtime.getFullYear(),endtime.getMonth(),endtime.getDate()+1);var enddate=new Date(endtime.getFullYear(),endtime.getMonth(),endtime.getDate()+14);this.fromdate=M.timeformat(fromdate);this.enddate=M.timeformat(enddate);this.initpicker();},prevrange:function(){var today=M.timeformat(M.getTime());if(today>=this.fromdate){return false;}
var fromtime=M.strtotime(this.fromdate);var fromdate=new Date(fromtime.getFullYear(),fromtime.getMonth(),fromtime.getDate()-14);var enddate=new Date(fromtime.getFullYear(),fromtime.getMonth(),fromtime.getDate()-1);this.fromdate=M.timeformat(fromdate);this.enddate=M.timeformat(enddate);this.initpicker();},initpicker:function(){this.initpickerhead();this.initpickerarea();this.getpricestatus();this.context.maincontent.find("div[tag=ChannelPrice]").show();var cssstatus=this.context.maincontent.find("div[tag=barSuccess]").css('display');if(cssstatus!='none'){this.context.maincontent.find("div[tag=ChannelPrice]").show();}
var that=this;var content=this.context.pickerarea.find('table').selectable({filter:'.canselected',start:function(e,ui){that.unselectedrtid=0;that.context.pickerarea.find('div.ui-selected').removeClass('ui-selected').removeClass('ui-selecting');var target=e.toElement||e.originalEvent.target;var t=$(target).attr('tag');if(!M.isEmpty(t)&&t=='setdxdefaultprice'){that.unselectedrtid=$(target).parents('tr').attr('rtid');}},selected:function(e,ui){$(ui.selected).find('div').addClass('ui-selected');},stop:this.selectable_finished.toEventHandler(this)});},inittooltip:function(){var list=this.context.pickerarea.find('i.ico-flashsale');list.each(function(){var tpl=$(this).parents('td').children('div');var msg=tpl.attr('discountmsg');tpl.attr("title","").tooltip({position:{my:"left+15 top+20",at:"left bottom"},track:1,content:msg,show:{delay:100},hide:false});});},batchbaseprice_change:function(e){var ele=M.EventEle(e);var baseprice=ele.val();if(M.isEmpty(baseprice)){ele.parents('div.item').find('strong[tag=price]').html('');return;}
var reg=/^[0-9]*$/;if(M.math_isnumber(baseprice)===false)
{return;}
var price=M.math_format(baseprice*this.commission);ele.attr('price',price);if(this.betauserstatus==1){ele.parents('div.item').find('strong[tag=price]').html(price);}},selectable_finished:function(){if(this.unselectedrtid!=0){this.setdxdefaultprice();}else{this.bathsetroomtypeprice();}},bathsetroomtypeprice:function(type){this.context.pickerarea.find('div.ui-selected').addClass('ui-selecting');var rtdata=this._getselectroomtype(type);var rtlist=rtdata['rtlist'];if(rtdata.fromdate==''){return false;}
if(M.isEmpty(type)&&rtdata.length==1){for(var i in rtlist){this.roomtypepricetarget=rtlist[i];}
this.roomtypepricetarget.fromdate=rtdata.fromdate;this.roomtypepricetarget.enddate=rtdata.enddate;var title='设置'+this.betauserstatus_text['price'][this.betauserstatus]+'-'+this.roomtypepricetarget.rtname;this.context.setroomtypedatepricefrom.find('h4[tag=title]').html(title);this.context.setroomtypedatepricefrom.find('input[name=price]').val('');if(this.betauserstatus==1){this.context.setroomtypedatepricefrom.find('h4[tag=title]').append('<span>佣金率：'+M.math_min(1,this.commission)*100+'%</span>');}else{this.context.setroomtypedatepricefrom.find('span[tag=commissionmsg]').html('');}
this.context.setroomtypedatepricefrom.find('strong[tag=baseprice]').parent().hide();M.Popup(this.context.setroomtypedatepricefrom,{"hideclass":"modal sm fade","showclass":"modal sm fade in"});}else{var html='';for(var i in rtlist){var item=rtlist[i];html+='<div class="item" rtid="'+item.rtid+'" pid="'+item.planid+'">';html+='<div class="name">'+item.rtname+'</div>';html+='<div class="wrapper"><input type="text" value="" name="baseprice" style="width:100px; margin-right:0;"></div>';if(this.betauserstatus==1){html+='<div class="wrapper">结算价：<strong class="red" tag="price"></strong></div>';}
html+='</div>';}
this.context.batchPricePop.find("li[tag=roomtypelist]").children('div').html(html);this.context.batchPricePop.find('input').bind("input propertychange",this.batchbaseprice_change.toEventHandler(this));var gettime=M.strtotime(rtdata.fromdate);var getdate=M.timeformat(gettime);var enddate=rtdata.enddate;var maxdate=M.timeformat(this._getMaxMonth(gettime));var li_datelist=this.context.batchPricePop.find('li[tag=datelist]');li_datelist.children('input[tag=startdate]').datepicker("setDate",getdate);li_datelist.children('input[tag=enddate]').datepicker("setDate",enddate);li_datelist.children('input[tag=startdate]').val(getdate).datepicker({showOtherMonths:true,selectOtherMonths:true,onSelect:this.startondateselect.toEventHandler(this)});li_datelist.children('input[tag=enddate]').val(enddate).datepicker({showOtherMonths:true,selectOtherMonths:true,onSelect:this.endondateselect.toEventHandler(this)});li_datelist.children('input[tag=startdate]').datepicker("option","minDate",getdate);li_datelist.children('input[tag=startdate]').datepicker("option","maxDate",maxdate);li_datelist.children('input[tag=enddate]').datepicker("option","minDate",getdate);li_datelist.children('input[tag=enddate]').datepicker("option","maxDate",maxdate);li_datelist.children('label').show().children('input').attr('checked','checked').removeAttr('disabled');var day=this._dateDiff(getdate,enddate);if(day<7){li_datelist.children('label').hide().children('input').attr('checked','checked').attr('disabled','disabled');}else{li_datelist.children('label').show().children('input').removeAttr('disabled');}
if(this.betauserstatus==1){this.context.batchPricePop.find('span[tag=commissionmsg]').html('佣金率：'+M.math_min(1,this.commission)*100+'%');}else{this.context.batchPricePop.find('span[tag=commissionmsg]').html('');}
M.Popup(this.context.batchPricePop,{"hideclass":"modal pricebatch fade","showclass":"modal pricebatch fade in"});}},_getselectroomtype:function(type){var rtlist={};var fromdate='';var enddate='';var length=0;if(M.isEmpty(type)){var tpllist=this.context.pickerarea.find('div.ui-selected');var roomtypelist=this.context.roomtypelist;tpllist.each(function(){var target_td=$(this).parents('td');var datestr=target_td.attr('time');if(M.isEmpty(fromdate)||fromdate>datestr){fromdate=datestr;}
if(M.isEmpty(enddate)||enddate<datestr){enddate=datestr;}
var rtid=target_td.parent().attr('rtid');var target_rt=roomtypelist.find('tr[tag=rt][rtid='+rtid+']');var planid=target_rt.attr("planid");var rtname=target_rt.find('div').html();if(M.isEmpty(rtlist[rtid+'rtid'])){var tmp={'rtid':rtid,'rtname':rtname,'planid':planid}
rtlist[rtid+'rtid']=tmp;length++;}});}else{this.context.roomtypelist.find('tr[tag=rt]').each(function(){var target=$(this);var price=target.attr('price');var planid=target.attr("planid");var rtname=target.find('div').html();var rtid=target.attr('rtid');if(!M.isEmpty(price)){if(M.isEmpty(rtlist[rtid+'rtid'])){var tmp={'rtid':rtid,'rtname':rtname,'planid':planid}
rtlist[rtid+'rtid']=tmp;length++;}}});var now=M.getTime();fromdate=M.timeformat(now);enddate=this.enddate;}
return{'rtlist':rtlist,'fromdate':fromdate,'enddate':enddate,'length':length};},getpricestatus:function(){var showloading=true;if(this.signed!=1&&this.signed!=2){showloading=false;}
var fromdate=this.fromdate;var enddate=this.enddate;var innid=this._getinnid();M._getjson('/Ota/getdxpricelist',{'innid':innid,'fromdate':fromdate,'enddate':enddate},this.getdxpricelist_finished.toEventHandler(this),'',showloading);},getdxpricelist_finished:function(d){if(d.status=="success"){var rtlist=d.data;for(var i in rtlist){var item=rtlist[i];var html=this._showpickerprice(item,'rt');this._setrtdata(item);var target=this.context.pickerarea.find('tr[rtid='+item.roomtypeid+']');target.html(html);}}else{if(!M.isEmpty(d.msg)){alert(d.msg);}}
this.inittooltip();},_setrtdata:function(item){var roomtypeid=item.roomtypeid;if(!M.isEmpty(item.planid)){this.context.roomtypelist.find('tr[tag=rt][rtid='+roomtypeid+']').attr('price',item.price).attr('planid',item.planid);}},initpickerarea:function(){var rtlist=this._getrtlist();var html='';for(var i in rtlist){var item=rtlist[i];html+='<tr idx="'+i+'" rtid="'+item.rtid+'">';html+=this._showpickerprice(item,'init');html+='</tr>';}
this.context.pickerarea.find("table").html(html);},_showpickerprice:function(item,from){var fromtime=M.strtotime(this.fromdate);var endtime=M.strtotime(this.enddate);var index=0;var html='';var baseprice=item.price;if(M.isEmpty(baseprice)){var pricetext=this.dx_model_text['price'][this.dx_model];html+='<td colspan="14" class="" tag="setdefaultprice"><div class="light " data-price="empty"><p class="full">暂无'+pricetext+'，<a href="#?" class="table-btn t14 " tag="setdxdefaultprice">立即设置</a></p></div></td>';}else{while(fromtime<=endtime){var datestr=M.timeformat(fromtime);baseprice=item.price;var price=M.math_division(baseprice,this.commission);if(from=='init'){html+='<td class="canselected" i="'+index+'" time="'+datestr+'"><div class="canselected"></div></td>';}else{var classstr='',pricetype='0',betastatusstr='';if(!M.isEmpty(item.pricelist)){var pricelist=item.pricelist;if(!M.isEmpty(pricelist[datestr])){baseprice=pricelist[datestr].price;price=M.math_division(baseprice,this.commission);classstr='iorange';pricetype='1';}}
var promotionstr='';var discountmsg='';var is_discount=this.isDiscount(datestr,item.discount,item.starttime,item.endtime,item.starthour);if(is_discount){classstr='iorange';promotionstr='<i class="ico-flashsale"></i>';if(is_discount==1){price=M.math_format(price-item.discount);discountmsg=datestr+' 已设置促销, <br/>此价格已减 '+item.discount+'元';}else if(is_discount==2){discountmsg=datestr+' 已设置促销, <br/>'+item.starthour+':00生效此价格立减'+item.discount+'元';}else if(is_discount==3){discountmsg=datestr+' 已设置促销, <br/>此价格已减 '+item.discount+'元';}}
if(this.betauserstatus==1){betastatusstr='sup';}
html+='<td i="'+index+'" class="canselected" time="'+datestr+'" data-type="'+pricetype+'">';html+='<div discountmsg="'+discountmsg+'" class="canselected '+classstr+'">';html+='<p tag="price" p="'+price+'" class="'+betastatusstr+'" bp="'+baseprice+'">&yen;'+price+'</p>';if(this.betauserstatus==1){html+='<p class="sub">结: '+baseprice+'</p>';}
html+=promotionstr+'</div></td>';}
index++;fromtime.setDate(fromtime.getDate()+1);}}
return html;},isDiscount:function(ondate,discount,starttime,endtime,starthour){var today=M.timeformat(M.getTime());var today_time=M.strtotime(today);var sys_starthour=M.timeformat(M.getTime(),'h');var code=0;if(discount<=0){return code;}
if(M.isEmpty(starttime)||M.isEmpty(endtime)){return code;}
var on_time=M.strtotime(ondate);var start_time=M.strtotime(starttime);var end_time=M.strtotime(endtime);if(on_time>=start_time&&on_time<=end_time){if(starthour==0){code=3;}else{if(today==ondate&&starthour<=sys_starthour){code=1;}else{code=2;}}}
return code;},_getrtlist:function(){var tpllist=this.context.roomtypelist.find('tr[tag=rt]');var rtlist=[];tpllist.each(function(){var rtid=$(this).attr('rtid');var price=$(this).attr('price');var planid=$(this).attr('planid');var index=$(this).attr('i');var tmp={'rtid':rtid,'price':price,'planid':planid,'index':index};rtlist[index]=tmp;});return rtlist;},initpickerhead:function(){var fromtime=M.strtotime(this.fromdate);var endtime=M.strtotime(this.enddate);var holiday=M.Holiday();var now=M.getTime();var nowdate=M.timeformat(now);var html='';var index=0;var daterangestr=M.timeformat(fromtime,'m/d')+'~'+M.timeformat(endtime,'m/d');var yearstr=M.timeformat(endtime,'Y');this.context.page.find("p[tag=range]").html(daterangestr);this.context.page.find("b[tag=year]").html(yearstr);while(fromtime<=endtime){var datestr=M.timeformat(fromtime);var datemsg=M.timeformat(fromtime,'m-d');var week=fromtime.getDay();var weekstr='周'+this.weektext[week];if(nowdate==datestr){weekstr='今天';}
var classstr='';if(week==6||week==0){classstr+='weekend';}
var holidaystr=holiday.getholiday(datestr);if(M.isEmpty(holidaystr)){holidaystr=holiday.getrelaxesday(datestr);}
if(M.isEmpty(holidaystr)){html+='<th i="'+index+'" class="'+classstr+'"><p class="month">'+datemsg+'</p><p>'+weekstr+'</p></th>';}else{html+='<th i="'+index+'" class="'+classstr+'"><p class="month">'+datemsg+'</p><p><tt>'+holidaystr+'</tt></p></th>';}
fromtime.setDate(fromtime.getDate()+1);}
this.context.pickerdate.find('tr').html(html);},initData:function(){this.getinnid=this.context.datainfo.attr('innid');var msg='今天还未满房？试试降价促销吧。<br/>- 您所设置的促销价格会一键推广到云掌柜代销的各个OTA平台;<br/>- 您的客栈在米途上会得到特别展示和推荐机会;';this.context.channellist.find('table').find('th').children('i').attr("title","").tooltip({position:{my:"left+15 top+20",at:"left bottom"},track:1,content:msg,show:{delay:100},hide:false});this.is_showBatahModifyPrice();},batchPricePop_click:function(e){var ele=M.EventEle(e);var t=ele.attr("tag");switch(t){case'saveprice':this.batchSavePrice(ele);break;case'close':M.CloseLast();this.context.pickerarea.find('div.ui-selected').removeClass('ui-selecting');break;}},savepdaterice:function(){var price=this.context.setroomtypedatepricefrom.find('input[name=price]').val();if(M.isEmpty(price)&&price!==0){alert('价格不能为空');return;}
if(!M.math_isnumber(price)){alert('价格只能是数字');return;}
var pricestr=this.roomtypepricetarget.rtid+'_'+this.roomtypepricetarget.planid+'_'+price;var pricelist=[];var baseprice=M.math_format(price*this.commission);pricelist.push({'rtid':this.roomtypepricetarget.rtid,'price':baseprice,'discount':0})
this.batchpricelist=pricelist;var innid=this._getinnid();var startdate=this.roomtypepricetarget.fromdate;var enddate=this.roomtypepricetarget.enddate;var weekstr='1,2,3,4,5,6,7';var data={'innid':innid,'startdate':startdate,'enddate':enddate,'weekstr':weekstr,'pricestr':pricestr};M._getjson('/Ota/yzgdbatchsaveprice',data,this.batchSavePrice_finished.toEventHandler(this),'',true);},batchSavePrice:function(ele){var li_datelist=this.context.batchPricePop.find('li[tag=datelist]');var li_roomtypelist=this.context.batchPricePop.find('li[tag=roomtypelist]').children();var startdate=li_datelist.children('input[tag=startdate]').val();var enddate=li_datelist.children('input[tag=enddate]').val();var week=[];li_datelist.children('label').each(function(){var weekday=$(this).children('input:checked').val();if(!M.isEmpty(weekday)){week.push(weekday);}});var weekstr='';if(!M.isEmpty(week)){weekstr=week.join(',');}
var price_arr=[];var pricelist=[];li_roomtypelist.children().each(function(){var rtid=$(this).attr('rtid');var pid=$(this).attr('pid');var baseprice=$(this).find('input[name=baseprice]').attr('price');var price=$(this).find('input[name=baseprice]').val();if(!M.isEmpty(price)){var str=rtid+'_'+pid+'_'+price;price_arr.push(str);pricelist.push({'rtid':rtid,'price':baseprice,'discount':0})}});if(M.isEmpty(price_arr)){alert('至少填写一个房型价格');return;}
this.batchpricelist=pricelist;var pricestr=price_arr.join(',');var data={'innid':this.getinnid,'startdate':startdate,'enddate':enddate,'weekstr':weekstr,'pricestr':pricestr};M._getjson('/Ota/yzgdbatchsaveprice',data,this.batchSavePrice_finished.toEventHandler(this),'',true);},batchSavePrice_finished:function(d){if(d.status!='success'){if(!M.isEmpty(d.data)){var data=d.data;var li_roomtypelist=this.context.batchPricePop.find('li[tag=roomtypelist]').children();var roomtypenameslist=[];for(var k in data){var roomtypeid=data[k];var roomtypename=li_roomtypelist.find('div[rtid='+roomtypeid+']').children('div:eq(0)').html();roomtypenameslist.push(roomtypename);}
var roomtypenamestr=roomtypenameslist.join(',');var msg="（"+roomtypenamestr+"）房型"+d.msg;alert(msg);return;}
alert(d.msg);return;}
var fromdate=d.req.startdate;var enddate=d.req.enddate;var batchpricelist=this.batchpricelist;var rtlist=d.data;var weekstr=d.req.weekstr;for(var i in batchpricelist){var item=batchpricelist[i];for(var k in rtlist){if(rtlist[k]['roomtypeid']==item.rtid){this._showbatchpickerprice(rtlist[k],fromdate,enddate,item.price,weekstr);}}}
M.success(d.msg);M.CloseLast();this.context.pickerarea.find('div.ui-selected').removeClass('ui-selecting');return;},_showbatchpickerprice:function(item,fromdate,enddate,baseprice,weekstr){var fromtime=M.strtotime(fromdate);var endtime=M.strtotime(enddate);var target=this.context.pickerarea.find("tr[rtid="+item.roomtypeid+"]");while(fromtime<=endtime){var datestr=M.timeformat(fromtime);var week=fromtime.getDay();if(week==0){week=7;}
var classstr='iorange',pricetype=1,betastatusstr='';if(this.betauserstatus==1){betastatusstr='sup';}
if(weekstr.indexOf(week)!=-1){var price=M.math_division(baseprice,this.commission);var tpl=target.children('td[time='+datestr+']');var promotionstr='';var msg='';var is_discount=this.isDiscount(datestr,item.discount,item.starttime,item.endtime,item.starthour);if(is_discount){classstr='iorange';promotionstr='<i class="ico-flashsale"></i>';if(is_discount==1){price=M.math_format(price-item.discount);msg=datestr+' 已设置促销, <br/>此价格已减 '+item.discount+'元';}else if(is_discount==2){msg=datestr+' 已设置促销, <br/>'+item.starthour+':00生效此价格立减'+item.discount+'元';}else if(is_discount==3){discountmsg=datestr+' 已设置促销, <br/>此价格已减 '+item.discount+'元';}}
var html='<div class="canselected '+classstr+'"><p tag="price" class="'+betastatusstr+'" p="'+price+'">&yen;'+price+'</p>';if(this.betauserstatus==1){html+='<p class="sub">结: '+baseprice+'</p>';}
html+=promotionstr+'</div>';tpl.html(html).attr('data-type',pricetype);if(msg){tpl.children('div').attr("title","").tooltip({position:{my:"left+15 top+20",at:"left bottom"},track:1,content:msg,show:{delay:100},hide:false});}}
fromtime.setDate(fromtime.getDate()+1);}},is_showBatahModifyPrice:function(){var table=this.context.channellist.find('table');table.find('th').children('a[tag=batchprice]').hide();table.find('tr[tag=list]').each(function(){if($(this).attr('pid')!=''){table.find('th').children('a[tag=batchprice]').show();return false;}});},flashsaleform_moneychange:function(e){var ele=M.EventEle(e);var price=ele.val();var reg=/^[0-9]*$/;if(reg.test(price)===false)
{alert("只支持正整数");price=price.replace(/[^\d]/g,"");ele.val(price);}
return true;},_handlediscounttip:function(rtid,startdate,discount){if(M.isEmpty(discount)||discount==0){return true;}
var orgprice=this.context.pickerarea.find('tr[rtid='+rtid+']').children('td[time='+startdate+']').find('p[tag=price]').attr('p');if(M.math_isnumber(discount)===false)
{return false;}
var value=Math.ceil(M.math_format(discount/orgprice,4)*100);var dis=M.math_min(orgprice,discount);if(value>50&&value<=100){var tipmsg="您确定设置的优惠价格超过底价"+value+"%！";if(!confirm(tipmsg)){return false;}}else{}
return true;},channellist_click:function(e){var ele=M.EventEle(e);var t=ele.attr('tag');switch(t){case'edit':this.editchannelprice(ele);break;case'addPrice':this.editchannelprice(ele);break;case'delete':this.deletechannelprice(ele);break;case'delpromotion':this.delpromotion(ele);break;}},_getAddMonth:function(date){var now=new Date(date.getFullYear(),date.getMonth()+1,date.getDate());return now;},_getAddYear:function(date){var now=new Date(date.getFullYear()+1,date.getMonth(),date.getDate());return now;},_getMaxMonth:function(date){var now=new Date(date.getFullYear(),date.getMonth()+6,date.getDate());return now;},_dateDiff:function(sDate1,sDate2){var oDate1=M.strtotime(sDate1);var oDate2=M.strtotime(sDate2);var iDays=parseInt(Math.abs(oDate1-oDate2)/1000/60/60/24);return iDays;},batchpricePop:function(){var gettime=M.getTime();var getdate=M.timeformat(gettime);var enddate=M.timeformat(this._getAddMonth(gettime));var maxdate=M.timeformat(this._getMaxMonth(gettime));var li_datelist=this.context.batchPricePop.find('li[tag=datelist]');li_datelist.children('input[tag=startdate]').datepicker("setDate",getdate);li_datelist.children('input[tag=enddate]').datepicker("setDate",enddate);li_datelist.children('input[tag=startdate]').val(getdate).datepicker({showOtherMonths:true,selectOtherMonths:true,onSelect:this.startondateselect.toEventHandler(this)});li_datelist.children('input[tag=enddate]').val(enddate).datepicker({showOtherMonths:true,selectOtherMonths:true,onSelect:this.endondateselect.toEventHandler(this)});li_datelist.children('input[tag=startdate]').datepicker("option","minDate",getdate);li_datelist.children('input[tag=startdate]').datepicker("option","maxDate",maxdate);li_datelist.children('input[tag=enddate]').datepicker("option","minDate",getdate);li_datelist.children('input[tag=enddate]').datepicker("option","maxDate",maxdate);li_datelist.children('label').show().children('input').attr('checked','checked').removeAttr('disabled');var li_roomtypelist=this.context.batchPricePop.find('li[tag=roomtypelist]').children();li_roomtypelist.empty();var tpl_roomtype=this.tpl_roomtype;var miotjs=$;this.context.channellist.children('table').find('tr[tag=list]').each(function(){var pid=$(this).attr('pid');if(M.isEmpty(pid)){return true;}
var data={'rtid':$(this).attr('rtid'),'roomtypename':$(this).children('td:eq(0)').html(),'pid':$(this).attr('pid')};li_roomtypelist.append(miotjs.tmpl(tpl_roomtype,data));});M.Popup(this.context.batchPricePop,{"hideclass":"modal pricebatch fade","showclass":"modal pricebatch fade in"});},startondateselect:function(startdate){var li_datelist=this.context.batchPricePop.find('li[tag=datelist]');var enddate=li_datelist.children('input[tag=enddate]').val();var day=this._dateDiff(startdate,enddate);if(day<7){li_datelist.children('label').hide().children('input').attr('checked','checked').attr('disabled','disabled');}else{li_datelist.children('label').show().children('input').removeAttr('disabled');}},endondateselect:function(enddate){var li_datelist=this.context.batchPricePop.find('li[tag=datelist]');var startdate=li_datelist.children('input[tag=startdate]').val();var day=this._dateDiff(startdate,enddate);if(day<7){li_datelist.children('label').hide().children('input').attr('checked','checked').attr('disabled','disabled');}else{li_datelist.children('label').show().children('input').removeAttr('disabled');}},deletechannelprice:function(ele){if(!confirm('确认要删除吗？该操作不可恢复！')){return;}
var pid=ele.parent().attr("pid");var roomtypeid=ele.parents("tr").attr("rtid");var innid=this._getinnid();var data={"innid":innid,"planid":pid,"roomtypeid":roomtypeid,"act":"delchannelprice"};M._getjson("/Ota/channelpricemanage",data,this.delchannelprice_finished.toEventHandler(this));},delchannelprice_finished:function(d){if(d.status=="success"){var rtid=d.req.roomtypeid;var html='';html+='<td style="vertical-align:middle;">'+d.roomtype.roomtypename+'</td>';html+='<td colspan="3"><a href="#?" class="btn btn-primary btn-small" tag="addPrice">设置代销价格</a></td>';this.context.channellist.find("tr[rtid="+d.roomtype.id+"]").html(html);M.success('删除成功');}else{M.error(d.msg);}},initchannelpricecontent:function()
{var fromdate=M.getTime();this.context.channelpricepicker=new M.PricePicker(this.context.channelprice,{"date":fromdate});this.context.channelpricepicker.setdateselected(this.channelpricedate_selected.toEventHandler(this));},editchannelprice:function(ele)
{var innid=this._getinnid();var roomtypeid=ele.parents("tr").attr("rtid");var planid=ele.parent().attr("pid");this.channelmonthtab_reset();this._getchannelprice(innid,roomtypeid,planid);this.context.channelpricepicker.before_open();var roomtypename=ele.parents("tr").attr("val");this.context.inputchannelprice.val('');this.context.channelpriceform.find("h3[tag=title]").html(roomtypename+'-设置代销价格');this.context.channelpriceform.attr("rtid",roomtypeid).attr("innid",innid).attr("planid",planid).find("a[tag=saveprice]").hide();M.Popup(this.context.channelpriceform,{"hideclass":"bootbox modal setprice fade","showclass":"bootbox modal setprice fade in"});},channelmonthtab_reset:function()
{var fromdate=M.getTime();fromdate.setDate(1);var montharr=new Array();for(var i=0;i<this.pricemonth;i++)
{var mon=fromdate.getMonth();var time=this.timeformat(fromdate,"Y-m-d");fromdate.setMonth(fromdate.getMonth()+1);montharr.push({"monthname":mon+1+"月","time":time});}
var tpl_month='<li date="${time}"><a tag="month" href="#?">${monthname}</a></li>';var months=$.tmpl(tpl_month,montharr);this.context.channelmonthtab.html("").append(months).children("li:first").attr("class","active");},_getchannelprice:function(innid,rtid,planid)
{var fromdate=this.context.channelpricepicker.getfromdate();var enddate=this.context.channelpricepicker.getenddate();this.context.channelpriceform.attr("planid","");if(M.isEmpty(rtid))
{return;}
var data={"act":"getchannelprice","roomtypeid":rtid,"innid":innid,"fromdate":fromdate,"enddate":enddate,"planid":planid};M._getjson("/Ota/channelpricemanage",data,this.getchannelpeprice_finished.toEventHandler(this));},getchannelpeprice_finished:function(d)
{if(d.status=="success")
{var pricelist=d.pricelist;var plan=d.plan;if(!M.isEmpty(plan)){this.context.inputchannelprice.val(plan.price);}
if(!M.isEmpty(pricelist))
{var pricesource=this._formatdateprice(pricelist);this.channelprice[d.req.roomtypeid]=pricesource;this.context.channelpricepicker.setPriceSource(pricesource);var begintimestr=this.timeformat(this._getdatetime(),"Y-m-d");this.context.channelpricepicker.changedate(begintimestr);}else{var begintimestr=this.timeformat(this._getdatetime(),"Y-m-d");this.context.channelpricepicker.setPriceSource({});this.context.channelpricepicker.cleardefaultprice();this.context.channelpricepicker.changedate(begintimestr);}}},channelpricedate_selected:function(ui,val)
{this.context.newchannelprice.val("");M.Popup(this.context.setchannelprice,{"hideclass":"bootbox modal sm fade","showclass":"bootbox modal sm fade in"},function(){this.context.channelpricepicker.disable();}.toEventHandler(this));},channlmonthtab_click:function(e)
{var ele=M.EventEle(e);var t=ele.attr("tag");switch(t){case"month":var rtid=this.context.channelpriceform.attr("rtid");ele.parent().parent().find(".active").attr("class","");ele.parent().attr("class","active");var time=ele.parent().attr("date");if(this.context.channelpricepicker)
{var source=this.channelprice[rtid];this.context.channelpricepicker.changedate(time,{});}
break;}},inputchannelprice_change:function(e){var ele=M.EventEle(e);ele.parent().children("a[tag=saveprice]").show();},channelpriceform_click:function(e){var ele=M.EventEle(e);var t=ele.attr('tag');switch(t){case'saveprice':this.savedefaultprice(ele);break;case'closebtn':this.cache_promotion='';break;}},_getinnid:function()
{var innid=this.context.maincontent.attr("innid");return innid;},newchannelprice_keyup:function(e)
{var keycode=e.which;if(keycode==13)
{this.savedatechannelprice();}},setchannelprice_click:function(e)
{var ele=M.EventEle(e);var t=ele.attr("tag");if(t=="saveprice")
{this.savedatechannelprice();}
else if(t=="closebtn")
{this.context.channelpricepicker.refresh();}},savedatechannelprice:function()
{var price=this.context.newchannelprice.val();if(M.isEmpty(price))
{alert("价格不能为空");return;}
else
{if(isNaN(price))
{alert("价格输入错误");return;}
var pricestr=this.context.channelpricepicker.getselectedvalue();pricestr=pricestr.replace(/\$p/g,price);if(pricestr.length>0)
{pricestr=pricestr.substr(1,pricestr.length-1);}
var roomtypeid=this.context.channelpriceform.attr("rtid");var planid=this.context.channelpriceform.attr("planid");var innid=this._getinnid();var btn=this.context.setchannelprice.children(".modal-footer").children("a[tag=saveprice]");if(!this.req_before(btn)){return;}
var data={"act":"updateprice","roomtypeid":roomtypeid,"innid":innid,"pricestr":pricestr,"price":price,"planid":planid};M._getjson("/Ota/channelpricemanage",data,this.updatechannelprice_finished.toEventHandler(this));}},updatechannelprice_finished:function(d)
{if(d.status=="success")
{this.context.channelpricepicker.setselecteddateprice(d.req.price,d.req.pricestr);this.context.channelpricepicker.refresh();this.close_click();M.success('保存成功');}else{alert(d.msg);}
var btn=this.context.setchannelprice.children(".modal-footer").children("a[tag=saveprice]");this.req_end(btn);},reqbusy:function()
{alert("请求处理中，请稍后再试");},req_before:function(btn)
{var busy=btn.attr("busy");if(busy=="1")
{this.reqbusy();return false;}
btn.html(this.submittext).attr("busy","1");btn.attr("class",btn.attr("tempclass")+" disabled");return true;},req_end:function(btn)
{btn.html(btn.attr("text")).attr("busy","");btn.attr("class",btn.attr("tempclass"));},close_click:function(e)
{this._closepopup();},_formatdateprice:function(pricearr)
{var source={};if(M.isEmpty(pricearr))
{return source;}
for(var i=0;i<pricearr.length;i++)
{var item=pricearr[i];temprtid=item.roomtypeid;var rtid=item.roomtypeid;var price=item.price;var date=item.date;var pricetype=item.type;var ymd=date.substr(0,10);source[ymd]={"price":price,"pricetype":pricetype};}
return source;},zerosize:function(value,length){if(!length)length=2;value=String(value);for(var i=0,zeros='';i<(length-value.length);i++){zeros+='0';}
return zeros+value;},_getdatetime:function()
{var date=M.getTime();return date;},timeformat:function(date,format)
{if(M.isEmpty(format))
{format="Y-m-d";}
var year=date.getFullYear();var month=this.zerosize(date.getMonth()+1+"",2);var day=this.zerosize(date.getDate()+"",2);var time=format.replace("Y",year).replace("m",month).replace("d",day);return time;},_addCacheEle:function(ele){this.cache_ele=ele;ele.attr('tag','no'+ele.attr('tag'));},_clearCacheEle:function(){var cache_ele=this.cache_ele;setTimeout(function(){var tag=cache_ele.attr('tag');cache_ele.attr('tag',tag.substr(2));},500);this.cache_ele='';return true;},NoUndefined:function(str)
{return M.isEmpty(str)?"":str;},_closepopup:function()
{M.CloseLast();},destroy:function(){}});var OtaYZGPage;M.ready(function(){OtaYZGPage=new M.Page.OtaYZGPage();return OtaYZGPage;});