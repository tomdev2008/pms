M.Page.Recharge=M.createClass();M.extend(M.Page.Recharge.prototype,{context:{},init:function(){this.initDOM();this.initEvent();this.initData();},initDOM:function(){this.context.body=$("body");this.context.recharge=$("#recharge");this.context.rechargePop=$("#rechargePop");this.context.cashierPop=$("#cashierPop");this.context.statusPop=$("#statusPop");},initEvent:function(){this.context.body.bind("click",this.body_click.toEventHandler(this));this.context.recharge.bind("click",this.rechargeClick.toEventHandler(this));this.context.rechargePop.bind("click",this.rechargePop_click.toEventHandler(this));this.context.rechargePop.find('input[name=money]').bind("input propertychange",this.rechargePopNameChange.toEventHandler(this));},initData:function(){var tipmsg=this.context.recharge.parent().children('i').attr('title');this.context.recharge.parent().children('i').attr('title','').tooltip({position:{my:"left+15 top+20",at:"left bottom"},track:1,content:tipmsg,show:{delay:100}});},_initTradingParam:function(){this.getTradingId=0;this.getTradingCode=0;},body_click:function(e){var ele=M.EventEle(e);var t=ele.attr('tag');var parent_tag=ele.parents('div[tag=account]').attr('tag');if(!(t=='ainfor'||t=='account'||parent_tag=='account')){this.context.rechargePop.find('div[tag=account]').hide();}},rechargePopNameChange:function(e){var ele=M.EventEle(e);var money=ele.val();var amount=this.context.recharge.attr('amount');var decimal=1;var money_arr=money.split(".");if(money_arr.length>2||(!M.isEmpty(money_arr[1])&&money_arr[1].length>decimal)){money=money.substring(0,(money.length-1));ele.val(money);return false;}else if(!(money>=0)&&!M.math_isnumber(money)){money=money.substring(0,(money.length-1));ele.val(money);return false;}
if(money>50000){money=money.substring(0,(money.length-1));ele.val(money);alert('每次充值限额5万元');return false;}
if(money>0){this.context.rechargePop.find('a[tag=recharge]').addClass('btn-primary');}else{this.context.rechargePop.find('a[tag=recharge]').removeClass('btn-primary');}},rechargePop_click:function(e){var ele=M.EventEle(e);var t=ele.attr('tag');if(t=='recharge'){this.rechargeFun();}else if(t=='ainfor'){this.context.rechargePop.find('div[tag=account]').show();}},rechargeFun:function(){var money=this.context.rechargePop.find('input[name=money]').val();if(money<=0){alert('请填写充值金额');return false;}
M._getjson('/Shortmessage/recharge',{'money':money},this._rechargeFun_callback.toEventHandler(this),'',true);},_rechargeFun_callback:function(d){if(d.status=='success'){M.ClosePopup();M.Popup(this.context.cashierPop,{'hideclass':'modal view cashier fade','showclass':'modal view cashier fade in'},function(){}.toEventHandler(this));var data=d.data;this.context.cashierPop.find('img[tag=qrcode]').attr('src',data.qr_url);this.context.cashierPop.find('span[tag=money]').html(data.money);this.getTradingId=data.trading_id;this.getTradingCode=data.trading_code;this._longPolling();}else{alert(d.msg);}},rechargeClick:function(){this.context.rechargePop.find('input[name=money]').val('');this.context.rechargePop.find('span[tag=price]').html(this.context.recharge.attr('amount'));M.Popup(this.context.rechargePop,{'hideclass':'modal view fade recharge','showclass':'modal view fade in recharge'},function(){}.toEventHandler(this));this._initTradingParam();},_longPolling:function(){var aid=this.getTradingId;var trade_no=this.getTradingCode;var data={"op":"getpaystatus","out_trade_no":aid,"trade_no":trade_no,'type':'sms'};M._getjson("/pay/getpaystatus",data,this.getpaystatus_finished.toEventHandler(this));},getpaystatus_finished:function(d){var data=d.info;if('202'==data.code){var showstatus=this.context.cashierPop.css("display");if(showstatus!='none'){this._longPolling();}}else{M.ClosePopup();M.Popup(this.context.statusPop,{'hideclass':'modal cashier fade','showclass':'modal cashier fade in'},function(){}.toEventHandler(this));this.context.statusPop.find('span[tag=price]').html(data.total_fee);var div_status=this.context.statusPop.find('div[tag=status]');if('200'==data.code){div_status.children('p:eq(0)').removeClass('red').addClass('green').html('支付成功！');div_status.children('p:eq(1)').html('您可通过短信频道查看余额的变化');this.context.recharge.parent().children('span').children('span').html(data.amount);}else{div_status.children('p:eq(0)').removeClass('green').addClass('red').html('支付失败！');div_status.children('p:eq(1)').html('您可以稍后再试或使用其他支付方式');}}},});var rechargePage='';M.ready(function(){rechargePage=new M.Page.Recharge();return rechargePage});