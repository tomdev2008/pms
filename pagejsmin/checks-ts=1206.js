M.Page.ChecksManagePage=M.createClass();M.extend(M.Page.ChecksManagePage.prototype,{context:{},temp_interval:{},init:function(){this.initDOM();this.initEvent();this.context.checkcountslist.find('span[tag=remark]').each(function(){var text=$(this).text();$(this).attr("title",'').tooltip({position:{my:"left+15 top+20",at:"left bottom"},track:1,content:text,show:{duration:100}});});this.context.checkcountslist.find('span[tag=orderremark]').each(function(){var text=$(this).text();$(this).attr("title",'').tooltip({position:{my:"left+15 top+20",at:"left bottom"},track:1,content:text,show:{duration:100}});});},initDOM:function(){this.context.groupbuyingsetlist=$("#groupbuyingsetlist");this.context.checkcountslist=$("#checkcountslist");this.context.pagelist=$("#pagelist");this.context.checked=$("#checked");},initEvent:function(){this.context.groupbuyingsetlist.bind("change",this.groupbuyingsetlist_change.toEventHandler(this));this.context.checkcountslist.bind("click",this.checkcountslist_click.toEventHandler(this));this.context.pagelist.bind("click",this.pagelist_click.toEventHandler(this));this.context.checked.bind("click",this.checked_click.toEventHandler(this));this.context.checkcountslist.find('span[tag=checkoutinfo]').each(function(){var tpl=$(this);var msg=tpl.attr("remark");var datestr=tpl.attr("date");var content="结算时间："+datestr;if(!M.isEmpty(msg)){content+="<br/>备注："+msg;}
tpl.attr('title','').tooltip({position:{my:"left+15 top+20",at:"left bottom"},track:1,content:content,show:{duration:100}});});},checked_click:function(e){var ele=M.EventEle(e);var tag=ele.attr('tag');switch(tag){case'sendvcode':this.sendcode();break;case'save':this.savecheck();break;default:break;}},savecheck:function(){var phone=this.context.checked.find('span[tag=phone]').html();var code=this.context.checked.find('input[name=code]').val();var remark=this.context.checked.find('textarea[tag=remark]').val();var voucherid=this.context.checked.attr('voucherid');var data={'phone':phone,'code':code,'voucherid':voucherid,'remark':remark};M._getjson('/groupbuying/checkVoucher',data,this.checkVoucher_finished.toEventHandler(this),'post',true);},checkVoucher_finished:function(d){if(d.status=='success'){var voucherid=d.req.voucherid;var target=this.context.checkcountslist.find('tr[voucherid='+voucherid+']');var statustpl='<i class="orderstatus orderstatus-checkin"></i>已使用';target.find('i').parent().html(statustpl);target.find('span[tag=remark]').html(d.req.remark);target.find('td[tag=checkdate]').html(d.checkdate);target.find('a[tag=checked]').remove();this._closepopup();}else{M.error(d.msg);}},groupbuyingsetlist_change:function(e){var ele=M.EventEle(e);var groupbuyingid=ele.val();window.location.href="/groupbuying/checks?groupbuyingid="+groupbuyingid;},checkcountslist_click:function(e){var ele=M.EventEle(e);var tag=ele.attr('tag');switch(tag){case'export':this.export();break;case'search':this.search();break;case'checked':this.checkedInfoShow(ele);break;default:break;}},checkedInfoShow:function(ele){var voucherid=ele.parents('tr').attr('voucherid');var name=ele.parents('tr').find('td[tag=name]').html();var phone=ele.parents('tr').find('td[tag=phone]').html();var vouchernum=ele.parents('tr').find('td[tag=vouchernum]').html();var date=ele.parents('tr').find('td[tag=date]').html();this.context.checked.attr('voucherid',voucherid);this.context.checked.find('span[tag=name]').html(name);this.context.checked.find('span[tag=phone]').html(phone);this.context.checked.find('span[tag=vouchernum]').html(vouchernum);this.context.checked.find('span[tag=date]').html(date);this.context.checked.find('input[name=code]').val('');this.context.checked.find('textarea[tag=remark]').val('');M.Popup(this.context.checked,{"hideclass":"modal fade sm","showclass":"modal fade sm in"},function(){});},search:function(){var param=this._getParams();window.location.href="/groupbuying/checks"+param;},export:function(){var param=this._getParams();window.open("/groupbuying/checksExport"+param);},pagelist_click:function(e){var ele=M.EventEle(e);var tag=ele.attr("tag");var p=1;if(tag=='pageindex'){return false;}
if(tag=='pageprev'){p=Number(ele.attr('p'));if(p<1){return false;}}
if(tag=='pagenext'){var page_max=Number(this.context.pagelist.attr('maxpage'));p=Number(ele.attr('p'));if(M.isEmpty(p)||p>page_max){return false;}}
if(tag=='page'){p=Number(ele.attr('p'));}
this._submit_fun(p);},sendcode:function(){var phone=this.context.checked.find('span[tag=phone]').html();var voucherid=this.context.checked.attr('voucherid');if(M.isEmpty(phone)){alert('手机号不能为空');return false;}
M._getjson('/groupbuying/sendCode',{'phone':phone,'voucherid':voucherid},this.getVerfiyFun_callback.toEventHandler(this),'post',true);return true;},getVerfiyFun_callback:function(d){if(d.status=='success'){this._secondsCountdown();}else{M.error(d.msg);}
return true;},_secondsCountdown:function(){var target=this.context.checked.find('a[tag=sendvcode]');var countdown=60;var _this=this;target.attr('tag','nogetcode').html(countdown+"秒后可重发");this.temp_interval=setInterval(function(){countdown--;if(countdown<=0){target.attr('tag','sendvcode').html('发送验证码');clearInterval(_this.temp_interval);}else{target.html(countdown+"秒后可重发");}},1000);},_submit_fun:function(p){var param=this._getParams();if(M.math_isnumber(p)){param+='&p='+p;}
window.location.href="/groupbuying/checks"+param;},_getParams:function(){var kw=this.context.checkcountslist.find('input[name=kw]').val();var id=this.context.groupbuyingsetlist.val();var select=this.context.checkcountslist.find('select[name=select]').val();var param='?groupbuyingid='+id+'&kw='+kw+'&select='+select;return param;},_closepopup:function()
{var _this=this;clearInterval(_this.temp_interval);this.context.checked.find('a[tag=nogetcode]').attr('tag','sendvcode').html('发送验证码');M.ClosePopup();},});M.ready(function(){var checks=new M.Page.ChecksManagePage();return checks;});