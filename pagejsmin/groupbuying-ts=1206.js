M.Page.groupbuying=M.createClass();M.extend(M.Page.groupbuying.prototype,{context:{},tip:'微官网和小程序都可以支持团购活动，两个渠道的团购活动，在服务费和结算方式上存在差异。通过微官网成交的团购订单，按照交易额收取1.2%的服务费（含微信支付手续费），在消费者核销离店后T+2结算； 通过小程序成交的团购订单，云掌柜不收取服务费（不含微信支付手续费），用户支付团购订单后T+1结算。',init:function(){this.initDOM();this.initEvent();this.initTooltip()},initDOM:function(){this.context.groupbuyinglist=$("#groupbuyinglist");this.context.delpop=$("#delPop");this.context.pagelist=$("#pagelist");this.context.addvoucher=$("#addvoucher");this.context.showrules=$("#showrules");this.context.showrulesPop=$("#showrulesPop");},initEvent:function(){this.context.groupbuyinglist.bind("click",this.groupbuyinglist_click.toEventHandler(this));this.context.delpop.bind("click",this.delpop_click.toEventHandler(this));this.context.pagelist.bind("click",this.pagelist_click.toEventHandler(this));this.context.addvoucher.bind("click",this.addvoucher_click.toEventHandler(this));this.context.showrules.bind("click",this.showrules_click.toEventHandler(this));this.context.showrulesPop.bind("click",this.showrulesPop_click.toEventHandler(this));},showrules_click:function(){M.Popup(this.context.showrulesPop,{'hideclass':'modal sm fade','showclass':'modal sm fade in'});},showrulesPop_click:function(e){var ele=M.EventEle(e);var t=ele.attr('tag');if(t=='close'){M.ClosePopup();}},initTooltip:function(){this.context.groupbuyinglist.find("tr td[tag=tooltip]").each(function(){var qrcode=$(this).attr('qrcode');if(!M.isEmpty(qrcode)){var tpl='<img src="'+qrcode+'" width="200px" alt="">';$(this).attr("title",'').tooltip({position:{my:"left+15 top+0",at:"left bottom"},track:1,content:tpl,show:{duration:100}});}});},addvoucher_click:function(){M._getjson('/GroupBuying/checkVoucherAuth',{},function(d){if(d.status=='success'){window.open('/GroupBuying/setting','_self');}else{M.error('此功能只面向vip用户开放');}});},groupbuyinglist_click:function(e){var ele=M.EventEle(e);var tag=ele.attr('tag');switch(tag){case'delvoucher':this.delvoucher(ele);break;case'soldout':this.soldout(ele);break;}},delpop_click:function(e){var ele=M.EventEle(e);var tag=ele.attr('tag');switch(tag){case'confirm':this.confirmoperation();break;case'cancel':M.ClosePopup();break;}},delvoucher:function(ele){var status=ele.parents('tr').attr('status');var gbid=ele.parents('tr').attr('gbid');if(status=='3'){M._getjson("/Groupbuying/checkVoucherStatus",{'groupbuyingid':gbid},this.checkvoucherstatus_finished.toEventHandler(this),'',true);}else{this._showdelpop(gbid,"delvoucher","删除操作不可恢复，是否确认删除");}},checkvoucherstatus_finished:function(d){var gbid=d.req.groupbuyingid;if(d.status=='success'){this._showdelpop(gbid,"delvoucher","删除操作不可恢复，是否确认删除");}else{alert("当前有未核销订单，商品不可删除");return;}},soldout:function(ele){var gbid=ele.parents('tr').attr('gbid');this.context.delpop.find("a[tag=confirm]").html("停售");this._showdelpop(gbid,"soldout","停售操作不可恢复，已销售商品核销不受影响，<br>是否确认停售");},confirmoperation:function(){var opetype=this.context.delpop.attr('opetype');var gbid=this.context.delpop.attr('gbid');M._getjson("/Groupbuying/changeGroupBuyingStatus",{'groupbuyingid':gbid,'act':opetype},this.confirmoperation_finished.toEventHandler(this),'',true);},confirmoperation_finished:function(d){if(d.status=='success'){M.ClosePopup();window.location.reload()}else{alert(d.msg);return;}},pagelist_click:function(e){var ele=M.EventEle(e);var tag=ele.attr("tag");var p=1;if(tag=='pageindex'){return false;}
if(tag=='pageprev'){p=ele.attr('p');if(p<1){return false;}}
if(tag=='pagenext'){var page_max=this.context.pagelist.attr('maxpage');p=ele.attr('p');if(M.isEmpty(p)||p>page_max){return false;}}
if(tag=='page'){p=ele.attr('p');}
var innid=M.getinnid();window.location.href="/Groupbuying/index?innid="+innid+"&p="+p;},_showdelpop:function(gbid,opetype,text){this.context.delpop.attr('gbid',gbid);this.context.delpop.attr('opetype',opetype);this.context.delpop.find("div[tag=content]").html(text);M.Popup(this.context.delpop,{'hideclass':'modal sm fade','showclass':'modal sm fade in'});},destroy:function(){}});var groupbuying;M.ready(function(){groupbuying=new M.Page.groupbuying();return groupbuying;});