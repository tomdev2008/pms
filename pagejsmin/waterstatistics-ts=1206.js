M.Page.WaterStatisticsPage=M.createClass();M.extend(M.Page.WaterStatisticsPage.prototype,{context:{},submittext:"处理中...",selectstatus_income:"",selectstatus_pay:"",tabexamp:{"1":"备注，如：201客人肖万凯买13号普洱茶饼一个。","2":"备注，如：大床房卫生间花洒换新"},init:function(){this.initDOM();this.initEvent();},initDOM:function(){this.context.fromdate=$("#fromdate");this.context.enddate=$("#enddate");this.context.datevallist=$("#datevallist");this.context.addstatistics=$("#addstatistics");this.context.incomestatisticsform=$("#incomestatisticsform");this.context.paystatisticsform=$("#paystatisticsform");this.context.incometypelist=$("#incometypelist");this.context.paytypelist=$("#paytypelist");this.context.incomedate=$("#incomedate");this.context.paydate=$("#paydate");this.context.hide_data=$("#hide_data");this.context.detail=$("#detail");this.context.innidlist=$("#innid");this.context.searchbtn=$("#searchbtn");this.context.searchform=$("#searchform");this.context.incometypeitem=$("#incometypeitem");this.context.paytypeitem=$("#paytypeitem");var innid=this.context.searchform.attr("innid");this.context.innidlist.val(innid);this.context.add_incomeitem=$("#add_incomeitem");this.context.add_payitem=$("#add_payitem");this.context.otherincome=$("#otherincome");this.context.otherpay=$("#otherpay");this.context.body=$(document.body);this.context.statisticsform=$("#statisticsform");this.context.recodesumdate=$("#recodesumdate");this.context.exportexcel=$("#export");this.context.incomedate.datepicker({showOtherMonths:true,selectOtherMonths:true});this.context.paydate.datepicker({showOtherMonths:true,selectOtherMonths:true});this.context.recodesumdate.datetimepicker({timeFormat:"HH:mm",dateFormat:"yy-mm-dd"});},initEvent:function(){this.context.addstatistics.bind("click",this.addstatistics_click.toEventHandler(this));this.context.incomestatisticsform.bind("click",this.incomestatisticsform.toEventHandler(this));this.context.paystatisticsform.bind("click",this.paystatisticsform.toEventHandler(this));this.context.searchbtn.bind("click",this.searchbtn_click.toEventHandler(this));$(document.body).bind("click",this.document_click.toEventHandler(this));this.initdetaildata();this.context.detail.bind("click",this.detail_click.toEventHandler(this));this.context.innidlist.bind("change",this.searchcondition_onchange.toEventHandler(this));this.context.statisticsform.bind("click",this.statisticsform_click.toEventHandler(this));},edititem_click:function(e){this.context.editpop.find("ul[class=nav-tabs]").children("li:first").attr("class","active");this.context.editpop.find("ul[class=nav-tabs]").children().eq(1).attr("class","");this.context.paytypeitem.css("display","none");this.context.incometypeitem.css("display","block");this.context.editpop.css("display","block");},addpayitem_finished:function(e){if(e.status=="success"){var data=e.data;var id=data.typeid;var html='<li id="'+data.typeid+'"><label>'+data.typename+'</label><a href="javascript:;"  tag="payedit" title="修改" class="edit">修改</a><a href="javascript:;"  tag="paydelete" title="删除" class="delete"></a></li>';var list='<li id="'+data.typeid+'"><a tag="type" typeid="45" href="javascript:;">'+data.typename+'</a></li>';this.context.paytypeitem.children("ul").children("li:last").before(html);this.context.paytypelist.children("ul").children("li:last").before(list);}else{alert(e.msg);}},deleterecodesum:function(ele){var id=ele.parents("tr").attr("cid");var innid=M.getinnid();var consumevisitdeledit=this.context.hide_data.attr('consumevisitdeledit');if(consumevisitdeledit!=1){alert('您没有删除记一笔账目的权限，请联系客栈管理员');return;}
var r=confirm("确认删除吗");if(!r)
return;M._getjson("/Reportsource/deletewaterstatistics",{"id":id,'innid':innid},this.deletewaterstatistics_finished.toEventHandler(this));},deletewaterstatistics_finished:function(d){if(d.status=="success"){var data=d.olddata;var id=data.id;var watertime=M.strtotime(data.waterdate);var date=M.timeformat(watertime,'Y-m-d');var tpllist=this.context.detail.find("tr[date="+date+"]");var tpl=this.context.detail.find("tr[cid="+id+"]");var t=tpl.attr('t');if(tpllist.length>1){if(t=='f'){var tpl_first=this.context.detail.find("tr[date="+date+"]:first");tpl_first.attr("t","f").children("td[tag=date]").attr("rowspan",tpllist.length-1).show();tpl_first.children("td[tag=total]").attr("rowspan",tpllist.length-1).show();}}
tpl.remove();this._filterlist();M.success("删除成功");}else{M.error(d.msg);}},editrecodesum:function(ele){var id=ele.parents("tr").attr("cid");var consumevisitdeledit=this.context.hide_data.attr('consumevisitdeledit');if(consumevisitdeledit!=1){alert('您没有修改记一笔账目的权限，请联系客栈管理员');return;}
M._getjson("/Reportsource/getwaterstatisticsdetail",{"id":id},this.getrecodesumdetail_finished.toEventHandler(this));},getrecodesumdetail_finished:function(d){if(d.status=="success"){var data=d.data;var tip='编辑收入';if(data.type!=1){tip='编辑支出';}
this.context.statisticsform.find("input[name=record]").attr("checked",false);this.context.statisticsform.find("input[name=record][value="+data.type+"]").attr("checked","checked");this.context.hide_data.attr("cid",data.id);this.context.statisticsform.children("div").children("h4").text(tip);this.context.hide_data.attr("typename",data.typename);var timestr=M.strtotime(data.waterdate);var datestr=M.timeformat(timestr,'Y-m-d h:i');this.context.recodesumdate.val(datestr);this.context.statisticsform.children().find("a[name=savebutton]").attr("tag","editsave");this.context.statisticsform.children().find("select[name=innid]").val(data.innid);this.context.statisticsform.children().find("button[tag=buttons]").html(data.typename+'<span  tag="dropdown" class="caret"></span>');this.context.statisticsform.children().find("textarea[name=remark]").val(data.remark);this.context.statisticsform.children().find("input[name=typeid]").val(data.typeid);this.context.statisticsform.children().find("input[name=money]").val(data.money);var tpl_type=this.context.statisticsform.find("li[tag=typelist]");var tpl_consume=tpl_type.find("div[t=consumelist]").attr("value",data.typeid);if(M.isEmpty(data.paytypecode)){data.paytypecode='cash';}
if(data.paytypecode=='shouyintai'){data.paytypename='收银台';}
var tpl_pay=tpl_type.find("div[t=paytypelist]").attr("value",data.paytypecode);tpl_pay.children("span").attr("value",data.paytypecode).text(data.paytypename);tpl_pay.children("div").hide();tpl_consume.children("div").hide();this.context.statisticsform.find("div[t=innlist]").children("div").hide();var paytypecode=data.paytypecode;var tpl_inn=this.context.statisticsform.find("div[t=innlist]").attr("value",data.innid);if(paytypecode=='shouyintai'){M.DropdownList(tpl_inn,null,{});tpl_pay.addClass("droplist_not").unbind("click");tpl_inn.addClass("droplist_not").unbind("click");this.context.recodesumdate.attr("disabled","disabled");this.context.statisticsform.find("input[name=record]").parents("li").hide();this.context.statisticsform.find("input[name=record]").attr("disabled","disabled");this.context.statisticsform.find("input[name=money]").attr("disabled","disabled");}else{tpl_pay.removeClass("droplist_not");tpl_inn.removeClass("droplist_not");this.context.recodesumdate.attr("disabled",false);this.context.statisticsform.find("input[name=record]").parents("li").hide();this.context.statisticsform.find("input[name=record]").attr("disabled",false);this.context.statisticsform.find("input[name=money]").attr("disabled",false);M.DropdownList(tpl_pay,null,{});M.DropdownList(tpl_inn,null,{});}
M.DropdownList(tpl_consume,null,{});this.initrecodesumform(data.type);M.Popup(this.context.statisticsform,{"hideclass":"modal sm fade","showclass":"modal sm fade in","dragable":true,"drag":this.dragincome.toEventHandler(this)},function(){}.toEventHandler(this));}},initrecodesumform:function(type){tabmsg="收入";if(type=='2'){tabmsg="支出";}
this.context.statisticsform.children().find("span[tag=datetip]").html(tabmsg+'日期');var tpl_type=this.context.statisticsform.find("li[tag=typelist]");var tpl_consume=tpl_type.find("div[t=consumelist]");var tpl_pay=tpl_type.find("div[t=paytypelist]");tpl_consume.find("div[tag=list]").children("div").hide();tpl_consume.find("div[tag=list]").children("div[t="+type+"]").show();},statisticsform_click:function(e){var ele=M.EventEle(e);var t=ele.attr("tag");var parents=ele.parents("div[t=innlist]");if(parents.length==0){var tpl=this.context.statisticsform.children().find("div[t=innlist]");var style=tpl.children("div").css("display");if(style!="none"){tpl.removeClass("droplist_on").children("div").hide();}}
var parents=ele.parents("div[t=consumelist]");if(parents.length==0){var tpl=this.context.statisticsform.children().find("div[t=consumelist]");var style=tpl.children("div").css("display");if(style!="none"){tpl.removeClass("droplist_on").children("div").hide();}}
var parents=ele.parents("div[t=paytypelist]");if(parents.length==0){var tpl=this.context.statisticsform.children().find("div[t=paytypelist]");var style=tpl.children("div").css("display");if(style!="none"){tpl.removeClass("droplist_on").children("div").hide();}}
if(t=="save"){this.editsaveform();}},editsaveform:function(){var data=this.getfromdata();var msg="收入";if(data.type==2){msg='支出';}
if(M.isEmpty(data.typeid))
{alert("请选择"+msg+"项目");return;}
if(M.isEmpty(data.paytypecode))
{alert("请选择支付方式");return;}
if(isNaN(data.money)||data.money==0)
{alert("请输入"+msg+"金额");return;}
var fromtime=this.context.fromdate.val();var endtime=this.context.enddate.val();this.createtable();var innid=M.getinnid();data.fromdate=fromtime;data.enddate=endtime;data.currentinnid=innid;M._getjson("/Reportsource/editsavewaterstatistics",data,this.editsaveform_finished.toEventHandler(this));},editsaveform_finished:function(d){if(d.status=="success"){var list=d.data;this.showiwaterdetail(list);this._filterlist();this._closepopup();M.success("保存成功");}else{alert(d.msg);}},getfromdata:function(){var day=this.context.recodesumdate.val();var innid=this.context.statisticsform.find("div[t=innlist]").children("span").attr("value");var typeid=this.context.statisticsform.find("div[t=consumelist]").children("span").attr("value");var typename=this.context.statisticsform.find("div[t=consumelist]").children("span").text();var type=this.context.statisticsform.find("input[name=record]:checked").val();var money=M.getVal(this.context.statisticsform.find("input[name=money]"));var remark=M.getVal(this.context.statisticsform.find("textarea[name=remark]"))
var paytypecode=this.context.statisticsform.find("div[t=paytypelist]").children("span").attr("value");var paytypename=this.context.statisticsform.find("div[t=paytypelist]").children("span").text();var id=this.context.hide_data.attr("cid");var data={"day":day,"paytypecode":paytypecode,"paytypename":paytypename,"innid":innid,"typeid":typeid,"type":type,"money":money,"remark":remark,"typename":typename,"id":id};return data;},searchcondition_onchange:function(){this.cleartable();this.initdetaildata();},cleartable:function(){this.context.detail.children("tbody").children("tr[tag=d]").remove();this.context.detail.children("tbody").children('tr[tag=total]').children("td[tag=total]").each(function(){$(this).html('-');});},_export:function(){var tpl_operate=this.context.detail.find("th[t=operate]").find("div[tag=option]");var tpl_type=this.context.detail.find("th[t=type]").find("div[tag=option]");var tpl_consumetype=this.context.detail.find("th[t=consumetype]").find("div[tag=option]");var tpl_paytype=this.context.detail.find("th[t=paytype]").find("div[tag=option]");var data_operate=this._getfilterddata(tpl_operate).toString();var data_type=this._getfilterddata(tpl_type).toString();var data_consumetype=this._getfilterddata(tpl_consumetype).toString();var data_paytype=this._getfilterddata(tpl_paytype).toString();var fromtime=this.context.fromdate.val();var endtime=this.context.enddate.val();var innid=M.getinnid();var href='/Reportsource/otherwaterstaticsexport?innid='+innid+'&fromdate='+fromtime+'&enddate='+endtime
+'&operate='+data_operate+'&type='+data_type+'&consume='+data_consumetype+'&paytype='+data_paytype;this.context.exportexcel.attr("href",href);},_filterlist:function(){this.context.detail.find("tr[tag=consume]").show().attr("show",1);;var tpl_operate=this.context.detail.find("th[t=operate]").find("div[tag=option]");var tpl_type=this.context.detail.find("th[t=type]").find("div[tag=option]");var tpl_consumetype=this.context.detail.find("th[t=consumetype]").find("div[tag=option]");var tpl_paytype=this.context.detail.find("th[t=paytype]").find("div[tag=option]");var data_operate=this._getfilterddata(tpl_operate);this._hidelist(data_operate,'operate');var data_type=this._getfilterddata(tpl_type);this._hidelist(data_type,'type');var data_consumetype=this._getfilterddata(tpl_consumetype);this._hidelist(data_consumetype,'consumetypename');var data_paytype=this._getfilterddata(tpl_paytype);this._hidelist(data_paytype,'paytypename');var tpl_list=this.context.detail.find("tr[tag=consume][show=1]");alltotal=this._resize(tpl_list);this.context.detail.find("tr[tag=total]").children("td[tag=total]").html(this.dealprice(alltotal)).removeClass("red");;if(alltotal<0){this.context.detail.find("tr[tag=total]").children("td[tag=total]").addClass("red");}
this._export();},_resize:function(tpl_list){var data=[];var datetotal=[];var dateroomtotal=[];var that=this;var alltotal=0;tpl_list.each(function(){var tpl=$(this);var date=tpl.attr("date");var count=0;if(!M.isEmpty(data[date])){count=data[date]['count'];}
if(M.isEmpty(count)||count==0){data[date]={"count":1,"isfirst":0};}else{data[date].count=count+1;}
var type=tpl.children("td[tag=type]").attr("t");var amount=tpl.children("td[tag=amount]").attr("t");var total=datetotal[date];if(M.isEmpty(total)||total==0){total=0;}
if(type!=2){datetotal[date]=M.math_add(amount,total);}else{datetotal[date]=M.math_min(total,amount);}
if(type!=2){alltotal=M.math_add(amount,alltotal);}else{alltotal=M.math_min(alltotal,amount);}});tpl_list.each(function(){var tpl=$(this);var date=tpl.attr("date");var count=data[date]['count'];var t=tpl.attr('t');var total=datetotal[date];var isfirst=data[date]['isfirst'];if(!M.isEmpty(t)&&t=='f'){tpl.children("td[tag=date]").attr("rowspan",count);tpl.children("td[tag=roommoney]").attr("rowspan",count);tpl.children("td[tag=total]").attr("rowspan",count).attr("total",total).html(that.dealprice(total)).removeClass("red");if(total<0){tpl.children("td[tag=total]").addClass("red");}
data[date].isfirst=1;}else{if(isfirst!=1){tpl.children("td[tag=date]").attr("rowspan",count).show();tpl.children("td[tag=roommoney]").attr("rowspan",count).show();tpl.children("td[tag=total]").attr("rowspan",count).show().attr("total",total).html(that.dealprice(total)).removeClass("red");if(total<0){tpl.children("td[tag=total]").addClass("red");}
data[date].isfirst=1;}else{tpl.children("td[tag=date]").hide();tpl.children("td[tag=roommoney]").attr("rowspan",count).hide();tpl.children("td[tag=total]").hide().attr("total",total).html(that.dealprice(total));}}});for(var k in dateroomtotal){alltotal=alltotal+dateroomtotal[k];}
return alltotal;},_hidelist:function(list,type){if(list.length==0){return;}
for(var i=0;i<list.length;i++){var value=list[i];this.context.detail.find("td[tag="+type+"][t="+value+"]").parents("tr").hide().attr("show",0);}},_getfilterddata:function(list){var data=[];list.each(function(){var tpl=$(this);var checked=tpl.find("input").attr("checked");if(M.isEmpty(checked)||checked!='checked'){value=tpl.find("input").val();data.push(value);}});return data;},detail_click:function(e){var ele=M.EventEle(e);var t=ele.attr("tag");var id=ele.attr("wid");var target=null;var target_pay=null;if(t=='showlist'){var showstatus=ele.parents("th[tag=filter]").find("div[tag=list]").css("display");if(showstatus=='none'){this.context.detail.find("th[tag=filter]").find("div[tag=list]").hide();}
ele.parents("th[tag=filter]").find("div[tag=list]").toggle();ele.parents("th[tag=filter]").find("div[t=0]").find("input").attr("checked",false);ele.parents("th[tag=filter]").find("div[t=1]").find("input").attr("checked","checked");}
if(t=='filter'){this._filterlist();ele.parents("div[tag=list]").find("input").parents("div[tag=option]").attr("t","0");ele.parents("div[tag=list]").find("input:checked").parents("div[tag=option]").attr("t","1");ele.parents("div[tag=list]").hide();if(ele.parents("div[tag=list]").find("div[tag=all]").find("input").attr("checked")=='checked'){ele.parents("div[tag=list]").find("div[tag=all]").attr("t","1");}else{ele.parents("div[tag=list]").find("div[tag=all]").attr("t","0");}}
if(t=='alloption'){var checked=ele.attr("checked");if(checked=='checked'){ele.parents("div[tag=list]").find("input").attr("checked","checked");}else{ele.parents("div[tag=list]").find("input").attr("checked",false);ele.parents("div[tag=list]").find("input").attr("checked",false);}}
if(t=='seloption'){ele.parents("div[tag=list]").find("div[tag=all]").find("input").attr("checked",false);}
if(t=="edit"){this.editrecodesum(ele);}
if(t=='delete'){this.deleterecodesum(ele);}
if(t=="otherincome"){target=ele.children(".filter");}
if(t=="value"){target=ele.parent(".filter");}
if(t=="pay"){target_pay=ele.parent(".filter");}
if(t=="otherpay_val"){target_pay=ele.parent().children(".filter");}
if(!M.isEmpty(target))
{var showstatus=target.children(".ip-dropdown").css("display");target.children(".ip-dropdown").toggle();if(showstatus=="none"){var filterlist=target.children(".ip-dropdown").children("div").children("div");this._handleotherincomestatus(filterlist);target.parent(".filter").addClass("filter_on");}else{target.parent(".filter").removeClass("filter_on");}}
if(!M.isEmpty(target_pay))
{var showstatus=target_pay.children(".ip-dropdown").css("display");target_pay.children(".ip-dropdown").toggle();if(showstatus=="none"){var filterlist=target_pay.children(".ip-dropdown").children("div").children("div");this._handleotherpaystatus(filterlist);target_pay.parent(".filter").addClass("filter_on");}else{target_pay.parent(".filter").removeClass("filter_on");}}},_handleotherincomestatus:function(filterlist){var otherincomelist=this.selectstatus_income.split(",");if(this.selectstatus_income==''){filterlist.each(function(){$(this).children("label").children("input").attr("checked","checked");});}else{filterlist.each(function(){var value=$(this).children("label").children("input").attr("code");var has=0;for(var i=0;i<otherincomelist.length;i++){var l=otherincomelist[i];if(value==l){has=1;}}
if(has==1){$(this).children("label").children("input").attr("checked","checked");}else{$(this).children("label").children("input").attr("checked",false);$(this).children("label").children("input").attr("checked",false);}});}},_handleotherpaystatus:function(filterlist){var otherpaylist=this.selectstatus_pay.split(",");if(this.selectstatus_pay==''){filterlist.each(function(){$(this).children("label").children("input").attr("checked","checked");});}else{filterlist.each(function(){var value=$(this).children("label").children("input").attr("code");var has=0;for(var i=0;i<otherpaylist.length;i++){var l=otherpaylist[i];if(value==l){has=1;}}
if(has==1){$(this).children("label").children("input").attr("checked","checked");}else{$(this).children("label").children("input").attr("checked",false);}});}},initdetaildata_screening:function(d){this.context.detail.find("tr[tag=d]").remove();this.createtable();this.initdetaildata_finished(d);},document_click:function(e){var ele=M.EventEle(e);var style=ele.attr("tag");if(M.isEmpty(style)||style!='dropdownlist'){var tpl=ele.parents("th[tag=otherincome]");var hf=ele.parents("th[tag=otherpay]");if(style!="value"&&style!="otherincome"){if(tpl.length!=1){this.context.otherincome.hide();this.context.otherincome.parents("th[tag=otherincome]").removeClass("filter_on");}}
if(style!="pay"&&style!="otherpay"){if(hf.length!=1){this.context.otherpay.hide();this.context.otherpay.parents("th[tag=otherpay]").removeClass("filter_on");}}}
var filtertpl=ele.parents("th[tag=filter]");if(filtertpl.length==0){this.context.detail.find("th[tag=filter]").find("div[tag=list]").hide();}},searchbtn_click:function(){this.context.searchform.submit();},createtable:function(){var fromtime=this.context.fromdate.val();var endtime=this.context.enddate.val();var fromdate=M.strtotime(fromtime);var enddate=M.strtotime(endtime);var tbody=this.context.detail.children("tbody");var tmpl=tbody.children('tr[tag=tmpl]');while(fromdate<=enddate)
{var datestr=M.timeformat(enddate,'m/d');var dateval=M.timeformat(enddate);var daterow=tmpl.clone(true).show().attr('tag','d');daterow.attr('date',dateval);daterow.children('td[f=date]').html(datestr);daterow.insertBefore(tmpl);enddate.setDate(enddate.getDate()-1);}},initdetaildata:function(){var fromtime=this.context.fromdate.val();var endtime=this.context.enddate.val();var innid=M.getinnid();M._getjson("/Reportsource/getwaterstatistics",{"fromdate":fromtime,"enddate":endtime,"innid":innid},this.initdetaildata_finished.toEventHandler(this));},initdetaildata_finished:function(d){if(d.status=="success"){var list=d.list;if(M.isEmpty(list)||list.length==0){this.context.exportexcel.hide();}
if(!M.isEmpty(list))
this.showiwaterdetail(list);}},showroomdetail:function(roommoneylist){var tbody=this.context.detail.children("tbody");if(roommoneylist==null)
return;for(var i=0;i<roommoneylist.length;i++){var date=roommoneylist[i].date;var total='';if(roommoneylist[i].total==''){total="";}else{total=this.dealprice(roommoneylist[i].total);}
tbody.children("tr[tag=d][date="+date+"]").children('td[f=room]').html(total);}},showiwaterdetail:function(waterlist){var tbody=this.context.detail.children("tbody");var tpl_f=this.context.detail.find("tr[tag=tmpl_f]");var tpl_s=this.context.detail.find("tr[tag=tmpl_s]");this.context.detail.find("tr[tag=consume]").remove();var tpl_total=this.context.detail.find("tr[tag=total]");var alltotal=0;for(var i in waterlist){var date=waterlist[i].date;var total=0;var list=waterlist[i].list;var html='';if(list!=null&&list.length>0){for(var j=0;j<list.length;j++){var item=list[j];var tpl=null;var money=item.money;if(j==0){tpl=tpl_f.clone(true).show();tpl.attr("t",'f').children("td[tag=date]").attr("rowspan",list.length);tpl.children("td[tag=total]").attr("rowspan",list.length);}else{tpl=tpl_s.clone(true).show();tpl.children("td[tag=roommoney]").attr("rowspan",list.length).attr("t","0");}
if(item.type==3){tpl.children("td[tag=operate]").attr("t",'-1').text('-');tpl.children("td[tag=type]").attr("t","3").text("订单收入");tpl.children("td[tag=consumetypename]").attr("t","-").text("-");tpl.children("td[tag=amount]").attr("t","-").html("-");tpl.children("td[tag=paytypename]").attr("t","-1").text("-");tpl.children("td[tag=op]").html('-');tpl.attr("date",date).attr("tag","consume").children("td[tag=date]").text(date);tpl.children("td[tag=amount]").attr("t",item.money).text(this.dealprice(item.money));tpl_total.before(tpl);total=M.math_add(total,money);}else{waterlist[i].appendmoney=0;tpl.children("td[tag=roommoney]").attr("rowspan",list.length).attr("t",item.money).text(this.dealprice(waterlist[i].appendmoney));tpl.attr("cid",item.id).attr("date",date).attr("tag","consume").children("td[tag=date]").text(date);html='';var title=list[j].remark;if(title=="")
title="暂无备注";if(M.isEmpty(item.username)){item.username='-';item.createby='-1';}
tpl.children("td[tag=time]").text(item.time);tpl.children("td[tag=operate]").attr("t",item.createby).text(item.username);var typename='收入';if(item.type==2){typename='支出';tpl.children("td[tag=type]").addClass("red");tpl.children("td[tag=consumetypename]").addClass("red");tpl.children("td[tag=amount]").addClass("red");tpl.children("td[tag=paytypename]").addClass("red");tpl.children("td[tag=remark]").addClass("red");tpl.children("td[tag=operate]").addClass("red");total=M.math_min(total,money);}else{total=M.math_add(total,money);}
if(M.isEmpty(item.paytypename)){item.paytypename='-';item.paytypecode='-1';}
tpl.children("td[tag=type]").attr("t",item.type).text(typename);tpl.children("td[tag=consumetypename]").attr("t",item.typeid).text(item.typename);tpl.children("td[tag=amount]").attr("t",item.money).html(this.dealprice(money));tpl.children("td[tag=paytypename]").attr("t",item.paytypecode).text(item.paytypename);tpl.children("td[tag=remark]").text(item.remark);tpl_total.before(tpl);}}}
alltotal=M.math_add(alltotal,total);tbody.find("tr[date="+date+"]").children('td[tag=total]').attr("total",total).html(this.dealprice(total));if(total<0){tbody.find("tr[date="+date+"]").children('td[tag=total]').addClass("red");}}
tpl_total.children("td[tag=total]").html(this.dealprice(alltotal));if(alltotal<0){tpl_total.children("td[tag=total]").addClass("red");}},incomestatisticsform:function(e){var ele=M.EventEle(e);var t=ele.attr("tag");if(t=='buttons'||t=="dropdown"){if(t=='dropdown')ele=ele.parent();var top=ele.offset().top+ele.outerHeight()+2;var left=ele.offset().left;this.context.incometypelist.css({"top":top,"left":left,"z-index":1060}).show();M.stopevent(e);}
if(t=="closebtn"){this.context.incometypelist.css("display","none");}
if(t=="addsave"){this.addsaveform(this.context.incomestatisticsform,"收入");}
if(t!='buttons'&&t!='dropdown')
{this.context.incometypelist.css("display","none");}
if(t=='editsave'){this.editsaveform(this.context.incomestatisticsform,"收入");}},paystatisticsform:function(e){var ele=M.EventEle(e);var t=ele.attr("tag");if(t=='buttons'||t=="dropdown"){if(t=='dropdown')ele=ele.parent();var top=ele.offset().top+ele.outerHeight()+2;var left=ele.offset().left;this.context.paytypelist.css({"top":top,"left":left,"z-index":1060}).show();M.stopevent(e);}
if(t=="closebtn"){this.context.paytypelist.css("display","none");}
if(t=="addsave"){this.addsaveform(this.context.paystatisticsform,"支出");}
if(t!='buttons'&&t!='dropdown')
{this.context.paytypelist.css("display","none");}
if(t=='editsave'){this.editsaveform(this.context.paystatisticsform,"支出");}},addstatistics_click:function(e){var ele=M.EventEle(e);var t=ele.attr("tag");if(t=='show_hide'){this.show_hide();}
if(t=="income"){this.context.editpop.css("display","none");this.context.addstatistics.removeClass("btn-box-on");this.statisticsformshow(t);}
if(t=="pay"){this.context.editpop.css("display","none");this.context.addstatistics.removeClass("btn-box-on");this.statisticsformshow(t);}},dragincome:function(){var display=this.context.incometypelist.css("display");var ele=this.context.incomestatisticsform.children().find("button[tag=buttons]");if(display=="none"){return;}
var top=ele.offset().top+ele.outerHeight()+2;var left=ele.offset().left;this.context.incometypelist.css({"top":top,"left":left,"z-index":1060}).show();M.stopevent(ele);},dealprice:function(num){if(num=='0'||num=='-'){return'-';}else{num=M.math_format(num);return'¥  '+num;}},dragpay:function(){var display=this.context.paytypelist.css("display");var ele=this.context.paystatisticsform.children().find("button[tag=buttons]");if(display=="none"){return;}
var top=ele.offset().top+ele.outerHeight()+2;var left=ele.offset().left;this.context.paytypelist.css({"top":top,"left":left,"z-index":1060}).show();M.stopevent(ele);},statisticsformshow:function(t){if(t=='income'){this.cleardata(this.context.incomestatisticsform,'收入');M.Popup(this.context.incomestatisticsform,{"hideclass":"modal sm fade","showclass":"modal sm fade in","dragable":true,"drag":this.dragincome.toEventHandler(this)},function(){}.toEventHandler(this));}
if(t=='pay'){this.cleardata(this.context.paystatisticsform,'支出');M.Popup(this.context.paystatisticsform,{"hideclass":"modal sm fade","showclass":"modal sm fade in","dragable":true,"drag":this.dragpay.toEventHandler(this)},function(){}.toEventHandler(this));}},cleardata:function(e,msg){var tip="记录收入";if(msg=="支出")
tip="记录支出";var timenow=this.context.hide_data.attr("timenow");e.children("div").children("h4").text(tip);e.children().find("input[name=adddate]").val(timenow);e.children().find("a[name=savebutton]").attr("tag","addsave");e.children().find("select[name=innid]").val("0");e.children().find("button[tag=buttons]").html('选择'+msg+'项目<span  tag="dropdown" class="caret"></span>');M.emptyVal(e.children().find("textarea[name=remark]"))
e.children().find("input[name=typeid]").val("");M.emptyVal(e.children().find("input[name=money]"));this.context.hide_data.attr("typename","");this.context.hide_data.attr("wid","");},show_hide:function(){var display=this.context.addstatistics.children("div").css("display");if(display=="block"){this.context.addstatistics.removeClass("btn-box-on");}else{this.context.addstatistics.addClass("btn-box-on");}},NoUndefined:function(str)
{return M.isEmpty(str)?"":str;},_closepopup:function()
{M.ClosePopup();},destroy:function(){}});