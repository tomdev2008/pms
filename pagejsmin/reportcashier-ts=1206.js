M.Page.ReportcashierPage=M.createClass();M.extend(M.Page.ReportcashierPage.prototype,{context:{},initpage:null,sorttarget:null,orderby:'lastdate',desc:'desc',levelname:'',paytypelist:{"list":[],"length":0,"select":"all"},paystatuslist:{"list":[],"length":0,"select":"all"},checkoutstatuslist:{"list":[],"length":0,"select":"all"},gatewaylist:{"list":[],"length":0,"select":"all"},platformlist:{"list":[],"length":0,"select":"all"},settlelist:{"list":[],"length":0,"select":"all"},miotsortlist:{"list":[],"length":0,"select":"all"},levelstr:'',tpl_guest:'<tr tag="guest" class="cursor-p" gid="${id}">'
+'<td>${levelname}</td>'
+'<td>${guestname}</td>'
+'<td>${phone}</td>'
+'<td>${cityname}</td>'
+'<td>${birthday}</td>'
+'<td>${totalprice}</td>'
+'<td>${remark}</td>'
+'<td>${lastenddate}</td>'
+'</tr>',tpl_guest_detail:'<td>${levelname}</td>'
+'<td>${guestname}</td>'
+'<td>${phone}</td>'
+'<td>${cityname}</td>'
+'<td>${birthday}</td>'
+'<td>${totalprice}</td>'
+'<td>${remark}</td>'
+'<td>${lastenddate}</td>',wkzorder_tpl:'<tr t="${billdate}">'
+'<td tag="${billdate}">${billdate}</td>'
+'<td>${payname}</td>'
+'<td>${ordercount}</td>'
+'<td>¥${total}<a href="#?" tag="${tag}" class="ml5" id="orderdetail" gateway="${gateway}" class="ml5" billid="${billid}">(明细)</a></td>'
+'<td>${rant}</td>'
+'<td class="${unpaidcss}">¥${unpaid}</td>'
+'<td class="${paidcss}">¥${paid}</td>'
+'<td>${account}</td>'
+'<td class="${paidoncss}">${paidon}</td>'
+'</tr>',wkzorderdetail_tpl:'<tr  tag="list">'
+'<td tag="${addtime}">${createon}</td>'
+'<td>${guestinfo}<br>${roomname}<br>${arriveinfo}</td>'
+'<td>${gateway}</td>'
+'<td>¥${totalprice}</td>'
+'<td>${orderfrom}</td>'
+'<td class="${css}">${accountstatus}</td>'
+'<td>${settletime}</td>'
+'</tr>',wkzappletorderdetail_tpl:'<tr  tag="list">'
+'<td tag="${addtime}">${createon}</td>'
+'<td>${guestinfo}<br>${roomname}<br>${arriveinfo}</td>'
+'<td>${gateway}</td>'
+'<td>¥${totalprice}</td>'
+'<td>小程序</td>'
+'</tr>',apporderdetail_tpl:'<tr class="${css}" tag="list">'
+'<td tag="${addtime}">${addtime}</td>'
+'<td tag="${enddate}">${enddate}</td>'
+'<td>${guestinfo}<br>${roomname}<br>${arriveinfo}</td>'
+'<td>${gateway}</td>'
+'<td>¥${totalprice}</td>'
+'<td>${orderfrom}</td>'
+'<td>${accountstatus}</td>'
+'<td>${settletime}</td>'
+'</tr>',bankbilllist_tpl:'<tr  tag="list" billid="${id}" billtype="${billtype}">'
+'<td tag="billdate" date="${billdate}">${billdate}</td>'
+'<td tag="settlecycle" settlecycle="${settlecycle}">${settlecyclestr}</td>'
+'<td>${bankname}</td>'
+'<td>${cardnumber}</td>'
+'<td>${paidtotal}</td>'
+'<td class="${css}">${ispaidmsg}</td>'
+'<td>${paiddate}</td>'
+'<td><a tag="showDetail" href="#?" id="${id}">明细</a></td>'
+'</tr>',bankbilldetail_tpl:'<tr tag="data" from="${from}">'
+'<td tag="plat">${platform}</td>'
+'{{if from=="cm"&& (type=="manual_plus" ||type=="manual_minus") }}'
+'<td colspan="3">{{html comment}}</td>'
+'{{else}}'
+'<td>${gateway}</td>'
+'<td>${total}</td>'
+'<td>${billrate}</td>'
+'{{/if}}'
+'{{if paidtotal<0 }}'
+'<td class="bold red">${paidtotal}</td>'
+'{{else}}'
+'<td class="bold">${paidtotal}</td>'
+'{{/if}}'
+'</tr>',orderdetailofbill_tpl:'<tr tag="data" from="${from}">'
+'<td tag="${addtime}">${createon}</td>'
+'<td>${guestinfo}<br>${roomname}<br>${arriveinfo}</td>'
+'<td>${gateway}</td>'
+'<td>${totalprice}</td>'
+'<td>${orderfrom}</td>'
+'<td>${accountstatus}</td>'
+'</tr>',orderdetailofbill_settle_tpl:'<tr tag="data" from="${from}">'
+'<td tag="${addtime}">${createon}</td>'
+'<td>'
+'{{if warnmsgarr!="" }}'
+'{{each warnmsgarr }}'
+'<div class="tip-warn light" style="margin:-4px -8px 5px;">${$value}</div>'
+'{{/each}}'
+'{{/if}}'
+'{{if allowance!="" }}'
+'<div class="tip-remind light" style="margin:-4px -8px 5px;">${allowance}</div>'
+'{{/if}}'
+'${guestinfo}<br>${roomname}<br>${arriveinfo}</td>'
+'<td>${totalprice}</td>'
+'<td>${accountstatus}</td>'
+'</tr>',msgtip:'结算规则：<br/> - 收银台订单，按照交易日期T+2进行结算<br/> - 微官网订单，按照交易日期T+2进行结算<br/> - 代销订单，每月15日起的首个工作日结算上月所有离店订单房费',tpl_ota_tr:'<tr tag="list" status="${settlement_status}">'
+'<td>${checkindate}</td>'
+'<td>${enddate}</td>'
+'<td>${orderinfo}</td>'
+'<td>${payprice}</td>'
+'<td>${settlement_name}</td>'
+'<td>${settlement_time}</td>'
+'</tr>',sort_otadetail:'checkindate',getdatetime:function(){var date=M.getTime();return date;},init:function(){this.initDOM();this.initEvent();this._initdatepicker();},initDOM:function(){this.context.innlist=$("#innlist");this.context.datelist=$("#datelist");this.context.datetypelist=$("#datetypelist");this.context.datepicker=$("#datepicker");this.context.paylist=$("#paylist");this.context.fromdate=$("#fromdate");this.context.enddate=$("#enddate");this.context.datetype=$("#datetype");this.context.pagelist=$("#pagelist");this.context.body=$("body");this.context.billlist=$("#billlist");this.context.menutab=$("#menutab");this.context.export=$("#export");this.context.orderDetail=$("#orderDetail");this.context.transparentlayer=$("#transparentlayer");this.context.billlisttip=$("#billlisttip");this.context.wkzOrderDetail=$("#wkzOrderDetail");this.context.needsetcard=$("#needsetcard");this.context.historyData=$("#historyData");this.context.wkzHistory=$("#wkzHistory");this.context.cashierHistory=$("#cashierHistory");this.context.orderdetail=$("#orderdetail");this.context.orderHistoryDetail=$("#orderHistoryDetail");this.context.bankOrderDetail=$("#bankOrderDetail");M.DropdownList(this.context.innlist,this.changeinnlist.toEventHandler(this),{});M.DropdownList(this.context.datelist,this.changedatelist.toEventHandler(this),{});M.DropdownList(this.context.datetypelist,this.changedatetypelist.toEventHandler(this),{});this.context.fromdate.datepicker({changeMonth:true,changeYear:true});this.context.enddate.datepicker({changeMonth:true,changeYear:true});this.context.miotOrderDetail=$("#miotOrderDetail");this.context.BankOrderDetail=$("#getBankOrderDetail");this.context.orderDetailOfBill=$("#orderDetailOfBill");this.context.cmOrderDetailOfBill=$("#cmOrderDetailOfBill");this.context.tabOtaDetail=$("#tabOtaDetail");this.context.wkzAppletOrderDetail=$("#wkzAppletOrderDetail");this.context.billdetailfrom=$("#billdetailfrom");},initEvent:function(){this.context.datepicker.bind('click',this.datepicker_click.toEventHandler(this));this.context.paylist.bind('click',this.paylist_click.toEventHandler(this));this.context.pagelist.bind('click',this.pagelist_click.toEventHandler(this));this.context.body.bind("click",this.body_click.toEventHandler(this));this.context.menutab.bind("click",this.menutab_click.toEventHandler(this));this.context.billlist.bind("click",this.billlist_click.toEventHandler(this));this.context.historyData.bind("click",this.historyData_click.toEventHandler(this));this.context.orderdetail.live('click',this.orderdetail_click.toEventHandler(this));this.context.cashierHistory.live('click',this.cashierHistory_click.toEventHandler(this));this.context.wkzOrderDetail.live('click',this.wkzOrderDetail_click.toEventHandler(this));this.context.billlist.children("table").find('tr').eq(0).children('th[tag=settlecycle]').children("i").attr("title",'').tooltip({position:{my:"left+15 top+20",at:"left bottom"},track:1,content:this.msgtip,show:{duration:100}});this.context.miotOrderDetail.live('click',this.miotOrderDetail_click.toEventHandler(this));this.context.BankOrderDetail.live('click',this.BankOrderDetail_click.toEventHandler(this));this.context.tabOtaDetail.bind('click',this.tabOtaDetail_click.toEventHandler(this));this.context.export.bind('click',this.export_click.toEventHandler(this));},tabOtaDetail_click:function(e){var ele=M.EventEle(e);var t=ele.attr('tag');if(t=='checkindate'){this.sort_otadetail='checkindate';this.context.tabOtaDetail.find('th').removeClass('sort_on');this.context.tabOtaDetail.find('th[tag=checkindate]').addClass('sort_on');this._getYZGOrder();}else if(t=='enddate'){this.sort_otadetail='enddate';this.context.tabOtaDetail.find('th').removeClass('sort_on');this.context.tabOtaDetail.find('th[tag=enddate]').addClass('sort_on');this._getYZGOrder();}else if(t=='settlement'){ele.children('div[tag=settlement_list]').show();}else if(t=='settlement_i'){ele.parent().children('div[tag=settlement_list]').show();}else if(t=='settlement_confirm'){var html_div=ele.parent().parent('div');html_div.parent().hide();this._changetocurrentsort();this._getYZGOrder();}else if(t=='orderstatus'){ele.children('div[tag=orderstatus_list]').show();}else if(t=='orderstatus_i'){ele.parent().children('div[tag=orderstatus_list]').show();}else if(t=='orderstatus_confirm'){var html_div=ele.parent().parent('div');html_div.parent().hide();this._changetocurrentsort();this._getYZGOrder();}else if(t=='ordertype'){ele.children('div[tag=ordertype_list]').show();}else if(t=='ordertype_i'){ele.parent().children('div[tag=ordertype_list]').show();}else if(t=='ordertype_confirm'){var html_div=ele.parent().parent('div');html_div.parent().hide();this._changetocurrentsort();this._getYZGOrder();}},settlement_confirm:function(){var target=this.context.tabOtaDetail.find('tr[tag=title]').find('div[tag=settlement_list]').children('div');var arr_status=Array();target.children('div[tag=list]').each(function(){if($(this).find('input').attr('checked')=='checked'){str_status=$(this).find('input').val();arr_status.push(str_status);}});var str_status=arr_status.join(',');return str_status;},orderstatus_confirm:function(){var target=this.context.tabOtaDetail.find('tr[tag=title]').find('div[tag=orderstatus_list]').children('div');var arr_status=Array();target.children('div[tag=list]').each(function(){if($(this).find('input').attr('checked')=='checked'){str_status=$(this).find('input').val();arr_status.push(str_status);}});var str_status=arr_status.join(',');return str_status;},ordertype_confirm:function(){var target=this.context.tabOtaDetail.find('tr[tag=title]').find('div[tag=ordertype_list]').children('div');var arr_status=Array();target.children('div[tag=list]').each(function(){if($(this).find('input').attr('checked')=='checked'){str_status=$(this).find('input').val();arr_status.push(str_status);}});var str_status=arr_status.join(',');return str_status;},changeinnlist:function(ele){var innid=ele.attr("value");var tpl=this.context.menutab.children("li.on");var type=tpl.find("a").attr("tag");if(type=="bill"){this._initdatepicker();}
if(type=="wkzorder"){this._getWkzOrder();}
if(type=="appletorder"){this._getWkzappletOrder();}
if(type=="pay"){this._getcloudlist();}
if(type=="miotorder"){this._changetocurrentsort();this._getMiotOrder();}
if(type=='yzgorder'){this._changetocurrentsort();this._getYZGOrder();}
if(!type){var tpl=this.context.historyData.children("a.cursor-d");var tag=tpl.attr("tag");if(tag=="showWkzHistory"){this.getWkzHistory();}
if(tag=="showCashierHistory"){this._getCashierHistory();}}},changedatelist:function(ele){var dateval=ele.attr("value");var tpl=this.context.menutab.children("li.on");var type=tpl.find("a").attr("tag");if(type=="bill"){this.changeDateVal(dateval);this._initdatepicker();}
if(type=="wkzorder"){this.changeDateVal(dateval);this._getWkzOrder();}
if(type=="pay"){this.changeDateVal(dateval);this._getcloudlist();}
if(type=="miotorder"){this.changeDateVal(dateval);this._changetocurrentsort();this._getMiotOrder();}
if(type=='yzgorder'){this.changeDateVal(dateval);this._changetocurrentsort();this._getYZGOrder();}
if(!type){var tpl=this.context.historyData.children("a.cursor-d");var tag=tpl.attr("tag");if(tag=="showWkzHistory"){this.getWkzHistory();}
if(tag=="showCashierHistory"){this._getCashierHistory();}}},changedatetypelist:function(ele){var datetypeval=ele.attr("value");var tpl=this.context.menutab.children("li.on");this.context.datetype.val(datetypeval);;var type=tpl.find("a").attr("tag");if(type=="miotorder"){this._changetocurrentsort();this._getMiotOrder();}
if(type=='yzgorder'){this._changetocurrentsort();this._getYZGOrder();}},changeDateVal:function(dateval){var mydate=new Date();var timeNow=mydate.getTime();var startDate='';var endDate='';var startdiff='';var enddiff='';var dateStr='';if(dateval=="today"){startDate=new Date(timeNow);endDate=new Date(timeNow);}
if(dateval=="yesterday"){var timediff=timeNow-24*3600*1000;startDate=new Date(timediff);endDate=new Date(timediff);}
if(dateval=="thismonth"){startDate=new Date(timeNow);endDate=new Date(timeNow);}
if(dateval=="last7days"){startdiff=timeNow-7*24*3600*1000;enddiff=timeNow-24*3600*1000;startDate=new Date(startdiff);endDate=new Date(enddiff);}
if(dateval=="last30days"){startdiff=timeNow-30*24*3600*1000;enddiff=timeNow-24*3600*1000;startDate=new Date(startdiff);endDate=new Date(enddiff);}
var startMonth=(startDate.getMonth()+1)>9?(startDate.getMonth()+1):'0'+(startDate.getMonth()+1);var startDay=(startDate.getDate())>9?(startDate.getDate()):'0'+(startDate.getDate());var endMonth=(endDate.getMonth()+1)>9?(endDate.getMonth()+1):'0'+(endDate.getMonth()+1);var endDay=(endDate.getDate())>9?(endDate.getDate()):'0'+(endDate.getDate());if(dateval=="thismonth"){startDay="01";}
var fromdate=startDate.getFullYear()+"-"+startMonth+"-"+startDay;var enddate=endDate.getFullYear()+"-"+endMonth+"-"+endDay;this.context.fromdate.val(fromdate);this.context.enddate.val(enddate);dateStr=startMonth+"月"+startDay+"日"+" - "+endMonth+"月"+endDay+"日";this.context.datepicker.children("input[tag=showrange]").val(dateStr);},wkzOrderDetail_click:function(e){var ele=M.EventEle(e);var tag=ele.attr("tag");if(tag=="gatewayfilter"){ele.children("div").show();this.context.wkzOrderDetail.children("table").find("div[tag=settlestatusfilter]").children("div").hide();this.context.wkzOrderDetail.children("table").find("div[tag=platformfilter]").children("div").hide();}
if(tag=="settlestatusfilter"){ele.children("div").show();this.context.wkzOrderDetail.children("table").find("div[tag=gatewayfilter]").children("div").hide();this.context.wkzOrderDetail.children("table").find("div[tag=platformfilter]").children("div").hide();}
if(tag=="confirmgatewayfilter"){var list=this.context.wkzOrderDetail.find("div[tag=gatewayfilter]").find("input:checked");gatewaylist=this._getselectlist(list);this.gatewaylist.list=gatewaylist;this.gatewaylist.length=this.context.wkzOrderDetail.find("div[tag=gatewayfilter]").find("input").length;if(gatewaylist.length==0){this.gatewaylist.select="none";}
if(gatewaylist.length==0){M.error("请您至少选择一个支付方式来筛选");return;}
this.context.wkzOrderDetail.children("table").find("div[tag=gatewayfilter]").children("div").hide();this._wkzOrderDetailSearch();}
if(tag=="confirmstatusfilter"){var list=this.context.wkzOrderDetail.find("div[tag=settlestatusfilter]").find("input:checked");settlestatus=this._getselectlist(list);this.settlelist.list=settlestatus;this.settlelist.length=this.context.wkzOrderDetail.find("div[tag=settlestatusfilter]").find("input").length;if(settlestatus.length==0){this.settlelist.select="none";}
if(settlestatus.length==0){M.error("请您至少选择一个结算状态来筛选");return;}
this.context.wkzOrderDetail.children("table").find("div[tag=settlestatusfilter]").children("div").hide();this._wkzOrderDetailSearch();}},_wkzOrderDetailSearch:function(e){var fromdate=this.context.fromdate.val();var enddate=this.context.enddate.val();var innid=M.getinnid();var data={"innid":innid,"fromdate":fromdate,"enddate":enddate};if(this.gatewaylist.list.length!=this.gatewaylist.length){data.gatewaylist=this.gatewaylist.list.toString();}
if(this.settlelist.list.length!=this.settlelist.length){data.settlelist=this.settlelist.list.toString();}
if((this.gatewaylist.length==0&&this.gatewaylist.select=="none")||(this.settlelist.length==0&&this.settlelist.select=="none")){this.context.wkzOrderDetail.children("table").hide();this.context.paylist.find("div[tag=noorder]").show();return;}
this._showloadingstatus();M._getjson("/Microinn/getWkzOrderDetail",data,this.getWkzOrder_finished.toEventHandler(this));},historyData_click:function(e){var ele=M.EventEle(e);var tag=ele.attr("tag");this.context.menutab.children("li").removeClass("on");if(tag=="showWkzHistory"){ele.addClass("light cursor-d");this.context.historyData.children("a[tag=showCashierHistory]").removeClass("light cursor-d");this.context.billlisttip.hide();this.context.billlist.hide();this.context.wkzHistory.show();this.context.cashierHistory.hide();this.getWkzHistory();}
if(tag=="showCashierHistory"){ele.addClass("light cursor-d");this.context.historyData.children("a[tag=showWkzHistory]").removeClass("light cursor-d");this.context.billlisttip.hide();this.context.billlist.hide();this.context.wkzHistory.hide();this.context.cashierHistory.show();this._getCashierHistory();}},getWkzHistory:function(e){var innid=M.getinnid();var data={"innid":innid,"fromdate":"2014-04-01","enddate":"2015-03-28"};M._getjson("/Microinn/getWkzOrderHistory",data,this.getWkzHistory_finished.toEventHandler(this));},getWkzHistory_finished:function(d){var orderlist=d.order;var showcardset=d.showcardset;this.handlerCardSet(showcardset);this.context.wkzHistory.children("div[tag=noorder]").hide();var ordertpl=$.tmpl(this.wkzorder_tpl,orderlist);var tpl=this.context.wkzHistory.children("table").children("tbody");tpl.children("tr").eq(0).nextAll().remove();tpl.children("tr").eq(0).after(ordertpl);var size=0;var ordercount=total=unpaid=paid=0;for(var i=0;i<orderlist.length;i++){var date=orderlist[i].billdate;size=tpl.children("tr[t="+date+"]").size();if(size>1){tpl.children("tr[t="+date+"]").eq(0).children("td[tag="+date+"]").attr("rowspan",2);tpl.children("tr[t="+date+"]").eq(1).children("td[tag="+date+"]").remove();}
ordercount+=parseInt(orderlist[i].ordercount);total+=parseInt(orderlist[i].total);unpaid+=orderlist[i].unpaid;paid+=orderlist[i].paid;}
if(isNaN(ordercount))
ordercount=0;if(isNaN(total))
total=0;if(isNaN(unpaid))
unpaid=0;if(isNaN(paid))
paid=0;var totalhtml='<tr><td>总计</td><td></td><td>'+ordercount+'</td><td>¥'+total+'</td><td></td><td class="red">¥'+Math.round(unpaid*100)/100+'</td><td>¥'+Math.round(paid*100)/100+'</td><td></td><td></td></tr>';tpl.children("tr:last").after(totalhtml);},_getCashierHistory:function(e){var innid=M.getinnid();var data={"innid":innid,"fromdate":"2014-08-01","enddate":"2015-03-31"};M._getjson("/Reportsource/getbilllist",data,this.getCashierHistory_finished.toEventHandler(this));},getCashierHistory_finished:function(d){if(d.status=="success"){var temp=d.list;var showcardset=d.showcardset;this.handlerCardSet(showcardset);var list=temp.list;var tpl_f=this.context.cashierHistory.find("tr[tag=tpl_f]");var tpl_s=this.context.cashierHistory.find("tr[tag=tpl_s]");var tpl_total=this.context.cashierHistory.find("tr[tag=total]").hide();this.context.cashierHistory.find("tr[tag=b]").remove();if(list.length==0){this.context.cashierHistory.find("tr[tag=noresult]").show();return;}
for(i in list){var data=list[i];var length=data.length;var billlist=data.list;var count=0;for(k in billlist){var bill=billlist[k];if(count==0){var tpl=tpl_f.clone(true).attr("tag","b").attr("date",i).attr("gateway",bill.gateway).show();tpl.children("td[tag=date]").attr("rowspan",length).text(i);tpl.children("td[tag=billdate]").attr("date",bill.billdate).text(bill.billdate);tpl.children("td[tag=paytypename]").text(bill.paytypename);tpl.children("td[tag=amount]").html(bill.total+'<a class="ml10" href="#?" tag="showDetail">明细</a>');tpl.children("td[tag=rate]").text(bill.billrate+"%");tpl.children("td[tag=payamount]").text(bill.needpay);tpl.children("td[tag=account]").text(bill.accountid);tpl.children("td[tag=total]").attr("rowspan",length).text(data.total);tpl_f.before(tpl);count++;}else{var tpl=tpl_s.clone(true).attr("tag","b").attr("date",i).attr("gateway",bill.gateway).show();tpl.children("td[tag=billdate]").attr("date",bill.billdate).text(bill.billdate);tpl.children("td[tag=paytypename]").text(bill.paytypename);tpl.children("td[tag=amount]").html(bill.total+'<a class="ml10" href="#?" tag="showDetail">明细</a>');tpl.children("td[tag=rate]").text(bill.billrate+"%");tpl.children("td[tag=payamount]").text(bill.needpay);tpl.children("td[tag=account]").text(bill.accountid);tpl_f.before(tpl);}}}
tpl_total.show().children("td[tag=pay]").text(temp.paytotal);tpl_total.children("td[tag=checkout]").text(temp.checkouttotal);tpl_total.children("td[tag=total]").text(temp.alltotal);}else{M.error(d.msg);}},orderdetail_click:function(e){var ele=M.EventEle(e);var paytype=ele.attr("gateway");var tag=ele.attr("tag");var billid=ele.attr("billid");var data={"a":"getbilldetail","billid":billid,"paytype":paytype,"tag":tag};M._getjson("/Microinn/getBillDetail",data,this.orderdetail_finished.toEventHandler(this));M.Popup(this.context.orderHistoryDetail,{"hideclass":"modal viewguest fade","showclass":"modal viewguest fade in"},function(){}.toEventHandler(this));},orderdetail_finished:function(d){var data=eval(d);var tr="<tr><th width='80'>预订时间</th><th>预订信息</th><th width='200'>客人信息</th><th width='180'>入住信息</th><th width='60'>金额</th><th width='80'>订单来源</th></tr>";for(var i=0;i<data.length;i++){tr+="<tr><td>"+data[i].addtime+"</td><td>"+data[i].roomname+"</td><td>"+data[i].guestinfo+"</td><td>"+data[i].arriveinfo+"</td><td>"+data[i].totalprice+"</td><td>"+data[i].orderfrom+"</td></tr>";}
this.context.orderHistoryDetail.children("div[class=modal-body]").find("tbody").contents().remove();this.context.orderHistoryDetail.children("div[class=modal-body]").find("tbody").html(tr);},cashierHistory_click:function(e){var ele=M.EventEle(e);var tag=ele.attr("tag");if(tag=="showDetail"){this.showbilldetail(ele);}},billlist_click:function(e){var ele=M.EventEle(e);var tag=ele.attr("tag");if(tag=="filter"){ele.children("div[tag=filterStatusBox]").toggle();}
if(tag=="paystatusconfirm"){var list=this.context.billlist.find("div[tag=filter]").find("input:checked");var settlestatus=[];list.each(function(){var value=$(this).val();settlestatus.push(value);});if(settlestatus.length==0){M.error("请您至少选择一个结算状态来筛选");return;}
this.context.billlist.find("div[tag=filter]").children("div[tag=filterStatusBox]").hide();var fromdate=this.context.fromdate.val();var enddate=this.context.enddate.val();var innid=M.getinnid();var data={"innid":innid,"fromdate":fromdate,"enddate":enddate};data.ispaid=settlestatus.toString();this._showloadingstatus();M._getjson("/Reportsource/getbankbilllist",data,this.getbankbilllist_finished.toEventHandler(this));}
if(tag=="showDetail"){this.showbankbilldetail(ele);}},showbankbilldetail:function(ele){var innid=M.getinnid();var date=ele.parents("tr").children("td[tag=billdate]").attr("date");var settlecycle=ele.parents("tr").children("td[tag=settlecycle]").attr("settlecycle");var datetime=M.strtotime(date);var billtype=ele.parents("tr").attr('billtype');var billid=ele.parents("tr").attr('billid');if(billtype=='voucher'){var data={"innid":innid,'billid':billid};M._getjson("/Reportsource/getbillinfo",data,this.getbillinfo_finished.toEventHandler(this));}else{var data={"innid":innid,"date":date,"settlecycle":settlecycle,'billtype':billtype,'billid':billid};this._showloadingstatus();M._getjson("/Reportsource/getbankbilldetail",data,this.getbankbilldetail_finished.toEventHandler(this));}},getbillinfo_finished:function(d){if(d.status=="success"){var detail=d.data;var list=detail.list;var tpl='<th width="140">购买时间</th>';tpl+='<th>描述</th>';tpl+='<th width="60">付款金额</th>';tpl+='<th width="60">返利金额</th>';tpl+='<th width="60">结算金额</th>';this.context.billdetailfrom.find('tr[tag=menu]').html(tpl);var html='';var commission=0;for(var i in list){var item=list[i];html+='<tr tag="billdetail">';html+='<td>'+item.createon+'</td>';html+='<td>'+item.guestname+','+item.phone+'</td>';html+='<td>'+item.payamount+'</td>';html+='<td>'+item.commission+'</td>';html+='<td>'+item.settleamount+'</td>';html+='</tr>';commission=M.math_add(commission,item.commission);}
this.context.billdetailfrom.find('tr[tag=billdetail]').remove();this.context.billdetailfrom.find('tr[tag=menu]').after(html);html='<td>总计</td>'
html+='<td></td>'
html+='<td>'+detail.total+'</td>'
html+='<td>'+commission+'</td>'
html+='<td>'+detail.needpay+'</td>';this.context.billdetailfrom.find('tr[tag=total]').html(html);M.Popup(this.context.billdetailfrom,{"hideclass":"modal large fade","showclass":"modal large fade in","dragable":true});}else{alert(d.msg);}},getbankbilldetail_finished:function(d){this._hideloadingstatus();if(d.status=="success"){var date=d.req.date;var settlecycle=d.req.settlecycle;var list=d.list;var total=d.total;var paidtotal=d.paidtotal;var from=list[0].from;var channelname='';if(from=='wkz'&&settlecycle==1){this.context.bankOrderDetail.find("div[tag=data]").children("table[tag=wkzbillfrom]").show();this.context.bankOrderDetail.find("div[tag=data]").children("table[tag=billfrom]").hide();}else{var detailtpl=$.tmpl(this.bankbilldetail_tpl,list);this.context.bankOrderDetail.find("div[tag=data]").children("table[tag=wkzbillfrom]").hide();this.context.bankOrderDetail.find("div[tag=data]").children("table[tag=billfrom]").show().children("tbody").find("tr[tag=data]").remove();this.context.bankOrderDetail.find("div[tag=data]").children("table[tag=billfrom]").children("tbody").children("tr:first").after(detailtpl);var tpl=this.context.bankOrderDetail.find("div[tag=data]").children("table").children("tbody");var wkz=tpl.find("tr[from=wkz]").size();var cashier=tpl.find("tr[from=cashier]").size();var miot=tpl.find("tr[from=miot]").size();if(wkz>=2){tpl.find("tr[from=wkz]").eq(0).children("td[tag=plat]").attr("rowspan",2);tpl.find("tr[from=wkz]").eq(1).children("td[tag=plat]").remove();}
if(cashier>=2){tpl.find("tr[from=cashier]").eq(0).children("td[tag=plat]").attr("rowspan",cashier);for(var i=cashier-1;i>=0;i--){if(i!==0){tpl.find("tr[from=cashier]").eq(i).children("td[tag=plat]").remove();}}}
if(miot>=2){tpl.find("tr[from=miot]").eq(0).children("td[tag=plat]").attr("rowspan",2);tpl.find("tr[from=miot]").eq(1).children("td[tag=plat]").remove();}}
this.context.bankOrderDetail.find("h4").text(date+" 结算明细");this.context.bankOrderDetail.find("div[tag=data]").children("table").children("tbody").find("tr[tag=total]").children("td[tag=total]").html(total);this.context.bankOrderDetail.find("div[tag=data]").children("table").children("tbody").find("tr[tag=total]").children("td[tag=paidtotal]").html(paidtotal);this.context.bankOrderDetail.find("h4").attr("billdate",date).attr("settlecycle",d.req.settlecycle).attr("billtype",d.req.billtype);M.Popup(this.context.bankOrderDetail,{"hideclass":"modal large fade","showclass":"modal large fade in","dragable":true});}else{M.error(d.msg);}},showbilldetail:function(ele){var innid=M.getinnid();var date=ele.parents("tr").attr("date");var billdate=ele.parents("tr").children("td[tag=billdate]").attr("date");var gateway=ele.parents("tr").attr("gateway");var paytypename=ele.parents("tr").children("td[tag=paytypename]").text();var datetime=M.strtotime(date);var datestr=M.timeformat(datetime,'Y.m.d');var desc=datestr+' ['+paytypename+'] 款项明细';this.context.orderDetail.find("h4[tag=title]").text(desc);var data={"innid":innid,"date":billdate,"gateway":gateway};this._showloadingstatus();M._getjson("/Reportsource/getbilldetail",data,this.getbilldetail_finished.toEventHandler(this));},getbilldetail_finished:function(d){this._hideloadingstatus();if(d.status=="success"){var list=d.list.list;var total=d.list.total;var tpl=this.context.orderDetail.find("tr[tag=tpl]");this.context.orderDetail.find("tr[tag=a]").remove();var total=0.00;for(var i=0;i<list.length;i++){var data=list[i];var tpl_a=tpl.clone(true).attr("tag","a").show();tpl_a.children("td[tag=date]").children("span").html(data.createon);tpl_a.children("td[tag=orderinfo]").html(data.desc);tpl_a.children("td[tag=total]").html(data.amount);tpl.before(tpl_a);total=this.addsum(total,data.amount);}
total=total+0.00;this.context.orderDetail.find("tr[tag=total]").children("td[tag=total]").html(total);M.Popup(this.context.orderDetail,{"hideclass":"modal large fade","showclass":"modal large fade in","dragable":true});}else{M.error(d.msg);}},addsum:function(num1,num2){return(parseInt(num1*100)+parseInt(num2*100))/100;},menutab_click:function(e){var ele=M.EventEle(e);var tag=ele.attr("tag");this.context.menutab.children("li").removeClass("on");this.context.historyData.children("a").removeClass("light cursor-d");ele.parents("li").addClass("on");this.context.paylist.hide();this.context.billlist.hide();this.context.billlisttip.hide();this.context.historyData.hide();this.context.wkzHistory.hide();this.context.cashierHistory.hide();this.context.miotOrderDetail.hide();this.context.tabOtaDetail.hide();this.context.wkzAppletOrderDetail.hide();this.context.wkzOrderDetail.hide();if(tag=="pay"){this.context.paylist.show();this._getcloudlist();this._initpayselect(tag);}
if(tag=="bill"){this.context.billlist.show();this.context.billlisttip.show();this.context.historyData.show();this._getbilllist();this._initpayselect(tag);}
if(tag=="appletorder"){this.context.wkzAppletOrderDetail.show();this._getWkzappletOrder();}
if(tag=="wkzorder"){this.context.wkzOrderDetail.show();this._getWkzOrder();this._initpayselect(tag);}
if(tag=="miotorder"){this.context.miotOrderDetail.show();this._changetocurrentsort();this._getMiotOrder();this._initpayselect(tag);}
if(tag=='yzgorder'){this._changetocurrentsort();this._getYZGOrder();}},_getformdata:function(){var fromdate=this.context.fromdate.val();var enddate=this.context.enddate.val();var innid=M.getinnid();var data={"innid":innid,"fromdate":fromdate,"enddate":enddate};return data;},_getYZGOrder:function(){var data=this._getformdata();this._showloadingstatus();this.context.tabOtaDetail.show();this.context.tabOtaDetail.find('tbody').find('tr[tag=list]').remove();this.context.tabOtaDetail.find('tbody').find('tr[tag=total]').hide();var strstatus_settlement=this.settlement_confirm();var strstatus_orderstatus=this.orderstatus_confirm();var strstatus_ordertype=this.ordertype_confirm();var datetype=this.context.datetype.val();data['sorttype']=this.sort_otadetail;data['settlmementstr']=strstatus_settlement;data['orderstatusstr']=strstatus_orderstatus;data['ordertypestr']=strstatus_ordertype;data['datetype']=datetype;M._getjson('/Report/getyzgorderlist',data,this.getYZGOrder_finished.toEventHandler(this));},getYZGOrder_finished:function(d){this._hideloadingstatus();if(d.status!='success'){var showcardset=d.showcardset;this.handlerCardSet(showcardset);alert(d.msg);return;}
var list=d.data.list;var counttotal=d.data.total;var html_tbody=this.context.tabOtaDetail.find('tbody');if(M.isEmpty(list)){html_tbody.children('tr[tag=list]').remove();html_tbody.children('tr[tag=nodata]').show();html_tbody.children('tr[tag=total]').hide();return;}
html_tbody.children('tr[tag=nodata]').hide();var tpldata_tr='';for(var k in list){var value=list[k];tpldata_tr+='<tr tag="list" orderstatus="'+value.orderstatus+'" status="'+value.settlement_status+'">'
+'<td>'+value.arrivedate+'</td>'
+'<td>'+value.enddate+'</td>'
+'<td>'+value.orderinfo+'</td>'
+'<td>'+value.totalprice+'</td>'
+'<td>'+value.ordertype+'</td>'
+'<td>'+value.orderstatus_name+'</td>'
+'<td>'+value.settlement_name+'</td>'
+'<td>'+value.settlement_time+'</td>'
+'</tr>';}
html_tbody.children('tr[tag=title]').after(tpldata_tr);html_tbody.children('tr[tag=list][status=3]').addClass('red');html_tbody.children('tr[tag=list][orderstatus=0]').removeClass();html_tbody.children('tr[tag=list][orderstatus=0]').addClass('light');html_tbody.children('tr[tag=total]').show().children('td[tag=total]').html(counttotal);},_getcloudlist:function(){var fromdate=this.context.fromdate.val();var enddate=this.context.enddate.val();var innid=M.getinnid();var data={"innid":innid,"fromdate":fromdate,"enddate":enddate};this._showloadingstatus();M._getjson("/Reportsource/getcloudlist",data,this.getlist_finished.toEventHandler(this));},_getWkzappletOrder:function(){var innid=M.getinnid();var fromdate=this.context.fromdate.val();var enddate=this.context.enddate.val();var data={"innid":innid,"fromdate":fromdate,"enddate":enddate,'platformlist':'wechatapplet'};this._showloadingstatus();M._getjson("/Microinn/getWkzOrderDetail",data,this.getWkzAppletOrder_finished.toEventHandler(this));},getWkzAppletOrder_finished:function(d){this._hideloadingstatus();if(d.status=="success"){var data=d.order;var showcardset=d.showcardset;this.handlerCardSet(showcardset);var order=data.list;var total=data.total;if(!M.isEmpty(order)){var ordertpl=$.tmpl(this.wkzappletorderdetail_tpl,order);this.context.wkzAppletOrderDetail.children("div[tag=noorder]").hide();this.context.wkzAppletOrderDetail.children("table").children("tbody").find("tr[tag=list]").remove();this.context.wkzAppletOrderDetail.children("table").children("tbody").children("tr:first").after(ordertpl);this.context.wkzAppletOrderDetail.children("table").show();this.context.wkzAppletOrderDetail.children("table").children("tbody").find("tr[tag=total]").show().children("td[tag=total]").text("¥"+total);this.context.wkzAppletOrderDetail.children("table").children("tbody").find("tr[tag=noresult]").hide();}else{this.context.wkzOrderDetail.children("table").children("tbody").find("tr[tag=list]").remove();this.context.wkzOrderDetail.children("table").children("tbody").find("tr[tag=noresult]").show();this.context.wkzOrderDetail.children("table").children("tbody").find("tr[tag=total]").hide();}}else{M.error(d.msg);}},_getWkzOrder:function(){var innid=M.getinnid();var fromdate=this.context.fromdate.val();var enddate=this.context.enddate.val();var data={"innid":innid,"fromdate":fromdate,"enddate":enddate};this._showloadingstatus();M._getjson("/Microinn/getWkzOrderDetail",data,this.getWkzOrder_finished.toEventHandler(this));},getWkzOrder_finished:function(d){this._hideloadingstatus();if(d.status=="success"){var data=d.order;var showcardset=d.showcardset;this.handlerCardSet(showcardset);var order=data.list;var total=data.total;if(!M.isEmpty(order)){var ordertpl=$.tmpl(this.wkzorderdetail_tpl,order);this.context.wkzOrderDetail.children("div[tag=noorder]").hide();this.context.wkzOrderDetail.children("table").children("tbody").find("tr[tag=list]").remove();this.context.wkzOrderDetail.children("table").children("tbody").children("tr:first").after(ordertpl);this.context.wkzOrderDetail.children("table").show();this.context.wkzOrderDetail.children("table").children("tbody").find("tr[tag=total]").show().children("td[tag=total]").text("¥"+total);this.context.wkzOrderDetail.children("table").children("tbody").find("tr[tag=noresult]").hide();}else{this.context.wkzOrderDetail.children("table").children("tbody").find("tr[tag=list]").remove();this.context.wkzOrderDetail.children("table").children("tbody").find("tr[tag=noresult]").show();this.context.wkzOrderDetail.children("table").children("tbody").find("tr[tag=total]").hide();}}else{M.error(d.msg);}},_initpayselect:function(tag){if(tag=="bill"){var settlestatus=this.context.billlist.find("div[tag=filter]");settlestatus.find("input").attr("checked","checked");}
if(tag=="wkzorder"){var wkz_gateway=this.context.wkzOrderDetail.find("div[tag=gatewayfilter]");wkz_gateway.find("input").attr("checked","checked");var wkz_plateform=this.context.wkzOrderDetail.find("div[tag=platformfilter]");wkz_plateform.find("input").attr("checked","checked");var wkz_settle=this.context.wkzOrderDetail.find("div[tag=settlestatusfilter]");wkz_settle.find("input").attr("checked","checked");}
if(tag=="pay"){var tpl_pay=this.context.paylist.find("div[tag=showpaytype]");tpl_pay.find("input").attr("checked","checked");var tpl_paystatus=this.context.paylist.find("div[tag=showpaystatus]");tpl_paystatus.find("input").attr("checked","checked");var tpl_checkout=this.context.paylist.find("div[tag=showcheckoutstatus]");tpl_checkout.find("input").attr("checked","checked");}},export_click:function(){M._getjson('/Reportsource/checkExportDataAuth',{},this.export_finished.toEventHandler(this))},export_finished:function(d){if(d.status=='success'){this._setexporthref();}else{alert(d.msg);}},_setexporthref:function(){var fromdate=this.context.fromdate.val();var enddate=this.context.enddate.val();var innid=M.getinnid();var tpl=this.context.menutab.children("li.on");var tag=tpl.find("a").attr("tag");this.context.datetypelist.css("display",'none');var datetype=this.context.datetype.val();if(tag=="bill"){var href='/reportsource/cashierbillexport?enddate='+enddate+'&fromdate='+fromdate+'&innid='+innid;}
if(tag=="wkzorder"){var href='/reportsource/wkzorderexport?enddate='+enddate+'&fromdate='+fromdate+'&innid='+innid;}
if(tag=="wkzorder"){var href='/reportsource/wkzorderexport?enddate='+enddate+'&fromdate='+fromdate+'&innid='+innid;}
if(tag=="appletorder"){var href='/reportsource/wkzappletorderexport?datetype='+datetype+'&enddate='+enddate+'&fromdate='+fromdate+'&innid='+innid;this.context.datetypelist.css("display",'block');}
if(tag=="pay"){var href='/reportsource/cashierpayexport?enddate='+enddate+'&fromdate='+fromdate+'&innid='+innid;}
if(tag=='yzgorder'){var href='/reportsource/exportyzgorders?datetype='+datetype+'&enddate='+enddate+'&fromdate='+fromdate+'&innid='+innid;this.context.datetypelist.css("display",'block');}
window.location.href=href;},_getbilllist:function(){var fromdate=this.context.fromdate.val();var enddate=this.context.enddate.val();var innid=M.getinnid();var data={"innid":innid,"fromdate":fromdate,"enddate":enddate};this._showloadingstatus();M._getjson("/Reportsource/getbankbilllist",data,this.getbankbilllist_finished.toEventHandler(this));},handlerCardSet:function(d){if(d=='1'){this.context.needsetcard.show();}else{this.context.needsetcard.hide();}},getbankbilllist_finished:function(d){this._hideloadingstatus();if(d.status=="success"){var temp=d.list;var list=temp.list;var showcardset=d.showcardset;this.handlerCardSet(showcardset);if(!M.isEmpty(list)){var total=temp.paidtotal;var listtpl=$.tmpl(this.bankbilllist_tpl,list);this.context.billlist.children("table").children("tbody").find("tr[tag=list]").remove();this.context.billlist.children("table").children("tbody").children("tr:first").after(listtpl);this.context.billlist.children("table").children("tbody").find("tr[tag=total]").children("td[tag=total]").text(total);this.context.billlist.children("table").children("tbody").find("tr[tag=total]").show();this.context.billlist.children("table").children("tbody").find("tr[tag=noresult]").hide();}else{this.context.billlist.children("table").children("tbody").find("tr[tag=list]").remove();this.context.billlist.children("table").children("tbody").find("tr[tag=total]").hide();this.context.billlist.children("table").children("tbody").find("tr[tag=noresult]").show();}}else{M.error(d.msg);}},body_click:function(e){var ele=M.EventEle(e);var tag=ele.attr("tag");var menu=this.context.menutab.children("li[class=on]").children("a").attr("tag");if(menu=="pay"){if(M.isEmpty(tag)){var target=ele.parents("div[id=paylist]");if(target.length==0){this.context.paylist.find("div[t=droplist]").hide();}}else{if(tag!="filter"){var target=ele.parents("div[id=paylist]");if(target.length==0){this.context.paylist.find("div[t=droplist]").hide();}}}}
if(menu=="wkzorder"){if(M.isEmpty(tag)){var target=ele.parents("div[id=wkzOrderDetail]");if(target.length==0){this.context.wkzOrderDetail.find("div[t=droplist]").hide();}}else{if(tag!="confirmgatewayfilter"||tag!="confirmplatformfilter"||tag!="confirmstatusfilter"){var target=ele.parents("div[id=wkzOrderDetail]");if(target.length==0){this.context.wkzOrderDetail.find("div[t=droplist]").hide();}}}}
if(menu=="bill"){if(M.isEmpty(tag)){var target=ele.parents("div[id=billlist]");if(target.length==0){this.context.billlist.find("div[t=droplist]").hide();}}else{if(tag!="paystatusconfirm"){var target=ele.parents("div[id=billlist]");if(target.length==0){this.context.billlist.find("div[t=droplist]").hide();}}}}
if(menu=="miotorder"){if(M.isEmpty(tag)){var target=ele.parents("div[id=miotOrderDetail]");if(target.length==0){this.context.miotOrderDetail.find("div[t=droplist]").hide();}}else{if(tag!="confirmgatewayfilter"||tag!="confirmstatusfilter"){var target=ele.parents("div[id=miotOrderDetail]");if(target.length==0){this.context.miotOrderDetail.find("div[t=droplist]").hide();}}}}
var innlength=ele.parents("div[id=innlist]").length;if(innlength==0){var t=ele.attr("tag");if(!(!M.isEmpty(t)&&t=='dropdownlist')){this.context.innlist.children("div").hide();}}
var datelistlength=ele.parents("div[id=datelist]").length;if(datelistlength==0){var t=ele.attr("tag");if(!(!M.isEmpty(t)&&t=='dropdownlist')){this.context.datelist.children("div").hide();}}
var datetypelistlength=ele.parents("div[id=datetypelist]").length;if(datetypelistlength==0){var t=ele.attr("tag");if(!(!M.isEmpty(t)&&t=='dropdownlist')){this.context.datetypelist.children("div").hide();}}
var datepickerlength=ele.parents("div[id=datepicker]").length;var df=ele.parents(".ui-datepicker-header");var df1=ele.parents(".ui-datepicker-calendar");if(datepickerlength==0&&df.length==0&&df1.length==0){this.context.datepicker.children("div").hide();}
var tpl=ele.parents("div[tag=settlement_list]");if(tpl.length==0&&tag!='dropdownlist'&&tag!='settlement'){this.context.tabOtaDetail.find('tr[tag=title]').find("div[tag=settlement_list]").hide();}
var ordertpl=ele.parents("div[tag=orderstatus_list]");if(ordertpl.length==0&&tag!='dropdownlist'&&tag!='orderstatus'){this.context.tabOtaDetail.find('tr[tag=title]').find("div[tag=orderstatus_list]").hide();}
var ordertypetpl=ele.parents("div[tag=ordertype_list]");if(ordertypetpl.length==0&&tag!='dropdownlist'&&tag!='ordertype'){this.context.tabOtaDetail.find('tr[tag=title]').find("div[tag=ordertype_list]").hide();}},paylist_click:function(e){var ele=M.EventEle(e);var t=ele.attr("tag");switch(t){case"showpaytype":this.context.paylist.find("div[tag=paystatuslist]").hide();this.context.paylist.find("div[tag=checkoutstatuslist]").hide();this._handlepeytypelist(ele);break;case"showpaystatus":this.context.paylist.find("div[tag=checkoutstatuslist]").hide();this.context.paylist.find("div[tag=paytypelist]").hide();this._handlepaystatuslist(ele);break;case"showcheckoutstatus":this.context.paylist.find("div[tag=paytypelist]").hide();this.context.paylist.find("div[tag=paystatuslist]").hide();this._handlecheckoutstatuslist(ele);break;case"paytypeconfirm":this.paytypeconfirm(ele);break;case"paystatusconfirm":this.paystatusconfirm(ele);break;case"checkoutstatusconfirm":this.checkoutstatusconfirm(ele);break;}},paytypeconfirm:function(ele){var list=this.context.paylist.find("div[tag=paytypelist]").find("input:checked");paytypelist=this._getselectlist(list);this.paytypelist.list=paytypelist;this.paytypelist.length=this.context.paylist.find("div[tag=paytypelist]").find("input").length;if(paytypelist.length==0){this.paytypelist.select="none";}
if(paytypelist.length==0){M.error("请您至少选择一个支付方式来筛选");return;}
this.context.paylist.find("div[tag=paytypelist]").hide();this._search();},paystatusconfirm:function(ele){var list=this.context.paylist.find("div[tag=paystatuslist]").find("input:checked");paytypelist=this._getselectlist(list);this.paystatuslist.list=paytypelist;this.paystatuslist.length=this.context.paylist.find("div[tag=paystatuslist]").find("input").length;if(paytypelist.length==0){this.paystatuslist.select="none";}
if(paytypelist.length==0){M.error("请您至少选择一个支付状态来筛选");return;}
this.context.paylist.find("div[tag=paystatuslist]").hide();this._search();},checkoutstatusconfirm:function(ele){var tpl=ele.parents("div[t=droplist]");var list=this.context.paylist.find("div[tag=checkoutstatuslist]").find("input:checked");paytypelist=this._getselectlist(list);this.checkoutstatuslist.list=paytypelist;this.checkoutstatuslist.length=this.context.paylist.find("div[tag=checkoutstatuslist]").find("input").length;if(paytypelist.length==0){this.checkoutstatuslist.select="none";}
if(paytypelist.length==0){M.error("请您至少选择一个结算状态来筛选");return;}
this.context.paylist.find("div[tag=checkoutstatuslist]").hide();this._search();},_search:function(){var fromdate=this.context.fromdate.val();var enddate=this.context.enddate.val();var innid=M.getinnid();var data={"innid":innid,"fromdate":fromdate,"enddate":enddate};if(this.paytypelist.list.length!=this.paytypelist.length){data.paytypelist=this.paytypelist.list.toString();}
if(this.paystatuslist.list.length!=this.paystatuslist.length){data.paystatuslist=this.paystatuslist.list.toString();}
if(this.checkoutstatuslist.list.length!=this.checkoutstatuslist.length){data.checkoutstatuslist=this.checkoutstatuslist.list.toString();}
if((this.paytypelist.length==0&&this.paytypelist.select=="none")||(this.paystatuslist.length==0&&this.paystatuslist.select=="none")||(this.checkoutstatuslist.length==0&&this.checkoutstatuslist.select=="none")){this.context.paylist.find("tr[tag=detail]").remove();this.context.paylist.find("tr[tag=noresult]").show();this.context.pagelist.hide();return;}
this._showloadingstatus();M._getjson("/Reportsource/getcloudlist",data,this.getlist_finished.toEventHandler(this));},_getselectlist:function(list){var data=[];list.each(function(){var value=$(this).val();data.push(value);});return data;},_handlepeytypelist:function(ele){var target=ele.parents("th[tag=filter]");target.find("div[tag=paytypelist]").toggle();var showsatus=target.find("div[tag=paytypelist]").css("display");if(showsatus!="none"){var paytypelist=this.paytypelist.list;if(paytypelist.length==0){if(this.paytypelist.select=="all"){target.find("div[tag=paytypelist]").find("input").attr("checked","checked");}}else{var list=target.find("div[tag=paytypelist]").find("label");for(var i=0;i<paytypelist.length;i++){list.children("input[value="+paytypelist[i]+"]").attr("checked","checked");}}}},_handlepaystatuslist:function(ele){var target=ele.parents("th[tag=filter]");target.find("div[tag=paystatuslist]").toggle();var showsatus=target.find("div[tag=paystatuslist]").css("display");if(showsatus!="none"){var paytypelist=this.paystatuslist.list;if(paytypelist.length==0){if(this.paystatuslist.select=="all"){target.find("div[tag=paystatuslist]").find("input").attr("checked","checked");}}else{var list=target.find("div[tag=paystatuslist]").find("label");for(var i=0;i<paytypelist.length;i++){list.children("input[value="+paytypelist[i]+"]").attr("checked","checked");}}}},_handlecheckoutstatuslist:function(ele){var target=ele.parents("th[tag=filter]");target.find("div[tag=checkoutstatuslist]").toggle();var showsatus=target.find("div[tag=checkoutstatuslist]").css("display");if(showsatus!="none"){var paytypelist=this.checkoutstatuslist.list;if(paytypelist.length==0){if(this.checkoutstatuslist.select=="all"){target.find("div[tag=checkoutstatuslist]").find("input").attr("checked","checked");}}else{var list=target.find("div[tag=checkoutstatuslist]").find("label");for(var i=0;i<paytypelist.length;i++){list.children("input[value="+paytypelist[i]+"]").attr("checked","checked");}}}},pagelist_click:function(e){var ele=M.EventEle(e);var tag=ele.attr("tag");switch(tag){case'page':this.gotopage(ele);break;}},gotopage:function(ele){var p=ele.attr("p");if(M.isEmpty(p))
return;var fromdate=this.context.fromdate.val();var enddate=this.context.enddate.val();var innid=M.getinnid();var data={"innid":innid,"fromdate":fromdate,"enddate":enddate,"p":p};if(this.paytypelist.list.length!=this.paytypelist.length){data.paytypelist=this.paytypelist.list.toString();}
if(this.paystatuslist.list.length!=this.paystatuslist.length){data.paystatuslist=this.paystatuslist.list.toString();}
if(this.checkoutstatuslist.list.length!=this.checkoutstatuslist.length){data.checkoutstatuslist=this.checkoutstatuslist.list.toString();}
if((this.paytypelist.length==0&&this.paytypelist.select=="none")||(this.paystatuslist.length==0&&this.paystatuslist.select=="none")||(this.checkoutstatuslist.length==0&&this.checkoutstatuslist.select=="none")){this.context.paylist.find("tr[tag=detail]").remove();this.context.paylist.find("tr[tag=noresult]").show();this.context.pagelist.hide();return;}
this._showloadingstatus();M._getjson("/Reportsource/getcloudlist",data,this.getlist_finished.toEventHandler(this));},_initdatepicker:function(){var fromdate=this.context.fromdate.val();var enddate=this.context.enddate.val();var innid=M.getinnid();var data={"innid":innid,"fromdate":fromdate,"enddate":enddate};this._showloadingstatus();M._getjson("/Reportsource/getbankbilllist",data,this.getbankbilllist_finished.toEventHandler(this));},getlist_finished:function(d){this._hideloadingstatus();if(d.status=="success"){var showcardset=d.showcardset;this.handlerCardSet(showcardset);var list=d.list;var pages=d.pagelist;this.context.paylist.find("tr[tag=detail]").remove();var tpl=this.context.paylist.find("tr[tag=tpl_temp]");this.context.paylist.find("tr[tag=noresult]").hide();if(list.length==0){this.context.paylist.find("tr[tag=noresult]").show();this.context.pagelist.hide();return;}
this.context.pagelist.show();for(var i=0;i<list.length;i++){var detail=list[i];var tpl_detail=tpl.clone(true).attr("tag","detail").show();tpl_detail.children("td[tag=date]").html(detail.createon);tpl_detail.children("td[tag=orderinfo]").html(detail.desc);tpl_detail.children("td[tag=paytypename]").html(detail.paytypename);tpl_detail.children("td[tag=amount]").html(detail.amount);tpl_detail.children("td[tag=paystatus]").html(detail.paystatusmsg);tpl_detail.children("td[tag=checkoutstatus]").html(detail.checkoutmsg);tpl_detail.children("td[tag=tradeno]").html(detail.tradingcode);if(detail.paystatus==3){tpl_detail.addClass("red");}
if(detail.paystatus==2){tpl_detail.addClass("light");}
tpl.before(tpl_detail);}
this._handlepages(pages);}else{M.error(d.msg);}},miotOrderDetail_click:function(e){var ele=M.EventEle(e);var tag=ele.attr("tag");if(tag=="gatewayfilter"){ele.children("div").show();this.context.miotOrderDetail.children("table").find("div[tag=settlestatusfilter]").children("div").hide();this.context.miotOrderDetail.children("table").find("div[tag=platformfilter]").children("div").hide();}
if(tag=="settlestatusfilter"){ele.children("div").show();this.context.miotOrderDetail.children("table").find("div[tag=gatewayfilter]").children("div").hide();this.context.miotOrderDetail.children("table").find("div[tag=platformfilter]").children("div").hide();}
if(tag=="confirmgatewayfilter"){var list=this.context.miotOrderDetail.find("div[tag=gatewayfilter]").find("input:checked");gatewaylist=this._getselectlist(list);this.gatewaylist.list=gatewaylist;this.gatewaylist.length=this.context.miotOrderDetail.find("div[tag=gatewayfilter]").find("input").length;if(gatewaylist.length==0){this.gatewaylist.select="none";}
if(gatewaylist.length==0){M.error("请您至少选择一个支付方式来筛选");return;}
this.context.miotOrderDetail.children("table").find("div[tag=gatewayfilter]").children("div").hide();this._changetocurrentsort();this._miotOrderDetailSearch();}
if(tag=="confirmstatusfilter"){var list=this.context.miotOrderDetail.find("div[tag=settlestatusfilter]").find("input:checked");settlestatus=this._getselectlist(list);this.settlelist.list=settlestatus;this.settlelist.length=this.context.miotOrderDetail.find("div[tag=settlestatusfilter]").find("input").length;if(settlestatus.length==0){this.settlelist.select="none";}
if(settlestatus.length==0){M.error("请您至少选择一个结算状态来筛选");return;}
this.context.miotOrderDetail.children("table").find("div[tag=settlestatusfilter]").children("div").hide();this._changetocurrentsort();this._miotOrderDetailSearch();}
if(tag=="addtimesort"){this.miotsortlist.list="addtimesort";this._miotOrderDetailSearch();this.context.miotOrderDetail.find("th[tag=enddatesort]").removeClass("sort_on");ele.addClass("sort_on");}
if(tag=="enddatesort"){this.miotsortlist.list="enddatesort";this._miotOrderDetailSearch();this.context.miotOrderDetail.find("th[tag=addtimesort]").removeClass("sort_on");ele.addClass("sort_on");}},_miotOrderDetailSearch:function(e){var fromdate=this.context.fromdate.val();var enddate=this.context.enddate.val();var innid=M.getinnid();var datetype=this.context.datetype.val();var data={"innid":innid,"fromdate":fromdate,"enddate":enddate,'datetype':datetype};if(this.gatewaylist.list.length!=this.gatewaylist.length){data.gatewaylist=this.gatewaylist.list.toString();}
if(this.settlelist.list.length!=this.settlelist.length){data.settlelist=this.settlelist.list.toString();}
if(this.miotsortlist.list){data.sorttype=this.miotsortlist.list.toString();}
if((this.gatewaylist.length==0&&this.gatewaylist.select=="none")||(this.settlelist.length==0&&this.settlelist.select=="none")){this.context.wkzOrderDetail.children("table").hide();this.context.paylist.find("div[tag=noorder]").show();return;}
this._showloadingstatus();M._getjson("/Microinn/getmiotOrderDetail",data,this.getMiotOrder_finished.toEventHandler(this));},_getMiotOrder:function(){var innid=M.getinnid();var fromdate=this.context.fromdate.val();var enddate=this.context.enddate.val();var datetype=this.context.datetype.val();var data={"innid":innid,"fromdate":fromdate,"enddate":enddate,'datetype':datetype};this._showloadingstatus();M._getjson("/Microinn/getMiotOrderDetail",data,this.getMiotOrder_finished.toEventHandler(this));},getMiotOrder_finished:function(d){this._hideloadingstatus();if(d.status=="success"){var showcardset=d.showcardset;this.handlerCardSet(showcardset);var data=d.order;var order=data.list;var total=data.total;if(!M.isEmpty(order)){var ordertpl=$.tmpl(this.apporderdetail_tpl,order);this.context.miotOrderDetail.children("table").children("tbody").find("tr[tag=noorder]").hide();this.context.miotOrderDetail.children("table").children("tbody").find("tr[tag=list]").remove();this.context.miotOrderDetail.children("table").children("tbody").children("tr:first").after(ordertpl);this.context.miotOrderDetail.children("table").show();this.context.miotOrderDetail.children("table").children("tbody").find("tr[tag=total]").show().children("td[tag=total]").text("¥"+total);this.context.miotOrderDetail.children("table").children("tbody").find("tr[tag=noresult]").hide();}else{this.context.miotOrderDetail.children("table").children("tbody").find("tr[tag=list]").remove();this.context.miotOrderDetail.children("table").children("tbody").find("tr[tag=noorder]").show();this.context.miotOrderDetail.children("table").children("tbody").find("tr[tag=total]").hide();}}else{M.error(d.msg);}},BankOrderDetail_click:function(e){var ele=M.EventEle(e);var innid=M.getinnid();var date=this.context.bankOrderDetail.find("h4").attr("billdate");var settlecycle=this.context.bankOrderDetail.find("h4").attr("settlecycle");var billtype=this.context.bankOrderDetail.find("h4").attr("billtype");var data={"innid":innid,"date":date,"settlecycle":settlecycle,'billtype':billtype};this._showloadingstatus();M._getjson("/Reportsource/getorderdetailofbill",data,this.bankOrderDetail_finished.toEventHandler(this));},bankOrderDetail_finished:function(d){this._hideloadingstatus();if(d.status=="success"){var date=d.req.date;var settlecycle=d.req.settlecycle;var list=d.list;var total=d.total;var detailtpl;if(settlecycle==30){return this.bankOrderDetail_cm_finished(d);}else{detailtpl=$.tmpl(this.orderdetailofbill_tpl,list);}
if(settlecycle==1){settlecycle=2;}
this.context.orderDetailOfBill.find("div[tag=data]").children("table").children("tbody").find("tr[tag=data]").remove();this.context.orderDetailOfBill.find("div[tag=data]").children("table").children("tbody").children("tr:first").after(detailtpl);this.context.orderDetailOfBill.find("h4").text(date+" - T+"+settlecycle+" 结算订单明细");this.context.orderDetailOfBill.find("div[tag=data]").children("table").children("tbody").find("tr[tag=total]").children("td").eq(3).text(total);this.context.orderDetailOfBill.find("h4").attr("billdate",date).attr("settlecycle",d.req.settlecycle);M.Popup(this.context.orderDetailOfBill,{"hideclass":"modal viewguest fade","showclass":"modal viewguest fade in","dragable":true});}else{M.error(d.msg);}},bankOrderDetail_cm_finished:function(d){this._hideloadingstatus();if(d.status=="success"){var date=d.req.date;var settlecycle=d.req.settlecycle;var list=d.list;var total=d.total;var detailtpl;detailtpl=$.tmpl(this.orderdetailofbill_settle_tpl,list);this.context.cmOrderDetailOfBill.find("div[tag=data]").children("table").children("tbody").find("tr[tag=data]").remove();this.context.cmOrderDetailOfBill.find("div[tag=data]").children("table").children("tbody").children("tr:first").after(detailtpl);this.context.cmOrderDetailOfBill.find("h4").text(date+" - 代销"+" 结算订单明细");this.context.cmOrderDetailOfBill.find("div[tag=data]").children("table").children("tbody").find("tr[tag=total]").children("td").eq(2).text(total);this.context.cmOrderDetailOfBill.find("h4").attr("billdate",date).attr("settlecycle",d.req.settlecycle);M.Popup(this.context.cmOrderDetailOfBill,{"hideclass":"modal viewguest fade","showclass":"modal viewguest fade in","dragable":true});}else{M.error(d.msg);}},_handlepages:function(pages){var list=pages.pagelist;if(list.length==0)
return;var nextpage=pages.nextpage;var pageindex=pages.pageindex;var maxpage=pages.maxpage;var prepage=pages.prepage;var html='<li><a p="'+prepage+'" tag="page" href="#">&laquo;</a></li>';for(var i=0;i<list.length;i++){var p=list[i];if(p.code==pageindex){html+='<li class="active"><a href="#?" title="">'+p.name+'</a></li>';}else{html+=' <li><a href="#?" tag="page" p="'+p.code+'" title="">'+p.name+'</a></li>'}}
if(maxpage>5){if(maxpage-pageindex>2){html+='<li><a href="#?">...</a></li>';html+='<li><a href="#?" tag="page" p="'+maxpage+'">'+maxpage+'</a></li>';}}
html+='<li><a href="#" tag="page" p="'+nextpage+'">&raquo;</a></li>';this.context.pagelist.show().html(html);},datepicker_click:function(e){var ele=M.EventEle(e);var t=ele.attr("tag");if(t=="showrange"){this.context.datepicker.children("div").toggle();}
if(t=="confirm"){this.paystatuslist={"list":[],"length":0,"select":"all"};this.checkoutstatuslist={"list":[],"length":0,"select":"all"};var tpl=this.context.menutab.children("li.on");var type=tpl.find("a").attr("tag");this.context.datelist.children("span").attr("value","").text("快捷日期");var dateobj=this.context.datelist.children("div").find("a[tag=option]");dateobj.each(function(){$(this).removeClass("on");});this.context.datelist.attr("value","");if(type=="bill"){this._initdatepicker();}else if(type=="wkzorder"){this._getWkzOrder();}else if(type=="pay"){this._getcloudlist();}else if(type=="miotorder"){this._changetocurrentsort();this._getMiotOrder();}else if(type=='yzgorder'){this._changetocurrentsort();this._getYZGOrder();}else if(type=='appletorder'){this._getWkzappletOrder();}}},_changetocurrentsort:function(){var tpl=this.context.menutab.children("li.on");var type=tpl.find("a").attr("tag");var datetype=this.context.datetype.val();if(type=="yzgorder"){if(datetype=='checkoutdays'){this.context.tabOtaDetail.find("tbody").find("tr[tag=title]").find('th[tag=checkindate]').removeClass("sort_on");this.context.tabOtaDetail.find("tbody").find("tr[tag=title]").find('th[tag=enddate]').addClass("sort_on");}else{this.context.tabOtaDetail.find("tbody").find("tr[tag=title]").find('th[tag=checkindate]').addClass("sort_on");}}
if(type=="miotorder"){if(datetype=='checkoutdays'){this.context.miotOrderDetail.find("th[tag=addtimesort]").removeClass("sort_on");this.context.miotOrderDetail.find("th[tag=enddatesort]").addClass("sort_on");}else{this.context.miotOrderDetail.find("th[tag=addtimesort]").addClass("sort_on");}}},_showloadingstatus:function(){this.context.transparentlayer.show();},_hideloadingstatus:function(){this.context.transparentlayer.hide();},NoUndefined:function(str)
{return M.isEmpty(str)?"":str;},_closepopup:function()
{M.ClosePopup();},destroy:function(){}});M.ready(function(){var cashier=new M.Page.ReportcashierPage();return cashier;});