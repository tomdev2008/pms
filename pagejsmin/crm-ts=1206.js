M.Page.CrmPage=M.createClass();M.extend(M.Page.CrmPage.prototype,{context:{},initpage:null,sorttarget:null,orderby:'lastdate',desc:'desc',levelname:'',droplist:{},levelstr:'',guestdetail:{},tpl_guest:'<tr tag="guest" class="cursor-p" gid="${id}">'
+'<td ga="td" gname="客人_查看">${guestname}</td>'
+'<td ga="td" gname="客人_查看">${levelname}</td>'
+'<td ga="td" gname="客人_查看">${birthday}</td>'
+'<td ga="td" gname="客人_查看">${phone}</td>'
+'<td ga="td" gname="客人_查看" tag="balance">${balance}</td>'
+'<td ga="td" gname="客人_查看">${lastdate}</td>'
+'<td ga="td" gname="客人_查看">${totalprice}</td>'
+'<td ga="td" gname="客人_查看">${nights}</td>'
+'<td ga="td" gname="客人_查看">${remark}</td>'
+'</tr>',tpl_guest_detail:'<td ga="td" gname="客人_查看">${guestname}</td>'
+'<td ga="td" gname="客人_查看">${levelname}</td>'
+'<td ga="td" gname="客人_查看">${membercardnum}</td>'
+'<td ga="td" gname="客人_查看">${phone}</td>'
+'<td ga="td" gname="客人_查看" tag="balance">${balance}</td>'
+'<td ga="td" gname="客人_查看">${lastdate}</td>'
+'<td ga="td" gname="客人_查看">${totalprice}</td>'
+'<td ga="td" gname="客人_查看">${nights}</td>'
+'<td ga="td" gname="客人_查看">${remark}</td>',tpl_page:'<li><a href="javascript:void(0);" tag="page" p="1">«</a></li>'
+'<li class="active"><a href="javascript:void(0);" title="">1</a></li>'
+'<li><a p="1" tag="page" href="javascript:void(0);">»</a></li>',getdatetime:function(){var date=M.getTime();return date;},_getDateMonth:function(now,month){var date=new Date(now.getFullYear(),now.getMonth()-month,now.getDate());return date;},init:function(){this.initDOM();this.initEvent();},initDOM:function(){this.context.body=$('body');this.context.guestlist=$("#guestlist");this.context.pagelist=$("#pagelist");this.context.guesttotal=$("#guesttotal");this.context.viewguestpop=$("#viewguestpop");this.context.guestdetail=$("#guestdetail");this.context.bookingrecord=$("#bookingrecord");this.context.rechargerecord=$("#rechargerecord");this.context.addguest=$("#addguest");this.context.addguestpop=$("#addguestpop");this.context.rechargepop=$("#rechargepop");this.context.confirmrechargepop=$("#confirmrechargepop");this.context.delguestPop=$("#delguestPop");this.context.editbalancepop=$("#editbalancepop");this.context.editbalanceinput=$("#editbalancepop input[name=amount]");this.context.loading=$("#loading");this.context.export=$("#export");this.context.memberAuthPop=$("#memberAuthPop");this.context.exportpop=$("#exportPop");this.context.masssms=$("#masssms");this.context.keyword=$("#keyword");this.context.search=$("#search");this.context.noguesttip=$("#noguesttip");var now=this.getdatetime();var startyear=M.timeformat(now,'Y');var endyear=startyear-80;var range=endyear+":"+startyear;this.context.addguestpop.find("input[name=birthday]").datepicker({changeMonth:true,changeYear:true,yearRange:range});this.initpage=this.context.pagelist.html();this.context.recharge_select=this.context.rechargepop.find("select[name=scheme]").html();},initEvent:function(){this.context.export.bind('click',this.export_click.toEventHandler(this));this.context.exportpop.bind('click',this.exportpop_click.toEventHandler(this));this.context.memberAuthPop.bind('click',this.memberAuthPop_click.toEventHandler(this));this.context.addguest.bind('click',this.addguest_click.toEventHandler(this));this.context.masssms.bind('click',this.masssms_click.toEventHandler(this));this.context.body.bind("click",this.body_click.toEventHandler(this));this.context.addguestpop.bind("click",this.addguestpop_click.toEventHandler(this));this.context.guestlist.bind('click',this.guestlist_click.toEventHandler(this));this.context.viewguestpop.bind('click',this.viewguestpop_click.toEventHandler(this));this.context.pagelist.bind('click',this.pagelist_click.toEventHandler(this));this.context.search.bind('click',this.search_click.toEventHandler(this));this.context.keyword.bind('keydown',this.searchkeyword_keydown.toEventHandler(this));this.context.rechargepop.bind('click',this.rechargepop_click.toEventHandler(this));this.context.confirmrechargepop.bind('click',this.confirmrechargepop_click.toEventHandler(this));this.context.rechargepop.find("select[name=scheme]").bind('change',this.scheme_change.toEventHandler(this));this.context.delguestPop.bind('click',this.deleteguestPop_click.toEventHandler(this));this.context.rechargerecord.bind('click',this.rechargerecord_click.toEventHandler(this));this.context.editbalancepop.bind('click',this.editbalancepop_click.toEventHandler(this));this.context.editbalanceinput.bind('blur',this.editbalanceinput_blur.toEventHandler(this));this.context.editbalanceinput.bind('focus',this.editbalanceinput_focus.toEventHandler(this));},export_click:function(e){var ele=M.EventEle(e);var islevel=ele.attr('islevel');if(islevel=='1'){var now=this.getdatetime();var thisdate=M.timeformat(now);var startdate=M.timeformat(this._getDateMonth(now,1));var mindate=M.timeformat(this._getDateMonth(now,12));this.context.exportpop.find("input[tag=startdate]").datepicker({showOtherMonths:true,selectOtherMonths:true});this.context.exportpop.find("input[tag=enddate]").datepicker({showOtherMonths:true,selectOtherMonths:true});this.context.exportpop.find("input[tag=startdate]").datepicker("option","minDate",mindate);this.context.exportpop.find("input[tag=startdate]").datepicker("option","maxDate",thisdate);this.context.exportpop.find("input[tag=enddate]").datepicker("option","minDate",mindate);this.context.exportpop.find("input[tag=enddate]").datepicker("option","maxDate",thisdate);this.context.exportpop.find("input[tag=startdate]").val(startdate);this.context.exportpop.find("input[tag=enddate]").val(thisdate);this.context.exportpop.find("input[tag=clause]").attr("checked",false);this.context.exportpop.find("a[tag=export]").attr("class",'btn btn-cancel');M.Popup(this.context.exportpop,{"hideclass":"modal w500 fade","showclass":"modal w500 fade in","dragable":true});}else{M.Popup(this.context.memberAuthPop,{"hideclass":"modal w500 fade","showclass":"modal w500 fade in","dragable":true});}},exportpop_click:function(e){var ele=M.EventEle(e);var t=ele.attr('tag');switch(t){case'clause':this.clause(ele);break;case'export':this.exportdata(ele);break;}},clause:function(ele){var html_parentdiv=ele.parent().parent();if(html_parentdiv.find('input[tag=clause]').is(':checked')){html_parentdiv.find('a[tag=export]').removeClass('btn-cancel').addClass('btn-primary');}else{html_parentdiv.find('a[tag=export]').removeClass('btn-primary').addClass('btn-cancel');}},exportdata:function(ele){if(ele.hasClass('btn-cancel')){return;}
var fromdate=this.context.exportpop.find('input[tag=startdate]').val();var enddate=this.context.exportpop.find('input[tag=enddate]').val();if(fromdate>enddate){alert('开始日期不能大于结束日期');return;}
var href="/Crm/exportMember?&fromdate="+fromdate+"&enddate="+enddate;window.location.href=href;this._closepopup();},memberAuthPop_click:function(e){var ele=M.EventEle(e);var t=ele.attr('tag');if(t=='closebtn'||t=='cancel'){M.ClosePopup();}},masssms_click:function(){var url='/ShortMessage/messagesend?grade=2&member=0';window.location=url;},confirmrechargepop_click:function(e){var ele=M.EventEle(e);var tag=ele.attr("tag");if(tag==='save'){this.saverecharge();}},saverecharge:function(){var gid=this.context.rechargepop.attr("gid");var schemeid=this.context.rechargepop.find("select[name=scheme]").val();var paytype=this.context.rechargepop.find("select[name=paytype]").val();var marketerid=this.context.rechargepop.find("select[name=marketer]").val();var remark=this.context.rechargepop.find("textarea[name=remark]").val();var data={"gid":gid,"schemeid":schemeid,"paytype":paytype,"marketerid":marketerid,"remark":remark};M._getjson("/Crm/saveguestrecharge",data,this.saverecharge_finished.toEventHandler(this),'',true);},saverecharge_finished:function(d){if(d.status=='success'){var totalamount=d.totalamount;this.context.viewguestpop.find("span[tag=balance]").text(totalamount);var gid=d.req.gid;this.context.guestlist.find("tr[gid="+gid+"]").children("td[tag=balance]").html(totalamount);M.CloseLast();M.CloseLast();this.context.guestdetail.hide();this.context.bookingrecord.hide();this.context.viewguestpop.find("li[tag=switchtab]").removeClass("active");this.context.viewguestpop.find("li[t=rechargerecord]").addClass("active");this.context.loading.show();this.showrechargerecord();}else{alert(d.msg);}},scheme_change:function(){var schemeid=this.context.rechargepop.find("select[name=scheme]").val();var scheme=schemes[schemeid];var total=M.math_add(scheme.recharge,scheme.give);var tip_tpl='￥'+scheme.recharge+' + ￥'+scheme.give+'（赠送）= <strong class="red t16">￥'+total+'</strong>';this.context.rechargepop.find("span[tag=tip]").html(tip_tpl);},rechargepop_click:function(e){var ele=M.EventEle(e);var tag=ele.attr("tag");if(tag=='save'){this.confirmrecharge();}},confirmrecharge:function(){var marketerid=this.context.rechargepop.find("select[name=marketer]").val();if(marketerid==0&&!confirm("确定不指定推广大使吗？"))return;var guest=this.guestdetail;this.context.confirmrechargepop.find("span[tag=phone]").html(guest.phone);this.context.confirmrechargepop.find("span[tag=guestname]").html(guest.guestname);this.context.confirmrechargepop.find("span[tag=levelname]").html(guest.levelname);var schemeid=this.context.rechargepop.find("select[name=scheme]").val();var scheme=schemes[schemeid];var total=M.math_add(scheme.recharge,scheme.give);var tip_tpl='￥'+scheme.recharge+' + ￥'+scheme.give+'（赠送）= <strong class="red t16">￥'+total+'</strong>';this.context.confirmrechargepop.find("span[tag=tip]").html(tip_tpl);M.Popup(this.context.confirmrechargepop,{"hideclass":"modal w500 fade","showclass":"modal w500 fade in","dragable":true});},addguestpop_click:function(e){var ele=M.EventEle(e);var tag=ele.attr("tag");if(tag=='save'){this.saveguestinfo();}},saveguestinfo:function(){var gid=this.context.addguestpop.attr("gid");var data={"act":"addguest"};if(!M.isEmpty(gid)){data.act="updateguest";data.gid=gid;}
data.guestname=this.context.addguestpop.find("input[name=guestname]").val();data.sex=this.context.addguestpop.find("div[t=sexlist]").children("span").attr("value");data.nation=this.context.addguestpop.find("input[name=nation]").val();data.levelid=this.context.addguestpop.find("div[t=levellist]").children("span").attr("value");data.phone=this.context.addguestpop.find("input[name=phone]").val();data.weixin=this.context.addguestpop.find("input[name=weixin]").val();data.vip=this.context.addguestpop.find("input[name=cardnum]").val();data.idtype=this.context.addguestpop.find("div[t=idcardform]").children("span").attr("value");data.idnum=this.context.addguestpop.find("input[name=idnum]").val();data.birthday=this.context.addguestpop.find("input[name=birthday]").val();data.address=this.context.addguestpop.find("input[name=address]").val();data.remark=this.context.addguestpop.find("textarea[name=remark]").val();if(data.idtype==1&&!M.isEmpty(data.idnum)){var reg=/(^\d{15}$)|(^\d{18}$)|(^\d{17}(\d|X|x)$)/;if(reg.test(data.idnum)===false)
{M.error("请输入正确的身份证号码");return;}}
if(M.isEmpty(data.guestname)){M.error("姓名不能为空");return;}
if(M.isEmpty(data.phone)){M.error("手机号码不能为空");return;}
var sendstatus=this.context.addguestpop.attr("sendstatus");if(sendstatus=='1'){M.error("请求处理中......");}
this.context.addguestpop.attr("sendstatus","1");M._getjson("/Crm/crmmanage",data,this.saveaddguest_finished.toEventHandler(this),'',true);},saveaddguest_finished:function(d){if(d.status=="success"){var guest=d.guest;var act=d.req.act;if(act=='addguest'){var html=$.tmpl(this.tpl_guest,guest);this.context.guestlist.children("tbody").children("tr[tag=loadding]").after(html);var total=parseInt(this.context.guesttotal.attr("t"));total=parseInt(total)+1;this.context.guesttotal.attr("t",total).html('共'+total+'个客人').show();if(total==1){this.context.guestlist.show();this.context.noguesttip.hide();this.context.pagelist.show();this.context.pagelist.empty().html(this.tpl_page);}
M.success("添加成功");}else{this.guestdetail=guest;this.showguestdetail();var gid=guest.id;var tpl=this.context.guestlist.children("tbody").children("tr[tag=guest][gid="+gid+"]");var html=$.tmpl(this.tpl_guest_detail,guest);tpl.html(html);M.success("修改成功");}
M.CloseLast();}else{this.context.addguestpop.attr("sendstatus","0");M.error(d.msg);}},body_click:function(e){var ele=M.EventEle(e);var style=ele.attr("tag");if(M.isEmpty(style)||style!='dropdownlist'){var tpl_parents=ele.parents("div[tag=popform]");if(tpl_parents.length>0){var tpl=ele.parents("div[tag=dropdownlist]");if(tpl.length==0){tpl_parents.children().find(".droplist_on").removeClass("droplist_on").children("div").hide();}}
var tpl=ele.parents("div[tag=filter]");if(tpl.length==0&&style!='filter'){this.context.guestlist.children().find("div[tag=filterlist]").hide();this.context.guestlist.children().find("th[tag=filter]").removeClass("filter_on");}
var tpl=ele.parents("div[t=sexlist]");if(tpl.length==0){this.context.addguestpop.find("div[t=sexlist]").children("div").hide();}
var tpl=ele.parents("div[t=idcardform]");if(tpl.length==0){this.context.addguestpop.find("div[t=idcardform]").children("div").hide();}
var tpl=ele.parents("div[t=levellist]");if(tpl.length==0){this.context.addguestpop.find("div[t=levellist]").children("div").hide();}}},searchkeyword_keydown:function(evt){var evt=evt?evt:(window.event?window.event:null);if(evt.keyCode==13){this.search_click();}},search_click:function(){var keyword=this.context.keyword.val();var filterlist=this.context.guestlist.children().find("div[tag=filterlist]").children("div").children("div");var levelstr=this._getselectfileter(filterlist);if(M.isEmpty(levelstr)){M.error("请选择客人等级");return;}
var data={"levelstr":levelstr,"keyword":keyword,"orderby":this.orderby,"desc":this.desc};M._getjson("/Crm/guestajaxpage",data,this.getguestlist_finished.toEventHandler(this),'',true);},pagelist_click:function(e){var ele=M.EventEle(e);var tag=ele.attr("tag");switch(tag){case'page':this.gotopage(ele);break;}},gotopage:function(ele){var p=ele.attr("p");if(M.isEmpty(p))
return;var filterlist=this.context.guestlist.children().find("div[tag=filterlist]").children("div").children("div");var levelstr=this._getselectfileter(filterlist);if(M.isEmpty(levelstr)){M.error("请选择客人等级");return;}
var keyword=this.context.keyword.val();var data={"keyword":keyword,"levelstr":levelstr,"orderby":this.orderby,"desc":this.desc,"p":p};M._getjson("/Crm/guestajaxpage",data,this.getguestlist_finished.toEventHandler(this),'',true);},addguest_click:function(){this.context.addguestpop.removeAttr("gid");this.context.addguestpop.find("h4").html("添加会员");this.context.addguestpop.find("input[name=guestname]").val('');this.context.addguestpop.find("input[name=birthday]").val('');this.context.addguestpop.find("input[name=nation]").val('');this.context.addguestpop.find("input[name=address]").val('');this.context.addguestpop.find("input[name=phone]").val('');this.context.addguestpop.find("input[name=weixin]").val('');this.context.addguestpop.find("input[name=cardnum]").val('');this.context.addguestpop.find("textarea[name=remark]").val('');this.context.addguestpop.find("input[name=idnum]").val('');var sextpl=this.context.addguestpop.find("div[t=sexlist]");this.droplist.sex=M.DropdownList(sextpl,null,{});var idcardtpl=this.context.addguestpop.find("div[t=idcardform]");this.droplist.card=M.DropdownList(idcardtpl,this.idcard_change.toEventHandler(this),{});var cardtpl=this.context.addguestpop.find("div[t=levellist]");this.droplist.level=M.DropdownList(cardtpl,null,{});this.context.addguestpop.attr("sendstatus","0");this.context.addguestpop.find(".droplist_on").removeClass("droplist_on").children("div").hide();this.context.addguestpop.find("input[name=idnum]").bind('keydown',this.idnum_keydown.toEventHandler(this));this.context.addguestpop.find("input[name=idnum]").bind('blur',this.idnum_keydown.toEventHandler(this));M.Popup(this.context.addguestpop,{"hideclass":"modal view fade","showclass":"modal view fade in","dragable":true});},editguestinfoshow:function(){var guest=this.guestdetail;this.context.addguestpop.attr("gid",guest.id);this.context.addguestpop.find("h4").html("修改会员");this.context.addguestpop.find("input[name=guestname]").val(guest.guestname);this.context.addguestpop.find("input[name=birthday]").val(guest.birthday);this.context.addguestpop.find("input[name=nation]").val(guest.nation);this.context.addguestpop.find("input[name=address]").val(guest.address);this.context.addguestpop.find("input[name=phone]").val(guest.phone);this.context.addguestpop.find("input[name=weixin]").val(guest.weixin);this.context.addguestpop.find("input[name=cardnum]").val(guest.membercardnum);this.context.addguestpop.find("input[name=birthday]").val(guest.birthday);this.context.addguestpop.find("textarea[name=remark]").val(guest.remark);this.context.addguestpop.find("input[name=idnum]").val(guest.idnum);var sextpl=this.context.addguestpop.find("div[t=sexlist]").attr("value",guest.sex);this.droplist.sex=M.DropdownList(sextpl,null,{});var idcardtpl=this.context.addguestpop.find("div[t=idcardform]").attr("value",guest.idtype);this.droplist.card=M.DropdownList(idcardtpl,this.idcard_change.toEventHandler(this),{});var cardtpl=this.context.addguestpop.find("div[t=levellist]").attr("value",guest.levelid);this.droplist.level=M.DropdownList(cardtpl,null,{});this.context.addguestpop.attr("sendstatus","0");this.context.addguestpop.find(".droplist_on").removeClass("droplist_on").children("div").hide();this.context.addguestpop.find("input[name=idnum]").bind('keydown',this.idnum_keydown.toEventHandler(this));this.context.addguestpop.find("input[name=idnum]").bind('blur',this.idnum_keydown.toEventHandler(this));M.Popup(this.context.addguestpop,{"hideclass":"modal view fade addguestpop higherlevel","showclass":"modal view fade addguestpop higherlevel in","dragable":true});},deleteguest:function(){var guest=this.guestdetail;this.context.delguestPop.attr('gid',guest.id);M.Popup(this.context.delguestPop,{"hideclass":"modal deletemember fade in","showclass":"modal deletemember fade in","dragable":true});},deleteguestPop_click:function(e){var ele=M.EventEle(e);var t=ele.attr("tag");if(t=='cancel'){M.CloseLast();}
if(t=='sure'){this.deleteguestinfo();}},deleteguestinfo:function(){var gid=this.context.delguestPop.attr('gid');M._getjson("/Crm/deleteguest",{'gid':gid},this.deleteguestinfo_finished.toEventHandler(this),'',true);},deleteguestinfo_finished:function(d){if(d.status=='success'){var gid=d.req.gid;var target=this.context.guestlist.find('tr[gid='+gid+']');target.remove();M.ClosePopup();}else{alert(d.msg);}},idcard_change:function(ele){var val=ele.attr("value");if(val==1){this.context.addguestpop.find("li[tag=birthday]").hide().find("input[name=birthday]").attr('maxlength','18');}else{this.context.addguestpop.find("li[tag=birthday]").show().find("input[name=birthday]").attr('maxlength','').val('');}},getbirthday18idcard:function(value){var year=value.substring(6,10);var month=value.substring(10,12);var day=value.substring(12,14);return year+"-"+month+"-"+day;},idnum_keydown:function(e){var ele=M.EventEle(e);var idtype=this.context.addguestpop.find("div[t=idcardform]").children("span").attr("value");if(idtype!=1)return;var value=ele.val();var birthday='';var reg=/(^\d{14}$)|(^\d{17}(\d|X|x)$)/;if(reg.test(value)){if(value.length>=14){birthday=this.getbirthday18idcard(value);}
this.context.addguestpop.find("input[name=birthday]").val(birthday);}},viewguestpop_click:function(e){var ele=M.EventEle(e);var tag=ele.attr("tag");switch(tag){case'edit':this.editguestinfoshow();break;case'rechargecard':this.showrechargecardpop();break;case'del':this.deleteguest();break;case'switchtab':var t=ele.attr("t");this.context.viewguestpop.find("li[tag=switchtab]").removeClass("active");ele.addClass("active");this.context.viewguestpop.find("div[tag=tab]").hide();if(t==='bookingrecord'){this.showbookingrecord();}else if(t==='rechargerecord'){this.showrechargerecord();}else{this.context.viewguestpop.find("div[id="+t+"]").show();}
break;}},rechargerecord_click:function(e){var ele=M.EventEle(e);var tag=ele.attr("tag");if(tag=='editbalance'){var balance=this.context.rechargerecord.find("span[tag=balance]").text();var gid=this.context.viewguestpop.attr('gid');$("#refundtips").hide();$("#rechargetips").hide();this.context.editbalancepop.attr('gid',gid);this.context.editbalancepop.find("span[tag=rechagebalance]").text(balance);this.context.editbalancepop.find("input[name=type]").removeAttr();this.context.editbalancepop.find("input[name=type]:first").attr('checked','checked');this.context.editbalancepop.find("input[name=amount]").val('');this.context.editbalancepop.find("textarea").val('');M.Popup(this.context.editbalancepop,{"hideclass":"modal fade sm fade","showclass":"modal fade sm in","dragable":true});}},editbalanceinput_blur:function(e){var ele=M.EventEle(e);var type=this.context.editbalancepop.find("input[name=type]:checked").val();var value=ele.val();if(type=='minus'){if(value){$("#refundtips").text("扣款"+value+"元").show();}}else{if(value){$("#rechargetips").text("补款"+value+"元").show();}}},editbalanceinput_focus:function(){$("#refundtips").hide();$("#rechargetips").hide();},editbalancepop_click:function(e){var ele=M.EventEle(e);var tag=ele.attr("tag");if(tag=='radio'){$("#refundtips").hide();$("#rechargetips").hide();this.context.editbalancepop.find("input[name=amount]").val('');this.context.editbalancepop.find("textarea").val('');}
if(tag=='save'){this.editrechagerecord(e);}},editrechagerecord:function(){var data={'type':this.context.editbalancepop.find("input[name=type]:checked").val(),'amount':this.context.editbalancepop.find("input[name=amount]").val(),'remark':this.context.editbalancepop.find("textarea").val(),'guestid':this.context.editbalancepop.attr('gid'),};if(M.isEmpty(data.type)){alert("操作类型不能为空");return;}
if(M.isEmpty(data.amount)){alert("金额不能为空");return;}
if(!M.math_isnumber(data.amount)){alert("金额格式错误");return;}
if(data.amount<0.01){alert("金额不得小于0.01");return;}
if(data.amount>100000){alert("金额不得大于100000");return;}
if(M.isEmpty(data.remark)){alert("备注不能为空");return;}
if(data.remark.length>100){alert("备注不能超过100字");return;}
M._getjson("/Crm/setrechargerecord",data,this.editrechagerecord_finished.toEventHandler(this),'',true);},editrechagerecord_finished:function(d){if(d.status=='success'){this.context.loading.show();this.showrechargerecord();M.CloseLast();}else{alert(d.msg);}},showbookingrecord:function(){var gid=this.context.viewguestpop.attr("gid");var data={"guestid":gid};M._getjson("/Crm/getorderrecord",data,this.getorderrecord_finished.toEventHandler(this),'',true);},getorderrecord_finished:function(d){if(d.status=='success'){var totalprice=d.totalprice;var totalnights=d.totalnights;var guest=d.guest;var list=d.list;this.context.bookingrecord.find("span[tag=totalprice]").html(totalprice);if(!M.isEmpty(guest.levelname)){this.context.bookingrecord.find("span[tag=levelname]").html(guest.levelname);}
this.context.bookingrecord.find("span[tag=totalnights]").html(totalnights);var list_tpl='';for(var k in list){var item=list[k];if(item.orderkind=='room'){list_tpl+='<li class="over"><span class="mr15">'+item.createon+'</span><span class="mr15">预定'+item.hotelname+'（'+item.roomtypename+' × '+item.num+'）</span><span class="mr15">消费￥'+item.needprice+'</span><span class="mr15">【'+item.paytypename+'】</span></li>';}else{if(item.goodsDetail){var info='';for(var i in item.goodsDetail){info+=item.goodsDetail[i].goodsname+'*'+item.goodsDetail[i].num+' ';}
list_tpl+='<li class="over"><span class="mr15">'+item.createon+'</span><span class="mr15">购买'+info+'</span><span class="mr15">消费￥'+item.needprice+'</span><span class="mr15">【'+item.paytypename+'】</span></li>';}else{list_tpl+='<li class="over"><span class="mr15">'+item.createon+'</span><span class="mr15">购买'+item.roomtypename+' × '+item.num+'</span><span class="mr15">消费￥'+item.needprice+'</span><span class="mr15">【'+item.paytypename+'】</span></li>';}}}
this.context.bookingrecord.find("ul").html(list_tpl);this.context.bookingrecord.show();}else{alert(d.msg);}},showrechargerecord:function(){var gid=this.context.viewguestpop.attr("gid");var data={"guestid":gid};M._getjson("/Crm/getrechargerecord",data,this.getrechargerecord_finished.toEventHandler(this),'',true);},getrechargerecord_finished:function(d){if(d.status=='success'){var summary=d.summary;var list=d.list;this.context.rechargerecord.find("span[tag=balance]").html(summary.balance);this.context.rechargerecord.find("span[tag=recharge]").html(summary.recharge);this.context.rechargerecord.find("span[tag=rechargetime]").html(summary.rechargetime);this.context.rechargerecord.find("span[tag=spend]").html(summary.spend);var list_tpl='<li class="over flex-layout">';list_tpl+='<span class="store-date">时间</span>';list_tpl+='<span class="store-operator">操作员</span>';list_tpl+='<span class="store-detail">详情</span>';list_tpl+='<span class="store-num">金额</span>';list_tpl+='</li>';for(var k in list){var item=list[k];if(item.type==1){if(item.mode=='auto'){if(item.remark){if(item.usertimes==0){list_tpl+='<li class="over flex-layout"><span class="store-date">'+item.createon+'</span><span class="store-operator" tag="creator" title="">'+item.creator+'</span><span class="store-detail gray">'+item.remark+'(充值'+item.recharge+'，赠送'+item.give+')</span>'+'<span class="store-num green">+¥'+item.amount+'</span></li>';}else{list_tpl+='<li class="over flex-layout"><span class="store-date">'+item.createon+'</span><span class="store-operator" tag="creator" title="">'+item.creator+'</span><span class="store-detail gray">'+item.remark+'(充值'+item.recharge+'，赠送'+item.give+' 仅限'+item.usertimes+'次）</span>'+'<span class="store-num green">+¥'+item.amount+'</span></li>';}}else{if(item.usertimes==0){list_tpl+='<li class="over flex-layout"><span class="store-date">'+item.createon+'</span><span class="store-operator" tag="creator" title="">'+item.creator+'</span><span class="store-detail gray">充值'+item.recharge+'，赠送'+item.give+'</span>'+'<span class="store-num green">+¥'+item.amount+'</span></li>';}else{list_tpl+='<li class="over flex-layout"><span class="store-date">'+item.createon+'</span><span class="store-operator" tag="creator" title="">'+item.creator+'</span><span class="store-detail gray">充值'+item.recharge+'，赠送'+item.give+' （仅限'+item.usertimes+'次）</span>'+'<span class="store-num green">+¥'+item.amount+'</span></li>';}}}else{list_tpl+='<li class="over flex-layout"><span class="store-date">'+item.createon+'</span><span class="store-operator" tag="creator" title="">'+item.creator+'</span><span class="store-detail gray">'+item.remark+'</span>'+'<span class="store-num green">+¥'+item.amount+'</span></li>';}}else{list_tpl+='<li class="over flex-layout"><span class="store-date">'+item.createon+'</span><span class="store-operator" tag="creator" title="">'+item.creator+'</span><span class="store-detail gray">'+item.remark+'</span><span class="store-num red">-￥'+item.amount+'</span></li>';}}
this.context.rechargerecord.find("ul").html(list_tpl);this.context.rechargerecord.find('span[tag=creator]').each(function(){var text=$(this).text();$(this).attr("title",'').tooltip({position:{my:"left+15 top+20",at:"left bottom"},track:1,content:text,show:{duration:100}});})
this.context.loading.hide();this.context.rechargerecord.show();}else{this.context.loading.hide();alert(d.msg);}},showrechargecardpop:function(){if(M.isEmpty(schemes)){alert("请先设置充值方案");window.location.href="/Crm/charge";return;}
var guest=this.guestdetail;this.rmrechargebygid(guest.id);this.context.rechargepop.attr("gid",guest.id);this.context.rechargepop.find("span[tag=phone]").html(guest.phone);this.context.rechargepop.find("span[tag=guestname]").html(guest.guestname);this.context.rechargepop.find("span[tag=levelname]").html(guest.levelname);this.context.rechargepop.find("select[name=scheme]").val(0);this.context.rechargepop.find("select[name=paytype]").val(0);this.context.rechargepop.find("select[name=marketer]").val(0);this.context.rechargepop.find("textarea[name=remark]").val('');this.scheme_change();M.Popup(this.context.rechargepop,{"hideclass":"modal w500 fade","showclass":"modal w500 fade in","dragable":true});},rmrechargebygid:function(gid){var _that=this;this.context.rechargepop.find("select[name=scheme]").html(this.context.recharge_select);this.context.rechargepop.find("select[name=scheme]").find('option').each(function(){var usertimes=parseInt($(this).attr('usertimes'));var rid=$(this).val();if(usertimes!=0||!M.isEmpty(usertimes)){M._getjson("/Crm/getRechargeCount",{'gid':gid,'rid':rid},_that.getRechargeCount_finished.toEventHandler(this),'',true);}});},getRechargeCount_finished:function(d){if(d.status=='success'){var count=d.data;var req=d.req;var target=$("#rechargepop").find("select[name=scheme]").find("option[value="+req.rid+"]");var usertimes=parseInt(target.attr('usertimes'));if(usertimes<=count){target.remove();}}},guestlist_click:function(e){var ele=M.EventEle(e);var tag=ele.attr("tag");switch(tag){case'filter':this.filterform(ele);break;case'handlefilter':this.handlefilter(ele);break;case'sort':this.sortguest(ele);break;case'option':this.leveloption_click(ele);break;case'selectall':this._handleleveloptionstatus(ele);break;default:var t=ele.parent("tr").attr("tag");if(t=='guest'){this.getguestdetail(ele);}
break;}},leveloption_click:function(ele){var checked=ele.attr("checked");if(checked!="checked"){ele.parents("div[tag=filter]").children().find("input[tag=selectall]").attr("checked",false);}},getguestdetail:function(ele){var gid=ele.parent("tr").attr("gid");var data={"act":"getguestdetail","gid":gid};M._getjson("/Crm/crmmanage",data,this.getguestdetail_finished.toEventHandler(this),'',true);},getguestdetail_finished:function(d){if(d.status=="success"){var guest=d.guest;this.guestdetail=guest;this.showguestdetail();M.Popup(this.context.viewguestpop,{"hideclass":"modal large fade nofade ui-draggable","showclass":"modal large fade in nofade ui-draggable in","dragable":true});}else{M.error(d.msg);}},showguestdetail:function(){var guest=this.guestdetail;this.context.viewguestpop.attr("gid",guest.id);this.context.guestdetail.find("span[tag=guestname]").html(guest.guestname);if(!M.isEmpty(guest.sexname)){this.context.guestdetail.find("span[tag=sex]").html('（'+guest.sexname+'）');}else{this.context.guestdetail.find("span[tag=sex]").html('');}
if(!M.isEmpty(guest.levelname)){this.context.guestdetail.find("span[tag=levelname]").html(guest.levelname);}else{this.context.guestdetail.find("span[tag=levelname]").html('-');}
if(!M.isEmpty(guest.age)&&guest.birthday!='0000-00-00'){this.context.guestdetail.find("span[tag=brithday]").html(guest.birthday+'（'+guest.age+'岁）');}else if(guest.birthday!='0000-00-00'){this.context.guestdetail.find("span[tag=brithday]").html(guest.birthday);}else{this.context.guestdetail.find("span[tag=brithday]").html('-');}
if(!M.isEmpty(guest.nation)){this.context.guestdetail.find("span[tag=nation]").html(guest.nation);}else{this.context.guestdetail.find("span[tag=nation]").html('-');}
if(!M.isEmpty(guest.idnum)){this.context.guestdetail.find("span[tag=idtype]").html(guest.idtypename);this.context.guestdetail.find("span[tag=idnum]").html(guest.idnum);}else{this.context.guestdetail.find("span[tag=idtype]").html('');this.context.guestdetail.find("span[tag=idnum]").html('-');}
if(!M.isEmpty(guest.phone)){this.context.guestdetail.find("span[tag=phone]").html(guest.phone);}else{this.context.guestdetail.find("span[tag=phone]").html('-');}
if(!M.isEmpty(guest.address)){this.context.guestdetail.find("span[tag=address]").html(guest.address);}else{this.context.guestdetail.find("span[tag=address]").html('-');}
if(!M.isEmpty(guest.weixin)){this.context.guestdetail.find("span[tag=weixin]").html(guest.weixin);}else{this.context.guestdetail.find("span[tag=weixin]").html('-');}
if(!M.isEmpty(guest.remark)){this.context.guestdetail.find("span[tag=remark]").html(guest.remark);}else{this.context.guestdetail.find("span[tag=remark]").html('-');}
this.context.guestdetail.find("span[tag=balance]").html(guest.balance);this.context.guestdetail.find("span[tag=createon]").html(guest.createon);this.context.guestdetail.find("span[tag=innname]").html(guest.innname);this.context.viewguestpop.find("li[tag=switchtab]").removeClass("active");this.context.viewguestpop.find("li[t=guestdetail]").addClass("active");this.context.viewguestpop.find("div[tag=tab]").hide();this.context.guestdetail.show();},_handleleveloptionstatus:function(ele){var tpllist=ele.parents("div[tag=filterlist]").children("div").children("div");if(ele.attr("checked")=="checked"){tpllist.children("label").children("input").attr("checked","checked");}else{tpllist.children("label").children("input").attr("checked",false);}},sortguest:function(ele){var orderby=ele.parents("th").attr("orderby");var desc=ele.parents("th").attr("desc");this.sorttarget=ele.parents("th");if(M.isEmpty(desc)){desc="desc";}
this.orderby=orderby;this.desc=desc;var filterlist=this.context.guestlist.children().find("div[tag=filterlist]").children("div").children("div");var levelstr=this._getselectfileter(filterlist);if(M.isEmpty(levelstr)){M.error("请选择客人等级");return;}
var keyword=this.context.keyword.val();var data={"levelstr":levelstr,"keyword":keyword,"orderby":orderby,"desc":desc};M._getjson("/Crm/guestajaxpage",data,this.getguestlist_finished.toEventHandler(this),'',true);},getguestlist_finished:function(d){if(d.status=="success"){var list=d.guestlist;var desc=d.req.desc;var orderby=d.req.orderby;var levelstr=d.req.levelstr;var p=d.req.p;var style_class='';if(desc=="desc"){desc="asc";style_class='sort_down_on';}else{desc="desc";style_class='sort_up_on';}
this.context.guestlist.find('th').removeClass('sort_down_on').removeClass('sort_up_on');this.context.guestlist.find('th[orderby='+orderby+']').attr('desc',desc).addClass(style_class);if(!M.isEmpty(this.sorttarget)){this.sorttarget.attr("desc",desc);}
this.context.guestlist.children("tbody").children("tr[tag=guest]").remove();if(!M.isEmpty(list)){this.context.noguesttip.hide();var guest_html=$.tmpl(this.tpl_guest,list);this.context.guestlist.children("tbody").append(guest_html).children("tr[tag=guest]").show();this.context.guestlist.children("tbody").children("tr[tag=noresult]").hide();}else{this.context.guestlist.children("tbody").children("tr[tag=guest]").hide();this.context.guestlist.children("tbody").children("tr[tag=noresult]").show();this.context.pagelist.hide();this.context.guesttotal.hide();}
var pages=d.pagelist;this.context.guesttotal.show().attr("t",d.total).html('共'+d.total+'个会员').show();this.handlepages(pages);}},handlepages:function(pages){var list=pages.pagelist;if(list.length==0)
return;var nextpage=pages.nextpage;var pageindex=pages.pageindex;var maxpage=pages.maxpage;var prepage=pages.prepage;var html='<li><a p="'+prepage+'" tag="page" href="javascript:void(0);">&laquo;</a></li>';for(var i=0;i<list.length;i++){var p=list[i];if(p.code==pageindex){html+='<li class="active"><a href="javascript:void(0);" title="">'+p.name+'</a></li>';}else{html+=' <li><a href="javascript:void(0);" tag="page" p="'+p.code+'" title="">'+p.name+'</a></li>'}}
if(maxpage>5){if(maxpage-pageindex>2){html+='<li><a href="javascript:void(0);">...</a></li>';html+='<li><a href="javascript:void(0);" tag="page" p="'+maxpage+'">'+maxpage+'</a></li>';}}
html+='<li><a href="javascript:void(0);" tag="page" p="'+nextpage+'">&raquo;</a></li>';this.context.pagelist.show().html(html);},handlefilter:function(ele){var filterlist=ele.parents("div[tag=filterlist]").children("div").children("div");var levelstr=this._getselectfileter(filterlist);if(M.isEmpty(levelstr)){M.error("请选择客人等级");return;}
this.levelstr=levelstr;ele.parents("th[tag=filter]").removeClass("filter_on");ele.parents("div[tag=filterlist]").hide();var keyword=this.context.keyword.val();var data={"levelstr":levelstr,"keyword":keyword,"orderby":this.orderby,"desc":this.desc};M._getjson("/Crm/guestajaxpage",data,this.getguestlist_finished.toEventHandler(this),'',true);},_getselectfileter:function(filterlist){var filterdata=[];filterlist.each(function(){var filter=$(this).children("label").children("input[name=level]");if(filter.attr("checked")=="checked"){filterdata.push(filter.val());}});return filterdata.toString();},filterform:function(ele){var showstatus=ele.parents("th[tag=filter]").children().find("div[tag=filterlist]").css("display");ele.parents("th[tag=filter]").children().find("div[tag=filterlist]").toggle();if(showstatus=="none"){var filterlist=ele.parents("th[tag=filter]").children().find("div[tag=filterlist]").children("div").children("div");this._handlelevelstatus(filterlist);ele.parents("th[tag=filter]").addClass("filter_on");}else{ele.parents("th[tag=filter]").removeClass("filter_on");}},_handlelevelstatus:function(filterlist){var levellist=this.levelstr.split(",");if(this.levelstr==''){filterlist.each(function(){$(this).children("label").children("input").attr("checked","checked");});}else{filterlist.each(function(){var value=$(this).children("label").children("input[name=level]").attr("value");var has=0;for(var i=0;i<levellist.length;i++){var l=levellist[i];if(value==l){has=1;}}
if(has==1){$(this).children("label").children("input[name=level]").attr("checked","checked");}else{$(this).children("label").children("input[name=level]").attr("checked",false);$(this).children("label").children("input[tag=selectall]").attr("checked",false);}});}},filterguest:function(){},merge_finished:function(d){},NoUndefined:function(str)
{return M.isEmpty(str)?"":str;},destroy:function(){}});M.ready(function(){var crm=new M.Page.CrmPage();return crm;});