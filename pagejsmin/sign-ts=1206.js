M.Page.SingPage=M.createClass();M.extend(M.Page.SingPage.prototype,{context:{},cache_ele:'',signed:'',phonechannel:'dx',tpl_mobile:'<li m_id="${id}" tag="mobile"><label>${mobile}</label><a tag="delete" href="#?" title="删除该手机" class="delete"></a></li>',init:function(){this.initDOM();this.initEvent();this.initfileupload();},initDOM:function(){this.context.applyform=$("#applyform");this.context.maincontent=$("#maincontent");this.context.rulelist=$("#rulelist");this.context.positivecard=$("#positivecard");this.context.oppositecard=$("#oppositecard");this.context.progress1=$("#progress1");this.context.progress2=$("#progress2");this.context.mobilelist=$("#mobilelist");this.context.addinnsign=$("#addinnsign");this.signed=this.context.maincontent.attr('signed');},initEvent:function(){this.context.applyform.bind("click",this.applyform_click.toEventHandler(this));this.context.positivecard.bind("click",this.positivecard_click.toEventHandler(this));this.context.oppositecard.bind("click",this.oppositecard_click.toEventHandler(this));this.context.mobilelist.bind("click",this.mobilelist_click.toEventHandler(this));this.context.addinnsign.bind("click",this.addinnsign_click.toEventHandler(this));},addinnsign_click:function(e){var ele=M.EventEle(e);ele.parent().hide();this.context.applyform.show();},_getinnid:function()
{var innid=this.context.maincontent.attr("innid");return innid;},oppositecard_click:function(){this.context.applyform.find("input[t=oppositecard]").click();},positivecard_click:function(){this.context.applyform.find("input[t=positivecard]").click();},applyform_click:function(e){var ele=M.EventEle(e);var t=ele.attr('tag');switch(t){case'delimg':this.delimage(ele);break;case'sendvcode':this.sendvcode();break;case'apply':this.applydx();break;case'reapply':this.reapply();break;case'selectinn':this.selectinn(ele);break;}},selectinn:function(ele){var innid=ele.attr('value');var target=this.context.applyform.find('label[innid='+innid+']');var checkedstatus=ele.attr('checked');if(checkedstatus=='checked'){target.show();}else{target.hide();}},initaddresstitle:function(){var checkedlength=this.context.applyform.find('input[name=signhotel]:checked').length;if(checkedlength==0){this.context.applyform.find('li[tag=addresstitle]').hide();}else{this.context.applyform.find('li[tag=addresstitle]').show();}
var signhotellength=this.context.applyform.find('input[name=signhotel]').length;if(signhotellength==1){this.context.applyform.find('input[name=signhotel]').attr('checked','checked');this.context.applyform.find('li[tag=addresstitle]').show();this.context.applyform.find('li[tag=address]').show();}},reapply:function(){var inndata=this._getselectinn();if(!M.isEmpty(inndata.error)){alert(inndata.error);return;}
var data={};data.innlist=JSON.stringify(inndata.innlist);M._getjson('/Ota/reapplydx',data,this.reapplydx_finished.toEventHandler(this),'',true);},reapplydx_finished:function(d){if(d.status=="success"){alert('重新签约成功');window.location.reload();}else{if(!M.isEmpty(d.msg)){alert(d.msg);}}},applydx:function(){var ownername=this.context.applyform.find('input[name=ownername]').val();var idnum=this.context.applyform.find('input[name=idnum]').val();var phone=this.context.applyform.find('input[name=phone]').val();var vcode=this.context.applyform.find('input[name=vcode]').val();var positivecard=this.context.applyform.find('img[t=positivecard]').attr('path');var oppositecard=this.context.applyform.find('img[t=oppositecard]').attr('path');var data={'ownername':ownername,'idnum':idnum,'phone':phone,'vcode':vcode,'positivecard':positivecard,'oppositecard':oppositecard,'type':'dx_apply'};var innidlist=[];this.context.applyform.find('input[name=signhotel]:checked').each(function(){var innid=$(this).val();if(!M.isEmpty(innid)){innidlist.push(innid);}});if(innidlist.length==0){alert('请选择要签约的客栈');return;}
data.innidstr=innidlist.toString();var inndata=this._getselectinn();if(!M.isEmpty(inndata.error)){alert(inndata.error);return;}
data.innlist=JSON.stringify(inndata.innlist);M._getjson('/Ota/applydx',data,this.applydx_finished.toEventHandler(this),'',true);},applydx_finished:function(d){if(d.status=="success"){var data=d.data;var phonelist=data.phonelist;this.signed=2;alert('认证资料提交成功，请尽快设置好代销价格~');window.location.reload();}else{alert(d.msg);}},sendvcode:function(){var phone=this.context.applyform.find('input[name=phone]').val();if(M.isEmpty(phone)){alert('手机号不能为空');return false;}
var re=/^(13|14|15|16|17|18|19)[0-9]{9}$/;if(!re.test(phone))
{alert("请输入正确的手机号");return false;}
var verifycode=this.context.applyform.find('input[name=verifycode]').val();M._getjson('/Ota/sendvcode',{'phone':phone,'type':'dx_apply','verifycode':verifycode},this.sendvcode_finished.toEventHandler(this),'',true);},sendvcode_finished:function(d){if(d.status=="success"){this.context.applyform.find("span[tag=timecount]").show().attr('c','120').html('120秒后可重发');this.context.applyform.find("a[tag=sendvcode]").hide();this.timer=window.setInterval(this.run.toEventHandler(this),1000);}else{alert(d.msg);}},run:function(){var c=this.context.applyform.find("span[tag=timecount]").attr('c');if(c<=1){this.context.applyform.find("a[tag=sendvcode]").show().html('重新发送');this.context.applyform.find("span[tag=timecount]").hide();window.clearInterval(this.timer);}else{c=parseInt(c)-1;this.context.applyform.find("span[tag=timecount]").show().attr('c',c).html(c+'秒后可重发');}},delimage:function(ele){var target=ele.parent();var t=target.children('img').attr('t');if(t=='positivecard'){this.context.positivecard.show();}else{this.context.oppositecard.show();}
target.remove();},mobilelist_click:function(e){var ele=M.EventEle(e);var t=ele.attr("tag");if(t=='add'){this.addmobile();}
if(t=='delete'){this.deletemobile(ele);}},deletemobile:function(ele){if(!window.confirm("你确定要删除吗？")){return;}
var id=ele.parent("li").attr("m_id");var innid=this._getinnid();M._getjson("/Ota/mobileDel",{"act":"deleteotamobile","innid":innid,"id":id,'source':this.phonechannel},this.deletemobile_finished.toEventHandler(this),'post',true);},deletemobile_finished:function(d){if(d.status=='success'){var id=d.req.id;this.context.mobilelist.children().find("li[m_id="+id+"]").remove();var length=this.context.mobilelist.children("ul").children("li[tag=mobile]").length;if(length<3){this.context.mobilelist.children("ul").children("li[tag=addnew]").show();}}else{if(!M.isEmpty(d.msg)){M.error(d.msg);}else{M.error("网络错误");}}},addmobile:function(){var mobile=M.getVal(this.context.mobilelist.children().find("input[name=mobile]"));var innid=this._getinnid();M._getjson("/Ota/mobileAdd",{"act":"addotamobile","innid":innid,"mobile":mobile,'source':this.phonechannel},this.addmobile_finished.toEventHandler(this),'post',true);},addmobile_finished:function(d){if(d.status=="success"){M.emptyVal(this.context.mobilelist.children().find("input[name=mobile]"));var data={"id":d.d.id,"mobile":d.req.mobile};var tpl=$.tmpl(this.tpl_mobile,data);var target=this.context.mobilelist.children().find("li[class=addnew]");target.before(tpl);var length=this.context.mobilelist.children("ul").children("li[tag=mobile]").length;if(length>=3){this.context.mobilelist.children("ul").children("li[tag=addnew]").hide();}}else{if(!M.isEmpty(d.msg)){M.error(d.msg);}else{M.error("网络错误");}}},initfileupload:function(){var tpl=this.context.applyform.children().find("input[type=file][tag=file]");var innid=this._getinnid();var that=this;tpl.each(function(){var type=$(this).attr("t");var url='/Ota/uploadImg?type='+type+'&innid='+innid;$(this).fileupload({url:url,dataType:'json',autoUpload:true,maxFileSize:1000000000,previewMaxWidth:100,previewMaxHeight:100,limitMultiFileUploadSize:5,previewCrop:true,beforeSend:function(e,data){var size=data.files[0].size;var limit=5*1024*1024;if(limit<size){M.error('您上传的图片太大了，请将图片压缩至5MB以下');return false;}
var limittype=new Array('JPG','JPEG','PNG','GIF','BMP','jpg','jpeg','png','gif','bmp');var type=data.files[0].type;var has=0;for(var i=0;i<limittype.length;i++){var item=limittype[i];if(type.indexOf(item)!=-1){has=1;}}
if(has==0){M.error('暂不支持这种格式的图片，请上传JPG/JPEG/PNG/GIF/BMP等格式');return false;}},done:function(e,data){var d=data.result;var ele=M.EventEle(e);if(d.status=="success"){that._finishedupload(d,ele);}else{M.error(d.msg);that._handleerror(ele);}},fail:function(jqXHR,textStatus,errorThrown,options){var a=eval('('+textStatus.jqXHR.responseText+')');},progressall:function(e,data){var ele=M.EventEle(e);var progress=parseInt(data.loaded/data.total*100,10);that._processhandle(ele,progress);}});});},_processhandle:function(ele,progress){var t=ele.attr("t");if(t=='positivecard'){this.context.progress1.show().children("span").html(progress+'%');this.context.positivecard.hide();}else{this.context.progress2.show().children("span").html(progress+'%');this.context.oppositecard.hide();}},_handleerror:function(ele){var t=ele.attr('t');if(t=='positivecard'){this.context.progress1.hide().children("span").html('0%');this.context.positivecard.show();}else{this.context.progress2.hide().children("span").html('0%');this.context.oppositecard.show();}},_finishedupload:function(d,ele){var t=ele.attr('t');if(t=='positivecard'){this.context.progress1.hide().children("span").html('0%');this.context.positivecard.hide();}else{this.context.progress2.hide().children("span").html('0%');this.context.oppositecard.hide();}
var data=d.data;var html='';html+='<div class="certificate">';html+=' <img width="70px" height="70px" src="'+data.url+'" path="'+data.path+'" t="'+t+'" alt="">';html+=' <a href="javascript:;" class="delete" tag="delimg"></a>';html+=' </div>';this.context.progress1.before(html);},_getselectinn:function(){var list=this.context.applyform.find('input[name=signhotel]:checked').parent();var innlist=[];var error='';list.each(function(){var innid=$(this).children('input[name=signhotel]').val();var address=M.getVal($(this).find('input[name=address]'));if(M.isEmpty(address)&&M.isEmpty(error)){error='客栈地址不能为空';}
var tmp={'innid':innid,'address':address};innlist.push(tmp);});return{'error':error,'innlist':innlist};},});var SingPage;M.ready(function(){SingPage=new M.Page.SingPage();return SingPage;});