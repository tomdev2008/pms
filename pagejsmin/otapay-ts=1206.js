M.Page.OtaPayPage=M.createClass();M.extend(M.Page.OtaPayPage.prototype,{context:{},temp_interval:{},chargesetting:{},getTradingId:0,getTradingCode:0,amount:0,payname:'',refresh:1,type:'',accounttpl:"<p>公司名称: 北京米天下科技股份有限公司</p><p>开户行: 中国光大银行股份有限公司北京上地支行</p><p>银行帐号: 353701880000 37100</p>",init:function(){this.initDOM();this.initEvent();},initDOM:function(){this.context.payform=$("#payform");this.context.payqrcodeform=$("#payqrcodeform");this.context.orderchannel=$("#orderchannel");var refresh=this.context.orderchannel.attr('refresh');if(!M.isEmpty(refresh)){this.refresh=refresh;}
this.context.otapayrule=$("#otapayrule");this.context.showpayrule=$("#showpayrule");this.context.contactform=$("#contactform");this.context.otacontact=$("#otacontact");this.context.appletbuy=$("#appletbuy");this.context.smsrecharge=$("#smsrecharge");this.context.rechargePop=$("#rechargePop");this.context.cashierPop=$("#cashierPop");this.context.statusPop=$("#statusPop");this.context.vipbuy=$("#vipbuy");this.context.payresultform=$("#payresultform");this.context.viptip=$("#viptip");this.context.radarbuy=$("#radarbuy");this.context.wkzbuy=$("#wkzbuy");this.context.wkzrebuy=$("#wkzrebuy");this.context.marketerRechargePop=$("#marketerRechargePop");this.context.payFinishPop=$("#payFinishPop");this.context.showaccount=$("#showaccount");this.context.marketercharge=$("#marketercharge");this.context.scroll_top=$("#sidebar");this.context.basicservicebuy=$("#basicservicebuy");this.context.basicserviceform=$("#basicserviceform");this.context.tipmsgform=$("#tipmsgform");this.context.memberbuyform=$("#memberbuyform");},initEvent:function(){$("#maincontent").scroll(this._scroll.toEventHandler(this));this.context.payform.bind("click",this.payform_click.toEventHandler(this));this.context.basicserviceform.bind("click",this.basicserviceform_click.toEventHandler(this));this.context.orderchannel.bind("click",this.orderchannel_click.toEventHandler(this));this.context.basicservicebuy.bind("click",this.basicservicebuy_click.toEventHandler(this));this.context.memberbuyform.bind("click",this.memberbuyform_click.toEventHandler(this));this.context.showpayrule.bind("click",this.showpayrule_click.toEventHandler(this));this.context.otacontact.bind("click",this.otacontact_click.toEventHandler(this));this.context.appletbuy.bind("click",this.appletbuy_click.toEventHandler(this));this.context.radarbuy.bind("click",this.radarbuy_click.toEventHandler(this));this.context.wkzbuy.bind("click",this.wkzbuy_click.toEventHandler(this));this.context.wkzrebuy.bind("click",this.wkzbuy_click.toEventHandler(this));this.context.smsrecharge.bind("click",this.smsrecharge_click.toEventHandler(this));this.context.rechargePop.bind("click",this.rechargePop_click.toEventHandler(this));this.context.vipbuy.bind("click",this.vipbuy_click.toEventHandler(this));this.context.tipmsgform.bind("click",this.tipmsgform_click.toEventHandler(this));this.context.viptip.attr("title",'').tooltip({position:{my:"left+15 top+20",at:"left bottom"},track:1,content:'含渠道直连、小程序及云掌柜即将推出的其他增值服务',show:{duration:100}});this.context.showaccount.attr("title",'').tooltip({position:{my:"left+15 top+20",at:"left bottom"},track:1,content:this.accounttpl,show:{duration:100}});this.context.marketercharge.bind("click",this.marketercharge_click.toEventHandler(this));this.context.marketerRechargePop.bind("click",this.marketerRechargePop_click.toEventHandler(this));},basicserviceform_click:function(e){var ele=M.EventEle(e);var t=ele.attr('tag');if(M.isEmpty(t)){ele=ele.parents('li[tag=month]');t=ele.attr('tag');}
switch(t){case'month':var month=ele.attr('month');this.context.basicserviceform.find('li[tag=month]').removeClass('active');this.context.basicserviceform.find('li[tag=month][month='+month+']').addClass('active');break;}},memberbuyform_click:function(e){var ele=M.EventEle(e);var t=ele.attr('tag');if(M.isEmpty(t)){ele=ele.parents('li');t=ele.attr('tag');}
switch(t){case'buyvip':this.context.memberbuyform.find('ul[tag=servicelist]').children('li').removeClass('active');ele.addClass('active');break;case'basicservice':this.context.memberbuyform.find('ul[tag=servicelist]').children('li').removeClass('active');ele.addClass('active');break;case'buy':var target=this.context.memberbuyform.find('ul[tag=servicelist]').children('li.active');var tag=target.attr('tag');var invitecode=M.getVal(this.context.memberbuyform.find('input[name=invitecode]'));if(tag=='basicservice'){var month=target.attr('month');M._getjson('/Pay/getbasicservicepayinfo',{'month':month,'invitecode':invitecode},this.pay_finished.toEventHandler(this),'',true);}
if(tag=='buyvip'){M._getjson('/Pay/getvippayinfo',{'invitecode':invitecode},this.pay_finished.toEventHandler(this),'',true);}
break;}},basicservicebuy_click:function(){this.context.memberbuyform.find('ul[tag=servicelist]').children('li').removeClass('active');this.context.memberbuyform.find('ul[tag=servicelist]').children('li[tag=basicservice][month=1]').addClass('active');M.Popup(this.context.memberbuyform,{'hideclass':'modal fade','showclass':'modal fade in'},function(){}.toEventHandler(this));},vipbuy_click:function(){this.context.memberbuyform.find('ul[tag=servicelist]').children('li').removeClass('active');this.context.memberbuyform.find('ul[tag=servicelist]').children('li[tag=buyvip]').addClass('active');M.Popup(this.context.memberbuyform,{'hideclass':'modal fade','showclass':'modal fade in'},function(){}.toEventHandler(this));},_scroll:function(){},rechargePop_click:function(e){var ele=M.EventEle(e);var t=ele.attr('tag');if(t=='recharge'){this.rechargeFun();}else if(t=='ainfor'){this.context.rechargePop.find('div[tag=account]').show();}else if(t=='recharge_method'){var payway=this.context.rechargePop.find('input[name=method]:checked').val();if(payway=='money'){this.context.rechargePop.find('li[tag=activity]').hide();}else{this.context.rechargePop.find('li[tag=activity]').show();}}},rechargeFun:function(){this.getTradingId=0;this.getTradingCode=0;this.type="sms";var money=this.context.rechargePop.find('input[name=money]').val();var payway=this.context.rechargePop.find('input[name=method]:checked').val();if(payway=='points'){money=200;}
if(money<=0){alert('请填写充值金额');return false;}
var data={'money':money,'payway':payway};this.amount=money;this.payname='智能短信';M._getjson('/Shortmessage/recharge',data,this._rechargeFun_callback.toEventHandler(this),'',true);},_rechargeFun_callback:function(d){if(d.status=='success'){M.ClosePopup();M.Popup(this.context.cashierPop,{'hideclass':'modal view cashier fade','showclass':'modal view cashier fade in'},function(){}.toEventHandler(this));var data=d.data;this.context.cashierPop.find('img[tag=qrcode]').attr('src',data.qr_url);this.context.cashierPop.find('span[tag=money]').html(data.money);this.getTradingId=data.trading_id;this.getTradingCode=data.trading_code;this._longPolling();}else{alert(d.msg);}},_longPolling:function(){var aid=this.getTradingId;var trade_no=this.getTradingCode;var type=this.type;var data={"op":"getpaystatus","out_trade_no":aid,"trade_no":trade_no,'type':type};M._getjson("/pay/getpaystatus",data,this.getsmspaystatus_finished.toEventHandler(this));},getsmspaystatus_finished:function(d){if(d.status=='handling'){var showstatus=this.context.cashierPop.css("display");if(showstatus!="none"){var _this=this;setTimeout(function(){_this._longPolling()},10000)}}else{M.ClosePopup();if(d.req.type=='sms'){M.Popup(this.context.statusPop,{'hideclass':'modal cashier fade','showclass':'modal cashier fade in'},function(){}.toEventHandler(this));this.context.statusPop.find('span[tag=price]').html(d.total_fee);var div_status=this.context.statusPop.find('div[tag=status]');if(d.status=='success'){div_status.children('p:eq(0)').removeClass('red').addClass('green').html('支付成功！');div_status.children('p:eq(1)').html('您可通过短信频道查看余额的变化');}else{div_status.children('p:eq(0)').removeClass('green').addClass('red').html('支付失败！');div_status.children('p:eq(1)').html('您可以稍后再试或使用其他支付方式');}}else{M.Popup(this.context.payFinishPop,{'hideclass':'modal cashier fade','showclass':'modal cashier fade in'},function(){}.toEventHandler(this));this.context.payFinishPop.find('span[tag=price]').html(d.total_fee);var div_status=this.context.payFinishPop.find('div[tag=status]');if(d.status=='success'){div_status.children('p:eq(0)').removeClass('red').addClass('green').html('支付成功！');div_status.children('p:eq(1)').html('您可通过推广大使频道查看余额的变化');}else{div_status.children('p:eq(0)').removeClass('green').addClass('red').html('支付失败！');div_status.children('p:eq(1)').html('您可以稍后再试或使用其他支付方式');}}}},smsrecharge_click:function(){M._getjson('/Pay/getusersmsacount',{},this.getusersmsacount_finished.toEventHandler(this),'',true);},getusersmsacount_finished:function(d){if(d.status=="success"){this.context.rechargePop.find('input[name=money]').val('');this.context.rechargePop.find('span[tag=price]').html(d.data.amount);this.context.rechargePop.find('input[name=method]:last').attr('checked','checked');this.context.rechargePop.find('li[tag=activity]').show();M.Popup(this.context.rechargePop,{'hideclass':'modal view fade recharge','showclass':'modal view fade in recharge'},function(){}.toEventHandler(this));}else{alert(d.msg);}},radarbuy_click:function(){M._getjson('/Pay/getdataradarinfo',{},this.pay_finished.toEventHandler(this));},wkzbuy_click:function(){M._getjson('/Pay/getwkzpayinfo',{},this.pay_finished.toEventHandler(this));},appletbuy_click:function(){this.payname='微官网小程序';M._getjson('/Applet/getotapayinfo',{'month':12,'buytype':'applet'},this.pay_finished.toEventHandler(this));},otacontact_click:function(){M.Popup(this.context.contactform,{"hideclass":"modal fade in modal-touch","showclass":"modal fade in modal-touch in"},function(){}.toEventHandler(this));},showpayrule_click:function(){M.Popup(this.context.otapayrule,{"hideclass":"modal view fade large","showclass":"modal view fade large in"},function(){}.toEventHandler(this));},payform_click:function(e){var ele=M.EventEle(e);var t=ele.attr('tag');switch(t){case'close':M.ClosePopup();break;case'setmonth':this.context.payform.find('div[tag=channellist]').find('a[tag=setmonth]').removeClass('active');ele.addClass('active');this._setpayamount();break;case'setbuytype':this._setpayamount(ele);break;break;case'setchannel':this._setpayamount();break;case'selectinn':this._setpayamount();break;case"pay":this.pay();break;case"showmoreinn":this.otherinntoggle();break;case'selectallinn':this.selallinn(ele);break;}},selallinn:function(ele){var checked=ele.attr('checked');if(checked=="checked"){this.context.payform.find('ul[tag=innlist]').find('input[name=innid]').attr('checked','checked');}else{this.context.payform.find('ul[tag=innlist]').find('input[name=innid]').attr('checked',false);}},pay:function(){var buytype=this.context.payform.find('input[name=buytype]:checked').val();var month=0;var channellist=[];if(buytype!='all'){month=this.context.payform.find('div[tag=channellist]').find('a[tag=setmonth].active').attr('value');var tpl_channellist=this.context.payform.find('div[tag=channellist]').find('input[name=channel]:checked');if(tpl_channellist.length==0){alert('请选择要订购的OTA渠道');return;}
tpl_channellist.each(function(){channellist.push($(this).val());});var tpl_checkchannellist=this.context.payform.find('div[tag=channellist]').find('input[name=channel][needpay=1]:checked');if(tpl_checkchannellist.length==0){alert('抱歉，目前无法只针对美团、airbnb、expedia或途家渠道提供直连服务');return;}}
this.payname='渠道直连';M._getjson('/Ota/getotapayinfo',{'channelstr':channellist.toString(),'month':month,'buytype':buytype},this.pay_finished.toEventHandler(this));},pay_finished:function(d){if(d.status=="success"){var data=d.data;var paystatus=d.paystatus;var tipmsg=d.tipmsg;if(paystatus==1){this.showpayresult(1,this.amount,this.channelname);}
this.amount=d.amount;this.context.payqrcodeform.find('span[tag=money]').html(d.amount);this.context.payqrcodeform.find('img').attr('src',data.pay_qr);this.context.payqrcodeform.attr('billid',d.billid);if(!M.isEmpty(tipmsg)){this.context.tipmsgform.find('p[tag=msg]').html(tipmsg);this.context.tipmsgform.attr('billid',d.billid);M.Popup(this.context.tipmsgform,{"hideclass":"modal sm fade in","showclass":"modal sm fade in"},function(){}.toEventHandler(this));}else{M.Popup(this.context.payqrcodeform,{"hideclass":"modal view cashier fade in","showclass":"modal view cashier fade in"},function(){}.toEventHandler(this));this.getpaystatus(d.billid);}}else{if(!M.isEmpty(d.msg)){alert(d.msg);}}},tipmsgform_click:function(e){var ele=M.EventEle(e);var t=ele.attr('tag');if(t=='buy'){M.CloseLast();var billid=this.context.tipmsgform.attr('billid');M.Popup(this.context.payqrcodeform,{"hideclass":"modal view cashier fade in","showclass":"modal view cashier fade in"},function(){}.toEventHandler(this));this.getpaystatus(billid);}},showpayresult:function(paystatus,amount,channelname){if(paystatus==1){M.ClosePopup();this.context.payresultform.find('p[tag=desc]').html('您已成功支付'+amount+'元，感谢您对云掌柜服务的信任和支持。');M.Popup(this.context.payresultform,{"hideclass":"modal cashier fade","showclass":"modal cashier fade in"},function(){}.toEventHandler(this));}},getpaystatus:function(billid){M._getjson('/Ota/getpaystatus',{'billid':billid},this.getpaystatus_finished.toEventHandler(this));},getpaystatus_finished:function(d){if(d.status=="success"){var data=d.data;if(this.refresh==1){location.reload();}else{this.showpayresult(1,data.amount,data.channelname);}}else{var _this=this;setTimeout(function(){_this.getpaystatus(d.billid)},10000)}},_setpayamount:function(){var buytype=this.context.payform.find('input[name=buytype]:checked').val();if(buytype=='all'){var payamount=3588;var discountamount=0;this.context.payform.find('div[tag=channellist]').hide();}else{this.context.payform.find('div[tag=channellist]').show();var month=this.context.payform.find('div[tag=channellist]').find('a[tag=setmonth].active').attr('value');if(month=='week'){month=0;}
var tpl_channellist=this.context.payform.find('div[tag=channellist]').find('input[name=channel][needpay=1]:checked');var channellength=tpl_channellist.length;var amount=M.math_format(this.chargesetting.baseprice)*month*channellength;var payamount=amount;for(var i=0;i<this.chargesetting.discountsetting.length;i++){var item=this.chargesetting.discountsetting[i];if(amount>=item.min&&amount<=item.max){payamount=amount*item.discount/10;}}
var discountamount=M.math_min(amount,payamount);}
this.context.payform.find('strong[tag=payamount]').html(payamount);if(discountamount>0){this.context.payform.find('span[tag=discountamount]').show().html('省¥'+discountamount);}else{this.context.payform.find('span[tag=discountamount]').hide();}},orderchannel_click:function(){var otacode=this.context.orderchannel.attr('channel');M._getjson('/Ota/getchargesetting',{'otacode':otacode},this.getchargesetting_finished.toEventHandler(this));},ota_buy:function(ele){var otacode=ele.parents("li").attr("ota");M._getjson('/Ota/getchargesetting',{'otacode':otacode},this.getchargesetting_finished.toEventHandler(this));},getchargesetting_finished:function(d){if(d.status=="success"){this.context.payform.find('div[tag=channellist]').find('input[name=channel]').attr('checked',false);var channel=d.data.channel;this.context.payform.find('div[tag=channellist]').find('input[name=channel]').each(function(){var value=$(this).val();if(channel.indexOf(value)!=-1){$(this).attr('checked','checked');}});this.context.payform.find('div[tag=channellist]').find('a[tag=setmonth][value=12]').addClass('active');this.chargesetting=d.data.setting;this.context.payform.find('input[name=buytype]').attr('checked',false);this.context.payform.find('input[name=buytype][value=all]').attr('checked','checked');this._setpayamount();this.context.payform.find('input[tag=selectallinn]').parent().show();M.Popup(this.context.payform,{"hideclass":"modal view fade large in","showclass":"modal view fade large in"},function(){}.toEventHandler(this));}else{if(!M.isEmpty(d.msg)){alert(d.msg);}}},marketercharge_click:function(){M._getjson('/Microinn/getMarketerSettleBalance',{},this.marketercharge_callback.toEventHandler(this),'',true);},marketercharge_callback:function(d){if(d.status=='success'){var data=d.data;this.context.marketerRechargePop.find('div[tag=account]').hide();this.context.marketerRechargePop.find("span[tag=price]").html(data.balance);this.context.marketerRechargePop.find("input[name=amount]").val('');M.Popup(this.context.marketerRechargePop,{'hideclass':'modal view fade recharge ui-draggable','showclass':'modal view fade in recharge ui-draggable'},function(){}.toEventHandler(this));}else{alert(d.msg);}},marketerRechargePop_click:function(e){var ele=M.EventEle(e);var tag=ele.attr("tag");this.type="marketerSettleCharge";if(tag=='recharge'){this.marketerRechargeFun();}},marketerRechargeFun:function(){this.getTradingId=0;this.getTradingCode=0;var amount=this.context.marketerRechargePop.find('input[name=amount]').val();if(amount<=0){alert('请填写充值金额');return false;}
var data={'amount':amount};this.amount=amount;this.payname='推广大使待结算充值';M._getjson('/Microinn/marketerSettleCharge',data,this._marketerRechargeFun_callback.toEventHandler(this),'',true);},_marketerRechargeFun_callback:function(d){if(d.status=='success'){M.ClosePopup();M.Popup(this.context.cashierPop,{'hideclass':'modal view cashier fade','showclass':'modal view cashier fade in'},function(){}.toEventHandler(this));var data=d.data;this.context.cashierPop.find('img[tag=qrcode]').attr('src',data.pay_qr);this.context.cashierPop.find('span[tag=money]').html(d.amount);this.getTradingId=d.billid;this.getTradingCode=data.trade_no;this._longPolling();}else{alert(d.msg);}},});var orderpay;M.ready(function(){orderpay=new M.Page.OtaPayPage();return orderpay;});