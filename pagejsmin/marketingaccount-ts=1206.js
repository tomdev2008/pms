M.Page.MicroMarketingAccountPage=M.createClass();M.extend(M.Page.MicroMarketingAccountPage.prototype,{context:{},tip:'代结算需保证账户内有充足余额，微信平台会收取一定的手续费。微信手续费为0.6%，实际支付金额=充值金额/（1-0.6%）',init:function(){this.initDOM();this.initEvent();this.initdatepicker();this.initdroplist();},initDOM:function(){this.context.body=$(document.body);this.context.achievementlist=$("#achievementlist");this.context.cashierPop=$("#cashierPop");this.context.payFinishPop=$("#payFinishPop");this.context.unaccountPop=$("#unaccountPop");this.context.unaccount=$("#unaccount");this.context.account=$("#account");this.context.accountPop=$("#accountPop");this.context.orderlistPop=$("#orderlistPop");this.context.showrules=$("#showrules");},initEvent:function(){this.context.body.bind("click",this.document_click.toEventHandler(this));this.context.achievementlist.bind("click",this.achievementlist_click.toEventHandler(this));this.context.achievementlist.find("input[name=fromdate]").datepicker({showOtherMonths:true,selectOtherMonths:true,onSelect:this.initdatepicker.toEventHandler(this)});this.context.achievementlist.find("input[name=enddate]").datepicker({showOtherMonths:true,selectOtherMonths:true});this.context.achievementlist.find("input[name=dateval]").bind("focus",this.dateval_focus.toEventHandler(this));this.context.unaccountPop.bind('click',this.unaccountPop_click.toEventHandler(this));this.context.unaccount.bind('click',this.unaccount_click.toEventHandler(this));this.context.accountPop.bind('click',this.accountPop_click.toEventHandler(this));this.context.account.bind('click',this.account_click.toEventHandler(this));this.context.showrules.tooltip({position:{my:"left+15 top+0",at:"left bottom"},track:1,content:this.tip,show:{duration:100}});},account_click:function(){var tpl=this.context.achievementlist.find("input[name=cb]:checked");if(tpl.length==0){alert("请选择订单！");return;}
var checkedprice=$('#checkedprice').html();var userprice=$('#userprice').html();if(parseInt(userprice*1000)<parseInt(checkedprice*1000)){alert("账户余额不足！请先充值");return;}
M.Popup(this.context.accountPop,{"dragable":false,"hideclass":"modal fade","showclass":"modal sm fade deletemember in"},function(){}.toEventHandler(this));},accountPop_click:function(e){var ele=M.EventEle(e);var tag=ele.attr("tag");if(tag=='save'){var tpl=this.context.achievementlist.find("input[name=cb]:checked");var idstr=comm='';tpl.each(function(){var id=$(this).attr("id");idstr+=comm+id;comm=',';});var data={"id":idstr};M._getjson("/Market/account",data,this.account_finished.toEventHandler(this));}else if(tag=='cancel'){M.ClosePopup();}},account_finished:function(d){if(d.status=='success'){window.location.reload();}else{alert(d.msg);}},unaccount_click:function(){var tpl=this.context.achievementlist.find("input[name=cb]:checked");if(tpl.length==0){alert("请选择订单！");return;}
M.Popup(this.context.unaccountPop,{"dragable":false,"hideclass":"modal fade","showclass":"modal sm fade deletemember in"},function(){}.toEventHandler(this));},unaccountPop_click:function(e){var ele=M.EventEle(e);var tag=ele.attr("tag");if(tag=='save'){var tpl=this.context.achievementlist.find("input[name=cb]:checked");var idstr=comm='';tpl.each(function(){var id=$(this).attr("id");idstr+=comm+id;comm=',';});var data={"id":idstr};M._getjson("/Market/accountCancel",data,this.unaccount_finished.toEventHandler(this));}else if(tag=='cancel'){M.ClosePopup();}},unaccount_finished:function(d){if(d.status=='success'){window.location.reload();}else{alert(d.msg);}},achievementlist_click:function(e){var ele=M.EventEle(e);var t=ele.attr("tag");switch(t){case'confirmdate':this.confirmdate();break;case'search':this.getList();break;case'selectone':this.selectone();break;case'select_all':this.selectall();break;case'orderinfo':this.getorderinfo(ele);break;default:break;}},getorderinfo:function(ele)
{var id=ele.parents('tr').attr('oid');M._getjson("/Microinn/getorderinfo",{'id':id},this.getorderinfo_finished.toEventHandler(this),'',true);},getorderinfo_finished:function(d)
{if(d.status=='success'){var tr_tpl='';for(var i in d.data){tr_tpl+='<tr>'+'                    <td>'+d.data[i].name+'</td>'+'                    <td>'+d.data[i].orderinfo+'</td>'+'                    <td>'+d.data[i].totalprice+'</td>'+'                    <td>'+d.data[i].commission+'</td>'+'                    <td><i class="settle-status '+d.data[i].accountingclass+'"></i>'+d.data[i].accountingstatus+'</td>'+'                </tr>';}}
this.context.orderlistPop.find('tr[tag=title]').after(tr_tpl);M.Popup(this.context.orderlistPop,{"dragable":false,"hideclass":"modal fade","showclass":"modal sm fade large in ui-draggable"},function(){}.toEventHandler(this));},getList:function(){var datetype=$('#datetype').find('span[tag=value]').attr('value');if(datetype=='adddate'){datetype=1;}else{datetype=2;}
var fromdate=this.context.achievementlist.find("input[name=fromdate]").val();var enddate=this.context.achievementlist.find("input[name=enddate]").val();var num=this.context.achievementlist.find("input[name=num]").val();window.location.href='?datetype='+datetype+'&fromdate='+fromdate+'&enddate='+enddate+'&num='+num;},document_click:function(e){var ele=M.EventEle(e);var tag=ele.attr("tag");if(M.isEmpty(tag)||(tag!='dropdownlist'&&tag!='value')){this.context.body.children().find(".ip-dropdown:visible").hide();}
var box=ele.parents('div[tag=datebox]');if(box.length==0){var tpl=ele.parents("div.ui-corner-all");if(tpl.length==0){this.context.achievementlist.find("div[tag=dateval]").hide();}}},selectone:function(){var checkedtpl=this.context.achievementlist.find("input[name=cb]:checked");var tpl=this.context.achievementlist.find("input[name=cb]");var allprice=0;checkedtpl.each(function(){var price=$(this).parent().parent().find('td[tag=price]').attr('value');price=parseInt(price*1000);allprice+=price;});$('#checkednum').html(checkedtpl.length);$('#checkedprice').html(allprice/1000);if(checkedtpl.length==tpl.length){this.context.achievementlist.find("input[name=select_all]").attr("checked",true);}else{this.context.achievementlist.find("input[name=select_all]").attr("checked",false);}},selectall:function(){var tpl=this.context.achievementlist.find("input[name=select_all]:checked");if(tpl.length>0){this.context.achievementlist.find("input[name=cb]").attr("checked",true);}else{this.context.achievementlist.find("input[name=cb]").attr("checked",false);}
var checkedtpl=this.context.achievementlist.find("input[name=cb]:checked");var allprice=0;checkedtpl.each(function(){var price=$(this).parent().parent().find('td[tag=price]').attr('value');price=parseInt(price*1000);allprice+=price;});$('#checkednum').html(checkedtpl.length);$('#checkedprice').html(allprice/1000);},confirmdate:function(){var fromdate=this.context.achievementlist.find("input[name=fromdate]").val();var enddate=this.context.achievementlist.find("input[name=enddate]").val();var fdate=M.timeformat(M.strtotime(fromdate),'n月/j日');var edate=M.timeformat(M.strtotime(enddate),'n月/j日');this.context.achievementlist.find("input[name=dateval]").val(fdate+' - '+edate);this.context.achievementlist.find("div[tag=dateval]").hide();},dateval_focus:function(){this.context.achievementlist.find("div[tag=dateval]").show();},initdroplist:function(){var tpl_datetype=this.context.achievementlist.find("div[t=datetype]");M.DropdownList(tpl_datetype,null,null);var ordertype=this.context.ordertype;M.DropdownList(ordertype,this.datetype_change.toEventHandler(this),null);},initdatepicker:function(){var fromdate=this.context.achievementlist.find("input[name=fromdate]").val();var enddate=this.context.achievementlist.find("input[name=enddate]").val();},datetype_change:function(ele){var value=ele.attr('value');this.context.datetype.find("span[tag=value]").attr('value','orderdate');this.context.datetype.find("span[tag=value]").attr('value','orderdate').html('预订日期');if(value=='room'){this.context.achievementlist.find("div[t=datetype]").find('div[tag=option]').show();}else{this.context.achievementlist.find("div[t=datetype]").find('div[tag=option]').hide();this.context.achievementlist.find("div[t=datetype]").find('div[tag=option][value=orderdate]').show();}},});M.ready(function(){var micromarketingaccount=new M.Page.MicroMarketingAccountPage();return micromarketingaccount;});