
M.Page.IndexPage=M.createClass();M.extend(M.Page.IndexPage.prototype,{context:{},datepickeraction:null,roomstatus:[],roomprice:{},dateprice:{},formatedateprice:{},switchdata:{},index:0,options:{fromtime:null,endtime:null},submittext:"处理中...",hotelroomtype:{},object:{},droplist:{},orderdata:{},otahotellist:{},initclientwidth:'',initdata:{width:''},search:{'total':0},allotalist:{'ctrip':'携程','ctrippayed':'携程预付','elong':'艺龙','booking':'Booking','meituan':'美团','agoda':'Agoda','qunar':'去哪儿'},closedotalist:{'ctrip':'携程','ctrippayed':'携程预付','elong':'艺龙','booking':'Booking'},tpl_serarchorder:'<div class="single">'
+' <div>'
+'<span class="name">${guestname}</span>'
+'<span class="phone">${phone}</span>'
+'<span class="status">已预订</span>'
+'</div>'
+'<div>'
+'<span>${fromdate}</span>, '
+'<span>${roomname}</span>, '
+'<span>住${nights}晚</span>'
+'</div>'
+'<div>'
+'<span>${channelname}</span>, '
+'<span>订单金额：&yen;${totalprice}</span>'
+'</div>'
+'<div class="note">${remark}</div>'
+'<div class="other" style="${showstatus}">订单来自&lt;<a href="/book/index?innid=${innid}">${innname}</a>&gt;<br/>请切换到该客栈查找才可查看订单详情。</div>'
+'</div>',roomtypeoption_tpl:'<option value="${roomcode}" t="room">${roomname}</option>',switchhistory_tpl:'<tr tag="h">'
+'<td>${roomtypename}</td>'
+'<td>${daterange}</td>'
+'<td >${targetstatus}</td>'
+'<td>${createon}</td>'
+'<td class="${statusclass}">${opstatus}</td>'
+'</tr>',hoteltab:'<div value="${innid}"><a href="javascript:;">${innname}</a></div>',roomtpl:'<td class="${styleclass}" hotelcode="${hotelcode}" tip="${hotelroomtypename}" tag="${tag}" roomtypeid="${roomtypeid}" roomtypecode="${hotelroomtypecode}" day="${date}">${roomnum}</td>',roomtypetpl:'<label class="mr10" style="white-space:nowrap;"><input name="checkbox" type="checkbox" value="${hotelroomtypecode}">${hotelroomtypename}</label>',_getdatetime:function()
{var date=M.getTime();return date;},init:function(){this.initDOM();this.initEvent();this.resetroomtypecount();if($.cookie('example')=='0'){this.context.turnover_toggle.click();}
this.initjieji();},win_resize:function()
{return;},initDOM:function(){this.context.pickerarea=$("#pickerarea");this.context.right=$("#rightpanel");this.context.roomlist=$("#roomlist");this.context.roomtype=$("#roomtype");this.context.roomtypeswitchform=$("#roomtypeswitchform");this.context.roomtypeswitch_btn=$("#roomtypeswitch_btn");this.context.switchtable=$("#switchtable");this.context.page=$("#formdaypage");this.context.fromdate=$("#fromdate");this.context.enddate=$("#enddate");this.context.switchroomtype=$("#switchroomtype")
this.context.remind_message=$("#remind_message");this.context.tipmessageform=$("#tipmessageform");this.context.innidlist=$("#innidlist");this.context.batchswitch=$("#batchswitch");this.context.batchform=$("#batchform");this.context.batch_fromdate=$("#batch_fromdate");this.context.batch_enddate=$("#batch_enddate");this.context.saveswitch_btn=$("#saveswitch_btn");this.context.batchswitch_btn=$("#batchswitch_btn");this.context.turnover_toggle=$("#turnover_toggle");this.context.turnover_toggle.css("display",'');this.context.header=$("#header");this.context.foot=$(".foot");this.context.otalist=$("#otalist");this.context.otainnlist=$("#otainnlist");this.context.roomswitchhistory=$("#roomswitchhistory");this.context.switchhistorylist=$("#switchhistorylist");this.context.qunarroomswitchhistory=$("#qunarroomswitchhistory");this.context.meituanroomswitchhistory=$("#meituanroomswitchhistory");this.context.searchswitchhistory_btn=$("#searchswitchhistory_btn");this.context.s_fromdate=$("#s_fromdate");this.context.s_enddate=$("#s_enddate");this.context.batch_fromdate.datepicker({showOtherMonths:true,selectOtherMonths:true});this.context.batch_enddate.datepicker({showOtherMonths:true,selectOtherMonths:true});this.context.s_fromdate.datepicker({showOtherMonths:true,selectOtherMonths:true});this.context.s_enddate.datepicker({showOtherMonths:true,selectOtherMonths:true});this.context.menu_search=$("#menu_search");this.context.searchorderlist=$("#searchorderlist");this.context.innroomdate=$("#innroomdate");this.context.searchkeyword=$("#searchkeyword");this.context.mains=$('#mains');this.context.footer=$('#footer');this.context.switchroomneedlogin=$("#switchroomneedlogin");this.object.order=order;this.context.reportyearhidden=$("#reportyearhidden");this.context.reportyearinnlist=$("#reportyearinnlist");this.context.reportyearimg=$("#reportyearimg");this.context.jiejiform=$("#jiejiform");this.context.chat=$("#chat");this.context.chatPopform=$("#chatPopform");},initEvent:function(){this.context.roomtypeswitch_btn.bind("click",this.roomtypeswitch_click.toEventHandler(this));this.context.page.bind("click",this.page_click.toEventHandler(this));this.context.roomtypeswitchform.bind("click",this.roomtypeswitchform_click.toEventHandler(this));this.context.switchroomtype.bind("click",this.switchroomtype_click.toEventHandler(this));this.context.tipmessageform.bind("click",this.tipmessageform_click.toEventHandler(this));this.context.remind_message.bind("click",this.remind_messages.toEventHandler(this));this.context.batchswitch.bind("click",this.batchswitch_click.toEventHandler(this));this.context.batchswitch_btn.bind("click",this.batchswitch_btn.toEventHandler(this));this.context.turnover_toggle.bind("click",this.togglestatistics_btn.toEventHandler(this));this.context.roomswitchhistory.bind("click",this.roomswitchhistory_btn.toEventHandler(this));this.context.searchswitchhistory_btn.bind("click",this.roomswitchhistory_search.toEventHandler(this));this.context.qunarroomswitchhistory.bind("click",this.roomswitchhistory_btn.toEventHandler(this));this.context.meituanroomswitchhistory.bind("click",this.roomswitchhistory_btn.toEventHandler(this));this.context.menu_search.bind("click",this.menu_search.toEventHandler(this));this.context.searchorderlist.bind("click",this.searchorderlist_click.toEventHandler(this));this.context.searchkeyword.bind("keydown",this.searchkeyword_keydown.toEventHandler(this));this.context.jiejiform.bind("click",this.jiejiform_click.toEventHandler(this));this.context.reportyearinnlist.bind("change",this.reportyearinnlist_change.toEventHandler(this));this.context.chat.bind("click",this.chat_click.toEventHandler(this));},chat_click:function(){},initjieji:function(){var jieji=$.cookie('jiejitip');if(M.isEmpty(jieji)||jieji==1){this.context.jiejiform.show();}else if(jieji==-1){this.context.jiejiform.hide();}},reportyearinnlist_change:function(e){var ele=M.EventEle(e);var img=ele.attr("value");this.context.reportyearimg.attr("src",img);},jiejiform_click:function(e){var ele=M.EventEle(e);var tag=ele.attr('tag');switch(tag){case'showdetail':this.context.jiejiform.hide();this.showjiejidetail();break;case'close':$.cookie('jiejitip',-1,{expires:3600*360*24});this.context.jiejiform.hide();break;}},showjiejidetail:function(){window.open('http://m.miot.cn/Activity/Actbus/ljindex');},reqbusy:function()
{alert("请求处理中，请稍后再试");},req_before:function(btn)
{var busy=btn.attr("busy");if(busy=="1")
{this.reqbusy();return false;}
btn.html(this.submittext).attr("busy","1");btn.attr("class",btn.attr("tempclass")+" disabled");return true;},req_end:function(btn)
{btn.html(btn.attr("text")).attr("busy","");btn.attr("class",btn.attr("tempclass"));},menu_search:function(){this.context.searchorderlist.children("div[tag=error]").hide();this.context.searchorderlist.toggle();var length=this.context.header.find("div.tool").children("a").length;var left=0;if(length==1){left=229;}
if(length==2){left=213;}
if(length==3){left=178;}
if(length==4){left=146;}
if(length==5){left=113;}
this.context.searchorderlist.children("i.arrow").css("left",left+'px');this.context.searchorderlist.children("i.arrow-b").css("left",left+'px');},searchkeyword_keydown:function(evt){this.context.searchorderlist.children("div[tag=error]").hide();var evt=evt?evt:(window.event?window.event:null);if(evt.keyCode==13){this.searchorder();}},searchorderlist_click:function(e){var ele=M.EventEle(e);var t=ele.attr("tag");if(t=="search"){this.searchorder();return;}
if(t=="close"){this._closesearchform();return;}
if(t=="loadmore"){this.loadmoreorder(ele);}else{var tpl=ele.parents("div[tag=o]");var showstatus=ele.parents("div[tag=o]").children("div[tag=other]").css("display");if(showstatus!='none')
return;if(tpl.length>0){pickeraction.searchorderdetail(tpl);}}},_closesearchform:function(){M.emptyVal(this.context.searchorderlist.children().find("input[name=keyword]"));this.context.searchorderlist.children("div[tag=error]").hide();this.context.searchorderlist.children().find("div[tag=list]").children("div[tag=o]").remove();this.context.searchorderlist.children("div[tag=listform]").hide();this.context.searchorderlist.children("div[tag=listform]").children("div[tag=total]").hide();this.context.searchorderlist.children("div[tag=listform]").children("div[tag=list]").hide().children("a[tag=loadmore]").hide();this.context.searchorderlist.hide();},loadmoreorder:function(ele){ele.html('<i class="loading16"></i>');var keyword=M.getVal(this.context.searchorderlist.children().find("input[name=keyword]"));var innid=this.context.roomtype.attr("innid");M._getjson("/book/searchorder",{"a":"searchorder","innid":innid,"keyword":keyword,"index":this.pageindex},this.searchorder_finished.toEventHandler(this));},searchorder:function(){this.page=0;var keyword=M.getVal(this.context.searchorderlist.children().find("input[name=keyword]"));this.context.searchorderlist.children("div[tag=error]").hide();if(M.isEmpty(keyword)){this.context.searchorderlist.children("div[tag=error]").show();this.context.searchorderlist.children("div[tag=listform]").hide();return;}
this.context.searchorderlist.children("div[tag=listform]").show();this.context.searchorderlist.children("div[tag=listform]").children("div[tag=total]").hide();this.context.searchorderlist.children("div[tag=listform]").children("div[tag=list]").hide().children("a[tag=loadmore]").hide();this.context.searchorderlist.children("div[tag=listform]").children("div[tag=loading]").show();this.context.searchorderlist.children().find("div[tag=list]").children("div[tag=o]").remove();this.search.total=0;var innid=this.context.roomtype.attr("innid");M._getjson("/book/searchorder",{"innid":innid,"keyword":keyword},this.searchorder_finished.toEventHandler(this));},searchorder_finished:function(d){if(d.status=="success"){var list=d.d.list;this.pageindex=d.d.nextpage;this.maxpage=d.d.maxpage;var total=d.d.total;if(this.search.total==0){this.search.total=total;}
var target=this.context.searchorderlist.children().find("div[tag=list]");for(var i=0;i<list.length;i++){var item=list[i];this._showorderlist(item,target);}
if(total<=0){target.hide();}else{target.show();}
var checkhasload=target.find('div[tag=o]').length;if(M.isEmpty(this.pageindex)||this.pageindex>this.maxpage){target.children("a[tag=loadmore]").hide();}else{target.children("a[tag=loadmore]").show();}
this.context.searchorderlist.children("div[tag=listform]").show();target.children("a[tag=loadmore]").html("加载更多");this.context.searchorderlist.children("div[tag=listform]").children("div[tag=total]").show().children("strong").html(total);this.context.searchorderlist.children("div[tag=listform]").children("div[tag=loading]").hide();this.context.searchorderlist.children("div[tag=listform]").show();this._resizeorderlist();}else{if(d.status=='hasswitch'){M.confirmmessage(d.msg,this.reload.toEventHandler(this));}}},reload:function(){location.reload('/book/index');},_resizeorderlist:function(){var headheight=this.context.header.outerHeight();var footheight=this.context.foot.outerHeight();var roomtypeheight=this.context.roomtype.outerHeight();var searchconditionheight=this.context.searchorderlist.children("div[tag=condition]").outerHeight();var list_offet=this.context.searchorderlist.children().children("div[tag=list]").offset();var page_offset=this.context.searchorderlist.children().children("div[tag=page]").offset();var winheight=this.getWindowHeight();var heigth=winheight-list_offet.top-footheight-headheight-40;this.context.searchorderlist.children().find("div[tag=list]").css("height",heigth);},getWindowHeight:function(){var de=document.documentElement;return self.innerHeight||(de&&de.clientHeight)||document.body.clientHeight;},_showorderlist:function(item,target){var tpl=target.children("div[tag=tpl]").clone(true).attr("tag","o").attr("oid",item.orderid).attr("uniqid",item.orderuniqid).attr("cid",item.checkingroupid).attr("status",item.ischeckin).attr("checkindate",item.fromdate).show();tpl.children("div").children("span[tag=name]").html(item.guestname);tpl.children("div").children("span[tag=phone]").html(item.phone);tpl.children("div").children("span[tag=orderstatus]").html(item.orderstatusmsg);tpl.children("div").children("span[tag=checkindate]").html(item.fromdate);tpl.children("div").children("span[tag=roomname]").html(item.roomname);tpl.children("div").children("span[tag=nights]").html('住'+item.nights+'晚');tpl.children("div").children("span[tag=orderfrom]").html(item.channelname);tpl.children("div").children("span[tag=totalprice]").html("订单金额：&yen;"+M.math_format(item.totalprice));tpl.children("div[tag=remark]").html(item.remark);tpl.children("div[tag=other]").css("display",item.showstatus).children("a").attr("href","/book/index?innid="+item.innid).text(item.innname);target.children("a[tag=loadmore]").before(tpl);if(M.isEmpty(item.showstatus)){tpl.addClass("cursor-d");}},roomswitchhistory_search:function(){var tpl=this.context.roomtypeswitchform.children().find("ul").children("li[class=active]");var innid=tpl.children("a[tag=switchinn]").attr("innid");var hotelfrom=this.context.roomtypeswitchform.attr("hotelfrom");var fromdate=this.context.s_fromdate.val();var enddate=this.context.s_enddate.val();var room=this.context.switchhistorylist.children().find("select[tag=roomtypelist]").val();M._getjson("/Ota/closeRoomHistory",{"act":"roomswitchhistory","hotelfrom":hotelfrom,"innid":innid,"startdate":fromdate,"enddate":enddate,"room":room},this.switchhistorylist_finished.toEventHandler(this));},roomswitchhistory_btn:function(){var tpl=this.context.roomtypeswitchform.children().find("ul").children("li[class=active]");var innid=tpl.children("a[tag=switchinn]").attr("innid");var hotelfrom=this.context.roomtypeswitchform.attr("hotelfrom");var now=M.getTime();var enddate=M.timeformat(now);var fromdate=M.timeformat(new Date(now.getFullYear(),now.getMonth(),now.getDate()-1));this.context.s_fromdate.val(fromdate);this.context.s_enddate.val(enddate);var room='';this.context.switchhistorylist.children().find("select[tag=roomtypelist]").children('option:first').attr('selected','selected');M._getjson("/Ota/closeRoomHistory",{"act":"roomswitchhistory","hotelfrom":hotelfrom,"innid":innid,"startdate":fromdate,"enddate":enddate,"room":room},this.switchhistorylist_finished.toEventHandler(this));},switchhistorylist_finished:function(d){if(d.status=="success"){var room=d.req.room;var historylist=d.historylist;var h_tpl=$.tmpl(this.switchhistory_tpl,historylist);var target_tpl=this.context.switchhistorylist.children().find("table[tag=historylist]").children("tbody");target_tpl.children("tr[tag=h]").remove();target_tpl.append(h_tpl);var roomtypelist=d.roomtypelist;var r_tpl=$.tmpl(this.roomtypeoption_tpl,roomtypelist);this.context.switchhistorylist.children().find("select[tag=roomtypelist]").children("option[t=room]").remove();this.context.switchhistorylist.children().find("select[tag=roomtypelist]").append(r_tpl);this.context.switchhistorylist.children().find("select[tag=roomtypelist]").val(room);if(historylist.length>0){target_tpl.show();this.context.switchhistorylist.children().find("div[tag=nohistory]").hide();}else{target_tpl.hide();this.context.switchhistorylist.children().find("div[tag=nohistory]").show();}
var otahotel=d.otahotel;if(otahotel.needlogin==1){this.context.switchroomneedlogin.show();}else{this.context.switchroomneedlogin.hide();}
this.context.switchroomneedlogin.attr("hotelfrom",otahotel.hotelfrom).attr("innid",otahotel.innid);M.Popup(this.context.switchhistorylist,{"hideclass":"modal setotaroom fade ","showclass":"modal setotaroom fade  in"});}},page_click:function(e){var ele=M.EventEle(e);var t=ele.attr("tag");var fromtime=M.strtotime(this.context.fromdate.val());if(!M.isEmpty(t)){this.getroomtypeswitch(t,fromtime);}},switchroomtype_click:function(e){var ele=M.EventEle(e).parent();var t=ele.attr("tag");switch(t){case"open":ele.addClass("switch-off");ele.attr("tag","close");break;case"close":ele.removeClass("switch-off");ele.attr("tag","open");break;case"saveswitch":this.saveswitch();break;}},batchswitch_btn:function(){this.req_before(this.context.batchswitch_btn);var data=this._getbatchdata();M._getjson("/Ota/batchSwitchRoom",data,this.batchswitch_finished.toEventHandler(this));},_getbatchdata:function(){var tpl_roomtype=this.context.batchform.children().find("li div[tag=roomtype] label input:checked");var hotelcode=this.context.batchswitch_btn.attr("hotelcode");var fromdate=this.context.batch_fromdate.val();var enddate=this.context.batch_enddate.val();var tpl=this.context.roomtypeswitchform.children().find("ul").children("li[class=active]");var innid=tpl.children("a[tag=switchinn]").attr("innid");var status=this.context.batchswitch_btn.attr("status");var hotelfrom=this.context.roomtypeswitchform.attr("hotelfrom");var data={"act":"batchswitchroom","hotelcode":hotelcode,"fromdate":fromdate,"enddate":enddate,"innid":innid,"status":status,"hotelfrom":hotelfrom};var i=0;tpl_roomtype.each(function(){var roomtypecode=$(this).val();data['roomtypecode'+i]=roomtypecode;i++;});data.length=i;return data;},batchswitch_finished:function(d){this.req_end(this.context.batchswitch_btn);if(d.status=="success"){var data=d.data;var fromdate=data.fromdate;var enddate=data.enddate;var status=d.req.status;var roomtypelist=data.roomtypecodelist;var fromtime=M.strtotime(fromdate);var endtime=M.strtotime(enddate);var tpl=this.context.switchtable.children("table").children("tbody");while(fromtime<=endtime){date=M.timeformat(fromtime,'Y-m-d');for(var i=0;i<roomtypelist.length;i++){var roomtypecode=roomtypelist[i];if(status=="close"){tpl.children("tr[tag=d_ota]").children("td[roomtypecode="+roomtypecode+"][day="+date+"]").removeClass("editable").addClass("closed").text("已关闭");}else{var roomnum=tpl.children("tr[tag=d]").children("td[roomtypecode="+roomtypecode+"][day="+date+"]").text();if(roomnum!=0){tpl.children("tr[tag=d_ota]").children("td[roomtypecode="+roomtypecode+"][day="+date+"]").removeClass("closed").addClass("editable").text(roomnum);}}}
fromtime.setDate(fromtime.getDate()+1);}
M.CloseLast();}else{alert(d.msg);}},batchswitch_click:function(e){var ele=M.EventEle(e);var t=ele.attr("tag");switch(t){case"batch_open":this.batchroomtype(t);break;case"batch_close":this.batchroomtype(t);break;}
this.context.batchswitch.children("div").toggle();},togglestatistics_btn:function(){this.context.pickerarea.children("table").children("tbody").children("tr").children("td[tag=total]").toggle();this.context.roomlist.children("tbody").children("tr").children("td[tag=watertotal]").toggle();var show=this.context.roomlist.children("tbody").children("tr").children("td[tag=watertotal]").attr("show");if(show=='0'){this.context.roomlist.children("tbody").children("tr").children("td[tag=watertotal]").attr("show","1");}else{this.context.roomlist.children("tbody").children("tr").children("td[tag=watertotal]").attr("show","0");}
pickeraction.transform.win_resize();if(show=='0'){this.context.turnover_toggle.children("div").removeClass("switch-off").addClass("switch-on");$.cookie("example","1",{expires:3600});}else{this.context.turnover_toggle.children("div").removeClass("switch-on").addClass("switch-off");$.cookie("example","0",{expires:3600});}},batchroomtype:function(t){if(t=='batch_close'){this.context.batchswitch_btn.attr("status","close");this.context.batchform.children("div").children("h4[tag=title]").html("批量关闭房型");var tpl=this.context.batchform.children().find("ul[tag=cntlist]");tpl.children("li").children("tt[tag=time_tip]").html('选择关闭时间段：');tpl.children("li").children("tt[tag=roomtype_tip]").html('选择关闭的房型：');this.context.batchswitch_btn.html('确认关闭');this.context.batchswitch_btn.attr('text','确认关闭');}else{this.context.batchswitch_btn.attr("status","open");this.context.batchform.children("div").children("h4[tag=title]").html("批量开启房型");var tpl=this.context.batchform.children().find("ul[tag=cntlist]");tpl.children("li").children("tt[tag=time_tip]").html('选择开启时间段：');tpl.children("li").children("tt[tag=roomtype_tip]").html('选择开启的房型：');this.context.batchswitch_btn.html('确认开启');this.context.batchswitch_btn.attr('text','确认开启');}
var now=this._getdatetime();var date=M.timeformat(now,'Y-m-d');this.context.batch_fromdate.val(date);this.context.batch_enddate.val(date);var roomtypelist=this.hotelroomtype.list;var html=$.tmpl(this.roomtypetpl,roomtypelist);this.context.batchswitch_btn.attr("hotelcode",this.hotelroomtype.hotelcode);this.context.batchform.children().find("ul[tag=cntlist] li div[tag=roomtype]").html(html);this.context.batchform.children().find("ul[tag=cntlist] li div[tag=roomtype] label").after(' ');M.Popup(this.context.batchform,{"hideclass":"bootbox modal view fade","showclass":"bootbox modal view fade in","dragable":true},function(){}.toEventHandler(this));},saveswitch:function(){this.req_before(this.context.saveswitch_btn);var data=this.switchdata;var status=this.context.switchroomtype.children().find("div[tag=switch]").children("div").attr("tag");data.status=status;data.act="switchroomtype";var tpl=this.context.roomtypeswitchform.children().find("ul").children("li[class=active]");data.innid=tpl.children("a[tag=switchinn]").attr("innid");M._getjson("/Ota/switchRoom",data,this.saveswitch_finished.toEventHandler(this));},saveswitch_finished:function(d){if(d.status=='success'){var req=d.req;var roomtypecode=req.roomtypecode;var date=req.fromdate;var status=req.status;var tpl=this.context.switchtable.children("table").children("tbody");if(status=="close"){tpl.children("tr[tag=d_ota]").children("td[roomtypecode="+roomtypecode+"][day="+date+"]").removeClass("editable").addClass("closed").text("已关闭");}else{var roomnum=tpl.children("tr[tag=d]").children("td[roomtypecode="+roomtypecode+"][day="+date+"]").text();tpl.children("tr[tag=d_ota]").children("td[roomtypecode="+roomtypecode+"][day="+date+"]").removeClass("closed").addClass("editable").text(roomnum);}}else{alert(d.msg);}
this.req_end(this.context.saveswitch_btn);M.CloseLast();},roomtypeswitchform_click:function(e){var ele=M.EventEle(e);var t=ele.attr("tag");var styleclass=ele.attr("class");switch(t){case"switch":this.switchroomtype(ele);break;}
this._handleCloaseSelect(ele);},_handleCloaseSelect:function(ele){var style=ele.attr("tag");if((M.isEmpty(style)||style!='dropdownlist')){var tpl_parents=ele.parents("div[t=otainnlist]");if(tpl_parents.length==0){this.context.otainnlist.find(".ip-dropdown").hide();}
tpl_parents=ele.parents("div[t=otalist]");if(tpl_parents.length==0){this.context.otalist.find(".ip-dropdown").hide();}}},switchroomtype:function(ele){var roomname=ele.attr("tip");var roomtypeid=ele.attr("roomtypeid");var roomtypecode=ele.attr("roomtypecode");var hotelcode=ele.attr("hotelcode");var fromdate=ele.attr("day");var styleclass=ele.attr("class");if(styleclass=="closed"){this.context.switchroomtype.children().find("div[tag=switch]").children("div").addClass("switch-off").attr("tag","close");}else{this.context.switchroomtype.children().find("div[tag=switch]").children("div").removeClass("switch-off").attr("tag","open");}
var hotelfrom=this.context.roomtypeswitchform.attr("hotelfrom");if(!this.closedotalist.hasOwnProperty(hotelfrom)){return;}
this.switchdata={"roomtypeid":roomtypeid,"roomtypecode":roomtypecode,"roomtypename":roomname,"hotelcode":hotelcode,"fromdate":fromdate,"enddate":fromdate,"hotelfrom":hotelfrom};this.context.switchroomtype.children("div").children("h4").children("span[tag=roomtypename]").text(roomname).css("padding-left",'0');var otaname=this.closedotalist[hotelfrom];this.context.switchroomtype.children("div").children("h4").children("span[tag=title]").html('开启/关闭'+otaname);M.Popup(this.context.switchroomtype,{"hideclass":"bootbox modal sm fade","showclass":"bootbox modal sm fade in","dragable":true},function(){}.toEventHandler(this));},otalist_change:function(ele){var tpl=ele.parents("div[t=otalist]");var hotelfrom=tpl.children("span").attr("value");this.context.roomtypeswitchform.attr("hotelfrom",hotelfrom);var innid=this.context.otainnlist.attr('value');this.getroomtypeswitch('','',innid);},roomtypeswitch_click:function(){this.context.roomtypeswitchform.children('div[tag=content]').hide();var html_loading='<div class="tc" tag="loading" style="padding: 50px 0px; display: none;"><i class="loading32"></i></div>';if(this.context.roomtypeswitchform.children('div[tag=loading]').length<1){this.context.roomtypeswitchform.append(html_loading);}
this.context.roomtypeswitchform.children('div[tag=content]').hide();this.context.roomtypeswitchform.children('div[tag=loading]').show();M.Popup(this.context.roomtypeswitchform,{"hideclass":"modal setotaroom setotaroomWide fade","showclass":"modal setotaroom setotaroomWide fade in","dragable":true},function(){}.toEventHandler(this));this.getroomtypeswitch();},getroomtypeswitch:function(t,fromtime,innid){var now=this._getdatetime();var nowdate=new Date(now.getFullYear(),now.getMonth(),now.getDate());if(t=='prev'){if(nowdate>=fromtime){return;}
var fromtime=M.strtotime(this.context.fromdate.val());var fromtime=new Date(fromtime.getFullYear(),fromtime.getMonth(),fromtime.getDate()-14);var endtime=new Date(fromtime.getFullYear(),fromtime.getMonth(),fromtime.getDate()+13);}else if(t=='next'){nowdate.setDate(nowdate.getDate()+90);var fromtime=M.strtotime(this.context.fromdate.val());var fromtime=new Date(fromtime.getFullYear(),fromtime.getMonth(),fromtime.getDate()+14);var endtime=new Date(fromtime.getFullYear(),fromtime.getMonth(),fromtime.getDate()+13);if(nowdate<=endtime){return;}}else{var fromtime=new Date(now.getFullYear(),now.getMonth(),now.getDate());var endtime=new Date(now.getFullYear(),now.getMonth(),now.getDate()+13);}
if(M.isEmpty(innid)){innid=this.context.roomtype.attr("innid");}
var fromdate=M.timeformat(fromtime,'Y-m-d');var enddate=M.timeformat(endtime,'Y-m-d');this.context.fromdate.val(fromdate);this.context.enddate.val(enddate);this.context.s_fromdate.val(fromdate);this.context.s_enddate.val(enddate);var hotelfrom=this.context.roomtypeswitchform.attr("hotelfrom");M._getjson("/book/getroomtypeswitch",{"innid":innid,"fromdate":fromdate,"enddate":enddate,"hotelfrom":hotelfrom},this.getroomtypeswitch_finished.toEventHandler(this));},getroomtypeswitch_finished:function(d){if(d.status=="success"){var req_innid=d.req.innid;this.context.switchtable.children("table").children("tbody").children("tr[tag=d]").remove();this.context.switchtable.children("table").children("tbody").children("tr[tag=d_ota]").remove();this.context.roomtypeswitchform.children().find("a[tag=switchinn]").parent().removeClass("active");var defaultllist=d.d.defaultroomlist;this.hotelroomtype={"list":defaultllist,"hotelcode":d.d.hotelcode};var roomswitchlist=d.d.roomswitchlist;var roomnumlist=d.d.roomnum;var hotelfrom=d.d.hotelfrom;this.context.roomtypeswitchform.attr("hotelfrom",hotelfrom);this.context.batchswitch.hide();this.context.switchtable.children("div[tag=ctripfrom]").hide();this.context.switchtable.children("div[tag=quarfrom]").hide();this.context.switchtable.children("div[tag=meituanfrom]").hide();this.context.switchtable.children("div[tag=tujia]").hide();if(this.closedotalist.hasOwnProperty(hotelfrom)){var otaname=this.closedotalist[hotelfrom];var ctripdirect=d.d.ctripdirect;if(hotelfrom=='ctrip'&&(M.isEmpty(ctripdirect)||ctripdirect!=1)){this.context.batchswitch.hide();this.context.roomtypeswitchform.children().find("h3[tag=title]").html("房态对照表<span>(提供90天的房态对照)</span>");this.context.switchtable.children("div[tag=ctripfrom]").show();}else{this.allotalist.ctrip='携程现付';this.context.batchswitch.show();this.context.roomtypeswitchform.children().find("h3[tag=title]").html("设置开关房");this.context.switchroomtype.find("h4").children("span[tag=title]").html('开启/关闭'+otaname);}}else{switch(hotelfrom){case'agoda':case'qunarlink':this.context.roomtypeswitchform.children().find("h3[tag=title]").html("房态对照表<span>(提供90天的房态对照)</span>");break;case'meituan':this.context.roomtypeswitchform.children().find("h3[tag=title]").html("房态对照表<span>(提供90天的房态对照)</span>");this.context.switchtable.children("div[tag=meituanfrom]").show();break;case'tujia':this.context.roomtypeswitchform.children().find("h3[tag=title]").html("房态对照表<span>(提供90天的房态对照)</span>");this.context.switchtable.children("div[tag=tujia]").show();break;default:this.context.roomtypeswitchform.children().find("h3[tag=title]").html("房态对照表<span>(提供90天的房态对照)</span>");this.context.switchtable.children("div[tag=quarfrom]").show();break;}}
this.otahotellist=d.otahotellist[hotelfrom];var hoteltab=$.tmpl(this.hoteltab,this.otahotellist);this.context.otainnlist.attr('value',req_innid);this.context.otainnlist.find('div[tag=innlist]').children().html(hoteltab);M.DropdownList(this.context.otainnlist,this.otainnlist_change.toEventHandler(this),{});var otatpl=this.context.otalist.children("div[t=otalist]").attr("value",hotelfrom);if(M.isEmpty(this.droplist.otatpl)){this.droplist.otatpl=M.DropdownList(otatpl,this.otalist_change.toEventHandler(this),{});}
this.context.otalist.find("div[tag=option]").hide();this.context.otalist.find("div[value="+hotelfrom+"][tag=option]").show();if(hotelfrom=='ctrip'&&!M.isEmpty(ctripdirect)&&ctripdirect==1){this.context.otalist.find("span").text('携程现付');this.context.otalist.find("div[value="+hotelfrom+"][tag=option]").children("a").text('携程现付');}
var tablist=d.tablist;for(var type in tablist){var typestatus=tablist[type];if(typestatus==1){this.context.otalist.find("div[value="+type+"][tag=option]").show();}}
if(hotelfrom=='ctrip'&&(M.isEmpty(ctripdirect)||ctripdirect!=1)){hotelfrom='monictrip';}
this.inittabledata(defaultllist,hotelfrom);var tpl=this.context.switchtable.children("table").children("tbody");if(!M.isEmpty(roomnumlist)){for(var r in roomnumlist){var room=roomnumlist[r];var roomtypecode=room.hotelroomtypecode;var fromtime=M.strtotime(this.context.fromdate.val());var endtime=M.strtotime(this.context.enddate.val());var roomname=room.hotelroomtypename;var status=room.status;tpl.children("tr[tag=d][roomtypecode="+roomtypecode+"]").children("td[tag=roomname]").html(roomname);while(fromtime<=endtime){var date=M.timeformat(fromtime,'Y-m-d');var num=status[date];tpl.children("tr[tag=d]").children("td[roomtypecode="+roomtypecode+"][day="+date+"]").html(num);if(hotelfrom=="qunar"||hotelfrom=="agoda"||hotelfrom=="monictrip"){tpl.children("tr[tag=d_ota]").children("td[roomtypecode="+roomtypecode+"][day="+date+"]").html(num).hide();}else{tpl.children("tr[tag=d_ota]").children("td[roomtypecode="+roomtypecode+"][day="+date+"]").html(num).show();}
fromtime.setDate(fromtime.getDate()+1);}}}
if(!M.isEmpty(roomswitchlist)){for(var i in roomswitchlist){var roomtypecode=roomswitchlist[i].roomtypecode;var fromdate=roomswitchlist[i].fromdate;var enddate=roomswitchlist[i].enddate;var status=roomswitchlist[i].status;if(status==0){var fromdatetime=M.strtotime(fromdate);var enddatetime=M.strtotime(enddate);while(fromdatetime<=enddatetime){var date=M.timeformat(fromdatetime,'Y-m-d');tpl.children("tr[tag=d_ota]").children("td[roomtypecode="+roomtypecode+"][day="+date+"]").removeClass("editable").addClass("closed").text("已关闭");fromdatetime.setDate(fromdatetime.getDate()+1);}}}}}else{alert(d.msg);}
this.context.roomtypeswitchform.children('div[tag=loading]').hide();this.context.roomtypeswitchform.children('div[tag=content]').show();},otainnlist_change:function(ele){var innid=ele.attr('value');if(M.isEmpty(innid)){alert('参数错误');return;}
this.getroomtypeswitch('','',innid);},inittabledata:function(defaultllist,hotelfrom){var fromtime=M.strtotime(this.context.fromdate.val());var endtime=M.strtotime(this.context.enddate.val());var html='<th style="width:80px;"></th><th>渠道</th>';var datestr=M.timeformat(fromtime,'m/d');var enddatestr=M.timeformat(endtime,'m/d');var year=M.timeformat(fromtime,'Y');;this.context.page.children("div[class=range]").children("p").text(datestr+'~'+enddatestr);this.context.page.children("div[class=range]").children("b").text(year);while(fromtime<=endtime){datestr=M.timeformat(fromtime,'m/d');html+='<th >'+datestr+'</th>';fromtime.setDate(fromtime.getDate()+1);}
this.context.switchtable.children("table").children("thead").children("tr").html(html);var tmpl=this.context.switchtable.children("table").children("tbody").children("tr[tag=tmpl]");var tmplnext=this.context.switchtable.children("table").children("tbody").children("tr[tag=tmplnext]");var channelname=this.allotalist[hotelfrom];if(M.isEmpty(defaultllist)){return false;}
for(var i=0;i<defaultllist.length;i++){var datarow=tmpl.clone(true).show().attr('tag','d');datarow.children("td[tag=roomname]").text(defaultllist[i].hotelroomtypename).attr("rowspan","2");if(!this.closedotalist.hasOwnProperty(hotelfrom)){datarow.children("td[tag=roomname]").removeAttr("rowspan");}
datarow.attr("roomtypeid",defaultllist[i].roomtypeid);datarow.children("td[tag=innname]").text('云掌柜');datarow=this.showitem(datarow,defaultllist[i],'','');datarow.insertBefore(tmpl);var row=tmplnext.clone(true).show().attr('tag','d_ota');row.children("td[tag=innname]").text(channelname);row=this.showitem(row,defaultllist[i],'editable','switch');if(!this.closedotalist.hasOwnProperty(hotelfrom)){row.hide();}else{row.show();}
row.insertBefore(tmpl);}},showitem:function(tpl,room,stylecalss,t){var fromtime=M.strtotime(this.context.fromdate.val());var endtime=M.strtotime(this.context.enddate.val());while(fromtime<=endtime){room.date=M.timeformat(fromtime,'Y-m-d');room.styleclass=stylecalss;room.tag=t;var html=$.tmpl(this.roomtpl,room);tpl.append(html);fromtime.setDate(fromtime.getDate()+1);}
return tpl;},resetroomtypecount:function(){var i=count=0;this.context.roomtype.children("table").children("tbody").find("td").each(function(){i=$(this).attr("i");if(i==undefined){$(this).attr("i",count);count=count*1+1;}else{count=i*1+1;}});},tipmessageform_click:function(e){var ele=M.EventEle(e);var t=ele.attr("tag");switch(t){case'checkoutuser':this.getcheckoutuser(ele);break;case'checkinuser':this.getcheckinuser(ele);break;case'changedate':this.changedate(ele);break;case'closebtn':this.context.tipmessageform.hide();this.context.mains.find('div[tag=tomorrow]').children('table').find('tbody').children('tr[tag=o]').remove();this.context.mains.find('div[tag=today]').children('table').find('tbody').children('tr[tag=o]').remove();this.changetipmessagemenu('tab_remind');break;case'tab_finance':this.changetipmessagemenu('tab_finance');break;case'tab_remind':this.changetipmessagemenu('tab_remind');break;case'tomorrow':this.remind_messages(t);break;case'today':this.remind_messages(t);break;}},changetipmessagemenu:function(t){this.context.tipmessageform.find("h4[tag=tabmenu]").hide();if(t=='tab_finance'){this.context.mains.find("div[tag=total]").show();this.context.mains.find("div[tag=remind]").hide();this.context.tipmessageform.find("div[tag=empty]").hide();this.context.tipmessageform.find("h4[tag=tabmenu]").find("a[tag=tab_remind]").parents("h4").show();}else{var isempty=this.context.tipmessageform.attr("isempty");this.context.mains.find("div[tag=total]").hide();if(isempty==1){this.context.tipmessageform.find("div[tag=empty]").show();}else{this.context.mains.find("div[tag=remind]").show();}
this.context.tipmessageform.find("h4[tag=tabmenu]").find("a[tag=tab_finance]").parents("h4").show();}},remind_messages:function(datestr){var innid=this.context.roomtype.attr("innid");var orderview=this.context.roomtype.attr('orderview');var t=this.context.remind_message.attr("tag");if(t=='tool-alert-unread'){this.context.remind_message.removeClass("tool-alert-unread");this.context.remind_message.attr("tag","tool-alert-unread");M._getjson("/book/alertread",{"a":"alertread"},function(){});}
if(orderview!=1){M.error('对不起，您没有该权限，请联系客栈管理员');return;}
this.context.tipmessageform.children('div').children('h4').hide();if(datestr=='tomorrow'){this.context.tipmessageform.children('div').children('h4[tag=h4_left]').show();}else{datestr='today';this.context.tipmessageform.children('div').children('h4[tag=h4_right]').show();}
this.account={};this.context.tipmessageform.find("div[tag=empty]").hide();this.context.tipmessageform.find("div[tag=content]").hide();this.context.tipmessageform.find("div[tag=loading]").show();M.Popup(this.context.tipmessageform,{"hideclass":"modal large fade","showclass":"modal large fade in","dragable":true},function(){}.toEventHandler(this));M._getjson("/book/getCheckInAndOutUser",{"innid":innid,'datestr':datestr},this.remind_messages_finished.toEventHandler(this));},changedate:function(ele){var value=ele.attr("value");ele.parents("ul").children("li").removeClass("active");ele.parents("li").addClass("active");this.showfindetail(value);},showfindetail:function(date){var data=this.orderdata.account[date];var tpl=this.context.mains.find('div[tag=infotoday]').children('div');if(M.isEmpty(data.account)||M.isEmpty(data.account.total)){data.account={"total":0};}
var waterstatus=this.orderdata.waterstatus;var watertotal=0;if(date=='after'){var checkinrate=this.orderdata.afercheckinrate;var checkincount=this.orderdata.aftercheckincount;watertotal=M.math_min(this.orderdata.afterwater.incommetotal,this.orderdata.afterwater.outcometotal);}else{var checkinrate=this.orderdata.checkinrate;var checkincount=this.orderdata.checkincount;watertotal=M.math_min(this.orderdata.water.incommetotal,this.orderdata.water.outcometotal);}
var total=data.account.total;if(!M.isEmpty(waterstatus)&&waterstatus==1){total=M.math_add(total,watertotal);}
if(!M.isEmpty(waterstatus)&&waterstatus==1){tpl.find("strong[tag=notemoney]").parent().show();tpl.find("strong[tag=notemoney]").html(watertotal);}else{tpl.find("strong[tag=notemoney]").parent().hide();}
tpl.find("strong[tag=orderincome]").html(data.account.total);tpl.find("strong[tag=accounttotal]").html(total);tpl.find('strong[tag=percent]').text(checkinrate+'%');tpl.find('strong[tag=rooms]').text(checkincount);},showremind:function(remindlist){var target=this.context.tipmessageform.find("div[tag=remindlist]");if(M.isEmpty(remindlist)||remindlist.length==0){target.hide();return;}
target.show();target.find("div[tag=add]").remove();var remindmark={1:'pickup',2:'dropoff',3:'ring'};var orderinfo='';for(var i=0;i<remindlist.length;i++){var tpl=target.find("div[tag=tpl]").clone().show().attr("tag","add");var item=remindlist[i];tpl.find("div[tag=date]").html(item.time);orderinfo=item.orderinfo;if(!M.isEmpty(item.orderinfo)){orderinfo+='；';}
if(!M.isEmpty(item.remark)){orderinfo+='提醒内容：'+item.remark;}
tpl.find("div[tag=orderinfo]").html(orderinfo);tpl.find('i').attr('class','point '+remindmark[item.type]);target.children("div").append(tpl);}},remind_messages_finished:function(d){if(d.status=="success"){var datestr=d.req.datestr;var needcarpluginstatus=d.needcarpluginstatus;if(datestr!='today'&&M.isEmpty(d.remindlist)&&M.isEmpty(d.checkinuser.userlist.length)&&M.isEmpty(d.checkoutuser.userlist.length)){this.context.tipmessageform.find("div[tag=empty]").show();this.context.tipmessageform.find("div[tag=loading]").hide();this.context.tipmessageform.find("div[tag=content]").hide();return;}
this.orderdata=d;var checkinuser=d.checkinuser;var checkoutuser=d.checkoutuser;var todaytitle='';var todaytitle2='';var cometit='今日预计无人到店';var gotit='今日预计无人离店';if(datestr=='today'){todaytitle='今日预达';todaytitle2='今日预离';this.context.tipmessageform.find('div[tag=infotomorrow]').hide();var div_infotoday=this.context.tipmessageform.find('div[tag=infotoday]').show();div_infotoday.find('strong[tag=go_num]').html(d.checkoutuser.userlist.length);this.showfindetail('today');}else{cometit='明日预计无人到店';gotit='明日预计无人离店';todaytitle='明日预达';todaytitle2='明日预离';this.context.tipmessageform.find('div[tag=infotoday]').hide();var div_infotomorrow=this.context.tipmessageform.find('div[tag=infotomorrow]').show();div_infotomorrow.find('strong[tag=come_num]').html(checkinuser.userlist.length);div_infotomorrow.find('strong[tag=go_num]').html(checkoutuser.userlist.length);}
this.showremind(d.remindlist);this.context.mains.find('div[tag=today_come]').find('span[tag=todaytitle]').text(todaytitle);this.context.mains.find('div[tag=today_come]').find('span[tag=todayperson]').text(checkinuser.userlist.length);this.context.mains.find('div[tag=today_come]').find('span[tag=tomorrowcar]').text(checkinuser.needcarcount);this.context.mains.find('div[tag=today_go]').find('span[tag=todaytitle]').text(todaytitle2);this.context.mains.find('div[tag=today_go]').find('span[tag=todayperson]').text(checkoutuser.userlist.length);this.context.mains.find('div[tag=today_go]').find('span[tag=todaycar]').text(checkoutuser.needcarcount);this.context.mains.find('div[tag=today_come]').children('table').find('tbody').children('tr[tag=o]').remove();this.context.mains.find('div[tag=today_go]').children('table').find('tbody').children('tr[tag=o]').remove();var html='';var html1='';var checkinuserlist=d.checkinuser.userlist;for(var i=0;i<checkinuserlist.length;i++){html+='<tr tag="o">';html+='<td>'+checkinuserlist[i]['guestname']+'</td>';if(M.isEmpty(checkinuserlist[i]['phone'])){checkinuserlist[i]['phone']='-';}
html+='<td>'+checkinuserlist[i]['phone']+'</td>';html+='<td>'+checkinuserlist[i]['roomname']+'-'+checkinuserlist[i]['roomtypename']+'</td>';html+='<td>'+checkinuserlist[i]['channelname']+'</td>';var needcartpl='<span>-</span>';if(checkinuserlist[i]['needcar']!=0){needcartpl='<span class="car-red"></span>';}
html+='<td tag="needcar">'+needcartpl+'</td></tr>';}
this.context.mains.find('div[tag=today_come]').children('table').find('tbody').append(html);var checkoutuserlist=d.checkoutuser.userlist;for(var j=0;j<checkoutuserlist.length;j++){var user=checkoutuserlist[j];html1+='<tr tag="o"><td>'+user['guestname']+'</td>';if(M.isEmpty(user['phone'])){user['phone']='-';}
html1+='<td>'+user['phone']+'</td>';html1+='<td>'+user['roomname']+'-'+user['roomtypename']+'</td>';html1+='<td>'+user['channelname']+'</td>';var needcartpl='<span>-</span>';if(user['needcar2']!=0){needcartpl='<span class="car-red"></span>';}
html1+='<td tag="needcar">'+needcartpl+'</td>+</tr>';}
this.context.mains.find('div[tag=today_go]').children('table').find('tbody').append(html1);if(checkinuserlist.length<1){this.context.tipmessageform.find("div[tag=today_come]").hide();this.context.tipmessageform.find("div[tag=come_emptydate]").html(cometit).show();}else{this.context.tipmessageform.find("div[tag=come_emptydate]").hide();this.context.tipmessageform.find("div[tag=today_come]").show();}
if(checkoutuserlist.length<1){this.context.tipmessageform.find("div[tag=today_go]").hide();this.context.tipmessageform.find("div[tag=go_emptydate]").html(gotit).show();}else{this.context.tipmessageform.find("div[tag=go_emptydate]").hide();this.context.tipmessageform.find("div[tag=today_go]").show();}
this.context.tipmessageform.find("div[tag=empty]").hide();this.context.tipmessageform.find("div[tag=loading]").hide();this.context.tipmessageform.find("div[tag=content]").show();}},close_click:function(e)
{M.CloseLast();},_managecell:function(tdele){$(tdele).css({"border-left":"none"});},zerosize:function(value,length){if(!length)length=2;value=String(value);for(var i=0,zeros='';i<(length-value.length);i++){zeros+='0';}
return zeros+value;},timeformat:function(date,format)
{if(M.isEmpty(format))
{format="Y-m-d";}
var year=date.getFullYear();var month=this.zerosize(date.getMonth()+1+"",2);var day=this.zerosize(date.getDate()+"",2);var time=format.replace("Y",year).replace("m",month).replace("d",day);return time;},NoUndefined:function(str)
{return M.isEmpty(str)?"":str;},datepicker_scrollhandler:function(){},_closepopup:function()
{M.ClosePopup();},destroy:function(){}});