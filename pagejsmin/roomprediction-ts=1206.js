M.Page.RadarBookingPage=M.createClass();M.extend(M.Page.RadarBookingPage.prototype,{context:{},reportchannel:{},roomtypeid:[],basecolor:['#ec584d','#ff822d','#ffd900','#5fbd52','#0395ff','#2abb9b','#9b2586','#ef656c','#ffb907','#f4df4d','#86d37c','#0cc3f1','#49cbc2','#b55ba3','#9b1319','#cc611a','#b39b15','#1c890d','#0c69ad','#17866e','#4f0140'],init:function(){this.initDOM();this.initEvent();this.refreshreportdata();},initDOM:function(){this.context.innid=$("#innid");M.DropdownList(this.context.innid,this.refreshreportdata.toEventHandler(this),{});this.context.datelist=$("#datelist");M.DropdownList(this.context.datelist,this.refreshreportdata.toEventHandler(this),{});this.context.detail=$("#detail");this.context.header=$("#header");},initEvent:function(){$(document.body).bind("click",this.document_click.toEventHandler(this));this.context.innid.bind("change",this.innid_change.toEventHandler(this));this.context.datelist.bind("change",this.datelist_change.toEventHandler(this));},innid_change:function(){var innid=this.context.innid.val();var innname=this.context.innid.find("option[value="+innid+"]").text();this.context.header.find("strong[tag=inn]").text(innname);this.refreshreportdata();},datelist_change:function(){var datetype=this.context.datelist.val();var datename=this.context.datelist.find("option[value="+datetype+"]").text();this.context.header.find("strong[tag=date]").text(datename);this.refreshreportdata();},document_click:function(e){var ele=M.EventEle(e);var tag=ele.attr("tag");if(M.isEmpty(tag)||tag!='dropdownlist'){var value=ele.parents("span[tag=value]");var channel_innid=ele.parents("div[tag=channel_innid]");if(channel_innid.length+value.length==0&&tag!='value'){this.context.innid.removeClass("droplist_on").find("div[tag=channel_innid]").hide();}
var date_list=ele.parents("div[tag=date_list]");if(date_list.length==0&&tag!='value'){this.context.datelist.removeClass("droplist_on").find("div[tag=date_list]").hide();}}},refreshreportdata:function(){var innid=M.getDroplistVal(this.context.innid);var days=M.getDroplistVal(this.context.datelist);if(M.isEmpty(innid))innid=this.context.innid.val();if(M.isEmpty(days))days=this.context.datelist.val();M._getjson('/Report/getRoomStatePrediction',{"innid":innid,"days":days},this.getreportdata_finished.toEventHandler(this),'',true);},getreportdata_finished:function(d){var data=d.data;this.reportchannel=data.roomtypelist;this.roomtypeid=data.roomtypeid;this._convertdatasource(data.roomsplist);},_convertdatasource:function(source){var formatedsource=[];var title_tpl='<tr><th></th>';var content_tpl='';for(var i in source){content_tpl+='<tr>'+'<td>'+this.reportchannel[i]+'</td>';for(var k in source[i]){content_tpl+='<td>'+source[i][k]+'%</td>';}
last_source_key=i;content_tpl+='</tr>';}
for(var k in source[this.roomtypeid[0]]){var ontime=M.strtotime(k);var ondate=M.timeformat(ontime,'n/j');title_tpl+='<th>'+ondate+'</th>';var date_source={"ondate":ontime};for(var m in this.roomtypeid){var roomtypeid=this.roomtypeid[m];date_source[roomtypeid]=parseFloat(source[roomtypeid][k]);}
formatedsource.push(date_source);}
title_tpl+='</tr>';this.context.detail.html(title_tpl+content_tpl);return formatedsource;},destroy:function(){}});M.ready(function(){var radarbooking=new M.Page.RadarBookingPage();return radarbooking;});