M.Page.OtaYZGPage=M.createClass();M.extend(M.Page.OtaYZGPage.prototype,{context:{},cache_ele:'',getinnid:0,channelprice:{},pricemonth:6,cache_orgprice:0,timer:'',signed:0,batchpricelist:{},unselectedrtid:0,rtid:0,dx_model:1,tpl_loading:'<div class="tc" style="padding: 78px 0px;" tag="loading"><i class="loading32"></i></div>',tpl_roomtype:'<div class="item" rtid="${rtid}" pid="${pid}">'+'<div class="name">${roomtypename}</div>'+'<div class="wrapper">'+'<input type="text" value="" style="width:100px; margin-right:0;">'+'</div>'+'</div>',weektext:{"1":"一","2":"二","3":"三","4":"四","5":"五","6":"六","0":"日"},fromdate:'',enddate:'',commission:1,roomtypepricetarget:{},dx_model_text:{'price':{'1':'底价','2':'价格'},'defaultprice':{'1':'底价','2':'价'}},init:function(){this.initDOM();this.initEvent();this.initData();this.initpicker();},initDOM:function(){this.context.setChannelPrice=$("#setChannelPrice");this.context.channellist=$("#channellist");this.context.channelpriceform=$("#channelpriceform");this.context.channelprice=$("#channelprice");this.context.channelmonthtab=$("#channelmonthtab");this.context.inputchannelprice=$("#inputchannelprice");this.context.newchannelprice=$("#newchannelprice");this.context.setchannelprice=$("#setchannelprice");this.context.applyzg=$("#applyzg");this.context.innnlist=$("#innnlist");this.context.datainfo=$("#datainfo");this.context.batchPricePop=$("#batchPricePop");this.context.maincontent=$("#maincontent");this.commission=this.context.maincontent.attr('commission');this.dx_model=this.context.maincontent.attr('dxm');var now=M.getTime();var fromdate=new Date(now.getFullYear(),now.getMonth(),now.getDate());var enddate=new Date(fromdate.getFullYear(),fromdate.getMonth(),fromdate.getDate()+13);this.fromdate=M.timeformat(fromdate);this.enddate=M.timeformat(enddate);this.context.pickerdate=$("#pickerdate");this.context.pickerarea=$("#pickerarea");this.context.roomtypelist=$("#roomtypelist");this.context.page=$("#page");this.context.daterange=$("#daterange");this.context.selecttime=$("#selecttime");var maxdate=new Date(now.getFullYear(),now.getMonth()+6,now.getDate());var mindate=M.timeformat(now);var datestr=M.timeformat(maxdate);this.context.selecttime.datepicker({onSelect:this.onselect.toEventHandler(this),'minDate':mindate,'maxDate':datestr});this.context.setdefaultpricefrom=$("#setdefaultpricefrom");this.context.batchsetprice=$("#batchsetprice");this.context.setcanclerule=$("#setcancelrule");this.context.cancleruleform=$("#cancleruleform");this.context.salecanclerule=$("#salecanclerule");this.context.flashsaleform=$("#flashsaleform");this.context.setflashsale=$("#setflashsale");this.context.batchsefaultpriceform=$("#batchsefaultpriceform");this.context.batchsetdefaultprice=$("#batchsetdefaultprice");this.context.header=$("#header");this.context.fixhead=$(".roomthumb .date");this.context.scroll=$('.main-content');this.context.ruletip=$('#ruletip');this.context.setroomtypedatepricefrom=$('#setroomtypedatepricefrom');this.context.batchsetprice=$('#batchsetprice');this.context.batchpriceform=$('#batchpriceform');this.context.fromdate=$('#fromdate');this.context.enddate=$('#enddate');var now=M.getTime();var fromdate=new Date(now.getFullYear(),now.getMonth(),now.getDate());var enddate=new Date(fromdate.getFullYear(),fromdate.getMonth(),fromdate.getDate()+13);this.context.fromdate.val(M.timeformat(fromdate));this.context.fromdate.datepicker({showOtherMonths:true,selectOtherMonths:true,minDate:mindate});this.context.enddate.val(M.timeformat(enddate));this.context.enddate.datepicker({showOtherMonths:true,selectOtherMonths:true,minDate:mindate});},initEvent:function(){this.context.page.bind("click",this.page_click.toEventHandler(this));this.context.batchsetprice.bind("click",this.batchsetprice_click.toEventHandler(this));this.context.batchpriceform.bind("click",this.batchpriceform_click.toEventHandler(this));this.context.daterange.bind("click",this.daterange_click.toEventHandler(this));this.context.maincontent.bind("click",this.main_click.toEventHandler(this));this.context.setroomtypedatepricefrom.bind("click",this.setroomtypedatepricefrom_click.toEventHandler(this));this.context.scroll.scroll(this.win_resize.toEventHandler(this));this.context.pickerarea.scroll(this.pickerarea_scroll.toEventHandler(this));$(window).resize(this.win_resize.toEventHandler(this));},batchsetprice_click:function(){this.context.batchpriceform.find('input[name=rtprice]').val('');M.Popup(this.context.batchpriceform,{"hideclass":"modal pricebatch fade","showclass":"modal pricebatch fade in"});},batchpriceform_click:function(e){var ele=M.EventEle(e);var t=ele.attr('tag');switch(t){case'saveprie':this.batchsavertprie();break;}},batchsavertprie:function(){var rtlist=this.context.batchpriceform.find('input[name=rtprice]');var rplist=[];rtlist.each(function(){var tpl=$(this);var price=tpl.val();if(!M.isEmpty(price)){var rtid=tpl.parents('div[tag=rt]').attr('rtid');var str=rtid+'_'+price;rplist.push(str);}});if(rplist.length==0){alert('请先设置门市价再保存');return false;}
var weeklist=this.context.batchpriceform.find('input[name=day]:checked');if(weeklist.length==0){alert('请至少选择一天');return false;}
var week=[];weeklist.each(function(){var tpl=$(this);var value=tpl.val();week.push(value);});var innid=this._getinnid();var fromdate=this.context.fromdate.val();var enddate=this.context.enddate.val();var data={'innid':innid,'fromdate':fromdate,'enddate':enddate,'rpstr':rplist.toString(),'weekstr':week.toString(),'act':'batchsetprice'};M._getjson('/RoomType/roomtypepricemanage',data,this.batchsetprice_finished.toEventHandler(this));},batchsetprice_finished:function(d){if(d.status=="success"){var rtlist=d.data;for(var i in rtlist){var item=rtlist[i]
var target=this.context.pickerarea.find('tr[rtid='+item.id+']');var pricelist=item.pricelist;for(var k in pricelist){var pitem=pricelist[k];target.find('td[time='+pitem.date+']').children('div').addClass('iorange').find('p').html('￥'+pitem.price);}}
M.CloseLast();}else{if(!M.isEmpty(d.msg)){alert(d.msg);}}},setroomtypedatepricefrom_click:function(e){var ele=M.EventEle(e);var t=ele.attr('tag');switch(t){case'saveprice':this.savepdaterice();break;}},pickerarea_scroll:function(){var top=this.context.pickerarea.scrollTop();var left=this.context.pickerarea.scrollLeft();this.context.pickerdate.scrollLeft(left);this.context.pickerdate.scrollTop(top);},win_resize:function(){this.context.fixhead.removeClass('posfixed');var height=this.context.header.outerHeight();var top=this.context.pickerdate.offset().top;if(top<=height){this.context.fixhead.addClass('posfixed');}else{this.context.fixhead.removeClass('posfixed');}
var width=70*14-13;var pickerarea_width=this.context.pickerarea.width();this.context.pickerdate.width(this.context.pickerarea.width());if(pickerarea_width<=(width+25+6)){this.context.pickerarea.css("overflow-x","scroll");this.context.roomtypelist.parents('div.leftbox').css("overflow-x","scroll");var w=this.context.pickerarea.width()/14;this.context.pickerarea.find("td.canselected").width(w);this.context.pickerdate.find('th').width(w);}else{this.context.pickerarea.css("overflow-x","hidden");this.context.roomtypelist.parents('div.leftbox').css("overflow-x","hidden");var width=this.context.pickerarea.find('td.canselected:first').width();this.context.pickerdate.find('th').width(width);}},batchdefaultprice_change:function(e){var ele=M.EventEle(e);var baseprice=ele.val();if(M.isEmpty(baseprice)){ele.parents('div.item').find('strong[tag=price]').html('');return;}
if(M.math_isnumber(baseprice)===false){return;}
var price=M.math_format(baseprice*this.commission);ele.attr('price',price);ele.parents('div.item').find('strong[tag=price]').html(price);},addTplPop:function(){M.ClosePopup();var div_salesadd=this.context.flashsaleform.children('div[id=sales-add]');div_salesadd.find('input[name=discount]').val('');div_salesadd.find('select[name=rtlist]').children('option[disabled!=disabled]').eq(0).attr('selected','selected');div_salesadd.find('select[name=onhour]').children().eq(0).attr('selected','selected');var ontime=M.getTime();var ondate=M.timeformat(ontime);if(!M.isEmpty(div_salesadd.find('input[name=fromdate]').attr('id'))){div_salesadd.find('input[name=fromdate]').val(ondate);div_salesadd.find('input[name=enddate]').val(ondate);}else{var maxdate=M.timeformat(new Date(ontime.getFullYear(),ontime.getMonth()+12,ontime.getDate()-1));div_salesadd.find('input[name=fromdate]').val(ondate).datepicker({'minDate':ondate,'maxDate':maxdate});div_salesadd.find('input[name=enddate]').val(ondate).datepicker({'minDate':ondate,'maxDate':maxdate});}
M.Popup(div_salesadd,{"hideclass":"modal view fade","showclass":"modal view fade in"});return true;},main_click:function(e){var ele=M.EventEle(e);var t=ele.attr("tag");if(t=='range'||t=='year'){return;}
var display=this.context.selecttime.css('display');if(display=='block'){this.context.selecttime.hide();}},daterange_click:function(){var offset=this.context.daterange.offset();this.context.selecttime.css({'left':offset.left,'top':offset.top+40}).show().datepicker("setDate",this.fromdate);},onselect:function(date){var fromtime=M.strtotime(date);var fromdate=new Date(fromtime.getFullYear(),fromtime.getMonth(),fromtime.getDate());var enddate=new Date(fromtime.getFullYear(),fromtime.getMonth(),fromtime.getDate()+14);this.fromdate=M.timeformat(fromdate);this.enddate=M.timeformat(enddate);this.context.selecttime.hide();this.initpicker();},page_click:function(e){var ele=M.EventEle(e);var t=ele.attr('tag');switch(t){case'prev':this.prevrange();break;case'next':this.nextrange();break;}},nextrange:function(){var endtime=M.strtotime(this.enddate);var fromdate=new Date(endtime.getFullYear(),endtime.getMonth(),endtime.getDate()+1);var enddate=new Date(endtime.getFullYear(),endtime.getMonth(),endtime.getDate()+14);this.fromdate=M.timeformat(fromdate);this.enddate=M.timeformat(enddate);this.initpicker();},prevrange:function(){var today=M.timeformat(M.getTime());if(today>=this.fromdate){return false;}
var fromtime=M.strtotime(this.fromdate);var fromdate=new Date(fromtime.getFullYear(),fromtime.getMonth(),fromtime.getDate()-14);var enddate=new Date(fromtime.getFullYear(),fromtime.getMonth(),fromtime.getDate()-1);this.fromdate=M.timeformat(fromdate);this.enddate=M.timeformat(enddate);this.initpicker();},initpicker:function(){this.initpickerhead();this.initpickerarea();this.getpricestatus();this.context.maincontent.find("div[tag=ChannelPrice]").show();var cssstatus=this.context.maincontent.find("div[tag=barSuccess]").css('display');if(cssstatus!='none'){this.context.maincontent.find("div[tag=ChannelPrice]").show();}
var that=this;this.context.pickerarea.find('tr').selectable({filter:'.canselected',start:function(e,ui){that.unselectedrtid=0;that.context.pickerarea.find('div.ui-selected').removeClass('ui-selected').removeClass('ui-selecting');var target=e.toElement||e.originalEvent.target;var t=$(target).attr('tag');if(!M.isEmpty(t)&&t=='setdxdefaultprice'){that.unselectedrtid=$(target).parents('tr').attr('rtid');}},selected:function(e,ui){$(ui.selected).find('div').addClass('ui-selected');},stop:this.selectable_finished.toEventHandler(this)});},inittooltip:function(){var list=this.context.pickerarea.find('i.ico-flashsale');list.each(function(){var tpl=$(this).parents('td').children('div');var msg=tpl.attr('discountmsg');tpl.attr("title","").tooltip({position:{my:"left+15 top+20",at:"left bottom"},track:1,content:msg,show:{delay:100},hide:false});});},batchbaseprice_change:function(e){var ele=M.EventEle(e);var baseprice=ele.val();if(M.isEmpty(baseprice)){ele.parents('div.item').find('strong[tag=price]').html('');return;}
var reg=/^[0-9]*$/;if(M.math_isnumber(baseprice)===false){return;}
var price=M.math_format(baseprice*this.commission);ele.attr('price',price);if(this.dx_model==2){ele.parents('div.item').find('strong[tag=price]').html(price);}},selectable_finished:function(){if(this.unselectedrtid!=0){this.setdxdefaultprice();}else{this.bathsetroomtypeprice();}},bathsetroomtypeprice:function(type){this.context.pickerarea.find('div.ui-selected').addClass('ui-selecting');var rtdata=this._getselectroomtype(type);var rtlist=rtdata['rtlist'];if(rtdata.fromdate==''){return false;}
if(M.isEmpty(type)&&rtdata.length==1){for(var i in rtlist){this.roomtypepricetarget=rtlist[i];}
this.roomtypepricetarget.fromdate=rtdata.fromdate;this.roomtypepricetarget.enddate=rtdata.enddate;var title='设置门市价 - '+this.roomtypepricetarget.rtname;this.context.setroomtypedatepricefrom.find('h4[tag=title]').html(title);this.context.setroomtypedatepricefrom.find('input[name=price]').val('');M.Popup(this.context.setroomtypedatepricefrom,{"hideclass":"modal sm fade","showclass":"modal sm fade in"});}else{var html='';for(var i in rtlist){var item=rtlist[i];html+='<div class="item" rtid="'+item.rtid+'" pid="'+item.planid+'">';html+='<div class="name">'+item.rtname+'</div>';html+='<div class="wrapper"><input type="text" value="" name="baseprice" style="width:100px; margin-right:0;"></div>';if(this.dx_model==2){html+='<div class="wrapper">结算价：<strong class="red" tag="price"></strong></div>';}
html+='</div>';}
this.context.batchPricePop.find("li[tag=roomtypelist]").children('div').html(html);this.context.batchPricePop.find('input').bind("input propertychange",this.batchbaseprice_change.toEventHandler(this));var gettime=M.strtotime(rtdata.fromdate);var getdate=M.timeformat(gettime);var enddate=rtdata.enddate;var maxdate=M.timeformat(this._getMaxMonth(gettime));var li_datelist=this.context.batchPricePop.find('li[tag=datelist]');li_datelist.children('input[tag=startdate]').datepicker("setDate",getdate);li_datelist.children('input[tag=enddate]').datepicker("setDate",enddate);li_datelist.children('input[tag=startdate]').val(getdate).datepicker({showOtherMonths:true,selectOtherMonths:true,onSelect:this.startondateselect.toEventHandler(this)});li_datelist.children('input[tag=enddate]').val(enddate).datepicker({showOtherMonths:true,selectOtherMonths:true,onSelect:this.endondateselect.toEventHandler(this)});li_datelist.children('input[tag=startdate]').datepicker("option","minDate",getdate);li_datelist.children('input[tag=startdate]').datepicker("option","maxDate",maxdate);li_datelist.children('input[tag=enddate]').datepicker("option","minDate",getdate);li_datelist.children('input[tag=enddate]').datepicker("option","maxDate",maxdate);li_datelist.children('label').show().children('input').attr('checked','checked').removeAttr('disabled');var day=this._dateDiff(getdate,enddate);if(day<7){li_datelist.children('label').hide().children('input').attr('checked','checked').attr('disabled','disabled');}else{li_datelist.children('label').show().children('input').removeAttr('disabled');}
M.Popup(this.context.batchPricePop,{"hideclass":"modal pricebatch fade","showclass":"modal pricebatch fade in"});}},_getselectroomtype:function(type){var rtlist={};var fromdate='';var enddate='';var length=0;if(M.isEmpty(type)){var tpllist=this.context.pickerarea.find('div.ui-selected');var roomtypelist=this.context.roomtypelist;tpllist.each(function(){var target_td=$(this).parents('td');var datestr=target_td.attr('time');if(M.isEmpty(fromdate)||fromdate>datestr){fromdate=datestr;}
if(M.isEmpty(enddate)||enddate<datestr){enddate=datestr;}
var rtid=target_td.parent().attr('rtid');var target_rt=roomtypelist.find('tr[tag=rt][rtid='+rtid+']');var planid=target_rt.attr("planid");var rtname=target_rt.find('div').html();if(M.isEmpty(rtlist[rtid+'rtid'])){var tmp={'rtid':rtid,'rtname':rtname,'planid':planid}
rtlist[rtid+'rtid']=tmp;length++;}});}else{this.context.roomtypelist.find('tr[tag=rt]').each(function(){var target=$(this);var price=target.attr('price');var planid=target.attr("planid");var rtname=target.find('div').html();var rtid=target.attr('rtid');if(!M.isEmpty(price)){if(M.isEmpty(rtlist[rtid+'rtid'])){var tmp={'rtid':rtid,'rtname':rtname,'planid':planid}
rtlist[rtid+'rtid']=tmp;length++;}}});var now=M.getTime();fromdate=M.timeformat(now);enddate=this.enddate;}
return{'rtlist':rtlist,'fromdate':fromdate,'enddate':enddate,'length':length};},getpricestatus:function(){var fromdate=this.fromdate;var enddate=this.enddate;var innid=this._getinnid();M._getjson('/Ota/getroomtypeprice',{'innid':innid,'fromdate':fromdate,'enddate':enddate},this.getrtpricelist_finished.toEventHandler(this),'',true);},getrtpricelist_finished:function(d){if(d.status=="success"){var rtlist=d.data;for(var i in rtlist){var item=rtlist[i];var html=this._showpickerprice(item);var target=this.context.pickerarea.find('tr[rtid='+item.id+']');target.html(html);}}else{if(!M.isEmpty(d.msg)){alert(d.msg);}}
this.inittooltip();},_setrtdata:function(item){var roomtypeid=item.roomtypeid;if(!M.isEmpty(item.planid)){this.context.roomtypelist.find('tr[tag=rt][rtid='+roomtypeid+']').attr('price',item.price).attr('planid',item.planid);}},initpickerarea:function(){var rtlist=this._getrtlist();var html='';for(var i in rtlist){var item=rtlist[i];html+='<tr idx="'+i+'" rtid="'+item.rtid+'">';html+=this._showpickerprice(item,'init');html+='</tr>';}
this.context.pickerarea.find("table").html(html);},_showpickerprice:function(item,type){var fromtime=M.strtotime(this.fromdate);var endtime=M.strtotime(this.enddate);var index=0;var html='';var pricelist=item.pricelist;while(fromtime<=endtime){var datestr=M.timeformat(fromtime);if(!M.isEmpty(type)&&type=='init'){html+='<td i="'+index+'" class="canselected" time="'+datestr+'">';html+='<div class="canselected ">';html+='<p tag="price" p="" ></p>';html+='</div></td>';index++;}else{var price=pricelist[datestr]['price'];var classstr='';if(pricelist[datestr]['pricefrom']=='calendar'){classstr='iorange';}
html+='<td i="'+index+'" class="canselected" time="'+datestr+'">';html+='<div class="canselected '+classstr+'">';html+='<p tag="price" p="'+price+'" >&yen;'+price+'</p>';html+='</div></td>';index++;}
fromtime.setDate(fromtime.getDate()+1);}
return html;},isDiscount:function(ondate,discount,starttime,endtime,starthour){var today=M.timeformat(M.getTime());var today_time=M.strtotime(today);var sys_starthour=M.timeformat(M.getTime(),'h');var code=0;if(discount<=0){return code;}
if(M.isEmpty(starttime)||M.isEmpty(endtime)){return code;}
var on_time=M.strtotime(ondate);var start_time=M.strtotime(starttime);var end_time=M.strtotime(endtime);if(on_time>=start_time&&on_time<=end_time){if(starthour==0){code=3;}else{if(today==ondate&&starthour<=sys_starthour){code=1;}else{code=2;}}}
return code;},_getrtlist:function(){var tpllist=this.context.roomtypelist.find('tr[tag=rt]');var rtlist=[];tpllist.each(function(){var rtid=$(this).attr('rtid');var price=$(this).attr('price');var planid=$(this).attr('planid');var index=$(this).attr('i');var tmp={'rtid':rtid,'price':price,'planid':planid,'index':index};rtlist[index]=tmp;});return rtlist;},initpickerhead:function(){var fromtime=M.strtotime(this.fromdate);var endtime=M.strtotime(this.enddate);var holiday=M.Holiday();var now=M.getTime();var nowdate=M.timeformat(now);var html='';var index=0;var daterangestr=M.timeformat(fromtime,'m/d')+'~'+M.timeformat(endtime,'m/d');var yearstr=M.timeformat(endtime,'Y');this.context.page.find("p[tag=range]").html(daterangestr);this.context.page.find("b[tag=year]").html(yearstr);while(fromtime<=endtime){var datestr=M.timeformat(fromtime);var datemsg=M.timeformat(fromtime,'m-d');var week=fromtime.getDay();var weekstr='周'+this.weektext[week];if(nowdate==datestr){weekstr='今天';}
var classstr='';if(week==6||week==0){classstr+='weekend';}
var holidaystr=holiday.getholiday(datestr);if(M.isEmpty(holidaystr)){holidaystr=holiday.getrelaxesday(datestr);}
if(M.isEmpty(holidaystr)){html+='<th i="'+index+'" class="'+classstr+'"><p class="month">'+datemsg+'</p><p>'+weekstr+'</p></th>';}else{html+='<th i="'+index+'" class="'+classstr+'"><p class="month">'+datemsg+'</p><p><tt>'+holidaystr+'</tt></p></th>';}
fromtime.setDate(fromtime.getDate()+1);}
this.context.pickerdate.find('tr').html(html);},initData:function(){},savepdaterice:function(){var price=this.context.setroomtypedatepricefrom.find('input[name=price]').val();if(M.isEmpty(price)&&price!==0){alert('价格不能为空');return;}
if(!M.math_isnumber(price)){alert('价格只能是数字');return;}
var innid=this._getinnid();var startdate=this.roomtypepricetarget.fromdate;var enddate=this.roomtypepricetarget.enddate;var fromtime=M.strtotime(startdate);var endtime=M.strtotime(enddate);var pricelist=[];while(fromtime<=endtime){var date=M.timeformat(fromtime);var str=date+'p'+price;pricelist.push(str);fromtime.setDate(fromtime.getDate()+1);}
var pricestr=pricelist.join('d');var data={'act':'updateprice','innid':innid,'roomtypeid':this.roomtypepricetarget.rtid,'price':price,'pricestr':pricestr};M._getjson('/RoomType/roomtypepricemanage',data,this.batchSavePrice_finished.toEventHandler(this),'',true);},batchSavePrice_finished:function(d){if(d.status=='success'){var data=d.data;for(var i in data){var item=data[i];var pricelist=item['pricelist'];var target=this.context.pickerarea.find('tr[rtid='+item.id+']');for(var d in pricelist){var p=pricelist[d];target.find('td[time='+p.date+']').children('div').addClass('iorange').find('p[tag=price]').html('¥'+p.price);}}
this.context.pickerarea.find('div.ui-selected').removeClass('ui-selecting');M.success('保存成功');M.CloseLast();}else{if(!M.isEmpty(d.msg)){alert(d.msg);}}},startondateselect:function(startdate){var li_datelist=this.context.batchPricePop.find('li[tag=datelist]');var enddate=li_datelist.children('input[tag=enddate]').val();var day=this._dateDiff(startdate,enddate);if(day<7){li_datelist.children('label').hide().children('input').attr('checked','checked').attr('disabled','disabled');}else{li_datelist.children('label').show().children('input').removeAttr('disabled');}},endondateselect:function(enddate){var li_datelist=this.context.batchPricePop.find('li[tag=datelist]');var startdate=li_datelist.children('input[tag=startdate]').val();var day=this._dateDiff(startdate,enddate);if(day<7){li_datelist.children('label').hide().children('input').attr('checked','checked').attr('disabled','disabled');}else{li_datelist.children('label').show().children('input').removeAttr('disabled');}},editchannelprice:function(ele){var innid=this._getinnid();var roomtypeid=ele.parents("tr").attr("rtid");var planid=ele.parent().attr("pid");this.channelmonthtab_reset();this._getchannelprice(innid,roomtypeid,planid);this.context.channelpricepicker.before_open();var roomtypename=ele.parents("tr").attr("val");this.context.inputchannelprice.val('');this.context.channelpriceform.find("h3[tag=title]").html(roomtypename+'-设置代销价格');this.context.channelpriceform.attr("rtid",roomtypeid).attr("innid",innid).attr("planid",planid).find("a[tag=saveprice]").hide();M.Popup(this.context.channelpriceform,{"hideclass":"bootbox modal setprice fade","showclass":"bootbox modal setprice fade in"});},channelmonthtab_reset:function(){var fromdate=M.getTime();fromdate.setDate(1);var montharr=new Array();for(var i=0;i<this.pricemonth;i++){var mon=fromdate.getMonth();var time=this.timeformat(fromdate,"Y-m-d");fromdate.setMonth(fromdate.getMonth()+1);montharr.push({"monthname":mon+1+"月","time":time});}
var tpl_month='<li date="${time}"><a tag="month" href="#?">${monthname}</a></li>';var months=$.tmpl(tpl_month,montharr);this.context.channelmonthtab.html("").append(months).children("li:first").attr("class","active");},inputchannelprice_change:function(e){var ele=M.EventEle(e);ele.parent().children("a[tag=saveprice]").show();},_getinnid:function(){var innid=this.context.maincontent.attr("innid");return innid;},close_click:function(e){this._closepopup();},_formatdateprice:function(pricearr){var source={};if(M.isEmpty(pricearr)){return source;}
for(var i=0;i<pricearr.length;i++){var item=pricearr[i];temprtid=item.roomtypeid;var rtid=item.roomtypeid;var price=item.price;var date=item.date;var pricetype=item.type;var ymd=date.substr(0,10);source[ymd]={"price":price,"pricetype":pricetype};}
return source;},zerosize:function(value,length){if(!length)length=2;value=String(value);for(var i=0,zeros='';i<(length-value.length);i++){zeros+='0';}
return zeros+value;},_getdatetime:function(){var date=M.getTime();return date;},timeformat:function(date,format){if(M.isEmpty(format)){format="Y-m-d";}
var year=date.getFullYear();var month=this.zerosize(date.getMonth()+1+"",2);var day=this.zerosize(date.getDate()+"",2);var time=format.replace("Y",year).replace("m",month).replace("d",day);return time;},_addCacheEle:function(ele){this.cache_ele=ele;ele.attr('tag','no'+ele.attr('tag'));},_clearCacheEle:function(){var cache_ele=this.cache_ele;setTimeout(function(){var tag=cache_ele.attr('tag');cache_ele.attr('tag',tag.substr(2));},500);this.cache_ele='';return true;},NoUndefined:function(str){return M.isEmpty(str)?"":str;},_closepopup:function(){M.CloseLast();},destroy:function(){}});var OtaYZGPage;M.ready(function(){OtaYZGPage=new M.Page.OtaYZGPage();return OtaYZGPage;});