M.Page.RegisterPage=M.createClass();M.extend(M.Page.RegisterPage.prototype,{context:{},on_init:null,init:function(){this.initDOM();this.initEvent();},initDOM:function(){this.context.content=$('#content');this.context.signupsuccessPop=$('#signupsuccessPop');this.context.graylayer_my=$('#graylayer_my');this.context.select_country=$("#select_country");this.context.select_city=$("#select_city");this.context.select_area=$("#select_area");this.context.countryPop=$("#countryPop");this.context.cityPop=$("#cityPop");this.context.areaPop=$("#areaPop");this.context.valid=$("#valid");this.context.inntype=$("#inntype");this.context.inntypeform=$("#inntypeform");this.context.signupSuccessAppletPop=$("#signupSuccessAppletPop");},initEvent:function(){this.context.content.bind('click',this.content_click.toEventHandler(this));this.context.select_country.bind('click',this.selectCountry.toEventHandler(this));this.context.select_city.bind('click',this.selectCity.toEventHandler(this));this.context.select_area.bind('click',this.selectArea.toEventHandler(this));this.context.countryPop.bind('click',this.countryPop_click.toEventHandler(this));this.context.cityPop.bind('click',this.cityPop_click.toEventHandler(this));this.context.areaPop.bind('click',this.areaPop_click.toEventHandler(this));this.context.inntype.bind('click',this.inntype_click.toEventHandler(this));this.context.inntypeform.bind('click',this.inntypeform_click.toEventHandler(this));this.context.content.find('input').bind('keydown',this.input_change.toEventHandler(this));this.context.signupSuccessAppletPop.bind('click',this.signupSuccessAppletPop_click.toEventHandler(this));},signupSuccessAppletPop_click:function(e){var ele=M.EventEle(e);var tag=ele.attr('tag');if(tag=='copy'){var clipboard=new ClipboardJS('#copyUrl');clipboard.on('success',function(e){alert('复制成功！');});}else if(tag=='back'){wx.miniProgram.navigateBack({});}},input_change:function(e){var ele=M.EventEle(e);var t=ele.attr('name');switch(t){case'innname':this.context.content.find('p[tag=innname_error]').hide();break;case'inntype':this.context.content.find('p[tag=inntype_error]').hide();break;case'contact':this.context.content.find('p[tag=contact_error]').hide();break;case'phone':this.context.content.find('p[tag=phone_error]').hide();break;case'valid':this.context.content.find('p[tag=valid_error]').hide();break;case'verfiycode':this.context.content.find('p[tag=verfiycode_error]').hide();break;}},inntype_click:function(){this.context.inntypeform.toggle();var css=this.context.inntypeform.attr('display');if(css!='none'){this.context.graylayer_my.show();this.context.inntypeform.css('hi')}else{this.context.graylayer_my.hide();}},inntypeform_click:function(e){var ele=M.EventEle(e);var t=ele.attr('tag');switch(t){case'inntype':this.selectinntype(ele);break;case'closebtn':this.context.inntypeform.hide();break;}},selectinntype:function(ele){this.context.inntypeform.find('a[tag=inntype]').removeClass('on');ele.addClass('on');var inntype=ele.attr('value');var typename=ele.html();this.context.inntype.attr('inntype',inntype).val(typename);this.context.inntypeform.hide();},content_click:function(e){var ele=M.EventEle(e);var t=ele.attr('tag');switch(t){case'register':this.registerFun();break;case'sendverfiy':this.sendVerfiyCode(ele);break;case'showinvitecode':this.showinvitecode(ele);break;}},sendVerfiyCode:function(){var phone=M.getVal(this.context.content.find('input[name=phone]'));if(M.isEmpty(phone)){this.context.content.find('p[tag=phone_error]').show();return false;}
var valid=this.context.valid.val();if(M.isEmpty(valid)){this.context.content.find('p[tag=valid_error]').show();return false;}
M._getjson('/Signup/sendverfiy',{'phone':phone,'valid':valid},this._sendVerfiyCode_callback.toEventHandler(this));},_sendVerfiyCode_callback:function(d){if(d.status=='success'){this.settime(this.context.content.find('input[tag=sendverfiy]'),60);}else{var error_type=d.error_type;if(!M.isEmpty(error_type)&&error_type=='valid'){this.context.content.find('p[tag=valid_error]').html(d.msg).show();}else{this.context.content.find('p[tag=phone_error]').html(d.msg).show();}}},showinvitecode:function(ele){ele.parents('tr').hide();this.context.content.find("table tr[tag=invitecode]").show();},settime:function(target,countdown){if(countdown==0){target.attr('tag','sendverfiy').val('发送验证码').removeClass('btn-no').addClass('btn');countdown=60;return false;}else{target.attr('tag','nosendverfiy').val(countdown+"秒后可重发").removeClass('btn').addClass('btn-no');countdown--;}
var _this=this;setTimeout(function(){_this.settime(target,countdown)},1000)},registerFun:function(){var html_table=this.context.content.find('table');var innname=html_table.find('input[name=innname]').val();var inntype=this.context.inntype.attr('inntype');var countryid=html_table.find('input[name=country]').attr('countryid');var countryname=html_table.find('input[name=country]').val();var desid=html_table.find('input[name=des]').attr('desid');var desname=html_table.find('input[name=des]').val();var areaid=html_table.find('input[name=area]').attr('areaid');var areaname=html_table.find('input[name=area]').val();var contact=html_table.find('input[name=contact]').val();var phone=html_table.find('input[name=phone]').val();var verfiycode=html_table.find('input[name=verfiycode]').val();var usersource=html_table.find('input[name=usersource]').val();var invitecode=html_table.find('input[name=invitecode]').val();if(M.isEmpty(innname)){this.context.content.find('p[tag=innname_error]').show();return false;}
if(M.isEmpty(desname)){this.context.content.find('p[tag=des_error]').show();return false;}
var is_area=this._checkArea(desid);if(M.isEmpty(contact)){this.context.content.find('p[tag=contact_error]').show();return false;}
if(M.isEmpty(phone)){this.context.content.find('p[tag=phone_error]').html('请输入手机号').show();return false;}
if(M.isEmpty(verfiycode)){this.context.content.find('p[tag=verfiycode_error]').show();return false;}
var data={'innname':innname,'inntype':inntype,'countryid':countryid,'desid':desid,'areaid':areaid,'contact':contact,'phone':phone,'verfiycode':verfiycode,'countryname':countryname,'desname':desname,'areaname':areaname,'usersource':usersource,'invitecode':invitecode};M._getjson('/Signup/register',data,this._registerFun_callback.toEventHandler(this));},_registerFun_callback:function(d){if(d.status=='success'){var _this=this;wx.miniProgram.getEnv(function(res){if(res.miniprogram===true){M.Popup(_this.context.signupSuccessAppletPop,{'hideclass':'modal fade signupsucc','showclass':'modal fade in signupsucc'},function(){}.toEventHandler(this));return true;}});M.Popup(this.context.signupsuccessPop,{'hideclass':'modal fade signupsucc','showclass':'modal fade in signupsucc'},function(){}.toEventHandler(this));}else{var code=d.code;if(!M.isEmpty(code)&&code=='sms'){this.context.content.find('p[tag=verfiycode_error]').html(d.msg).show();}else if(code=='invitecode'){this.context.content.find('p[tag=invitecode_error]').html(d.msg).show();}else{this.context.content.find('p[tag=phone_error]').html(d.msg).show();}}},selectCountry:function(){this.context.cityPop.hide();this.context.cityPop.hide();var left=this.context.select_country.offset().left;var objtop=this.context.select_country.offset().top+this.context.select_country.outerHeight();this.context.graylayer_my.show();this.context.countryPop.css("left",left).css("top",objtop).show();var html="";for(var k in country){var val=country[k];html+='<a tag="country" value="'+val.id+'" href="javascript:;">'+val.name+'</a>';}
this.context.countryPop.find('div[tag=list]').html(html);},selectCity:function(){this.context.countryPop.hide();var countryid=this.context.select_country.attr('countryid');this.initcitydata(countryid);this.context.areaPop.hide();var left=this.context.select_city.offset().left;var objtop=this.context.select_city.offset().top+this.context.select_city.outerHeight();this.context.cityPop.css("left",left).css("top",objtop);this.context.cityPop.find("li[tag=hot]").show();this.context.cityPop.find("li[tag=all]").hide();this.context.cityPop.find("a[tag=tabAll]").removeClass("on");this.context.cityPop.find("a[tag=tabHot]").removeClass("").addClass("on");this.context.graylayer_my.show();this.context.cityPop.show();this.context.content.find('p[tag=des_error]').hide();},selectArea:function(){this.context.countryPop.hide();this.context.cityPop.hide();var cityid=this.context.select_city.attr("cityid");var desid=this.context.select_city.attr("desid");if(M.isEmpty(cityid)&&M.isEmpty(desid)){return;}
var left=this.context.select_area.offset().left;var objtop=this.context.select_area.offset().top+this.context.select_area.outerHeight();this.context.areaPop.css("left",left).css("top",objtop);var areahtml="";var arealist=area[desid];if(!M.isEmpty(arealist)){for(var key in arealist){var areainfo=arealist[key];areahtml+="<a href='javascript:;' cityid='"+cityid+"' desid='"+desid+"' areaid='"+areainfo.id+"' tag='selectarea'>"+areainfo.name+"</a>";}}
if(!M.isEmpty(areahtml)){this.context.areaPop.find("div[tag=arealist]").html(areahtml);this.context.graylayer_my.show();this.context.areaPop.show();}
this.context.content.find('p[tag=area_error]').hide();},countryPop_click:function(e){var ele=M.EventEle(e);var t=ele.attr('tag');if(t=='close'){this.context.countryPop.hide();this.context.graylayer_my.hide();return true;}else if(t!='country'){return true;}
var value=ele.attr('value');var name=ele.html();this.context.select_country.val(name).attr('countryid',value);this.context.countryPop.hide();this.context.select_city.attr('cityid',0).attr('desid',0).val('');this.context.select_area.attr('areaid',0).attr('cityid',0).attr('desid',0).val('');this.context.graylayer_my.hide();},cityPop_click:function(e){var ele=M.EventEle(e);var t=ele.attr("tag");if(t=="closelist")
{this.context.cityPop.hide();this.context.graylayer_my.hide();}else if(t=="tabHot"){this.context.cityPop.find("li[tag=hot]").show();this.context.cityPop.find("li[tag=all]").hide();this.context.cityPop.find("a[tag=tabAll]").removeClass("on");this.context.cityPop.find("a[tag=tabHot]").removeClass("").addClass("on");}else if(t=="tabAll"){this.context.cityPop.find("li[tag=hot]").hide();this.context.cityPop.find("li[tag=all]").show();this.context.cityPop.find("div[tag=province]").show();this.context.cityPop.find("div[tag=provincelist]").show();this.context.cityPop.find("div[tag=hasProvince]").hide();this.context.cityPop.find("a[tag=tabHot]").removeClass("on");this.context.cityPop.find("a[tag=tabAll]").removeClass("").addClass("on");}else if(t=="selectdis"){var cityid=ele.attr("cityid");var cityname=ele.text();var dishtml="";var deslist=des[cityid];if(!M.isEmpty(deslist)){for(var key in deslist){var desinfo=deslist[key];dishtml+="<a href='javascript:;' cityid='"+cityid+"' desid='"+desinfo.id+"' tag='selectdes'>"+desinfo.name+"</a>";}}else{dishtml+='数据加载出错，请联系客户经理';}
this.context.cityPop.find("li[tag=all]").find("div[tag=province]").hide();this.context.cityPop.find("li[tag=all]").find("div[tag=hasProvince]").show();this.context.cityPop.find("li[tag=all]").find("strong[tag=disname]").text(cityname);this.context.cityPop.find("li[tag=all]").find("div[tag=hasProvincelist]").html(dishtml);}else if(t=="editdis"){this.context.cityPop.find("li[tag=all]").find("div[tag=province]").show();this.context.cityPop.find("li[tag=all]").find("div[tag=hasProvince]").hide();}else if(t=="selectdes"){var cityid=ele.attr("cityid");var desid=ele.attr("desid");var desname=ele.text();var hasdesid=this.context.select_city.attr("desid");this.context.select_city.attr("cityid",cityid).attr("desid",desid).val(desname);if(hasdesid!=desid){this.context.select_area.attr('areaid',0).attr('cityid',0).attr('desid',0).val('');}
this.context.cityPop.hide();this.context.graylayer_my.hide();}else if(t=="selecthot"){var cityid=ele.attr("cityid");var desid=ele.attr("desid");var hotdesname=ele.text();var hashotdesid=this.context.select_city.attr("desid");this.context.select_city.attr("cityid",cityid).attr("desid",desid).val(hotdesname);if(hashotdesid!=desid){this.context.select_area.attr('areaid',0).attr('cityid',0).attr('desid',0).val('');}
this.context.cityPop.hide();this.context.graylayer_my.hide();}},areaPop_click:function(e){var ele=M.EventEle(e);var t=ele.attr("tag");if(t=="closelist"){this.context.areaPop.hide();}else if(t=="selectarea"){var areaid=ele.attr("areaid");var areaname=ele.text();var cityid=ele.attr("cityid");var desid=ele.attr("desid");this.context.select_area.attr("areaid",areaid).attr("cityid",cityid).attr("desid",desid).val(areaname);this.context.areaPop.hide();}
this.context.graylayer_my.hide();},initcitydata:function(countryid){var hothtml="";var hotdeslist=hotdes[countryid];if(!M.isEmpty(hotdeslist)){for(var key in hotdeslist){var hotdesinfo=hotdeslist[key];hothtml+="<a href='javascript:;' desid='"+hotdesinfo.id+"' cityid='"+hotdesinfo.p_id+"' tag='selecthot'>"+hotdesinfo.name+"</a>";}}else{hothtml='暂未添加热门，请选择“全部”';}
var dishtml="";if(M.isEmpty(district[countryid])){alert('获取数据失败');}else{var provincelist=district[countryid];for(var key in provincelist){var provinceinfo=provincelist[key];dishtml+="<a href='javascript:;' cityid='"+provinceinfo.id+"' tag='selectdis'>"+provinceinfo.name+"</a>";}}
this.context.cityPop.find("li[tag=hot]").children("div").html(hothtml);this.context.cityPop.find("li[tag=all]").find("div[tag=provincelist]").html(dishtml);},_checkArea:function(desid){var is_area=0;var arealist=area[desid];if(!M.isEmpty(arealist)){is_area=1;}
return is_area;}});M.ready(function(){var register=new M.Page.RegisterPage();return register;});