M.Page.set_wkzgood=M.createClass();M.extend(M.Page.set_wkzgood.prototype,{context:{},target_tpl:null,typelist:{},tag_target:null,openstatus:2,innid:1175,sendstatus:'0',img:null,operate:'',imgid:0,wkzinfo:'',good_tpl:'<li class="goodslist clx" id="${id}" stock="${stock}" top="${top}">'
+'<div class="pic">'
+'<img src="${img}">'
+'</div>'
+'<div class="wrap">'
+'<div class="name" tag="goodname">${goodname}</div>'
+'<div class="category" tag="catename">${catename}</div>'
+'<div class="price"><strong tag="price">${saleprice}</strong><dfn>元</dfn></div>'
+'<div class="sales" tag="salecount">${salecount}</div>'
+'<div class="${stockstyle}" tag="stock">${stock}</div>'
+'<div class="op">'
+'<a class="table-btn" href="#?" tag="editgood">编辑商品</a>'
+'<a class="table-btn table-btn-alt ml20" href="#?" tag="delgood">删除</a>'
+'</div>'
+'<div class="desc" tag="desc">${gooddesc}</div>'
+'</div>'
+'</li>',good_img:'<li class="${imgcover}" t="img" rid="${roomtypeid}" imgid="${id}" tag="goodimg">'
+'<img src="${url}" />'
+'<a href="#?" class="delete" tag="delete"></a>'
+'<a href="#?" class="setCover" tag="setCover">设为封面图</a>'
+'<i class="cover">封面</i>'
+'</li>',goodorder_tpl:'<tr>'
+'<td>${createon}</td>'
+'<td>${goodinfo}</td>'
+'<td>${channelcode}</td>'
+'<td>${totalprice}</td>'
+'<td>${guestinfo}</td>'
+'<td>${remark}</td>'
+'</tr>',goodcate_tpl:'<li class="over clx" tag="cate" id="${id}" sort="${sort}">'
+'<div class="sortvalue"><input name="sort" value="${sort}" type="text" placeholder="请输入大于零的整数" /></div>'
+'<div class="classname"><input name="catename" value="${category}" type="text" placeholder="类别名不超过四个字" /></div>'
+'<div class="manipulation">'
+'<a title="删除该预订" class="del-book mr5 mt5" href="javascript:;" tag="del"></a>'
+'<a title="添加预订" class="add-book mt5" href="javascript:;" tag="add"></a>'
+'</div>'
+'</li>',goodsort_tpl:'<option value="${id}">${category}</option>',upload_btn_tpl:'<li class="ui-state-disabled" tag="loading" style="display: none">'
+'<div class="pic"><span class="loading" tag="process">上传中...10.55%</span></div>'
+'</li>'
+'<li class="ui-state-disabled" tag="upload_li">'
+'<div class="pic"><a href="#?" class="add" tag="upload_btn" type=""></a></div>'
+'</li>',product_tip:'<img src="/pic/intro.jpg">',timer:null,init:function(){this.initDOM();this.initEvent();this.initfileupload();this.innlist_change();},initDOM:function(){this.context.maincontent=$("body");this.context.innlist=$("#innlist");this.context.inndetail=$("#inndetail");this.context.settablist=$("#settablist");this.context.fromdate=$("#fromdate");this.context.enddate=$("#enddate");this.context.goodsSetting=$("#goodsSetting");this.context.orderList=$("#orderList");this.context.addGoodsPop=$("#addGoodsPop");this.context.categoryPop=$("#categoryPop");this.context.goodsfromdate=$("#goodsfromdate");this.context.goodsenddate=$("#goodsenddate");this.context.goodsfromdate.datepicker({showOtherMonths:true,selectOtherMonths:true});this.context.goodsenddate.datepicker({showOtherMonths:true,selectOtherMonths:true});this.context.gordersearch=$("#gordersearch");this.context.goodsrename=$("#goodsrename");this.context.wkzroomresize=$('#wkzroomresize');this.context.tooltip_product=$("#tooltip_product");this.context.save_wkzroomresize=$('#save_wkzroomresize');this.context.upform=$("#upform");this.context.loading32=$("#loading32");this.context.export=$("#export");},initEvent:function(){this.context.innlist.bind("change",this.innlist_change.toEventHandler(this));this.context.settablist.bind("click",this.settablist_click.toEventHandler(this));this.context.settablist.children("li:first").addClass("on");this.context.goodsSetting.bind('click',this.goodsSetting_click.toEventHandler(this));this.context.categoryPop.bind('click',this.categoryPop_click.toEventHandler(this));this.context.goodsrename.bind('click',this.goodsrename_click.toEventHandler(this));this.context.addGoodsPop.bind('click',this.addGoodsPop_click.toEventHandler(this));this.context.export.bind('click',this.export_click.toEventHandler(this));this.context.save_wkzroomresize.bind('click',this.save_wkzroomresize_click.toEventHandler(this));this.context.gordersearch.bind('click',this.gordersearch_click.toEventHandler(this));this.context.tooltip_product.attr("title",'').tooltip({position:{my:"left+15 top+20",at:"left bottom"},track:1,content:this.product_tip,show:{duration:100}});},export_click:function(e){var gfromdate=this.context.goodsfromdate.val();var genddate=this.context.goodsenddate.val();var innid=this.context.innlist.val();window.location.href='/Microinn/exportGoodsOrder?gfromdate='+gfromdate+'&genddate='+genddate+'&innid='+innid;},goodsrename_click:function(e){var ele=M.EventEle(e);var tag=ele.attr('tag');if(tag==='save'){this.settabname();}},settabname:function(){var tabname=this.context.goodsrename.find("input[name=tabname]").val();M._getjson("/Microinn/settabname",{'tabname':tabname},this.settabname_finished.toEventHandler(this));},settabname_finished:function(d){if(d.status=='success'){alert('保存成功');}else{M.error(d.msg);}},clearwkzcache:function(){var innid=this.context.innlist.val();M._getjson('/Microinn/clearwkzcache',{'type':'hotel','innid':innid},this.clearwkzcache_finished.toEventHandler(this));},clearwkzcache_finished:function(){},innlist_change:function(){this._getmodeldata();},initfileupload:function(){var tpl=this.context.maincontent.children().find("input[type=file][tag=file]");var innid=this.context.innlist.val();tpl.each(function(){var type=$(this).attr("t");var url='/Microinn/uploadImg?type='+type;$(this).fileupload({url:url,dataType:'json',autoUpload:true,maxFileSize:1000000000,previewMaxWidth:100,previewMaxHeight:100,limitMultiFileUploadSize:5,previewCrop:true,beforeSend:function(e,data){var size=data.files[0].size;var limit=5*1024*1024;if(limit<size){M.error('您上传的图片太大了，请将图片压缩至5MB以下');return false;}
var limittype=new Array('JPG','JPEG','PNG','GIF','BMP','jpg','jpeg','png','gif','bmp');var type=data.files[0].type;var has=0;for(var i=0;i<limittype.length;i++){var item=limittype[i];if(type.indexOf(item)!=-1){has=1;}}
if(has==0){M.error('暂不支持这种格式的图片，请上传JPG/JPEG/PNG/GIF/BMP等格式');return false;}},done:function(e,data){var d=data.result;if(d.status=="success"){page._finishedupload(d);}else{M.error(d.msg);page._handleerror(d);}},fail:function(jqXHR,textStatus,errorThrown,options){},progressall:function(e,data){var progress=parseInt(data.loaded/data.total*100,10);page._processhandle(progress);}});});$("#video").fileupload({url:'/Microinn/uploadvideo',dataType:'json',autoUpload:true,maxFileSize:1000000000,limitMultiFileUploadSize:5,beforeSend:function(e,data){var size=data.files[0].size;$("body").find('div[tag=innvideo]').find('p[tag=videoname]').html(data.files[0].name);},done:function(e,data){var ele=M.EventEle(e);var target=ele.parents('div[tag=innvideo]');var d=data.result;if(d.status=="success"){target.find('p[tag=videostatus]').html('视频已上传，优酷正在审核中，请稍候').show();target.find('tr[tag=vidoinfo]').hide();}else{M.error(d.msg);target.find('div[tag=progress]').css('width','0%').html('0 %');target.find('p[tag=videosize]').html('0 MB / 0 MB').parent().hide();}},fail:function(jqXHR,textStatus,errorThrown,options){},progressall:function(e,data){var progress=parseInt(data.loaded/data.total*100,10);var videosize=parseInt(data.total/(1024*1024)*100)/100;var laodsize=parseInt(data.loaded/(1024*1024)*100)/100;var ele=M.EventEle(e);var target=ele.parents('div[tag=innvideo]');target.find('tr[tag=vidoinfo]').show();target.find('div[tag=progress]').css('width',progress+'%').html(progress+' %');target.find('p[tag=videosize]').html(laodsize+' MB / '+videosize+' MB').parent().show();}});},_handleerror:function(d){var target=this.target_tpl;var t=target.attr("tag");if(t=="roomtype"||t=="pop_roomtype"||t=="goodimg"){if(t=="pop_roomtype"||t=="goodimg"){target.children("li[tag=add]").show().children("input[tag=file]").val('');target.children("li[tag=loading]").hide().children("div").children("span").text("上传中...0%");}
if(t=="roomtype"){this.roomtypetarget.children("div[tag=img]").show();this.roomtypetarget.children("div[tag=loading]").hide();this.roomtypetarget.children("div[tag=loading]").children("span").text("上传中...0%");target.children("li[tag=add]").show().children("input[tag=file]").val('');target.children("li[tag=loading]").hide().children("div").children("span").text("上传中...0%");}}else if(t=='imglist'||t=='shopkeepersay'||t=='innavatar'){target.find('li[tag=loading]').hide();}else if(t=='uploadimagepage'){target.html(target.attr('title')).attr('upstatus',0);}},_finishedupload:function(d){var target=this.target_tpl;var t=target.attr("tag");if(t=="roomtype"||t=="pop_roomtype"||t=="goodimg"){this.roomtype_upload_finished(d);if(t=="pop_roomtype"||t=="goodimg"){target.children("li[tag=add]").show().children("input[tag=file]").val('');target.children("li[tag=loading]").hide().children("div").children("span").text("上传中...0%");}
if(t=="roomtype"){this.roomtypetarget.children("div[tag=img]").show();this.roomtypetarget.children("div[tag=loading]").hide();this.roomtypetarget.children("div[tag=loading]").children("span").text("上传中...0%");target.children("li[tag=add]").show().children("input[tag=file]").val('');target.children("li[tag=loading]").hide().children("div").children("span").text("上传中...0%");}}else if(t=='uploadimagepage'){target.html(target.attr('title')).attr('upstatus',0);var tpl=this.context.setfeature.find('dl[tag=image]').show();tpl.find("div[tag=firstupload]").hide();tpl.find("div[tag=hasupload]").show().find('img').attr('src',d.path);M.confirmmessage('形象页设定成功，在手机上刷新微官网看看效果吧！');this.clearwkzcache();}else{page.upload_finished(d);}},roomtype_upload_finished:function(d){var target=this.target_tpl;var t=target.attr("tag");if(t=="roomtype"||t=="pop_roomtype"||t=="goodimg"){var photo=this.context.wkzroomresize.find("div[name='wkzcanvas']").children().find("img[name=photo]");photo.imgAreaSelect({remove:true});}else{var photo=target.children().find("img[name=photo]");photo.imgAreaSelect({remove:true});}
this.context.wkzroomresize.find("img[name='photo']").attr('src','');this.context.wkzroomresize.find("img[name='preview']").attr('src','');this.context.wkzroomresize.children("div[tag=save_btn]").show();var pic_path=d.path;this.context.wkzroomresize.find("h4[name='progress_title']").show().text('请按比例裁剪图片');this.context.wkzroomresize.find("div[name='progress']").hide();this.context.wkzroomresize.find("div[class='before']").show();this.context.wkzroomresize.find("div[class='after']").show();this.context.wkzroomresize.find("div[class='modal-footer']").show();this.context.save_wkzroomresize.attr('pic_path',pic_path);this.context.wkzroomresize.find("img[name='photo']").attr('src',pic_path).hide();this.context.wkzroomresize.find("img[name='preview']").attr('src',pic_path).hide();var target=this.context.wkzroomresize.find("div[name='wkzcanvas']");if(t=="pop_roomtype"||t=="roomtype"){this.context.wkzroomresize.css("z-index","9999");this.context.wkzroomresize.attr("type","roomtype");}
if(t=="goodimg"){this.context.wkzroomresize.attr("type","goodimg");}
this.context.wkzroomresize.attr("sendstatus",0);this.context.wkzroomresize.find("div[tag=save_btn]").children("a").addClass("btn-cancel").removeClass("btn-primary");M.Popup(this.context.wkzroomresize,{"hideclass":"modal wkzroomresize fade","showclass":"modal wkzroomresize fade in"});setTimeout(this.cutImage2.toEventHandler(this),100);},_processhandle:function(process){var target=this.target_tpl;var t=target.attr("tag");if(t=="pop_roomtype"||t=="goodimg"){target.children("li[tag=add]").hide();var tpl=target.children("li[tag=loading]").show();tpl.children("div").children("span").html('上传中...'+process+'%');}
else if(t=="roomtype"){var target=this.roomtypetarget;target.children("div[tag=img]").hide();var tpl=target.children("div[tag=loading]").show();tpl.children("span").html('上传中...'+process+'%');}else if(t=="uploadimagepage"){var target=this.target_tpl;target.html('上传中...'+process+'%');}else{if(this.operate=='modify'){var tpl_li=target.find('li').children('a[imgid='+this.imgid+']').parent();tpl_li.children('img').hide();tpl_li.children('div[tag=operate]').hide();tpl_li.children('div[tag=desc]').hide();tpl_li.children('div[tag=description]').hide();tpl_li.children('div[tag=loading]').find("span").html('上传中...'+process+'%');tpl_li.children('div[tag=loading]').show();if(process>=100){tpl_li.children('div[tag=loading]').hide();tpl_li.children('img').show();tpl_li.children('div[tag=operate]').show();tpl_li.children('div[tag=desc]').show();}
if(process>=100&&t=='innimg'){tpl_li.children('div[tag=description]').show();}}else{target.find('li[tag=loading]').find("span").html('上传中...'+process+'%');target.find('li[tag=upload_li]').hide();target.find('li[tag=loading]').show();if(process>=100){target.find('li[tag=upload_li]').show();}}}},upload_finished:function(d){var target=this.target_tpl;var photo=target.children().find("img[name=photo]");photo.imgAreaSelect({remove:true});target.children().find("img[name=photo]").attr("src",'');target.children().find("div[tag=preview]").children("img").attr("src",'');target.children().find("li[tag=loading]").hide().children("span").html('0%');var uploadform=target.parent("form[name=upform]");var type=uploadform.attr('type');if(type=='roomtype'){target.children("div[tag=roomtype]").slideDown("fast");}
target.children("div[tag=show_img]").slideDown("fast");target.children("a[tag=save_img]").slideDown("fast");target.children("div[tag=div_save]").slideDown("fast");target.children("div[tag=inn_description]").slideDown("fast");target.children().find("img[name=photo]").attr("src",d.path);target.children().find("div[tag=preview]").children("img").attr("src",d.path);M.emptyVal(target.children().find("textarea[name='pic_content']"));this.context.picurl.val(d.path);this.cutImage(d.path);if(type=='shopkeepersay'){if(this.imgid>0){var title=target.find('li[imgid='+this.imgid+']').find('div[tag=desc]').attr('title');target.find('div[tag=div_save]').find('textarea').val(title);}else{target.find('div[tag=div_save]').find('textarea').val('');}}},cutImage2:function(src,target){var src=this.context.wkzroomresize.find("img[name='preview']").show().attr('src');this.context.wkzroomresize.find("img[name='photo']").show();var target=this.context.wkzroomresize.find("div[name='wkzcanvas']");var img=new Image();img.src=src;if($.browser.msie){img.onreadystatechange=function(){if(img.readyState=="complete"||img.readyState=="loaded"){imgOnLoad2(img,target);}};}else{img.onload=function(){if(img.complete==true){imgOnLoad2(img,target);};};}},save_wkzroomresize_click:function(e){var eventEle=M.EventEle(e);var style=eventEle.attr("class");if(style.indexOf('btn-cancel')!=-1){return;}
var roomtypeid=eventEle.attr('roomtypeid');var goodid=eventEle.attr('goodid');var innid=this.context.innlist.val();var type=this.context.wkzroomresize.attr("type");var x1=this.context.upform.children("input[id='x1']").val();var y1=this.context.upform.children("input[id='y1']").val();var x2=this.context.upform.children("input[id='x2']").val();var y2=this.context.upform.children("input[id='y2']").val();var w=this.context.upform.children("input[id='w']").val();var h=this.context.upform.children("input[id='h']").val();var picurl=eventEle.attr('pic_path');var description='';var sendstatus=this.context.wkzroomresize.attr("sendstatus");this.context.wkzroomresize.attr("sendstatus","1");if(sendstatus==1){return;}
var data={"type":type,"innid":innid,"picurl":picurl,"roomtypeid":roomtypeid,"goodid":goodid,"description":description,"x1":x1,"x2":x2,"y1":y1,"y2":y2,"w":w,"h":h};M._getjson("/Microinn/saveImage",data,this.save_wkzroomresize_click_finished.toEventHandler(this));$("#save_wkzroomresize").attr("id","saveload");},save_wkzroomresize_click_finished:function(d){if(d.status=='success'){var target=d.img.target;if(target=='roomtype'){$("#saveload").attr("id","save_wkzroomresize");M.CloseLast();this.context.wkzroomalbum.next("div[class=graylayer]").eq(0).remove();var roomtypeid=d.req.roomtypeid;var target=this.target_tpl;var t=target.attr("tag");var data={"imgcover":d.img.imgcover,"roomtypeid":d.img.roomtypeid,"url":d.path,"id":d.img.id};var html=$.tmpl(this.roomtype_img,data);this.context.roomalbum.children("li").removeClass("hasCover").find("i[class=cover]").css("display","none");this.context.roomalbum.children("li[tag=add]").before(html);this.context.pop_addimg.val('');target.children("li[tag=add]").show();if(t=='roomtype'){this.roomtypetarget.children("div[tag=img]").children("a").removeClass("add").addClass("edit").children("img").show();this.roomtypetarget.children("div[tag=img]").children("a").children("i").attr("style","");}
this.context.roomsetlist.children("li[roomtypeid="+roomtypeid+"]").find("div[tag=img]").children("a").removeClass("add").addClass("edit")
var tpl_img=this.context.roomsetlist.children("li[roomtypeid="+roomtypeid+"]").find("img").show();tpl_img.parent().find("i[tag=upload]").attr("style","");var img=tpl_img.attr("src");tpl_img.attr("src",d.path);}
if(target=="goodimg"){M.CloseLast();var imgid=d.img.id;var data={"imgcover":d.img.imgcover,"roomtypeid":d.img.goodid,"url":d.path,"id":d.img.id};var html=$.tmpl(this.good_img,data);this.context.addGoodsPop.find("ul[tag=pic]").find("ul[tag=goodimg]").children("li").removeClass("hasCover").find("i[class=cover]").css("display","none");this.context.addGoodsPop.find("ul[tag=pic]").find("ul[tag=goodimg]").children("li[tag=add]").before(html);this.context.goodsSetting.find("li[id="+d.img.goodid+"]").children("div[class=pic]").children("img").attr("src",d.path);var goodid=d.req.goodid;if(M.isEmpty(goodid)){this.context.addGoodsPop.find("ul[tag=pic]").find("ul[tag=goodimg]").children("li").children("a[tag=setCover]").hide();}
var imgidstr="";var oldimgid=this.context.addGoodsPop.find("a[tag=savegood]").attr("imgid");if(M.isEmpty(oldimgid)){this.context.addGoodsPop.find("a[tag=savegood]").attr("imgid",imgid);}else{imgidstr=oldimgid+","+imgid;this.context.addGoodsPop.find("a[tag=savegood]").attr("imgid",imgidstr);}
var rid=d.req.goodid;this.context.addGoodsPop.find("ul[tag=pic]").find("ul[tag=goodimg]").children("li[rid='']").attr('rid',rid);}
var innid=d.img.innid;M._getjson("/Microinn/flushInnClear",{"innid":innid});}else{alert('网络错误，请重新上传');}},setCover:function(ele){var id=ele.parents("li").attr("imgid");var rid=ele.parents("li").attr("rid");var tag=ele.parents("li").attr("tag");var innid=this.context.innlist.val();M._getjson("/Microinn/setCover",{"id":id,"innid":innid,"rid":rid,"tag":tag},this.setCover_finished.toEventHandler(this));},setCover_finished:function(d){if(d.status=="success"){var id=d.req.id;var rid=d.req.rid;var innid=d.req.innid;var tag=d.req.tag;if(tag=='goodimg'){this.context.addGoodsPop.find("ul[tag=pic]").find("ul[tag=goodimg]").children("li").removeClass("hasCover");var img=this.context.addGoodsPop.find("ul[tag=pic]").find("ul[tag=goodimg]").find("li[imgid="+id+"]").addClass("hasCover").children("img").attr("src");this.context.addGoodsPop.find("ul[tag=pic]").find("ul[tag=goodimg]").find("li[imgid="+id+"]").children("i").show();this.context.goodsSetting.find("ul[tag=goodlist]").children("li[id="+rid+"]").children().find("img").attr("src",img);this.context.addGoodsPop.find("a[tag=savegood]").attr("imgid",id);}
M._getjson("/Microinn/flushInnClear",{"innid":innid});}else{M.error(d.msg);}},roomalum_delete:function(ele){var style=ele.parents("li").attr("class");if(style.indexOf("hasCover")>0||style=="hasCover"){M.error("如要删除此图片，请先设置一张封面图");return;}
var res=confirm("确认删除吗");if(!res){return;}
var id=ele.parents("li").attr("imgid");var innid=this.context.innlist.val();var type=ele.parents('li').attr('tag');M._getjson("/Microinn/deleteImg",{"id":id,"innid":innid,'type':type},this.roomalum_delete_finished.toEventHandler(this));},roomalum_delete_finished:function(d){if(d.status=="success"){var id=d.req.id;var target=d.target;if(target=="roomtype"){this.context.roomalbum.children("li[imgid="+id+"]").remove();}
if(target=="goodimg"){this.context.addGoodsPop.find("ul[tag=pic]").find("ul[tag=goodimg]").find("li[imgid="+id+"]").remove();}}else{M.error(d.msg);}},settablist_click:function(e){var ele=M.EventEle(e);var t=ele.attr("tag");if(M.isEmpty(t)){return false;}
this.context.goodsSetting.hide();this.context.orderList.hide();this.context.goodsrename.hide();this.context.settablist.children("li").removeClass("on");ele.parent("li").addClass("on");if(t=='setGoods'){this.context.goodsrename.show();this.context.goodsSetting.show();}else if(t=='setOrders'){var fromdate=$("#defaultfromdate").val();var endate=M.timeformat(M.getTime(),'Y-m-d');this.context.goodsfromdate.val(fromdate);this.context.goodsenddate.val(endate);this.context.orderList.show();this.context.loading32.show();}
this._getmodeldata();},_getmodeldata:function(){var type=this.context.settablist.children("li[class=on]").children("a").attr("tag");var innid=this.context.innlist.val();this.innid=innid;var fromdate=this.context.goodsfromdate.val();var enddate=this.context.goodsenddate.val();if(M.isEmpty(type)){type='setGoods';}
if(type=='settablist'){this._resetloadstatus("load");}
this.context.goodsSetting.children("div[tag=loading]").show();M._getjson("/Microinn/getWkzInfo",{"innid":innid,"type":type,"fromdate":fromdate,"enddate":enddate},this.getwkzinfo_finished.toEventHandler(this));},getwkzinfo_finished:function(d){if(d.status=='success'){this.wkzinfo=d.data;var type=d.type;if(type=='setGoods'){var goods=d.wkzgoods;this.context.goodsrename.find("input[name=tabname]").val(this.wkzinfo.tabname);this.context.goodsSetting.children("div[tag=loading]").hide();if(M.isEmpty(goods)){this.context.goodsSetting.find("ul[tag=listhead]").hide();this.context.goodsSetting.find("ul[tag=goodlist]").children("li[tag=nogood]").prevAll().remove();this.context.goodsSetting.find("ul[tag=goodlist]").children("li[tag=nogood]").show();}else{$.each(goods,function(i,item){if(i==0&&item.top==1){item.tag='cancelstick';item.text='取消置顶';}else{item.tag='stick';item.text='置顶';}});var goodhtml=$.tmpl(this.good_tpl,goods);this.context.goodsSetting.find("ul[tag=listhead]").show();this.context.goodsSetting.find("ul[tag=goodlist]").children("li[tag=nogood]").hide();this.context.goodsSetting.find("ul[tag=goodlist]").children("li[tag=nogood]").prevAll().remove();this.context.goodsSetting.find("ul[tag=goodlist]").children("li[tag=nogood]").before(goodhtml);}}
if(type=='setOrders'){var wkzorderinfo=d.wkzorderinfo;if(M.isEmpty(wkzorderinfo)){this.context.orderList.children("table[tag=wkzorders]").hide();this.context.orderList.children("div[tag=nogoodsorder]").show();this.context.orderList.children("table[tag=wkzorders]").find("tr[tag=orderhead]").nextAll().remove();}else{var goodordershtml=$.tmpl(this.goodorder_tpl,wkzorderinfo);this.context.orderList.children("table[tag=wkzorders]").show();this.context.orderList.children("div[tag=nogoodsorder]").hide();this.context.orderList.children("table[tag=wkzorders]").find("tr[tag=orderhead]").nextAll().remove();this.context.orderList.children("table[tag=wkzorders]").find("tr[tag=orderhead]").after(goodordershtml);var totalprice=0;for(var i=0;i<wkzorderinfo.length;i++){totalprice=M.math_add(totalprice,wkzorderinfo[i].totalprice);}
if(isNaN(totalprice))
totalprice=0;var totalhtml='<tr><td>总计</td><td></td><td></td><td tag="totalprice">'+totalprice+'</td><td></td><td></td></tr>';this.context.orderList.children("table[tag=wkzorders]").find("tr:last").after(totalhtml);}}}else{if(d.status=='hasswitch'){M.confirmmessage(d.msg,this.reload.toEventHandler(this));}else if(d.msg){alert(d.msg);}else{alert('数据加载失败，刷新页面重新加载');}}},reload:function(){location.reload();},categoryPop_click:function(e){var ele=M.EventEle(e);var t=ele.attr("tag");if(t=='add'){this.addcate();}
if(t=='save'){this.savecate();}
if(t=='del'){this.delcate(ele);}},addcate:function(){var html='<li class="over clx" tag="cate">'
+'<div class="sortvalue"><input name="sort" value="" type="text" placeholder="请输入大于零的整数" class="mt5 mb5"/></div>'
+'<div class="classname"><input name="catename" value="" type="text" placeholder="类别名不超过四个字" class="mt5 mb5"/></div>'
+'<div class="manipulation"><a href="#?" class="del-book mr5 mt5" tag="del"></a><a href="#?" class="add-book mt5" tag="add"></a></div>'
+'</li>';this.context.categoryPop.find("li[tag=cate]:last").after(html);this._showbtn();},savecate:function(){var data={};data.innid=this.context.innlist.val();var cates=[];var show=0;var errmsg='';this.context.categoryPop.find("ul li[tag=cate]").each(function(){var tpl=$(this);var id=tpl.attr('id');var sort=tpl.find("input[name=sort]").val();var category=tpl.find("input[name=catename]").val();var reg=/^[1-9]\d*$/;if(M.isEmpty(sort)){show=1;errmsg='排序值不能为空';return;}
if(!reg.test(sort)){show=1;errmsg='请输入大于零的整数，数值越大排序越靠前';return;}
if(M.isEmpty(category)){show=1;errmsg='类别名不能为空';return;}
if(M.getstrlength(category)>8){show=1;errmsg='类别名称不超过四个字';return;}
id=id?id:0;cates.push({'id':id,'sort':sort,'category':category});});if(show==1){alert(errmsg);return;}
data['cates']=cates;M._getjson("/Microinn/manegeGoodCate",data,this.savecate_finished.toEventHandler(this));},savecate_finished:function(d){if(d.status=='success'){alert('保存成功');this._closepopup();return;}else{alert(d.msg);return;}},delcate:function(ele){var data={};var li=ele.parents('li');data.innid=this.context.innlist.val();data.id=li.attr('id');if(M.isEmpty(data.id)){li.remove();this._showbtn();}else{M._getjson("/Microinn/delGoodCateCheck",data,this.delcate_finished.toEventHandler(this));}},delcate_finished:function(d){if(d.status=='success'){this.context.categoryPop.find("li[id="+d.data+"]").remove();this._showbtn();}else{alert(d.msg);return;}},goodsSetting_click:function(e){var ele=M.EventEle(e);var t=ele.attr("tag");if(t=='addGoods'){this.addGoodsPopup();}
if(t=='addGoodsCate'){this.editgoodscate();}
if(t=='delgood'){this.delgood(e);}
if(t=='editgood'){this._clearGoodForm();this.editgood(e);}},addGoodsPopup:function(){var innid=this.context.innlist.val();M._getjson("/Microinn/getGoodCategoryList",{'innid':innid},this.addGoodsPopup_finished.toEventHandler(this));},addGoodsPopup_finished:function(d){if(d.status=='success'){this._clearGoodForm();this.context.addGoodsPop.find("a[tag=savegood]").attr("action","add");this.context.addGoodsPop.find("a[tag=savegood]").removeAttr("editid");this.context.addGoodsPop.children("div[class=modal-header]").children("h4").children("font").text("添加商品");var catehtml=$.tmpl(this.goodsort_tpl,d.data);this.context.addGoodsPop.find("select[name=cate]").html(catehtml);M.Popup(this.context.addGoodsPop,{"hideclass":"modal wkzGoodsPop large fade","showclass":"modal wkzGoodsPop large fade in"},function(){}.toEventHandler(this));}else{alert(d.msg);return;}},editgoodscate:function(){var innid=this.context.innlist.val();M._getjson("/Microinn/getGoodCategoryList",{'innid':innid},this.editgoodscate_finished.toEventHandler(this));},editgoodscate_finished:function(d){if(d.status=='success'){var html=$.tmpl(this.goodcate_tpl,d.data);if(html.length==0){html='<li class="over clx" tag="cate">'
+'<div class="sortvalue"><input name="sort" value="" type="text" placeholder="请输入大于零的整数" class="mt5 mb5"/></div>'
+'<div class="classname"><input name="catename" value="" type="text" placeholder="类别名不超过四个字" class="mt5 mb5"/></div>'
+'<div class="manipulation"><a href="#?" class="del-book mr5 mt5" tag="del"></a><a href="#?" class="add-book mt5" tag="add"></a></div>'
+'</li>';}
this.context.categoryPop.find("ul").html('<li class="over clx" tag="head"><div class="sortvalue">排序值<span class="red t12">*数值大排序靠前</span></div><div class="classname">类别名</div><div class="manipulation"></div></li>');this.context.categoryPop.find("li[tag=head]").after(html);this._showbtn();M.Popup(this.context.categoryPop,{"hideclass":"modal fade","showclass":"modal fade in"},function(){}.toEventHandler(this));}else{alert('网络错误');return;}},_showbtn:function(){this.context.categoryPop.find("ul li[tag=cate]").find("a").hide();if(this.context.categoryPop.find("ul li[tag=cate]").length<=1){this.context.categoryPop.find("ul li[tag=cate]:first").find("a[tag=add]").show();}else if(this.context.categoryPop.find("ul li[tag=cate]").length>=10){this.context.categoryPop.find("ul li[tag=cate]").find("a[tag=del]").show();this.context.categoryPop.find("ul li[tag=cate]:last").find("a[tag=add]").hide();}else{this.context.categoryPop.find("ul li[tag=cate]").find("a[tag=del]").show();this.context.categoryPop.find("ul li[tag=cate]:last").find("a").show();}},delgood:function(e){var res=confirm("确认删除吗？");if(!res){return;}
var ele=M.EventEle(e);var id=ele.parents("li").attr("id");M._getjson("/Microinn/delGoods",{"goodid":id},this.delgoods_finished.toEventHandler(this));},delgoods_finished:function(d){if(d.status=="success"){var id=d.id;this.context.goodsSetting.find("ul[tag=goodlist]").children("li[id="+id+"]").remove();var goodsnum=this.context.goodsSetting.find("ul[tag=goodlist]").children("li[tag=nogood]").prevAll().size();if(goodsnum==0){this.context.goodsSetting.find("ul[tag=listhead]").hide();this.context.goodsSetting.find("ul[tag=goodlist]").children("li[tag=nogood]").show();}}else{M.error(d.msg);}},editgood:function(e){var ele=M.EventEle(e);var id=ele.parents("li").attr("id");M._getjson("/Microinn/getGoodInfo",{"goodid":id},this.editgoods_finished.toEventHandler(this));},editgoods_finished:function(d){if(d.status=="success"){var data=d.data;var imglist=d.list;var id=data.id;var goodname=data.goodname;var saleprice=data.saleprice;var stock=data.stock;var gooddesc=data.gooddesc;var img_html=$.tmpl(this.good_img,imglist);var catelist=d.catelist;var catehtml=$.tmpl(this.goodsort_tpl,catelist);this.context.addGoodsPop.find("input[name=goodname]").val(M.htmlspecialchars_decode(goodname));this.context.addGoodsPop.find("input[name=goodprice]").val(saleprice);this.context.addGoodsPop.find("input[name=goodstock]").val(stock);this.context.addGoodsPop.find("textarea[name=gooddesc]").val(M.htmlspecialchars_decode(gooddesc));this.context.addGoodsPop.find("a[tag=savegood]").attr("action","edit").attr("editid",id);this.context.addGoodsPop.find("ul[tag=pic]").find("ul[tag=goodimg]").children("li[tag=add]").before(img_html);this.context.addGoodsPop.children("div[class=modal-header]").children("h4").children("font").text("编辑商品");this.context.addGoodsPop.find("select[name=cate]").html(catehtml);if(!M.isEmpty(data.categoryid)){this.context.addGoodsPop.find("select[name=cate]").val(data.categoryid);}
M.Popup(this.context.addGoodsPop,{"hideclass":"modal wkzGoodsPop large fade","showclass":"modal wkzGoodsPop large fade in"},function(){}.toEventHandler(this));}else{M.error(d.msg);}},addGoodsPop_click:function(e){var ele=M.EventEle(e);var t=ele.attr("tag");if(t=="savegood"){this.addgood();}
if(t=="addgoodpic"){this.target_tpl=ele.parent("div").parent("li").parent("ul").attr("tag","goodimg");var goodid=this.context.addGoodsPop.find("a[tag=savegood]").attr("editid");this.context.save_wkzroomresize.attr('goodid',goodid).attr("roomtypeid",0);this.context.addGoodsPop.find("ul[tag=pic]").find("ul[tag=goodimg]").children("li[tag=add]").children("input[tag=file]").click();}
if(t=="delete"){this.roomalum_delete(ele);}
if(t=="setCover"){this.setCover(ele);}},addgood:function(){var action=this.context.addGoodsPop.find("a[tag=savegood]").attr("action");var goodname=this.context.addGoodsPop.find("input[name=goodname]").val();var price=this.context.addGoodsPop.find("input[name=goodprice]").val();var goodstock=this.context.addGoodsPop.find("input[name=goodstock]").val();var gooddesc=this.context.addGoodsPop.find("textarea[name=gooddesc]").val();var imgid=this.context.addGoodsPop.find("a[tag=savegood]").attr("imgid");var categoryid=this.context.addGoodsPop.find("select[name=cate]").val();var data={"action":action,"goodname":goodname,"price":price,"goodstock":goodstock,"gooddesc":gooddesc,"imgid":imgid,"categoryid":categoryid};if(action=='edit'){var id=this.context.addGoodsPop.find("a[tag=savegood]").attr("editid");data.goodid=id;}
if(M.isEmpty(goodname)){alert("商品名称不能为空");return;}
var regu=/['"$<>]+/;var re=new RegExp(regu);if(re.test(goodname)){alert("请不要在商品名中使用 \' \" $ < > 等特殊符号");return;}
if(M.getstrlength(goodname)>30){alert("商品名称不能超过30个字哦");return;}
if(M.isEmpty(categoryid)){alert('请选择一个商品分类');return;}
if(!M.isEmpty(price)){if(price==0){alert("商品价格不能为0！");return;}
if(!$.isNumeric(price)){alert("请填写正确的商品价格！");return;}
if(price>100000){alert('老板，您的商品太昂贵了我们承担不起啊~卖些便宜点儿的东西吧');return false;}}else{alert("商品价格不能为空！");return;}
if(!M.isEmpty(goodstock)){if(!$.isNumeric(goodstock)&&goodstock!=0){alert("请填写正确的商品库存！");return;}
var s=goodstock.length-goodstock.replace(/\./g,"").length;if(s>0){alert('商品库存只能输入整数喔');return;}
if(goodstock>=10000){alert("商品库存不能大于9999！");return;}}else{alert("商品库存不能为空！");return;}
M._getjson("/Microinn/addGoods",data,this.addgood_finished.toEventHandler(this));},addgood_finished:function(d){if(d.status=="success"){var action=d.action;var data=d.data;var path=d.path;if(action=='add'){data.img=path;data.tag='stick';var goodhtml=$.tmpl(this.good_tpl,data);this.context.goodsSetting.find("ul[tag=goodlist]").children("li[tag=nogood]").before(goodhtml);var goodsnum=this.context.goodsSetting.find("ul[tag=goodlist]").children("li[tag=nogood]").prevAll().size();if(goodsnum!=0){this.context.goodsSetting.find("ul[tag=listhead]").show();this.context.goodsSetting.find("ul[tag=goodlist]").children("li[tag=nogood]").hide();}}
if(action=='edit'){var id=data.id;var goodname=M.htmlspecialchars_decode(data.goodname);var catename=data.catename;var saleprice=data.saleprice;var stock=data.stock;var stockstyle=data.stockstyle;var gooddesc=M.htmlspecialchars_decode(data.gooddesc);var salecount=data.salecount;this.context.goodsSetting.find("li[id="+id+"]").attr('stock',stock);this.context.goodsSetting.find("li[id="+id+"]").children("div[class=wrap]").find("div[tag=goodname]").text(goodname);this.context.goodsSetting.find("li[id="+id+"]").children("div[class=wrap]").find("div[tag=catename]").text(catename);this.context.goodsSetting.find("li[id="+id+"]").children("div[class=wrap]").find("strong[tag=price]").text(saleprice);this.context.goodsSetting.find("li[id="+id+"]").children("div[class=wrap]").find("div[tag=stock]").removeClass().addClass(stockstyle).text(stock);this.context.goodsSetting.find("li[id="+id+"]").children("div[class=wrap]").find("div[tag=desc]").text(gooddesc);this.context.goodsSetting.find("li[id="+id+"]").children("div[class=wrap]").find("div[tag=salecount]").text(salecount);this.context.goodsSetting.find("li[id="+id+"]").children("div[class=pic]").children("img").attr("src",path);}
this._closepopup();}else{M.error(d.msg);}},gordersearch_click:function(){var gfromdate=this.context.goodsfromdate.val();var genddate=this.context.goodsenddate.val();var innid=this.context.innlist.val();M._getjson("/Microinn/goodsOrderSearch",{"innid":innid,"gfromdate":gfromdate,"genddate":genddate},this.goodsordersearch_finished.toEventHandler(this));},goodsordersearch_finished:function(d){if(d.status=="success"){var wkzorderinfo=d.wkzorderinfo;if(M.isEmpty(wkzorderinfo)){this.context.orderList.children("table[tag=wkzorders]").hide();this.context.orderList.children("div[tag=nogoodsorder]").show();this.context.orderList.children("table[tag=wkzorders]").find("tr[tag=orderhead]").nextAll().remove();}else{var goodordershtml=$.tmpl(this.goodorder_tpl,wkzorderinfo);this.context.orderList.children("table[tag=wkzorders]").show();this.context.orderList.children("div[tag=nogoodsorder]").hide();this.context.orderList.children("table[tag=wkzorders]").find("tr[tag=orderhead]").nextAll().remove();this.context.orderList.children("table[tag=wkzorders]").find("tr[tag=orderhead]").after(goodordershtml);var totalprice=0;for(var i=0;i<wkzorderinfo.length;i++){totalprice=M.math_add(totalprice,wkzorderinfo[i].totalprice);}
if(isNaN(totalprice))
totalprice=0;var totalhtml='<tr><td>总计</td><td></td><td></td><td tag="totalprice">'+totalprice+'</td><td></td><td></td></tr>';this.context.orderList.children("table[tag=wkzorders]").find("tr:last").after(totalhtml);}}else{M.error(d.msg);}},_clearGoodForm:function(){this.context.addGoodsPop.find("input[name=goodname]").val("");this.context.addGoodsPop.find("input[name=goodprice]").val("");this.context.addGoodsPop.find("input[name=goodstock]").val("");this.context.addGoodsPop.find("textarea[name=gooddesc]").val("");this.context.addGoodsPop.find("a[tag=savegood]").attr("action","").attr("editid","").attr("imgid","");this.context.addGoodsPop.find("ul[tag=pic]").find("ul[tag=goodimg]").children("li[tag=add]").prevAll().remove();this.context.wkzroomresize.children("div[tag=save_btn]").children("a").attr("goodid","");},_clearmicroform:function(){this.context.taglist.children("li[t=tag]").remove();this.context.inndetail.children().find("dd[tag=refuseinfo]").hide();this.context.inndetail.children().find("a[tag=savewifi]").hide();this.context.inndetail.children().find("span[tag=savewifitips]").hide();this.context.inndetail.children().find("span[tag=tips]").show();this.context.inndetail.children().find("dd[tag=refuseinfo]").hide();this.context.inndetail.attr("aid","");this.context.inndetail.children().find("input[name=address]").val('').attr("disabled",false);this.context.inndetail.children().find("input[name=phone]").attr("disabled",false);this.context.whzdataform.children("dl[tag=phone][dis=dis][i=1]").remove();this.context.inndetail.children().find("input[name=wifipassword]").attr("disabled",false);this.context.inndetail.children().find("input[name=weixin]").val('');var html=this.context.mobilelist.children("li[class=addnew]").clone();this.context.mobilelist.children("li").remove();this.context.mobilelist.html(html);M.emptyVal(this.context.inndetail.children().find("input[name=phone]"));M.emptyVal(this.context.inndetail.children().find("input[name=wifipassword]"));M.emptyVal(this.context.inndetail.children().find("textarea[name=description]"));this.context.inndetail.children().find("dd[tag=innapply_btn]").html('<a href="javascript:;" tag="open"  class="btn btn-primary" style="width:120px;" tag="open">申请开通</a>');},reqbusy:function()
{alert("请求处理中，请稍后再试");},req_before:function(btn)
{var busy=btn.attr("busy");if(busy=="1")
{this.reqbusy();return false;}
btn.html(this.submittext).attr("busy","1");btn.attr("class",btn.attr("tempclass")+" disabled");return true;},req_end:function(btn)
{btn.html(btn.attr("text")).attr("busy","");btn.attr("class",btn.attr("tempclass"));},NoUndefined:function(str)
{return M.isEmpty(str)?"":str;},_closepopup:function()
{M.ClosePopup();},destroy:function(){}});var target_tpl=null;var typelist={"innavatar":"35:24","innweixin":"9:5","shopkeepersay":"1:1","inn":"35:24","roomtype":"35:24"};function imgOnLoad(img,target){target_tpl=target;var width=img.width;var height=img.height;var r=height/width;var imgOrgBox=target_tpl.children().find("div[tag=imgOrgBox]");var photo=target_tpl.children().find("img[name=photo]");if(r>1.5){imgActualHeight=imgOrgBox.height();imgActualWidth=imgActualHeight/r;photo.attr("style","height:100%");$('#s').val(height/imgActualHeight);$('#s1').val(imgActualHeight/height);}else{imgActualWidth=imgOrgBox.width();imgActualHeight=imgActualWidth*r;photo.attr("style","width:100%");$('#s').val(width/imgActualWidth);$('#s1').val(imgActualWidth/width);}
var uploadform=target.parent("form[name=upform]");var type=uploadform.attr('type');var raido=typelist[type];photo.imgAreaSelect({remove:true});var raidoarr=raido.split(":");var imgwidth=imgActualWidth-10;var imgheight=parseInt(imgwidth*raidoarr[1]/raidoarr[0]);if(imgheight>imgActualHeight){imgheight=imgActualHeight-10;imgwidth=parseInt(imgheight*raidoarr[0]/raidoarr[1])-10;}
photo.imgAreaSelect({x1:0,y1:0,x2:imgwidth,y2:imgheight,onInit:preview,instance:true,aspectRatio:raido,handles:true,parent:imgOrgBox,onSelectEnd:preview});target_tpl.find("a[tag=save_img]").removeClass("btn-cancel").addClass("btn-info");}
function imgOnLoad2(img,target){target_tpl=target;var width=img.width;var height=img.height;var r=height/width;var imgOrgBox=target_tpl.children().find("div[tag=imgOrgBox]");var photo=target_tpl.children().find("img[name=photo]");photo.imgAreaSelect({remove:true});if(r>1.5){imgActualHeight=imgOrgBox.height();imgActualWidth=imgActualHeight/r;photo.attr("style","height:100%");$('#s').val(height/imgActualHeight);$('#s1').val(imgActualHeight/height);}else{imgActualWidth=imgOrgBox.width();imgActualHeight=imgActualWidth*r;photo.attr("style","width:100%");$('#s').val(width/imgActualWidth);$('#s1').val(imgActualWidth/width);}
var uploadform=target.parent("form[name=upform]");var type=uploadform.attr('type');var raido=typelist['roomtype'];var raidoarr=raido.split(":");var imgwidth=imgActualWidth-10;var imgheight=parseInt(imgwidth*raidoarr[1]/raidoarr[0]);if(imgheight>imgActualHeight){imgheight=imgActualHeight-10;imgwidth=parseInt(imgheight*raidoarr[0]/raidoarr[1])-10;}
photo.imgAreaSelect({x1:0,y1:0,x2:imgwidth,y2:imgheight,onInit:preview2,instance:true,aspectRatio:"35:24",handles:true,parent:imgOrgBox,onSelectEnd:preview2});$("#wkzroomresize").find("div[tag=save_btn]").children("a").removeClass("btn-cancel").addClass("btn-primary");}
function preview(img,selection){if(!selection.width||!selection.height)
return;var selectionDiv=target_tpl.children().find("div[tag=preview]");var preview_img=target_tpl.children().find("img[tag=preview_img]");var scaleX=selectionDiv.width()/selection.width;var scaleY=selectionDiv.height()/selection.height;preview_img.css({width:Math.round(scaleX*imgActualWidth),height:Math.round(scaleY*imgActualHeight),marginLeft:-Math.round(scaleX*selection.x1),marginTop:-Math.round(scaleY*selection.y1)});var s=$("#s").val();var x1=selection.x1*s;$('#x1').val(x1);var y1=selection.y1*s;$('#y1').val(y1);$('#x2').val(selection.x2);$('#y2').val(selection.y2);var w=selection.width*s;$('#w').val(w);var h=selection.height*s;$('#h').val(h);}
function preview2(img,selection){if(!selection.width||!selection.height)
return;var selectionDiv=target_tpl.children().find("div[tag=preview]");var preview_img=target_tpl.children().find("img[tag=preview_img]");var scaleX=selectionDiv.width()/selection.width;var scaleY=selectionDiv.height()/selection.height;preview_img.css({width:Math.round(scaleX*imgActualWidth),height:Math.round(scaleY*imgActualHeight),marginLeft:-Math.round(scaleX*selection.x1),marginTop:-Math.round(scaleY*selection.y1)});var s=$("#s").val();var x1=selection.x1*s;$('#x1').val(x1);var y1=selection.y1*s;$('#y1').val(y1);$('#x2').val(selection.x2);$('#y2').val(selection.y2);var w=selection.width*s;$('#w').val(w);var h=selection.height*s;$('#h').val(h);}
M.ready(function(){page=new M.Page.set_wkzgood();return page;});