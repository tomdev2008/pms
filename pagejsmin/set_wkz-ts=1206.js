M.Page.set_wkz=M.createClass();M.extend(M.Page.set_wkz.prototype,{context:{},target_tpl:null,typelist:{},tag_target:null,openstatus:2,innid:1175,sendstatus:'0',roomtypetarget:null,wkzroomtypelist:{},img:null,operate:'',imgid:0,wkzinfo:'',cache_ele:'',dis_roomtype_tpl:'<label tag="rt" class="mr10" style="display:inline-block;"><input name="roomtype" value="${id}" tag="roomtypeselect" type="checkbox" checked="checked">${roomtypename}</label> ',pv_tpl:'<tr t="${date}" tag="date"><td>${date}</td><td tag="n">-</td></tr>',like_tpl:'<tr t="${date}" tag="date"><td>${date}</td><td tag="n">-</td>'+'<td tag="weixin"><ul class="userlist clx"><i>-</i></ul>'+'</td>'+'</tr>',weixin_url:'<ul class="userlist clx"><li><img src="${avatarurl}" title="微信昵称" /></li></ul>',order_tpl:'<tr t="${date}" tag="date">'
+'<td>${date}</td>'
+'<td tag="payname">-</td>'
+'<td tag="ordercount">-</td>'
+'<td tag="total">-</td>'
+'<td tag="rant">-</td>'
+'<td tag="unpaid">-</td>'
+'<td tag="paid">-</td>'
+'<td tag="account">-</td>'
+'<td tag="paidon">-</td>'
+'</tr>',openwkz_tip:'已开通微官网',addmiot_tip:'已加入米途直销平台，点击查看服务条款。',product_tip:'<img src="/pic/intro.jpg">',innname_tip:'如需修改，请点击左侧"客栈及房型" - "修改客栈信息"',innlike_tip:'如需修改，请点击左侧"客栈及房型" - "修改客栈信息"',paystatus_tip:'结算金额与订单金额不一致？</br>支付宝在客人付款时会收取<strong class="bold red">1%</strong>的手续费，<br/>微信支付会收取<strong class="bold red">0.6%</strong>的手续费。',alicert_tip:'未完成实名认证的支付宝账户，<br>收款额度限制为5000元/年',roomtype:'<option value="${id}" tag="${tag}" style="${style}">${roomtypename}</option>',tag_tpl:'<li t="tag"><label for="checkbox">${tagname}</label><a tag="delete" href="#?" title="删除该标签" class="delete"></a></li>',opensuccess_tpl:'<div class="wxBox mt10" tag="opensuccess">'
+'<h1>通过链接分享您的微官网：</h1>'
+'<h2>您的微官网链接：<a href="https://wx.miot.cn/i-${innid}" target="_blank" class="red t14">https://wx.miot.cn/i-${innid}</a> ，'
+'可将此网址通过QQ、微博、论坛等分享。</h2>'
+'<h1 class="mt15">有自家微信公众号？</h1>'
+'<h2>已认证过的服务号，可以直接使用上方您的微官网链接；<br/>如果是订阅号，请使用<span>https://wx.miot.cn/i-${innid}?t=mp</span>。<br/><span class="red">(由于微信限制，订阅号无法使用微信支付，我们会为您隐藏“微信支付”的按钮)</span>'
+'</div>',img_tpl:' <li tag="img" imgid="${id}"><img src="${url}" /><div class="tool clx" tag="description" style="display:none"><input type="text" maxlength="20" tag="inputdescription" value="${description}" /><a href="#?" class="save" style="display: none" tag="savedescription">保存</a></div><div class="pic" tag="loading" style="display: none"><span class="loading" tag="process">上传中...10.55%</span></div><a imgid="${id}" href="#?" tag="delete" class="delete"></a><a class="fullcover" href="#?" operate="modify" tag="upload_btn">重新上传</a><a href="#?" class="move"></a></li>',img_tpl_shopkeepersay:'<li imgid="${id}" head="${head}" tag="img">'
+'<img src="${url}" />'
+'<div title="${description}" tag="desc" style="display:none">${shortdescription}</div>'
+'<div class="tool clx" tag="operate">'
+'<a href="#?" class="fr" tag="editbosssay">修改照片说明</a>'
+'<a href="#?" tag="setupboss" style="display:none;">设为掌柜</a>'
+'</div>'
+'<span class="active" tag="bosshead">掌柜<br/>头像</span>'
+'<div class="pic" tag="loading" style="display: none"><span class="loading" tag="process">上传中...10.55%</span></div>'
+'<a imgid="${id}" href="#?" tag="delete" class="delete"></a><a class="fullcover" href="#?" operate="modify" tag="upload_btn">重新上传</a>'
+'</li>',roomtype_img:'<li class="${imgcover}" t="img" rid="${roomtypeid}" imgid="${id}" tag="roomtype">'
+'<img src="${url}" />'
+'<a href="#?" class="delete" tag="delete"></a>'
+'<a href="#?" class="setCover" tag="setCover">设为封面图</a>'
+'<i class="cover">封面</i>'
+'</li>',mobile_tpl:'<li mid="${mid}"><label>${mobile}</label><a tag="del" href="#?" title="删除该手机"          class="delete"></a></li>',wkzorder_tpl:'<tr t="${billdate}">'
+'<td tag="${billdate}">${billdate}</td>'
+'<td>${payname}</td>'
+'<td>${ordercount}</td>'
+'<td>¥${total}<a href="#?" tag="${tag}" class="ml5" id="orderdetail" gateway="${gateway}" class="ml5" billid="${billid}">(明细)</a></td>'
+'<td>${rant}</td>'
+'<td class="${unpaidcss}">¥${unpaid}</td>'
+'<td class="${paidcss}">¥${paid}</td>'
+'<td>${account}</td>'
+'<td class="${paidoncss}">${paidon}</td>'
+'</tr>',upload_btn_tpl:'<li class="ui-state-disabled" tag="loading" style="display: none">'
+'<div class="pic"><span class="loading" tag="process">上传中...10.55%</span></div>'
+'</li>'
+'<li class="ui-state-disabled" tag="upload_li">'
+'<div class="pic"><a href="#?" class="add" tag="upload_btn" type=""></a></div>'
+'</li>',themelist:{'blue':'themes-blue.jpg','elegantblack':'themes-black.jpg','freshgreen':'themes-green.jpg','lnkstyle':'themes-ink.jpg','luxuriousred':'themes-red.jpg'},tpl_use_roomtype:' <label class="mr10" style="display:inline-block;"><input name="checkbox" type="checkbox" tag="selectroomtype" rtid="${id}">${roomtypename}</label>',timer:null,init:function(){this.initDOM();this.initEvent();this.initfileupload();this.innlist_change();},initDOM:function(){this.context.innlist=$("#innlist");this.context.inndetail=$("#inndetail");this.openstatus=this.context.inndetail.attr("openstatus");this.context.editinfo=$("#editinfo");this.context.settablist=$("#settablist");this.context.picSetting=$("#picSetting");this.context.saleSetting=$("#saleSetting");this.context.roomSetting=$("#roomSetting");this.context.uploadpicform=$("#picSetting").children('form');this.context.picurl=$("#picurl");this.context.upform=$("#upform");this.context.description=$("#description");this.context.addinntag=$("#addinntag");this.context.taglist=$("#taglist");this.context.paycardform=$("div[tag=paycardform]");this.context.mobilelistform=$("#mobilelistform");this.context.whzdataform=$("#whzdataform");this.context.applyopen_btn=$("#applyopen_btn");this.context.tooltip_innname=$("#tooltip_innname");this.context.tooltip_innlike=$("#tooltip_innlike");this.context.tooltip_product=$("#tooltip_product");this.context.search_btn=$("#search_btn");this.context.editpaycard=$("#editpaycard");this.context.fromdate=$("#fromdate");this.context.enddate=$("#enddate");this.context.file_upload=$("#fileupload");this.context.progress=$("#progress");this.context.videostatus=$("#videostatus");this.context.singleToggle=$("#singleToggle");this.context.discountPop=$("#discountPop");this.context.save_status=$("#save_status");this.context.save_discount=$("#save_discount");this.context.discount_input=$('#discount_input');this.context.wkzroomresize=$('#wkzroomresize');this.context.save_wkzroomresize=$('#save_wkzroomresize');this.context.roomtype_load=$('#roomtype_load');this.context.pic_load=$('#pic_load');this.context.maincontent=$("body");this.context.setroomtypedesc=$("#setroomtypedesc");this.context.savedesc=$("#savedesc");this.context.wkzroomalbum=$("#wkzroomalbum");this.context.pop_addimg=$("#pop_addimg");this.context.fromdate.datepicker({showOtherMonths:true,selectOtherMonths:true});this.context.enddate.datepicker({showOtherMonths:true,selectOtherMonths:true});this.context.tooltip_innlike.attr("title",'').tooltip({position:{my:"left+15 top+20",at:"left bottom"},track:1,content:this.innlike_tip,show:{duration:100}});this.context.tooltip_innname.tooltip({position:{my:"left+15 top+20",at:"left bottom"},track:1,show:{duration:100}});this.context.tooltip_product.attr("title",'').tooltip({position:{my:"left+15 top+20",at:"left bottom"},track:1,content:this.product_tip,show:{duration:100}});this.context.applyopen_btn.find('span[tag=wkzstatus]').attr("title",'').tooltip({position:{my:"left+15 top+20",at:"left bottom"},track:1,content:this.openwkz_tip,show:{duration:100}});this.context.applyopen_btn.find('span[tag=miotstatus]').attr("title",'').tooltip({position:{my:"left+15 top+20",at:"left bottom"},track:1,content:this.addmiot_tip,show:{duration:100}});this.context.whzdataform.find('a[tag=seeexamples]').attr("title",'').tooltip({position:{my:"left+15 top+20",at:"left bottom"},track:1,content:customsample_tip,show:{duration:100}});this.context.picSetting.find('div[tag=innavatarsample]').attr("title",'').tooltip({position:{my:"left+15 top+20",at:"left bottom"},track:1,content:innavatarsample_tip,show:{duration:100}});this.context.picSetting.find('div[tag=shopkeepersaysample]').attr("title",'').tooltip({position:{my:"left+15 top+20",at:"left bottom"},track:1,content:shopkeepersaysample_tip,show:{duration:100}});this.context.picSetting.find('div[tag=imgsample]').attr("title",'').tooltip({position:{my:"left+15 top+20",at:"left bottom"},track:1,content:imgsample_tip,show:{duration:100}});this.context.mobilenum=$("#mobilenum");this.context.mobilelist=$("#mobilelist");this.context.accountmobilelist=$("#accountmobilelist");this.context.addfield=this.context.mobilelist.children("li[class=addnew]");this.context.cancelrule=$("#cancelrule");this.context.newcouSelect=$("#newcouSelect");this.context.setdatepop=$("#setdatepop");this.context.paytypelist=$("#paytype");this.context.savepaytype=$("#savepaytype");this.context.orderdetail=$("#orderdetail");this.context.orderdetailBox=$("#orderDetailBox");this.context.faclist=$("#faclist");this.context.faclistul=$("#faclist").children("li");this.context.wkzqrcode=$("#wkzqrcode");this.context.plateformBox=$("#plateformBox");this.context.getmoreliked=$("#likeuser");this.context.autoconfirm=$("#autoconfirm");this.context.descriptionpop=$('#descriptionPop');this.context.successpop=$('#successPop');this.context.appliedpop=$('#AppliedPop');this.context.showinnlist=$('#showinnlist');this.context.cancelrulesdays=$("#cancelrulesdays");this.context.percents=$("#percents");this.context.cancletip=$("#cancletip");this.context.adddiscount=$("#adddiscount");this.context.loading32=$("#loading32");this.context.hoteldiscountbtn=$("#hoteldiscountbtn");this.context.divminnight=$("#divminnight");this.context.setfeature=$("#setfeature");this.context.wkzqrcodeform=$("#wkzqrcodeform");this.context.video=$("#video");this.context.uploadvideo=$("#uploadvideo");this.context.videostatus=$("#videostatus");this.context.setfeature.find('a[tag=wkzthemetip]').attr("title",'').tooltip({position:{my:"left+15 top+20",at:"left bottom"},track:1,content:theme_tip,show:{duration:100}});},initEvent:function(){this.context.maincontent.bind("click",this.body_click.toEventHandler(this));this.context.innlist.bind("change",this.innlist_change.toEventHandler(this));this.context.addinntag.bind("click",this.addinntag_click.toEventHandler(this));this.context.editinfo.bind("click",this.editinfo.toEventHandler(this));this.context.taglist.bind("click",this.taglist_click.toEventHandler(this));this.context.applyopen_btn.bind("click",this.applyopen_btn_click.toEventHandler(this));this.context.editpaycard.bind("click",this.editpaycard_click.toEventHandler(this));this.context.settablist.bind("click",this.settablist_click.toEventHandler(this));this.context.search_btn.bind("click",this.search_btn_click.toEventHandler(this));this.context.picSetting.bind("click",this.uploadpicform_click.toEventHandler(this));this.context.singleToggle.find("div[class='switch has-switch']").bind('click',this.wkzstatus_toggle.toEventHandler(this));this.context.save_wkzroomresize.bind('click',this.save_wkzroomresize_click.toEventHandler(this));this.context.mobilelist.bind('click',this.mobilelist_click.toEventHandler(this));this.context.accountmobilelist.bind('click',this.accountmobilelist_click.toEventHandler(this));this.context.paytypelist.bind('click',this.paytypelist_click.toEventHandler(this));this.context.savepaytype.bind('click',this.savepaytype.toEventHandler(this));this.context.orderdetail.live('click',this.orderdetail_click.toEventHandler(this));this.context.whzdataform.bind('click',this.whzdataform_click.toEventHandler(this));this.context.faclistul.bind('click',this.faclist.toEventHandler(this));this.context.plateformBox.bind('click',this.plateformBox_click.toEventHandler(this));this.context.getmoreliked.on('click',"#morelike",this._getmodellikedata.toEventHandler(this));this.context.autoconfirm.find("div[tag=switch]").bind('click',this.autoconfirm_click.toEventHandler(this));this.context.autoconfirm.find("div[tag=switchonlineservice]").bind('click',this.onlineservice_click.toEventHandler(this));this.context.descriptionpop.bind('click',this.descriptionpop_click.toEventHandler(this));this.context.showinnlist.bind('click',this.showinnlist_click.toEventHandler(this));this.context.setfeature.bind('click',this.setfeature_click.toEventHandler(this));this.context.setfeature.find("ul[tag=musiclist]").find("a").bind('hover',this.music_hover.toEventHandler(this));this.context.wkzqrcodeform.bind('mouseenter',this.wkzqrcodeform_mouseenter.toEventHandler(this));this.context.wkzqrcodeform.bind('mouseleave',this.wkzqrcodeform_mouseleave.toEventHandler(this));this.context.uploadvideo.bind('click',this.uploadvideo_click.toEventHandler(this));var themelist=this.themelist;this.context.setfeature.find("ul[tag=themelist]").children("li").each(function(){var tag=$(this).attr('tag');var imagename=themelist[tag];var msg='<img src="/pic/'+imagename+'" />';$(this).children('a').attr("title",'').tooltip({position:{my:"left+15 top+20",at:"left bottom"},track:1,content:msg,show:{duration:100}});});},uploadvideo_click:function(){this.context.video.click();},wkzqrcodeform_mouseleave:function(){var target=this.context.wkzqrcodeform;this.timer=setTimeout(function(){target.removeClass('wkzcode_on');},5000);},wkzqrcodeform_mouseenter:function(){if(typeof(this.timer)=='number'){clearTimeout(this.timer);}
this.context.wkzqrcodeform.addClass('wkzcode_on');},music_hover:function(e){var ele=M.EventEle(e);ele.parents("li").find('i').attr('pstatus',0).toggle();},body_click:function(e){var ele=M.EventEle(e);var t=ele.attr("tag");if((M.isEmpty(t)||t!='dropdownlist')){var tpl=ele.parents("div[t=minnightdata]");if(tpl.length==0&&t!='minnightdata'){this.context.divminnight.children("div[t=minnightdata]").children("div").hide();}}},setfeature_click:function(e){var ele=M.EventEle(e);var t=ele.attr("tag");switch(t){case'switch':this.switchimagepage();break;case'blue':case'elegantblack':case'freshgreen':case'lnkstyle':case'luxuriousred':this.settheme(t);break;case'uploadimagepage':var upstatus=ele.attr('upstatus');if(M.isEmpty(upstatus)||upstatus==0){this.context.setfeature.find('input[t=imagepage]').click();this.target_tpl=ele;}
break;case'setmusic':this.setbackgroundmusic(ele);break;case'setordreremind':this.setordreremind(ele);break;case'play':this.playmusic(ele);break;}},playmusic:function(ele){var classstr=ele.attr('class');if(classstr.indexOf('pause')==-1){var target=this.context.setfeature.find('i[tag=play].pause');if(target.length>0){target.removeClass('pause').siblings('.music').removeClass('rotate').children("audio").get(0).pause();}
ele.addClass("pause");ele.siblings('.music').children("audio").get(0).play();ele.siblings('.music').addClass('rotate');}else{ele.removeClass("pause");ele.siblings('.music').children("audio").get(0).pause();ele.siblings('.music').removeClass('rotate');}},setordreremind:function(){var target=this.context.setfeature.find('div[tag=orderremind]');var currentstatus=target.attr('class');var orderremind=0;if(currentstatus.indexOf('switch-on')==-1){orderremind=1;}
M._getjson('/Microinn/setfeature',{'type':'orderremind','orderremind':orderremind},this.orderremind_finished.toEventHandler(this),'',true);},orderremind_finished:function(d){if(d.status=="success"){var target=this.context.setfeature.find('div[tag=orderremind]');var currentstatus=target.attr('class');if(currentstatus.indexOf('switch-on')==-1){target.removeClass('switch-off').addClass('switch-on');}else{target.addClass('switch-off').removeClass('switch-on');}
this.clearwkzcache();}else{alert(d.msg);}},setbackgroundmusic:function(ele){var checkedstatus=ele.attr("checked");var backgroundmusic=0;if(checkedstatus=="checked"){backgroundmusic=ele.val();}
M._getjson('/Microinn/setfeature',{'type':'backgroundmusic','backgroundmusic':backgroundmusic},this.backgroundmusic_finished.toEventHandler(this),'',true);},backgroundmusic_finished:function(d){if(d.status=="success"){var value=d.req.backgroundmusic;if(value!=0){this.context.setfeature.find("ul[tag=musiclist]").find("input[tag=setmusic]").attr("checked",false);this.context.setfeature.find("ul[tag=musiclist]").find("input[tag=setmusic][value="+value+"]").attr("checked",'checked');}}else{alert(d.msg);}},settheme:function(t){M._getjson('/Microinn/setfeature',{'type':'theme','theme':t},this.setfeature_finished.toEventHandler(this),'',true);},setfeature_finished:function(d){if(d.status=="success"){var type=d.type;if(type=='theme'){var t=d.req.theme;this.context.setfeature.find('ul[tag=themelist]').children('li').removeClass('th-item-selected');this.context.setfeature.find('ul[tag=themelist]').children('li[tag='+t+']').addClass('th-item-selected');var theme=this.context.setfeature.find('li.th-item-selected').find('div.desc').html();M.confirmmessage('您已经选择“'+theme+'”主题，在手机上访问您的微官网看看吧！');}else{var target=this.context.setfeature.find('div[tag=imagepagestatus]');var currentstatus=target.attr('class');var status=1;if(currentstatus.indexOf('switch-on')==-1){target.removeClass('switch-off').addClass('switch-on');this.context.setfeature.find('dl[tag=image]').show();}else{target.addClass('switch-off').removeClass('switch-on');this.context.setfeature.find('dl[tag=image]').hide();status=0;}}
this.clearwkzcache();}else{if(!M.isEmpty(d.msg)){alert(d.msg);}}},clearwkzcache:function(){var innid=this.context.innlist.val();M._getjson('/Microinn/clearwkzcache',{'type':'hotel','innid':innid},this.clearwkzcache_finished.toEventHandler(this));},clearwkzcache_finished:function(){},switchimagepage:function(){var target=this.context.setfeature.find('div[tag=imagepagestatus]');var currentstatus=target.attr('class');var status=0;if(currentstatus.indexOf('switch-on')==-1){status=1;}
M._getjson('/Microinn/setfeature',{'type':'imagepagestatus','imagepagestatus':status},this.setfeature_finished.toEventHandler(this));},showinnlist_click:function(e){var ele=M.EventEle(e);var t=ele.attr("tag");if(t=='save'){this.showinn_save();}},showinn_save:function(){var len=this.context.showinnlist.find('li[tag=inn]').length;var innid=this.context.innlist.val();var innidstr='';for(var i=0;i<len;i++){var this_li=this.context.showinnlist.find('li[tag=inn]').eq(i);var this_innid=this_li.find('input').val();if(this_li.find('input').attr('checked')=='checked'&&this_innid!=innid){innidstr+=this_innid+',';}}
M._getjson('/Microinn/setshowinn',{'innidstr':innidstr,'innid':innid},this.showinn_callback.toEventHandler(this));},showinn_callback:function(d){if(d.status=='success'){alert(d.data);}else{alert(d.msg);}},autoconfirm_click:function(e){var ele=M.EventEle(e);var obj=ele.parent("div");if(obj.attr("status")==1){obj.attr("status",0).removeClass("switch-on").addClass("switch-off");}else{obj.attr("status",1).removeClass("switch-off").addClass("switch-on");}
var status=obj.attr("status");M._getjson("/Microinn/setautoconfirm",{"status":status},this.autoconfirm_finished.toEventHandler(this));},onlineservice_click:function(e){var ele=M.EventEle(e);var obj=ele.parent("div");if(obj.attr("status")==1){obj.attr("status",0).removeClass("switch-on").addClass("switch-off");}else{obj.attr("status",1).removeClass("switch-off").addClass("switch-on");}
var status=obj.attr("status");M._getjson("/Microinn/onlineservice",{"status":status},this.onlineservice_finished.toEventHandler(this));},autoconfirm_finished:function(d){if(d.status=="success"){var status=d.req.status;if(status==1){this.context.autoconfirm.children("p[tag=openmsg]").show();this.context.autoconfirm.children("p[tag=closemsg]").hide();}else{this.context.autoconfirm.children("p[tag=openmsg]").hide();this.context.autoconfirm.children("p[tag=closemsg]").show();}
this.clearwkzcache();}
alert(d.msg);},onlineservice_finished:function(d){if(d.status=="success"){var status=d.req.status;if(status==1){this.context.autoconfirm.children("p[tag=appletopenmsg]").show();this.context.autoconfirm.children("p[tag=appletclosemsg]").hide();}else{this.context.autoconfirm.children("p[tag=appletopenmsg]").hide();this.context.autoconfirm.children("p[tag=appletclosemsg]").show();}
this.clearwkzcache();}
alert(d.msg);},plateformBox_click:function(e){var ele=M.EventEle(e);var tag=ele.attr("tag");if(tag=="agreeplaterule"){var agree=this.context.plateformBox.find("input[tag=agreeplaterule]").is(":checked");if(agree==true){this.context.plateformBox.find("a[tag=jionplateform]").removeClass("btn btn-cancel").addClass("btn btn-primary").attr("flag","1");}else{this.context.plateformBox.find("a[tag=jionplateform]").removeClass("btn btn-primary").addClass("btn btn-cancel").attr("flag","");}}
if(tag=="jionplateform"){var agree=this.context.plateformBox.find("input[tag=agreeplaterule]").is(":checked");var flag=this.context.plateformBox.find("a[tag=jionplateform]").attr("flag");var innid=this.context.innlist.val();if(agree==true&&flag==1){M._getjson("/Microinn/jionPlateForm",{"innid":innid},this.jionplateform_finished.toEventHandler(this));}}},jionplateform_finished:function(d){if(d.status=="success"){this.context.applyopen_btn.find("a[tag=joinus]").hide();this.context.applyopen_btn.find("span[tag=miotstatus]").show();}else{M.confirmmessage(d.msg);}
this._closepopup();},faclist:function(e){var ele=M.EventEle(e);if(ele.is("li")){ele.toggleClass('has');}else{ele.parent("li").toggleClass('has');}},whzdataform_click:function(e){var ele=M.EventEle(e);var tag=ele.attr("tag");if(tag=='add'){var hasphone2=this.context.whzdataform.children("dl[tag=phone][dis=none]").css("display");if(hasphone2=='block'){var size=this.context.whzdataform.children("dl[tag=phone]").size();}else{var size=this.context.whzdataform.children("dl[tag=phone][dis=dis]").size();}
if(size>=2){alert("最多只能添加2个手机号");return;}
var phonetpl=this.context.whzdataform.children("dl[tag=phone][dis=dis]").clone(true);phonetpl.attr("i",1);phonetpl.find("input").val("");this.context.whzdataform.children("dl[tag=receptephone]").before(phonetpl);this.phonetpl_change();}
if(tag=='del'){ele.parent("dd").parent("dl").remove();this.phonetpl_change();}
if(tag=='addIntroText'){this.context.whzdataform.children("dl[tag=textmodule]").hide();this.context.whzdataform.children("dl[tag=customText]").show();}else if(tag=='delminusText'){this.context.whzdataform.children("dl[tag=textmodule]").show();this.context.whzdataform.children("dl[tag=customText]").hide();this.context.whzdataform.children("dl[tag=customText]").find('textarea').val('');this.context.whzdataform.children("dl[tag=customText]").find('input').val('');}},phonetpl_change:function()
{var phonetpl=this.context.whzdataform.children("dl[tag=phone][dis=dis]");if(phonetpl.length>1)
{this.context.whzdataform.children("dl[tag=phone][dis=dis]").find("a[tag=add]").remove();this.context.whzdataform.children("dl[tag=phone][dis=dis]").find("a[tag=del]").remove();this.context.whzdataform.children("dl[tag=phone][dis=dis]").find("input[name=phone]").after("<a href='javascript:;' tag='del' class='del' title='删除'></a>");this.context.whzdataform.children("dl[tag=phone][dis=dis]:last").children("dt").text("");this.context.whzdataform.children("dl[tag=phone][dis=dis]:last").children("dd").append('<a title="添加" class="add" tag="add" href="javascript:;"></a>');}
else
{this.context.whzdataform.children("dl[tag=phone][dis=dis]").find("a[tag=add]").remove();this.context.whzdataform.children("dl[tag=phone][dis=dis]").find("a[tag=del]").remove();this.context.whzdataform.children("dl[tag=phone][dis=dis]").children("dt").html('<span class="red mr5">*</span>联系电话');this.context.whzdataform.children("dl[tag=phone][dis=dis]:last").attr("i",0);this.context.whzdataform.children("dl[tag=phone][dis=dis]:last").find("input[name=phone]").after('<a title="添加" class="add" tag="add" href="javascript:;"></a>');}},orderdetail_click:function(e){var ele=M.EventEle(e);var paytype=ele.attr("gateway");var tag=ele.attr("tag");var billid=ele.attr("billid");var data={"a":"getbilldetail","billid":billid,"paytype":paytype,"tag":tag};M._getjson("/Microinn/getBillDetail",data,this.orderdetail_finished.toEventHandler(this));M.Popup(this.context.orderdetailBox,{"hideclass":"modal viewguest fade","showclass":"modal viewguest fade in"},function(){}.toEventHandler(this));},orderdetail_finished:function(d){var data=eval(d);var tr="<tr><th width='80'>预订时间</th><th>预订信息</th><th width='200'>客人信息</th><th width='180'>入住信息</th><th width='60'>金额</th><th width='80'>订单来源</th></tr>";for(var i=0;i<data.length;i++){tr+="<tr><td>"+data[i].addtime+"</td><td>"+data[i].roomname+"</td><td>"+data[i].guestinfo+"</td><td>"+data[i].arriveinfo+"</td><td>"+data[i].totalprice+"</td><td>"+data[i].orderfrom+"</td></tr>";}
this.context.orderdetailBox.children("div[class=modal-body]").find("tbody").contents().remove();;this.context.orderdetailBox.children("div[class=modal-body]").find("tbody").html(tr);},innlist_change:function(){this._getmodeldata();},initfileupload:function(){var tpl=this.context.maincontent.children().find("input[type=file][tag=file]");var innid=this.context.innlist.val();tpl.each(function(){var type=$(this).attr("t");var url='/Microinn/uploadImg?type='+type;$(this).fileupload({url:url,dataType:'json',autoUpload:true,maxFileSize:1000000000,previewMaxWidth:100,previewMaxHeight:100,limitMultiFileUploadSize:5,previewCrop:true,beforeSend:function(e,data){var size=data.files[0].size;var limit=5*1024*1024;if(limit<size){M.error('您上传的图片太大了，请将图片压缩至5MB以下');return false;}
var limittype=new Array('JPG','JPEG','PNG','GIF','BMP','jpg','jpeg','png','gif','bmp');var type=data.files[0].type;var has=0;for(var i=0;i<limittype.length;i++){var item=limittype[i];if(type.indexOf(item)!=-1){has=1;}}
if(has==0){M.error('暂不支持这种格式的图片，请上传JPG/JPEG/PNG/GIF/BMP等格式');return false;}},done:function(e,data){var d=data.result;if(d.status=="success"){page._finishedupload(d);}else{M.error(d.msg);page._handleerror(d);}},fail:function(jqXHR,textStatus,errorThrown,options){},progressall:function(e,data){var progress=parseInt(data.loaded/data.total*100,10);page._processhandle(progress);}});});$("#video").fileupload({url:'/Microinn/uploadvideo',dataType:'json',autoUpload:true,maxFileSize:1000000000,limitMultiFileUploadSize:5,beforeSend:function(e,data){var size=data.files[0].size;$("body").find('div[tag=innvideo]').find('p[tag=videoname]').html(data.files[0].name);},done:function(e,data){var ele=M.EventEle(e);var target=ele.parents('div[tag=innvideo]');var d=data.result;if(d.status=="success"){target.find('p[tag=videostatus]').html('视频已上传，优酷正在审核中，请稍候').show();target.find('tr[tag=vidoinfo]').hide();}else{M.error(d.msg);target.find('div[tag=progress]').css('width','0%').html('0 %');target.find('p[tag=videosize]').html('0 MB / 0 MB').parent().hide();}},fail:function(jqXHR,textStatus,errorThrown,options){},progressall:function(e,data){var progress=parseInt(data.loaded/data.total*100,10);var videosize=parseInt(data.total/(1024*1024)*100)/100;var laodsize=parseInt(data.loaded/(1024*1024)*100)/100;var ele=M.EventEle(e);var target=ele.parents('div[tag=innvideo]');target.find('tr[tag=vidoinfo]').show();target.find('div[tag=progress]').css('width',progress+'%').html(progress+' %');target.find('p[tag=videosize]').html(laodsize+' MB / '+videosize+' MB').parent().show();}});},_handleerror:function(d){var target=this.target_tpl;var t=target.attr("tag");if(t=="roomtype"||t=="pop_roomtype"||t=="goodimg"){if(t=="pop_roomtype"||t=="goodimg"){target.children("li[tag=add]").show().children("input[tag=file]").val('');target.children("li[tag=loading]").hide().children("div").children("span").text("上传中...0%");}
if(t=="roomtype"){this.roomtypetarget.children("div[tag=img]").show();this.roomtypetarget.children("div[tag=loading]").hide();this.roomtypetarget.children("div[tag=loading]").children("span").text("上传中...0%");target.children("li[tag=add]").show().children("input[tag=file]").val('');target.children("li[tag=loading]").hide().children("div").children("span").text("上传中...0%");}}else if(t=='imglist'||t=='shopkeepersay'||t=='innavatar'){target.find('li[tag=loading]').hide();}else if(t=='uploadimagepage'){target.html(target.attr('title')).attr('upstatus',0);}},_finishedupload:function(d){var target=this.target_tpl;var t=target.attr("tag");if(t=="roomtype"||t=="pop_roomtype"||t=="goodimg"){this.roomtype_upload_finished(d);if(t=="pop_roomtype"||t=="goodimg"){target.children("li[tag=add]").show().children("input[tag=file]").val('');target.children("li[tag=loading]").hide().children("div").children("span").text("上传中...0%");}
if(t=="roomtype"){this.roomtypetarget.children("div[tag=img]").show();this.roomtypetarget.children("div[tag=loading]").hide();this.roomtypetarget.children("div[tag=loading]").children("span").text("上传中...0%");target.children("li[tag=add]").show().children("input[tag=file]").val('');target.children("li[tag=loading]").hide().children("div").children("span").text("上传中...0%");}}else if(t=='uploadimagepage'){target.html(target.attr('title')).attr('upstatus',0);var tpl=this.context.setfeature.find('dl[tag=image]').show();tpl.find("div[tag=firstupload]").hide();tpl.find("div[tag=hasupload]").show().find('img').attr('src',d.path);M.confirmmessage('形象页设定成功，在手机上刷新微官网看看效果吧！');this.clearwkzcache();}else{page.upload_finished(d);}},roomtype_upload_finished:function(d){var target=this.target_tpl;var t=target.attr("tag");if(t=="roomtype"||t=="pop_roomtype"||t=="goodimg"){var photo=this.context.wkzroomresize.find("div[name='wkzcanvas']").children().find("img[name=photo]");photo.imgAreaSelect({remove:true});}else{var photo=target.children().find("img[name=photo]");photo.imgAreaSelect({remove:true});}
this.context.wkzroomresize.find("img[name='photo']").attr('src','');this.context.wkzroomresize.find("img[name='preview']").attr('src','');this.context.wkzroomresize.children("div[tag=save_btn]").show();var pic_path=d.path;this.context.wkzroomresize.find("h4[name='progress_title']").show().text('请按比例裁剪图片');this.context.wkzroomresize.find("div[name='progress']").hide();this.context.wkzroomresize.find("div[class='before']").show();this.context.wkzroomresize.find("div[class='after']").show();this.context.wkzroomresize.find("div[class='modal-footer']").show();this.context.save_wkzroomresize.attr('pic_path',pic_path);this.context.wkzroomresize.find("img[name='photo']").attr('src',pic_path).hide();this.context.wkzroomresize.find("img[name='preview']").attr('src',pic_path).hide();var target=this.context.wkzroomresize.find("div[name='wkzcanvas']");if(t=="pop_roomtype"||t=="roomtype"){this.context.wkzroomresize.css("z-index","9999");this.context.wkzroomresize.attr("type","roomtype");}
if(t=="goodimg"){this.context.wkzroomresize.attr("type","goodimg");}
this.context.wkzroomresize.attr("sendstatus",0);this.context.wkzroomresize.find("div[tag=save_btn]").children("a").addClass("btn-cancel").removeClass("btn-primary");M.Popup(this.context.wkzroomresize,{"hideclass":"modal wkzroomresize fade","showclass":"modal wkzroomresize fade in"});setTimeout(this.cutImage2.toEventHandler(this),100);},_processhandle:function(process){var target=this.target_tpl;var t=target.attr("tag");if(t=="pop_roomtype"||t=="goodimg"){target.children("li[tag=add]").hide();var tpl=target.children("li[tag=loading]").show();tpl.children("div").children("span").html('上传中...'+process+'%');}
else if(t=="roomtype"){var target=this.roomtypetarget;target.children("div[tag=img]").hide();var tpl=target.children("div[tag=loading]").show();tpl.children("span").html('上传中...'+process+'%');}else if(t=="uploadimagepage"){var target=this.target_tpl;target.html('上传中...'+process+'%');}else{if(this.operate=='modify'){var tpl_li=target.find('li').children('a[imgid='+this.imgid+']').parent();tpl_li.children('img').hide();tpl_li.children('div[tag=operate]').hide();tpl_li.children('div[tag=desc]').hide();tpl_li.children('div[tag=description]').hide();tpl_li.children('div[tag=loading]').find("span").html('上传中...'+process+'%');tpl_li.children('div[tag=loading]').show();if(process>=100){tpl_li.children('div[tag=loading]').hide();tpl_li.children('img').show();tpl_li.children('div[tag=operate]').show();tpl_li.children('div[tag=desc]').show();}
if(process>=100&&t=='innimg'){tpl_li.children('div[tag=description]').show();}}else{target.find('li[tag=loading]').find("span").html('上传中...'+process+'%');target.find('li[tag=upload_li]').hide();target.find('li[tag=loading]').show();if(process>=100){target.find('li[tag=upload_li]').show();}}}},upload_finished:function(d){var target=this.target_tpl;var photo=target.children().find("img[name=photo]");photo.imgAreaSelect({remove:true});target.children().find("img[name=photo]").attr("src",'');target.children().find("div[tag=preview]").children("img").attr("src",'');target.children().find("li[tag=loading]").hide().children("span").html('0%');var uploadform=target.parent("form[name=upform]");var type=uploadform.attr('type');if(type=='roomtype'){target.children("div[tag=roomtype]").slideDown("fast");}
target.children("div[tag=show_img]").slideDown("fast");target.children("a[tag=save_img]").slideDown("fast");target.children("div[tag=div_save]").slideDown("fast");target.children("div[tag=inn_description]").slideDown("fast");target.children().find("img[name=photo]").attr("src",d.path);target.children().find("div[tag=preview]").children("img").attr("src",d.path);M.emptyVal(target.children().find("textarea[name='pic_content']"));this.context.picurl.val(d.path);this.cutImage(d.path);if(type=='shopkeepersay'){if(this.imgid>0){var title=target.find('li[imgid='+this.imgid+']').find('div[tag=desc]').attr('title');target.find('div[tag=div_save]').find('textarea').val(title);}else{target.find('div[tag=div_save]').find('textarea').val('');}}},settablist_click:function(e){var ele=M.EventEle(e);var t=ele.attr("tag");if(M.isEmpty(t)){return false;}
this.context.inndetail.hide();this.context.picSetting.hide();this.context.saleSetting.hide();this.context.roomSetting.hide();this.context.setfeature.hide();this.context.settablist.children("li").removeClass("on");ele.parent("li").addClass("on");if(t=='setBasic'){this.context.inndetail.show();}else if(t=='setPic'){this.context.picSetting.show();}else if(t=='setSale'){this.context.saleSetting.show();}else if(t=='setRoom'){this.context.roomSetting.show();}else if(t=='setFeature'){this.context.setfeature.find("div[tag=loading]").show();this.context.setfeature.find("div[tag=content]").hide();this.context.setfeature.show();}
this._getmodeldata();},_getmodeldata:function(){this.context.saleSetting.children("div[tag=likeform]").find("tr[tag=likeuser]").children("td").children("ul").hide();this.context.saleSetting.children("div[tag=likeform]").find("tr[tag=likeuser]").children("td").html('<ul class="userlist clx"></ul>');var likegroupnum=this.context.saleSetting.children("div[tag=likeform]").find("tr[tag=likeuser]").attr("likegroupnum",40);var type=this.context.settablist.children("li[class=on]").children("a").attr("tag");var innid=this.context.innlist.val();this.innid=innid;var fromdate=this.context.fromdate.val();var enddate=this.context.enddate.val();if(type=='settablist'){this._resetloadstatus("load");}
this.context.roomtype_load.show();this.context.pic_load.show();M._getjson("/Microinn/getWkzInfo",{"innid":innid,"type":type,"fromdate":fromdate,"enddate":enddate},this.getwkzinfo_finished.toEventHandler(this));},getwkzinfo_finished:function(d){if(d.status=='success'){this.wkzinfo=d.data;var type=d.type;this.context.wkzqrcodeform.show().hide();if(type=='setPic'){this.context.pic_load.hide();this._setPic(d.roomtypelist,d.imglist,d.video);this.initfileupload();}
if(type=='setFeature'){this.setfeature(d.setfeature);}
if(type=='setSale'){this._setSale(d.pv,d.order,d.like);}
this._setBasic(d.data);}else{if(d.status=='hasswitch'){M.confirmmessage(d.msg,this.reload.toEventHandler(this));}else if(d.msg){alert(d.msg);}else{alert('数据加载失败，刷新页面重新加载');}}},setfeature:function(featuredata){if(M.isEmpty(featuredata.theme)){featuredata.theme='blue';}
this.context.setfeature.find("div[tag=loading]").hide();this.context.setfeature.find("div[tag=content]").show();this.context.setfeature.find("ul[tag=themelist]").children("li.th-item-selected").removeClass('th-item-selected');this.context.setfeature.find("ul[tag=themelist]").children("li[tag="+featuredata.theme+"]").addClass('th-item-selected');if(featuredata.imagepagestatus==1){this.context.setfeature.find("div[tag=imagepagestatus]").addClass('switch-on').removeClass('switch-off');this.context.setfeature.find('dl[tag=image]').show();}else{this.context.setfeature.find("div[tag=imagepagestatus]").removeClass('switch-on').addClass('switch-off');this.context.setfeature.find('dl[tag=image]').hide();}
if(!M.isEmpty(featuredata.image.thumb)){this.context.setfeature.find("img[tag=image]").attr('src',featuredata.image.thumb);this.context.setfeature.find("div[tag=firstupload]").hide();this.context.setfeature.find("div[tag=hasupload]").show();}else{this.context.setfeature.find("div[tag=imagepagestatus]").removeClass('switch-on').addClass('switch-off');this.context.setfeature.find('dl[tag=image]').hide();this.context.setfeature.find("div[tag=firstupload]").show();this.context.setfeature.find("div[tag=hasupload]").hide();}
if(featuredata.orderremind==1){this.context.setfeature.find('div[tag=orderremind]').removeClass('switch-off').addClass('switch-on');}else{this.context.setfeature.find('div[tag=orderremind]').addClass('switch-off').removeClass('switch-on');}
if(this.wkzinfo.opentowkz==1){if(!M.isEmpty(this.wkzinfo.qrcode)){this.context.wkzqrcodeform.show().removeClass('wkzcode_on').find('img').attr("src",this.wkzinfo.qrcode);}}},reload:function(){location.reload();},wkzstatus_toggle:function(e){var switch_obj=this.context.singleToggle.find("div[name='switch']");var status=switch_obj.attr('status');var classname=switch_obj.attr('classname');if(status==1){switch_obj.attr("class","switch-animate switch-off").attr('status',0);}else{switch_obj.attr("class","switch-animate switch-on").attr('status',1);}
if(classname=='btn-primary'){switch_obj.attr('classname','btn-no');this.context.save_status.removeClass('btn-primary').addClass('btn-no');}else{switch_obj.attr('classname','btn-primary');this.context.save_status.removeClass('btn-no').addClass('btn-primary');}},save_wkzroomresize_click:function(e){var eventEle=M.EventEle(e);var style=eventEle.attr("class");if(style.indexOf('btn-cancel')!=-1){return;}
var roomtypeid=eventEle.attr('roomtypeid');var goodid=eventEle.attr('goodid');var innid=this.context.innlist.val();var type=this.context.wkzroomresize.attr("type");var x1=this.context.upform.children("input[id='x1']").val();var y1=this.context.upform.children("input[id='y1']").val();var x2=this.context.upform.children("input[id='x2']").val();var y2=this.context.upform.children("input[id='y2']").val();var w=this.context.upform.children("input[id='w']").val();var h=this.context.upform.children("input[id='h']").val();var picurl=eventEle.attr('pic_path');var description='';var sendstatus=this.context.wkzroomresize.attr("sendstatus");this.context.wkzroomresize.attr("sendstatus","1");if(sendstatus==1){return;}
var data={"type":type,"innid":innid,"picurl":picurl,"roomtypeid":roomtypeid,"goodid":goodid,"description":description,"x1":x1,"x2":x2,"y1":y1,"y2":y2,"w":w,"h":h};M._getjson("/Microinn/saveImage",data,this.save_wkzroomresize_click_finished.toEventHandler(this));$("#save_wkzroomresize").attr("id","saveload");},save_wkzroomresize_click_finished:function(d){if(d.status=='success'){var target=d.img.target;var innid=d.img.innid;M._getjson("/Microinn/flushInnClear",{"innid":innid});}else{alert('网络错误，请重新上传');}},_setPic:function(roomtpelist,imglist,video){if(!M.isEmpty(roomtpelist)&&roomtpelist.length>0){var tpl=this.roomtype;var tpllist=$.tmpl(tpl,roomtpelist);this.context.description.val(roomtpelist[0].roomtypename);}
var avatar_tpl=this.context.picSetting.children().children("div[tag=innavatar]");this._showimg(avatar_tpl,imglist.innavatar,"innavatar");var inn_tpl=this.context.picSetting.children().children("div[tag=innimg]");this._showimg(inn_tpl,imglist.inn,"innimg");var shopkeepersay_tpl=this.context.picSetting.children().children("div[tag=shopkeepersay]");this._showimg(shopkeepersay_tpl,imglist.shopkeepersay,"shopkeepersay");if(M.isEmpty(video.status)||M.isEmpty(video.checkstatus)){this.context.videostatus.hide();}else{if(video.status==1&&video.checkstatus==1){this.context.videostatus.html('视频已通过，请访问您的微官网或<a href="http://v.youku.com/v_show/id_'+video.url+'.html" target="_blank">点此查看</a>').show();}else if(video.status==1&&video.checkstatus==0){this.context.videostatus.text('视频已上传，优酷正在转码中，请稍候').show();}else if(video.status==1&&video.checkstatus==2){this.context.videostatus.text('视频转码失败，请重新上传').show();}else if(video.status==1&&video.checkstatus==3){this.context.videostatus.text('视频已上传，优酷正在审核中，请稍候').show();}else if(video.status==1&&video.checkstatus==4){this.context.videostatus.html('视频已被优酷屏蔽，屏蔽原因：'+video.errormsg+'<br/>'+'请更换视频重新上传。').show();}else if(video.status==1&&video.checkstatus==5){this.context.videostatus.text('视频上传失败，请重新上传').show();}else{this.context.videostatus.text('视频上传失败，请重新上传').show();}}
this.innphotosort();},_showimg:function(dom,imglist,type){var target=dom.children("div[tag=imglist]").children("ul");target.html('');if(type=='innimg'){type='inn';}
if(M.isEmpty(imglist)){target.append(this.upload_btn_tpl);target.find('a[tag=upload_btn]').attr('type',type);dom.children().find("a[tag=show_pics]").hide();return;}
var imgtpl='';if(type=="shopkeepersay"){imgtpl=$.tmpl(this.img_tpl_shopkeepersay,imglist);imgtpl.children("div[tag=desc]").show();target.html(imgtpl);target.children('li[head=1]').find('a[tag=setupboss]').hide();target.children('li[head=0]').find('a[tag=setupboss]').show();target.children('li[head=1]').find('span[tag=bosshead]').show();target.children('li[head=0]').find('span[tag=bosshead]').hide();target.children('li[head=1]').find('a[tag=editbosssay]').html('修改掌柜说');target.append(this.upload_btn_tpl);}else if(type=='innavatar'){var len=imglist.length;var imgs=imglist[len-1];imgtpl=$.tmpl(this.img_tpl,imgs);target.html(imgtpl);target.find('li[tag=upload_li]').hide();}else{imgtpl=$.tmpl(this.img_tpl,imglist);target.html(imgtpl);if(type=='inn'){this.setlistindex(target.children('li[tag=img]'));target.find('div[tag=description]').show();}
target.append(this.upload_btn_tpl);}
target.find('a[tag=upload_btn]').attr('type',type);dom.children().find("a[tag=show_pics]").show();this._deletebtnshow(type,target);},_deletebtnshow:function(type,target){var applystatus=this.wkzinfo.applystatus;if(M.isEmpty(applystatus)||applystatus==0){return 0;}
var length=target.find('li[tag=img]').length;if(type=='inn'||type=='innimg'){if(length>2){target.find('a[tag=delete]').addClass('delete');}else{target.find('a[tag=delete]').removeClass('delete');}}else{if(length>1){target.find('a[tag=delete]').addClass('delete');}else{target.find('a[tag=delete]').removeClass('delete');}}},innphotosort:function(){this.context.picSetting.find('div[tag=innimg]').children('div[tag=imglist]').children("ul").sortable({placeholder:"placeHolder",items:"li:not(.ui-state-disabled)",stop:this.saveinnphotosort.toEventHandler(this)});},checkchangestatus:function(list){var status=0;var index=1;list.each(function(){if($(this).attr("index")!=index){status=1;}
index++;});return status;},setlistindex:function(list){var index=1;list.each(function(){$(this).attr("index",index);index++;});},saveinnphotosort:function(e){var target_ul=M.EventEle(e);var list=target_ul.children("li[tag=img]");var changestatus=this.checkchangestatus(list);if(changestatus==0){return;}
this.setlistindex(list);var sortlist=[];list.each(function(){var wid=$(this).attr("imgid");sortlist.push(wid);});var data={'type':'innimg','sortstr':sortlist.toString()};M._getjson('/Microinn/sortinnimg',data,this.sort_callback.toEventHandler(this));},sort_callback:function(d){if(d.status=="success"){M.success('保存成功');}else{M.error(d.msg);}},_setSale:function(pvlist,orderlist,likelist){this._resetloadstatus("finished");this._resetpvform();if(!M.isEmpty(pvlist)){this._dealpvdata(pvlist);}
if(!M.isEmpty(likelist)){this._deallikedata(likelist);}
this._resetorderform();if(!M.isEmpty(orderlist)){this._dealorderdata(orderlist);}else{this.context.saleSetting.children("div[tag=orderform]").children("div[tag=noorder]").show();this.context.saleSetting.children("div[tag=orderform]").children("table").hide();}},_setBasic:function(data){this._clearmicroform();this.context.inndetail.children().find("span[tag=innname]").text(M.htmlspecialchars_decode(data.innname));if(!M.isEmpty(data)){this.context.inndetail.children().find("input[name=address]").val(M.htmlspecialchars_decode(data.address));this.context.whzdataform.children("dl[tag=phone][i=0]").find("input[name=phone]").val(data.phone1);this.context.whzdataform.children("dl[tag=phone][i=1]").find("input[name=phone]").val(data.phone2);this.context.whzdataform.children("dl[tag=receptephone]").find("input[name=receptephone]").val(data.receptephone);this.context.inndetail.children().find("input[name=weixin]").val(data.weixin);this.context.inndetail.children().find("input[name=wifipassword]").val(data.wifipassword);this.context.inndetail.children().find("textarea[name=description]").val(M.htmlspecialchars_decode(data.description));this.context.inndetail.children().find("textarea[name=shortdescription]").val(data.shortdescription);this.context.inndetail.children().find("textarea[name=shopkeepersay]").val(data.shopkeepersay);this.context.inndetail.children().find("textarea[name=feature]").val(data.feature);this.context.inndetail.children().find("input[name=contactor]").val(data.contactor);this.context.inndetail.children().find("textarea[name=traffic]").val(data.introcontent);this.context.inndetail.children().find("textarea[name=hotelfeature]").val(data.hotelfeature);this.context.paycardform.children().find("input[name=paycard]").val(data.paycard);this.context.paycardform.children().find("input[name=alipayname]").val(data.alipayname);this.context.paycardform.children().find("input[name=tenpay]").val(data.tenpay);this.context.paycardform.children().find("input[name=tenpayname]").val(data.tenpayname);var obj=this.context.faclistul;obj.each(function(){obj.removeClass("has");});var features=data.features;if(!M.isEmpty(features)){var strs=new Array();strs=features.split(",");for(i=0;i<strs.length;i++)
{this.context.faclist.children("li[name="+strs[i]+"]").attr("class","has");}}else{this.context.faclistul.attr("class","");}
if(!M.isEmpty(data.paycard)){this.context.paycardform.children().find("input[name=paycard]").attr("disabled",true);}else{this.context.paycardform.children().find("input[name=paycard]").attr("disabled",false);}
if(!M.isEmpty(data.alipayname)){this.context.paycardform.children().find("input[name=alipayname]").attr("disabled",true);}else{this.context.paycardform.children().find("input[name=alipayname]").attr("disabled",false);}
if(!M.isEmpty(data.tenpay)){this.context.paycardform.children().find("input[name=tenpay]").attr("disabled",true);}else{this.context.paycardform.children().find("input[name=tenpay]").attr("disabled",false);}
if(!M.isEmpty(data.tenpayname)){this.context.paycardform.children().find("input[name=tenpayname]").attr("disabled",true);}else{this.context.paycardform.children().find("input[name=tenpayname]").attr("disabled",false);}
if(!M.isEmpty(data.paycard)&&!M.isEmpty(data.alipayname)&&!M.isEmpty(data.tenpay)&&!M.isEmpty(data.tenpayname)){this.context.paycardform.find("dl[tag=save_btn]").hide();}else{this.context.paycardform.find("dl[tag=save_btn]").show();}
var innid=this.context.innlist.val();this.context.applyopen_btn.find('dd[tag=remindinfo]').hide();this.context.inndetail.find('div[tag=branch]').hide();if(M.isEmpty(data.status)&&data.status!=0){this.context.inndetail.children().find("dd[tag=refuseinfo]").hide();this.context.mobilelistform.hide();this.context.wkzqrcode.hide();this.context.autoconfirm.hide();this.openstatus=data.status;this.context.applyopen_btn.find('dd[tag=remindinfo]').show();}else if(data.status==0){this.context.inndetail.children().find("dd[tag=refuseinfo]").show();this.context.mobilelistform.hide();this.context.wkzqrcode.hide();this.context.autoconfirm.hide();this.openstatus=data.status;}else if(!M.isEmpty(data.id)){this.openstatus=data.status;this.context.inndetail.attr("aid",data.id);this.context.inndetail.children().find("input[name=address]").val(data.address);this.context.inndetail.children().find("input[name=phone]").val(data.phone);this.context.inndetail.children().find("input[name=wifipassword]").val(data.wifipassword);this.context.inndetail.children().find("input[name=weixin]").val(data.weixin);this.context.whzdataform.children("dl[tag=phone][i=0]").find("input[name=phone]").val(data.phone1);if(!M.isEmpty(data.phone2)){this.context.whzdataform.children("dl[tag=phone][i=1]").show();this.context.whzdataform.children("dl[tag=phone][i=0]").find("a").removeClass("add").addClass("del").attr("tag","del").attr("title","删除");this.context.whzdataform.children("dl[tag=phone][i=1]").find("input[name=phone]").val(data.phone2);}else{this.context.whzdataform.children("dl[tag=phone][i=0]").find("a").removeClass("del").addClass("add").attr("tag","add").attr("title","添加");this.context.whzdataform.children("dl[tag=phone][i=1]").hide();}
if(data.status==1||data.status==3){this.context.wkzqrcode.show();this.context.mobilelistform.show();this.context.whzdataform.slideDown("normal");var tpl=$.tmpl(this.opensuccess_tpl,{"innid":innid});this.context.inndetail.children().find("dd[tag=innapply_btn]").html('<a href="javascript:;" class="btn" style="width:120px;">已开通</a>');this.context.wkzqrcode.find("div[tag=opensuccess]").remove();this.context.wkzqrcode.find("div[tag=downloadbox]").after(tpl);if(!M.isEmpty(data.qrcode)){this.context.inndetail.children().find("div[tag=qrcode]").children("img").attr("src",data.qrcode).show();}else{this.context.inndetail.children().find("div[tag=qrcode]").children("img").attr("src",data.qrcode).hide();}
this.context.wkzqrcode.find("div[tag=qrcode]").show();var bookmobilelist=data.bookmobile;if(!M.isEmpty(bookmobilelist)){this.context.mobilelist.children("li[class=addnew]").html('<input type="text" id="mobilenum" class="tname" placeholder="+新增手机" setplaceholder="" value=""><input type="button" tag="add" value="+" flag="book" class="btn btn-success tbtn">');for(var j=0;j<bookmobilelist.length;j++){var mobilelistval=bookmobilelist[j];tpl=$.tmpl(this.mobile_tpl,{"mid":mobilelistval.id,"mobile":mobilelistval.mobile});this.context.mobilelist.children("li[class=addnew]").before(tpl);}
if(bookmobilelist.length==3){this.context.mobilelist.children("li[class=addnew]").hide();}else{this.context.mobilelist.children("li[class=addnew]").show();}}else{M.emptyVal(this.context.mobilenum);this.context.mobilelist.children("li[class=addnew]").children("input[tag=add]").attr("value","+");this.context.mobilelist.children("li[class=addnew]").prevAll().remove();this.context.mobilelist.children("li[class=addnew]").show();this.context.mobilelist.children("li[class=addnew]").children('input[type=text]').val('');}
this.context.autoconfirm.show();if(data.autoconfirm==1){this.context.autoconfirm.children("p[tag=openmsg]").show();this.context.autoconfirm.children("p[tag=closemsg]").hide();this.context.autoconfirm.find("div[tag=switch]").attr("status",data.autoconfirm).attr("class","switch-animate switch-on");}
if(data.autoconfirm==0){this.context.autoconfirm.children("p[tag=openmsg]").hide();this.context.autoconfirm.children("p[tag=closemsg]").show();this.context.autoconfirm.find("div[tag=switch]").attr("status",data.autoconfirm).attr("class","switch-animate switch-off");}
if(!M.isEmpty(data.displaybranchshop)&&data.displaybranchshop==1){this._handshowinn(data.showinnlist);}else{this.context.inndetail.children('div[tag=branch]').hide();}}
if(data.status==2){this.context.mobilelistform.slideUp("normal");this.context.inndetail.children().find("dd[tag=innapply_btn]").html('<a href="javascript:;" class="btn" style="width:120px;">正在开通</a><span class="ml10">请等待客户经理与您联系</span>');this.context.wkzqrcode.hide();}
if(data.status==3){this.context.mobilelistform.slideDown("normal");this.context.inndetail.children().find("dd[tag=innapply_btn]").html('<a href="javascript:;" class="btn" style="width:120px;">正在开通</a><span class="ml10">正在审核，时间不超过24小时，请您耐心等待。</span>');this.context.wkzqrcode.hide();}
this.context.applyopen_btn.find('dd[tag=applytips]').hide();}else{this.openstatus='';this.context.applyopen_btn.find('dd[tag=remindinfo]').show();}
var taglist=data.tag;if(!M.isEmpty(taglist)){for(var i=0;i<taglist.length;i++){var tagname=taglist[i];var tpl=$.tmpl(this.tag_tpl,{"tagname":tagname});this.context.taglist.children("li[tag=add]").before(tpl);}
if(taglist.length==3){this.context.taglist.children("li[tag=add]").hide();}else{this.context.taglist.children("li[tag=add]").show();}}else{this.context.taglist.children("li[tag=add]").show();}
this._wkzstatus(data);}},_wkzstatus:function(data){if(data.status==1){this.context.applyopen_btn.find('span[tag=wkzstatus]').show();this.context.applyopen_btn.find('dd[tag=innapply_btn]').hide();if(data.plateform==1){this.context.applyopen_btn.find('span[tag=miotstatus]').show();this.context.applyopen_btn.find('a[tag=joinus]').hide();}else{this.context.applyopen_btn.find('span[tag=miotstatus]').hide();this.context.applyopen_btn.find('a[tag=joinus]').show();}}else{this.context.applyopen_btn.find('dd[tag=innapply_btn]').show();this.context.applyopen_btn.find('span[tag=wkzstatus]').hide();this.context.applyopen_btn.find('span[tag=miotstatus]').hide();this.context.applyopen_btn.find('a[tag=joinus]').hide();this.context.applyopen_btn.find('dd[tag=applytips]').hide();}},_handshowinn:function(showinnlist){this.context.inndetail.children('div[tag=branch]').find('li[tag=inn]').show();this.context.inndetail.children('div[tag=branch]').find('li[tag=inn][innid='+this.innid+']').hide();this.context.inndetail.children('div[tag=branch]').show();if(showinnlist=='all'){this.context.showinnlist.find('input').attr('checked','checked');}else if(!M.isEmpty(showinnlist)){var len=showinnlist.length;this.context.showinnlist.find('input').removeAttr('checked');for(var i=0;i<len;i++){var data_innid=showinnlist[i];var this_li=this.context.showinnlist.find('li[tag=inn][innid='+data_innid+']');var this_innid=this_li.find('input').attr('checked','checked');}}else{this.context.showinnlist.find('input').removeAttr('checked');}},editpaycard_click:function(){var innid=this.context.innlist.val();var paycard=this.context.paycardform.children().find("input[name=paycard]").val();var alipayname=this.context.paycardform.children().find("input[name=alipayname]").val();var tenpay=this.context.paycardform.children().find("input[name=tenpay]").val();var tenpayname=this.context.paycardform.children().find("input[name=tenpayname]").val();if(M.isEmpty(paycard)&&!M.isEmpty(alipayname)){var res=confirm("您还未填写支付宝账号，确认保存么？");if(!res){return;}}
if(!M.isEmpty(paycard)&&M.isEmpty(alipayname)){var res=confirm("您还未填写支付宝收款人姓名，确认保存么？");if(!res){return;}}
if(M.isEmpty(tenpay)&&!M.isEmpty(tenpayname)){var res=confirm("您还未填写财付通账号，确认保存么？");if(!res){return;}}
if(!M.isEmpty(tenpay)&&M.isEmpty(tenpayname)){var res=confirm("您还未填写财付通收款人姓名，确认保存么？");if(!res){return;}}
M._getjson("/Microinn/editPayCard",{"innid":innid,"paycard":paycard,"alipayname":alipayname,"tenpay":tenpay,"tenpayname":tenpayname},this.editpaycard_finished.toEventHandler(this));},editpaycard_finished:function(d){if(d.status=='success'){var paycard=d.paycard;var alipayname=d.alipayname;var tenpay=d.tenpay;var tenpayname=d.tenpayname;if(!M.isEmpty(paycard)){this.context.paycardform.children().find("input[name=paycard]").attr("disabled",true);}
if(!M.isEmpty(alipayname)){this.context.paycardform.children().find("input[name=alipayname]").attr("disabled",true);}
if(!M.isEmpty(tenpay)){this.context.paycardform.children().find("input[name=tenpay]").attr("disabled",true);}
if(!M.isEmpty(tenpayname)){this.context.paycardform.children().find("input[name=tenpayname]").attr("disabled",true);}
if(!M.isEmpty(paycard)&&!M.isEmpty(alipayname)&&!M.isEmpty(tenpay)&&!M.isEmpty(tenpayname)){this.context.paycardform.find("dl[tag=save_btn]").hide();}else{this.context.paycardform.find("dl[tag=save_btn]").show();}
M.success("保存成功");}else{if(M.isEmpty(d.msg)){M.error("网络错误");}else{M.error(d.msg);}}},search_btn_click:function(){this._getmodeldata();},_resetloadstatus:function(type){if(type=='load'){this.context.saleSetting.children("div[tag=orderform]").children("table").hide();this.context.saleSetting.children("div[tag=pvform]").children("table").hide();this.context.saleSetting.children("div[tag=likeform]").children("table").hide();this.context.saleSetting.children("div[tag=orderform]").children("div[tag=loading]").show();this.context.saleSetting.children("div[tag=pvform]").children("div[tag=loading]").show();this.context.saleSetting.children("div[tag=likeform]").children("div[tag=loading]").show();}else{this.context.saleSetting.children("div[tag=orderform]").children("table").show();this.context.saleSetting.children("div[tag=pvform]").children("table").show();this.context.saleSetting.children("div[tag=likeform]").children("table").show();this.context.saleSetting.children("div[tag=orderform]").children("div[tag=loading]").hide();this.context.saleSetting.children("div[tag=pvform]").children("div[tag=loading]").hide();this.context.saleSetting.children("div[tag=likeform]").children("div[tag=loading]").hide();}},initdetaildata_finished:function(d){this._resetloadstatus("finished");if(d.status=='success'){var pvlist=d.d.pv;this._resetpvform();this._dealpvdata(pvlist);var orderlist=d.d.order
this._resetorderform();this._dealorderdata(orderlist);}},_dealorderdata:function(orderlist){this.context.saleSetting.children("div[tag=orderform]").children("div[tag=noorder]").hide();this.context.saleSetting.children("div[tag=orderform]").children("table").show();var ordertpl=$.tmpl(this.wkzorder_tpl,orderlist);var tpl=this.context.saleSetting.children("div[tag=orderform]").children("table").children("tbody");tpl.children("tr").eq(0).nextAll().remove();tpl.children("tr").eq(0).after(ordertpl);var size=0;var ordercount=total=unpaid=paid=0;for(var i=0;i<orderlist.length;i++){var date=orderlist[i].billdate;size=tpl.children("tr[t="+date+"]").size();if(size>1){tpl.children("tr[t="+date+"]").eq(0).children("td[tag="+date+"]").attr("rowspan",2);tpl.children("tr[t="+date+"]").eq(1).children("td[tag="+date+"]").remove();}
ordercount+=parseInt(orderlist[i].ordercount);total+=parseInt(orderlist[i].total);unpaid+=orderlist[i].unpaid;paid+=orderlist[i].paid;}
if(isNaN(ordercount))
ordercount=0;if(isNaN(total))
total=0;if(isNaN(unpaid))
unpaid=0;if(isNaN(paid))
paid=0;var totalhtml='<tr><td>总计</td><td></td><td>'+ordercount+'</td><td>¥'+total+'</td><td></td><td class="red">¥'+Math.round(unpaid*100)/100+'</td><td>¥'+Math.round(paid*100)/100+'</td><td></td><td></td></tr>';tpl.children("tr:last").after(totalhtml);},_dealpvdata:function(pvlist){var fromdate=this.context.fromdate.val();var enddate=this.context.enddate.val();var fromtime=M.strtotime(fromdate);var endtime=M.strtotime(enddate);var pvform_tpl=this.context.saleSetting.children("div[tag=pvform]").children("table");var length=pvlist.length;var total=0;for(var i=0;i<length;i++){var pv=pvlist[i];var date=pv.date;var tpl=pvform_tpl.children("tbody").children("tr[t="+date+"]").children("td[tag=n]").text(pv.num);total+=parseInt(pv.num);}
if(total==0)
total='-';pvform_tpl.children("tbody").children("tr[tag=total]").children("td[tag=n]").text(total);},_deallikedata:function(likelist){var pagesize=40;var length=likelist.result.length;this.context.saleSetting.children("div[tag=likeform]").find("strong[tag=total]").html(likelist.counts).attr("likecounts",likelist.counts);if(length<=0){this.context.saleSetting.find("tr[tag=totletr]").hide();this.context.saleSetting.find("tr[tag=nolike]").show();this.context.saleSetting.find("tr[tag=likeuser]").hide();this.context.saleSetting.find("tr[tag=likelist]").hide();}else{var weixin_url="";for(var i=0;i<length;i++){var likearray=likelist.result[i];var avatarurl=likearray.avatarurl;if(avatarurl!=''){var nickname=likearray.nickname;weixin_url+='<li><img src="'+avatarurl+'" title="'+nickname+'"/></li>';}}
if(likelist.counts>pagesize){weixin_url+='<li class="more" id="morelike"><a href="#?">查看<br/>更多</a></li>';}
this.context.saleSetting.children("div[tag=likeform]").find("tr[tag=likeuser]").children("td").children("ul").html(weixin_url);this.context.saleSetting.find("tr[tag=totletr]").show();this.context.saleSetting.find("tr[tag=nolike]").hide();this.context.saleSetting.find("tr[tag=likeuser]").show();}},_getmodellikedata:function(){var ifmore=0;var pagesize=40;var innid=this.context.innlist.val();var likecounts=this.context.saleSetting.children("div[tag=likeform]").find("strong[tag=total]").attr("likecounts");var likegroupnum=this.context.saleSetting.children("div[tag=likeform]").find("tr[tag=likeuser]").attr("likegroupnum");this.context.saleSetting.children("div[tag=likeform]").find("tr[tag=likeuser]").attr("likegroupnum",parseInt(likegroupnum)+pagesize);if(parseInt(likegroupnum)<=0||parseInt(likegroupnum)>parseInt(likecounts)){alert('已完成全部加载');return;}
if(parseInt(likegroupnum)+pagesize<parseInt(likecounts)){ifmore=1}
M._getjson("/Microinn/getWkzMoreLiked",{"innid":innid,"groupnum":likegroupnum,"pagesize":pagesize},this._getmodellikedata_finished.toEventHandler(this,ifmore));},_getmodellikedata_finished:function(d,ifmore){this.context.saleSetting.children("div[tag=likeform]").find("li[id=morelike]").hide();var weixin_url='';var length=d.result.length;for(var i=0;i<length;i++){var likearray=d.result[i];var avatarurl=likearray.avatarurl;if(avatarurl!=''){var nickname=likearray.nickname;weixin_url+='<li><img src="'+avatarurl+'" title="'+nickname+'"/></li>';}}
if(ifmore){weixin_url+='<li class="more" id="morelike"><a href="#?">查看<br/>更多</a></li>';}
this.context.saleSetting.children("div[tag=likeform]").find("tr[tag=likeuser]").children("td").children("ul:last").append(weixin_url);},_resetpvform:function(){var fromdate=this.context.fromdate.val();var enddate=this.context.enddate.val();var fromtime=M.strtotime(fromdate);var endtime=M.strtotime(enddate);var pvform_tpl=this.context.saleSetting.children("div[tag=pvform]").children("table");pvform_tpl.children("tbody").children("tr[tag=date]").remove();pvform_tpl.children("tbody").children("tr[tag=total]").children("td[tag=n]").html("-");while(fromtime<=endtime)
{var date=M.timeformat(endtime);var tpl=$.tmpl(this.pv_tpl,{"date":date});pvform_tpl.children("tbody").children("tr[tag=total]").before(tpl);endtime.setDate(endtime.getDate()-1);}},_resetorderform:function(){var fromdate=this.context.fromdate.val();var enddate=this.context.enddate.val();var fromtime=M.strtotime(fromdate);var endtime=M.strtotime(enddate);var orderform_tpl=this.context.saleSetting.children("div[tag=orderform]").children("table");orderform_tpl.children("tbody").children("tr[tag=date]").remove();orderform_tpl.children("tbody").children("tr[tag=total]").children("td[tag=total]").html("-");orderform_tpl.children("tbody").children("tr[tag=total]").children("td[tag=pricetotal]").html("-");while(fromtime<=endtime)
{var date=M.timeformat(endtime);endtime.setDate(endtime.getDate()-1);}},taglist_click:function(e){var ele=M.EventEle(e);var t=ele.attr("tag");if(t=="delete"){this.delete_tag(ele);}},delete_tag:function(ele){var tagname=ele.parent("li").children("label").text();this.tag_target=ele.parent("li");var innid=this.context.innlist.val();var data={"innid":innid,"tagname":tagname};M._getjson("/Microinn/deleteInnTag",data,this.delete_tag_finished.toEventHandler(this));},delete_tag_finished:function(d){if(d.status=='success'){this.tag_target.remove();this.context.taglist.children("li[tag=add]").show();this.context.taglist.children("span").hide();M.success("删除成功");}else{M.error(d.msg);}},applyopen_btn_click:function(e){var ele=M.EventEle(e);var t=ele.attr("tag");if(t=='open'){this.openmicroinn();}else if(t=='joinus'){this.context.plateformBox.find('a[tag=jionplateform]').parent().parent().children().show();M.Popup(this.context.plateformBox,{"hideclass":"modal fade","showclass":"modal fade in"},function(){}.toEventHandler(this));}else if(t=='miotstatus'){M.Popup(this.context.plateformBox,{"hideclass":"modal fade","showclass":"modal fade in"},function(){}.toEventHandler(this));this.context.plateformBox.find('a[tag=jionplateform]').parent().parent().children().hide();}},openmicroinn:function(){var innid=this.context.innlist.val();var data={"innid":innid};M._getjson("/Microinn/apply",data,this.openmicroinn_finished.toEventHandler(this));},openmicroinn_finished:function(d){if(d.status=='success'){this.context.settablist.children("li").show();this.context.whzdataform.show();this.context.paycardform.show();this.context.inndetail.children('div[tag=branch]').show();this.context.mobilelistform.show();this.context.autoconfirm.find("div[tag=switch]").attr("status",1).removeClass("switch-off").addClass("switch-on");this.context.autoconfirm.show();this.context.wkzqrcode.show().find("img").attr("src",d.qrcode);this.openstatus=3;this.context.applyopen_btn.find('dd[tag=refuseinfo]').hide();this.context.applyopen_btn.find('dd[tag=remindinfo]').hide();this.context.applyopen_btn.find("span[tag=wkzstatus]").show();this.context.applyopen_btn.find("span[tag=wkzstatus]").attr("title","").tooltip({position:{my:"left+15 top+20",at:"left bottom"},track:1,content:'已开通微官网',show:{delay:100},hide:false});this.context.inndetail.children().find("dd[tag=innapply_btn]").hide().html('<a href="javascript:;" class="btn" style="width:120px;">正在开通</a><span class="ml10">正在审核，时间不超过24小时，请您耐心等待。</span>');this.context.successpop.find('img').attr('src',d.qrcode);M.Popup(this.context.successpop,{"hideclass":"modal sm fade","showclass":"modal sm fade in"},function(){}.toEventHandler(this));if(!M.isEmpty(d.otherwkzshop)){this.context.showinnlist.find('ul').append($.tmpl(this.tpl_branchshop,d.otherwkzshop));$this._handshowinn(d.showinnlist);}else{this.context.inndetail.children('div[tag=branch]').hide();}}else{if(M.isEmpty(d.msg)){this.context.applyopen_btn.find('dd[tag=remindinfo]').hide();this.context.applyopen_btn.find('dd[tag=refuseinfo]').hide();this.context.applyopen_btn.find('dd[tag=applytips]').show();var data=d.data;var msg='您的微官网信息维护不完整：<br />';for(var i=0;i<data.length;i++){msg+=(1+i)+'. '+data[i]+'<br />';}
msg+='请检查修改后重新点击“申请开通”。';this.context.applyopen_btn.find('dd[tag=applytips]').children('p').html(msg);}else{alert(d.msg);}}},addinntag_click:function(){var tagname=M.getVal(this.context.taglist.children("li[tag=add]").children("input[name=tag]"));var innid=this.context.innlist.val();if(M.getstrlength(tagname)>16||M.getstrlength(tagname)<4){alert('每个标签2-8个字');return;}
var data={"innid":innid,"tagname":tagname};M._getjson("/Microinn/addinntag",data,this.addinntag_finished.toEventHandler(this));},addinntag_finished:function(d){if(d.status=='success'){var tagname=d.req.tagname;M.emptyVal(this.context.taglist.children("li[tag=add]").children("input[name=tag]"));var tpl=$.tmpl(this.tag_tpl,{"tagname":tagname});this.context.taglist.children("li[tag=add]").before(tpl);var length=this.context.taglist.children("li[t=tag]").length;if(length==3){this.context.taglist.children("li[tag=add]").hide();this.context.taglist.children("span").show();}else{this.context.taglist.children("li[tag=add]").show();}}else{M.error(d.msg);}},saveimg:function(ele){var style=ele.attr('class');if(!M.isEmpty(style)&&style.indexOf('btn-cancel')!=-1){return;}
ele.attr("tag","load");var target=this.target_tpl;var uploadform=target.parent("form[name=upform]");var type=uploadform.attr('type');var innid=this.context.innlist.val();var x1=this.context.upform.children("input[id=x1]").val();var x2=this.context.upform.children("input[id=x2]").val();var y1=this.context.upform.children("input[id=y1]").val();var y2=this.context.upform.children("input[id=y2]").val();var w=this.context.upform.children("input[id=w]").val();var h=this.context.upform.children("input[id=h]").val();var picurl=this.context.picurl.val();var roomtypeid=0;var description=M.getVal(target.children("div[tag=inn_description]").find("input[name=description]"));if(type=='shopkeepersay'){var pic_content=M.getVal(uploadform.find("textarea[name='pic_content']"));var data={"type":type,"innid":innid,"picurl":picurl,"roomtypeid":roomtypeid,"description":description,"x1":x1,"x2":x2,"y1":y1,"y2":y2,"w":w,"h":h,'pic_content':pic_content};}else{var data={"type":type,"innid":innid,"picurl":picurl,"roomtypeid":roomtypeid,"description":description,"x1":x1,"x2":x2,"y1":y1,"y2":y2,"w":w,"h":h};}
data['act']='add';data['imgid']=0;if(this.operate=='modify'){data['act']='modify';data['imgid']=this.imgid;}
M._getjson("/Microinn/saveImage",data,this.saveimg_finished.toEventHandler(this));},saveimg_finished:function(d){var target=this.target_tpl;target.children("a[tag=load]").attr("tag","save_img");target.children().find("a[tag=load]").attr("tag","save_img");if(d.status=='success'){M.success("保存成功");var type=d.req.type;var imgtpl=$.tmpl(this.img_tpl,d.img);if(type=="shopkeepersay"){imgtpl=$.tmpl(this.img_tpl_shopkeepersay,d.img);imgtpl.children("div[tag=desc]").show();}
if(type=='innavatar'){target.children("div[tag=imglist]").children("ul").children('li[tag=upload_li]').hide();}
if(this.operate=='modify'){var imginfo=d.img;var tpl_lithis=target.children("div[tag=imglist]").children("ul").find('a[imgid='+imginfo.id+']').parent();tpl_lithis.children('img').attr('src',d.path);tpl_lithis.children('div[tag=desc]').attr('title',imginfo.description).html(imginfo.shortdescription);if(type!="shopkeepersay"){tpl_lithis.children("div[tag=desc]").hide();}}else{var length=target.children("div[tag=imglist]").children("ul").children("li").length;if(length>0){target.children("div[tag=imglist]").children("ul").children("li[tag=loading]").before(imgtpl);}else{target.children("div[tag=imglist]").children("ul").append(imgtpl);}
target.children("div[tag=imglist]").find('li[head=1]').find('a[tag=editbosssay]').html('修改掌柜说');if(type=='inn'){this.setlistindex(target.children("div[tag=imglist]").children("ul").children('li[tag=img]'));target.children("div[tag=imglist]").children("ul").find('div[tag=description]').show();}
target.children("div[tag=imglist]").children("ul").children('li[head=1]').find('span[tag=bosshead]').show();target.children("div[tag=imglist]").children("ul").children('li[head=0]').find('span[tag=bosshead]').hide();target.children("div[tag=imglist]").children("ul").children('li[head=1]').find('a[tag=setupboss]').hide();target.children("div[tag=imglist]").children("ul").children('li[head=0]').find('a[tag=setupboss]').show();}
target.children().find("a[tag=show_pics]").show();target.children().find("input[tag=file]").val('');target.children("div[tag=show_img]").slideUp("fast");target.children("div[tag=div_save]").slideUp("fast");target.children("div[tag=inn_description]").slideUp("fast");target.parent("form[name=upform]").find("textarea[name='pic_content']").val('');M.emptyVal(target.children("div[tag=inn_description]").find("input[name=description]"));this._deletebtnshow(type,target);var rtid=d.img.roomtypeid;var url=d.img.url;var innid=d.img.innid;M._getjson("/Microinn/flushInnClear",{"innid":innid});}else{alert(d.msg)}},uploadfile_change:function(){var target=this.target_tpl;target.children().find("li[tag=loading]").show();var uploadform=target.parent("form[name=upform]");var callbackfun=uploadform.attr('callback');var type=uploadform.attr('type');var options={success:this.upload_finished.toEventHandler(this)};uploadform.ajaxSubmit(options);return false;},uploadpicform_click:function(e){var ele=M.EventEle(e);var t=ele.attr("tag");var type=ele.attr("type");this.target_tpl=ele.parents("div[class=uploadBox]");if(t=='upload_btn'){this.operate='add';this.imgid=0;if(!M.isEmpty(ele.attr('operate'))&&ele.attr('operate')=='modify'){this.operate='modify';this.imgid=ele.parent().children('a').attr('imgid');}
var uploadform=this.target_tpl.parent("form[name=upform]");uploadform.attr("type",type);ele.parents("div[class=uploadBox]").children("input[tag=file]").click();this.target_tpl.find("a[tag=save_img]").addClass("btn-cancel").removeClass("btn-info");}else if(t=='uploadvideo_btn'){this.context.uploadvideo.click();}else if(t=='save_img'){this.saveimg(ele);}else if(t=='show_pics'){this.showimglist(ele);}else if(t=='close'){this.hideimglist(ele);}else if(t=='delete'){this._deleteimg(ele);}else if(t=='editbosssay'){this.editbosssay(ele);}else if(t=='setupboss'){this.setupboss(ele);}else if(t=='innhead'){this.innheadvideo(ele,t);}else if(t=='innvideo'){this.innheadvideo(ele,t);}else if(t=='savedescription'){this.savedescription(ele);}else if(t=='inputdescription'){ele.parents('div[tag=imglist]').find('a[tag=savedescription]').hide();ele.parent().children('a').show();}},savedescription:function(ele){var id=ele.parents('li[tag=img]').attr('imgid');var content=ele.parent().children('input').val();var innid=this.context.innlist.val();if(M.isEmpty(content)){alert('描述不能为空');return;}
M._getjson("/Microinn/savemanagersay",{"id":id,"innid":innid,'content':content,'type':'innimg'},this._editdescription_finished.toEventHandler(this));},innheadvideo:function(ele,tag){if(tag=='innvideo'){ele.parent().parent().children('li').removeClass('active');ele.parent().addClass('active');this.context.picSetting.find('div[tag=innavatar]').hide();this.context.picSetting.find('div[tag=shopkeepersay]').hide();this.context.picSetting.find('div[tag=innimg]').hide();this.context.picSetting.find('div[tag=innvideo]').show();this.context.picSetting.find('div[tag=videotitle]').show();}else{ele.parent().parent().children('li').removeClass('active');ele.parent().addClass('active');this.context.picSetting.find('div[tag=innavatar]').show();this.context.picSetting.find('div[tag=shopkeepersay]').show();this.context.picSetting.find('div[tag=innimg]').show();this.context.picSetting.find('div[tag=innvideo]').hide();this.context.picSetting.find('div[tag=videotitle]').hide();}},descriptionpop_click:function(e){var ele=M.EventEle(e);var t=ele.attr('tag');if(t=='save'){this.savemanagersay(ele);}},editbosssay:function(ele){var id=ele.parents('li').attr('imgid');var content=ele.parents('li').find('div[tag=desc]').attr('title');this.context.descriptionpop.find('h4').html(ele.html());this.context.descriptionpop.find('ul').attr('imgid',id);this.context.descriptionpop.find('textarea[name=content]').val(content);M.Popup(this.context.descriptionpop,{"hideclass":"modal sm fade","showclass":"modal sm fade in"},function(){}.toEventHandler(this));},savemanagersay:function(ele){var id=this.context.descriptionpop.find('ul').attr('imgid');var innid=this.context.innlist.val();var content=this.context.descriptionpop.find('textarea[name=content]').val();if(M.isEmpty(id)){alert('数据错误，请刷新重试');return true;}
M._getjson("/Microinn/savemanagersay",{"id":id,"innid":innid,'content':content,'type':'shopkeepersay'},this._editdescription_finished.toEventHandler(this));},_editdescription_finished:function(d){if(d.status=='success'){var data=d.data;if(data.type=='shopkeepersay'){this._closepopup();this.context.picSetting.find('div[tag=shopkeepersay]').find('li[imgid='+data.id+']').find('div[tag=desc]').attr('title',data.description).html(data.shortdescription);}else{this.context.picSetting.find('div[tag=imglist]').find('li[imgid='+data.id+']').find('a[tag=savedescription]').hide();}
M.success('保存成功');}else{alert(d.msg);}},setupboss:function(ele){this.ele=ele;var id=ele.parents('li').attr('imgid');var innid=this.context.innlist.val();M._getjson("/Microinn/setupbosshead",{"id":id,"innid":innid},this._setupboss_finished.toEventHandler(this));},_setupboss_finished:function(d){if(d.status=='success'){M.success('设置成功');this.ele.parents('ul').find('li[head=1]').find('a[tag=setupboss]').show();this.ele.parents('ul').find('li[head=1]').find('span[tag=bosshead]').hide();this.ele.parents('ul').find('li[head=1]').find('a[tag=editbosssay]').html('修改照片说明');this.ele.parents('ul').find('li[head=1]').attr('head',0);this.ele.parents('li').attr('head',1);this.ele.parents('ul').find('li[head=1]').find('a[tag=editbosssay]').html('修改掌柜说');this.ele.parents('li').find('a[tag=setupboss]').hide();this.ele.parents('li').find('span[tag=bosshead]').show();}else{alert(d.msg);}},_deleteimg:function(ele){this.img=ele;var id=ele.attr("imgid");var type=ele.parents('form').children('div.uploadBox').attr('tag');var innid=this.context.innlist.val();var applystatus=this.wkzinfo.applystatus;if(type=='shopkeepersay'&&!M.isEmpty(applystatus)&&applystatus>0){var head=ele.parent('li').attr('head');if(head==1){alert('如果要删除此图片，请先设置一张掌柜头像');return;}}
var res=confirm("确认删除吗");if(!res){return;}
M._getjson("/Microinn/deleteImg",{"id":id,"innid":innid,'type':type},this._deleteimg_finished.toEventHandler(this));},_deleteimg_finished:function(d){if(d.status=="success"){M.success("删除成功");var type=d.req.type;var tpl_ul=this.img.parents("ul");this.img.parent("li").removeAttr('tag');this._deletebtnshow(type,tpl_ul);this.img.parent("li").remove();var innid=d.innid;M._getjson("/Microinn/flushInnClear",{"innid":innid});}else{M.error(d.msg);}},showimglist:function(ele){ele.parents("div[class=uploadBox]").children("div[tag=imglist]").toggle();},hideimglist:function(ele){ele.parents("div[class=uploadBox]").children("div[tag=imglist]").hide();},cutImage:function(src){var img=new Image();img.src=src;var target=this.target_tpl;if($.browser.msie){img.onreadystatechange=function(){if(img.readyState=="complete"||img.readyState=="loaded"){imgOnLoad(img,target);}};}else{img.onload=function(){if(img.complete==true){imgOnLoad(img,target);};};}},cutImage2:function(src,target){var src=this.context.wkzroomresize.find("img[name='preview']").show().attr('src');this.context.wkzroomresize.find("img[name='photo']").show();var target=this.context.wkzroomresize.find("div[name='wkzcanvas']");var img=new Image();img.src=src;if($.browser.msie){img.onreadystatechange=function(){if(img.readyState=="complete"||img.readyState=="loaded"){imgOnLoad2(img,target);}};}else{img.onload=function(){if(img.complete==true){imgOnLoad2(img,target);};};}},editinfo:function(){var innid=this.context.innlist.val();this.context.editinfo.attr("cclick","click");var contactor=this.context.inndetail.children().find("input[name=contactor]").val();if(M.isEmpty(contactor)){alert("掌柜称呼不能为空！");return;}
var address=M.getVal(this.context.whzdataform.children().find("input[name=address]"));var geography=M.getVal(this.context.whzdataform.children().find("input[name=geography]"));if(M.isEmpty(address)){alert("客栈地址不能为空！");return;}
var phone1=M.getVal(this.context.whzdataform.children("dl[tag=phone][i=0][dis=dis]").find("input[name=phone]"));if(M.isEmpty(phone1)){alert("联系电话不能为空！");return;}
var hasphone2=this.context.whzdataform.children("dl[tag=phone][dis=none]").css("display");if(hasphone2=='block'){var phone2=M.getVal(this.context.whzdataform.children("dl[tag=phone][i=1][dis=none]").children("dd").children("input[name=phone]"));}else{var phone2=M.getVal(this.context.whzdataform.children("dl[tag=phone][i=1][dis=dis]").children("dd").children("input[name=phone]"));}
if(M.isEmpty(phone2)){this.context.whzdataform.children("dl[tag=phone][i=1][dis=dis]").hide();this.context.whzdataform.children("dl[tag=phone][i=0][dis=dis]").find("a[tag=del]").attr('class','add').attr('tag','add').attr('title','添加');}
var receptephone=M.getVal(this.context.whzdataform.children().find("input[name=receptephone]"));var weixin=M.getVal(this.context.inndetail.children().find("input[name=weixin]"));var description=M.getVal(this.context.inndetail.children().find("textarea[name=description]"));var obj=this.context.faclistul;var namestr='';obj.each(function(){var hasclass=$(this).attr("class");var name=$(this).attr("name");if(hasclass=="has"){namestr+=','+name;}});var features=namestr.substr(1);var traffic=M.getVal(this.context.inndetail.children().find("textarea[name=traffic]"));var hotelfeature=M.getVal(this.context.inndetail.children().find("textarea[name=hotelfeature]"));var data={"address":address,"geography":geography,"weixin":weixin,"phone1":phone1,"phone2":phone2,"receptephone":receptephone,"contactor":contactor,"description":description,"features":features,"hotelfeature":hotelfeature,"innid":innid,"traffic":traffic};M._getjson("/Microinn/editMicroInninfo",data,this.editinfo_finished.toEventHandler(this));this.req_before(this.context.editinfo);},editinfo_finished:function(d){if(d.status=='success'){var innid=d.innid;M.success("修改成功");M._getjson("/Microinn/flushInnClear",{"innid":innid});}else{alert(d.msg);}
this.req_end(this.context.editinfo);},mobilelist_click:function(e){var ele=M.EventEle(e);var t=ele.attr("tag");if(t=='add'){this.addnew(e);}
if(t=='del'){this.delmobile(ele);}},addnew:function(e){var ele=M.EventEle(e);var flag=ele.attr("flag");var size=this.context.mobilelist.children("li").size();var mobile=M.getVal(this.context.mobilelist.children("li").children("input[id=mobilenum]"));if(!M.isEmpty(mobile)){var re=/^(13|14|15|18|17|19)[0-9]{9}$/;if(!re.test(mobile))
{alert("请输入正确的手机号");return false;}}else{alert('手机号不能为空');return;}
if(size<4){M._getjson("/Microinn/setMobile",{"mobile":mobile,"flag":flag},this.addnew_finished.toEventHandler(this));}else{alert('最多可设置3个手机号码');}},addnew_finished:function(d){if(d.status=="success"){var mid=d.id;var mobile=d.mobile;var flag=d.flag;tpl=$.tmpl(this.mobile_tpl,{"mid":mid,"mobile":mobile});this.context.mobilelist.children("li[class=addnew]").before(tpl);var size=this.context.mobilelist.children("li").size();if(size==4){this.context.mobilelist.children("li[class=addnew]").hide();}
this.context.mobilelist.children("li[class=addnew]").find('input[type=text]').val('');}else{M.error(d.msg);}},delmobile:function(ele){var res=confirm("确认删除吗？");if(!res){return;}
var id=ele.parent("li").attr("mid");var flag=ele.parent("li").parent("ul").attr("flag");if(M.isEmpty(id))
{return;}
M._getjson("/Microinn/deleteMobile",{"id":id},this.delmobile_finished.toEventHandler(this,flag));},delmobile_finished:function(d,flag){if(d.status=="success"){var mid=d.id;if(flag=='book'){this.context.mobilelist.find("li[mid="+mid+"]").remove();var size=this.context.mobilelist.children("li").size();if(size<4){this.context.mobilelist.children("li[class=addnew]").show();this.context.accountmobilelist.children("li[class=addnew]").children("input[tag=add]").attr("flag","book");this.context.mobilelist.children("li[class=addnew]").children("input[class=tname]").val("");}}
if(flag=='account'){this.context.accountmobilelist.find("li[mid="+mid+"]").remove();var size=this.context.accountmobilelist.children("li").size();if(size<2){this.context.accountmobilelist.children("li[class=addnew]").show();this.context.accountmobilelist.children("li[class=addnew]").children("input[tag=add]").attr("flag","account");this.context.accountmobilelist.children("li[class=addnew]").children("input[class=tname]").val("");}}}else{M.error(d.msg);}},accountmobilelist_click:function(e){var ele=M.EventEle(e);var t=ele.attr("tag");if(t=='add'){this.addnew(e);}
if(t=='del'){this.delmobile(ele);}},paytypelist_click:function(e){var ele=M.EventEle(e);var t=ele.attr("tag");if(t=='type_all'){this.context.paytypelist.children("li").eq(1).children("div[class=part]").hide();this.context.paytypelist.find("input[name=everydeposit]").val("");}
if(t=='pay_first'){this.context.paytypelist.find("input[name=everydeposit]").val("");}
if(t=='type_deposit'){this.context.paytypelist.children("li").eq(1).children("div[class=part]").show();$("#payfirst").attr("checked","checked");}},savepaytype:function(ele){var paytype;var deposittype='';var everymoney='';paytype=this.context.paytypelist.find("input[name=wkzpayment]:checked").val();if(paytype==2){deposittype=this.context.paytypelist.find("input[name=wkzpayment-part]:checked").val();if(deposittype=='pay_every'){everymoney=this.context.paytypelist.find("input[name=everydeposit]").val();if(M.isEmpty(everymoney)){M.error("请填写预付定金的金额！");return false;}
var m=everymoney.length-everymoney.replace(/\./g,"").length;if(m>0){M.error("订金金额只能输入整数喔");return false;}
if(!$.isNumeric(everymoney)){M.error("订金金额只能输入数字喔");return false;}
if(everymoney<0){M.error("订金金额不能为负数哦");return false;}
if(everymoney==0){M.error("订金金额不能为0哦");return false;}}
if(M.isEmpty(deposittype)){M.error("请选择预付订金的方式！");return false;}}
M._getjson("/Microinn/setPayType",{"paytype":paytype,"deposittype":deposittype,"everymoney":everymoney},this.setPaytype_finished.toEventHandler(this));},setPaytype_finished:function(d){if(d.status=="success"){M.success(d.msg);this.clearwkzcache();}else{M.error(d.msg);}},_clearmicroform:function(){this.context.taglist.children("li[t=tag]").remove();this.context.inndetail.children().find("dd[tag=refuseinfo]").hide();this.context.inndetail.children().find("a[tag=savewifi]").hide();this.context.inndetail.children().find("span[tag=savewifitips]").hide();this.context.inndetail.children().find("span[tag=tips]").show();this.context.inndetail.children().find("dd[tag=refuseinfo]").hide();this.context.inndetail.attr("aid","");this.context.inndetail.children().find("input[name=address]").val('').attr("disabled",false);this.context.inndetail.children().find("input[name=phone]").attr("disabled",false);this.context.whzdataform.children("dl[tag=phone][dis=dis][i=1]").remove();this.context.inndetail.children().find("input[name=wifipassword]").attr("disabled",false);this.context.inndetail.children().find("input[name=weixin]").val('');var html=this.context.mobilelist.children("li[class=addnew]").clone();this.context.mobilelist.children("li").remove();this.context.mobilelist.html(html);M.emptyVal(this.context.inndetail.children().find("input[name=phone]"));M.emptyVal(this.context.inndetail.children().find("input[name=wifipassword]"));M.emptyVal(this.context.inndetail.children().find("textarea[name=description]"));this.context.inndetail.children().find("dd[tag=innapply_btn]").html('<a href="javascript:;" tag="open"  class="btn btn-primary" style="width:120px;" tag="open">申请开通</a>');},reqbusy:function()
{alert("请求处理中，请稍后再试");},req_before:function(btn)
{var busy=btn.attr("busy");if(busy=="1")
{this.reqbusy();return false;}
btn.html(this.submittext).attr("busy","1");btn.attr("class",btn.attr("tempclass")+" disabled");return true;},req_end:function(btn)
{btn.html(btn.attr("text")).attr("busy","");btn.attr("class",btn.attr("tempclass"));},NoUndefined:function(str)
{return M.isEmpty(str)?"":str;},_closepopup:function()
{M.ClosePopup();},destroy:function(){}});var target_tpl=null;var typelist={"innavatar":"35:24","innweixin":"9:5","shopkeepersay":"1:1","inn":"35:24","roomtype":"35:24"};function imgOnLoad(img,target){target_tpl=target;var width=img.width;var height=img.height;var r=height/width;var imgOrgBox=target_tpl.children().find("div[tag=imgOrgBox]");var photo=target_tpl.children().find("img[name=photo]");if(r>1.5){imgActualHeight=imgOrgBox.height();imgActualWidth=imgActualHeight/r;photo.attr("style","height:100%");$('#s').val(height/imgActualHeight);$('#s1').val(imgActualHeight/height);}else{imgActualWidth=imgOrgBox.width();imgActualHeight=imgActualWidth*r;photo.attr("style","width:100%");$('#s').val(width/imgActualWidth);$('#s1').val(imgActualWidth/width);}
var uploadform=target.parent("form[name=upform]");var type=uploadform.attr('type');var raido=typelist[type];photo.imgAreaSelect({remove:true});var raidoarr=raido.split(":");var imgwidth=imgActualWidth-10;var imgheight=parseInt(imgwidth*raidoarr[1]/raidoarr[0]);if(imgheight>imgActualHeight){imgheight=imgActualHeight-10;imgwidth=parseInt(imgheight*raidoarr[0]/raidoarr[1])-10;}
photo.imgAreaSelect({x1:0,y1:0,x2:imgwidth,y2:imgheight,onInit:preview,instance:true,aspectRatio:raido,handles:true,parent:imgOrgBox,onSelectEnd:preview});target_tpl.find("a[tag=save_img]").removeClass("btn-cancel").addClass("btn-info");}
function imgOnLoad2(img,target){target_tpl=target;var width=img.width;var height=img.height;var r=height/width;var imgOrgBox=target_tpl.children().find("div[tag=imgOrgBox]");var photo=target_tpl.children().find("img[name=photo]");photo.imgAreaSelect({remove:true});if(r>1.5){imgActualHeight=imgOrgBox.height();imgActualWidth=imgActualHeight/r;photo.attr("style","height:100%");$('#s').val(height/imgActualHeight);$('#s1').val(imgActualHeight/height);}else{imgActualWidth=imgOrgBox.width();imgActualHeight=imgActualWidth*r;photo.attr("style","width:100%");$('#s').val(width/imgActualWidth);$('#s1').val(imgActualWidth/width);}
var uploadform=target.parent("form[name=upform]");var type=uploadform.attr('type');var raido=typelist['roomtype'];var raidoarr=raido.split(":");var imgwidth=imgActualWidth-10;var imgheight=parseInt(imgwidth*raidoarr[1]/raidoarr[0]);if(imgheight>imgActualHeight){imgheight=imgActualHeight-10;imgwidth=parseInt(imgheight*raidoarr[0]/raidoarr[1])-10;}
photo.imgAreaSelect({x1:0,y1:0,x2:imgwidth,y2:imgheight,onInit:preview2,instance:true,aspectRatio:"35:24",handles:true,parent:imgOrgBox,onSelectEnd:preview2});$("#wkzroomresize").find("div[tag=save_btn]").children("a").removeClass("btn-cancel").addClass("btn-primary");}
function preview(img,selection){if(!selection.width||!selection.height)
return;var selectionDiv=target_tpl.children().find("div[tag=preview]");var preview_img=target_tpl.children().find("img[tag=preview_img]");var scaleX=selectionDiv.width()/selection.width;var scaleY=selectionDiv.height()/selection.height;preview_img.css({width:Math.round(scaleX*imgActualWidth),height:Math.round(scaleY*imgActualHeight),marginLeft:-Math.round(scaleX*selection.x1),marginTop:-Math.round(scaleY*selection.y1)});var s=$("#s").val();var x1=selection.x1*s;$('#x1').val(x1);var y1=selection.y1*s;$('#y1').val(y1);$('#x2').val(selection.x2);$('#y2').val(selection.y2);var w=selection.width*s;$('#w').val(w);var h=selection.height*s;$('#h').val(h);}
function preview2(img,selection){if(!selection.width||!selection.height)
return;var selectionDiv=target_tpl.children().find("div[tag=preview]");var preview_img=target_tpl.children().find("img[tag=preview_img]");var scaleX=selectionDiv.width()/selection.width;var scaleY=selectionDiv.height()/selection.height;preview_img.css({width:Math.round(scaleX*imgActualWidth),height:Math.round(scaleY*imgActualHeight),marginLeft:-Math.round(scaleX*selection.x1),marginTop:-Math.round(scaleY*selection.y1)});var s=$("#s").val();var x1=selection.x1*s;$('#x1').val(x1);var y1=selection.y1*s;$('#y1').val(y1);$('#x2').val(selection.x2);$('#y2').val(selection.y2);var w=selection.width*s;$('#w').val(w);var h=selection.height*s;$('#h').val(h);}