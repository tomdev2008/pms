M.Page.OtaAppletPayPage=M.createClass();M.extend(M.Page.OtaAppletPayPage.prototype,{context:{},temp_interval:{},chargesetting:{},inn_tpl:'<li class="branch-item" innid="${innid}">'
+'<input type="checkbox" tag="select" class="mr10" ${checked} />'
+'<span class="branch-name" innid="${innid}">${innname}</span>'
+'</li>',init:function(){this.initDOM();this.initEvent();},initDOM:function(){this.context.payform=$("#payform");this.context.payqrcodeform=$("#payqrcodeform");this.context.orderchannel=$("#orderchannel");this.context.otapayrule=$("#otapayrule");this.context.showpayrule=$("#showpayrule");this.context.contactform=$("#contactform");this.context.otacontact=$("#otacontact");this.context.appletImg=$(".pic-xcx");this.context.innsort=$("#innsort");this.context.loading=$("#loading");},initEvent:function(){this.context.payform.bind("click",this.payform_click.toEventHandler(this));this.context.orderchannel.bind("click",this.orderchannel_click.toEventHandler(this));this.context.showpayrule.bind("click",this.showpayrule_click.toEventHandler(this));this.context.otacontact.bind("click",this.otacontact_click.toEventHandler(this));this.context.innsort.bind("click",this.innsort_click.toEventHandler(this));this.context.innsort.find("ul").sortable({placeholder:"placeHolder",stop:this.saveinnsort.toEventHandler(this)});},innsort_click:function(e){var ele=M.EventEle(e);var t=ele.attr('tag');if(t=='select'){this.saveinnsort();}},saveinnsort:function(){var innidlist=[];var innidstr='';this.context.innsort.find("ul li input:checked").each(function(){var that=$(this);var innid=that.parents("li").attr("innid");innidlist.push(innid);});if(!M.isEmpty(innidlist)){innidstr=innidlist.toString();}
this.context.loading.show();M._getjson('/Applet/saveinnidsort',{'innidstr':innidstr},this.saveinnsort_finished.toEventHandler(this),'',true);},saveinnsort_finished:function(d){this.context.loading.hide();if(d.status=='success'){var data=d.data;this.context.innsort.find('ul').html($.tmpl(this.inn_tpl,data));}else{M.error(d.msg);return;}},otacontact_click:function(){M.Popup(this.context.contactform,{"hideclass":"modal fade in modal-touch","showclass":"modal fade in modal-touch in"},function(){}.toEventHandler(this));},showpayrule_click:function(){M.Popup(this.context.otapayrule,{"hideclass":"modal view fade large","showclass":"modal view fade large in"},function(){}.toEventHandler(this));},payform_click:function(e){var ele=M.EventEle(e);var t=ele.attr('tag');switch(t){case'close':M.ClosePopup();break;case'setmonth':this.context.payform.find('div[tag=channellist]').find('a[tag=setmonth]').removeClass('active');ele.addClass('active');this._setpayamount();break;case'setbuytype':this._setpayamount(ele);break;break;case'setchannel':this._setpayamount();break;case'selectinn':this._setpayamount();break;case"pay":this.pay();break;case"showmoreinn":this.otherinntoggle();break;case'selectallinn':this.selallinn(ele);break;case'authlogin':this.getpreauthcode();break;}},getpreauthcode:function(){M._getjson('/Applet/getpreauthcode',null,this.getpreauthcode_finished.toEventHandler(this),'',true);},getpreauthcode_finished:function(d){if(d.status=='success'){var data=d.data;var url="https://mp.weixin.qq.com/cgi-bin/componentloginpage?"+"component_appid="+data.appid+"&pre_auth_code="+data.pre_auth_code+"&redirect_uri="+data.redirect_uri+"&auth_type="+data.auth_type;window.location.href=url;}else{alert(d.msg);}},selallinn:function(ele){var checked=ele.attr('checked');if(checked=="checked"){this.context.payform.find('ul[tag=innlist]').find('input[name=innid]').attr('checked','checked');}else{this.context.payform.find('ul[tag=innlist]').find('input[name=innid]').attr('checked',false);}},pay:function(){M._getjson('/Applet/getotapayinfo',{'month':12,'buytype':'applet'},this.pay_finished.toEventHandler(this));},pay_finished:function(d){if(d.status=="success"){var data=d.data;var paystatus=d.paystatus;if(paystatus==1){location.reload();}
this.context.payqrcodeform.find('span[tag=money]').html(d.amount);this.context.payqrcodeform.find('img').attr('src',data.pay_qr);this.context.payqrcodeform.attr('billid',d.billid);M.Popup(this.context.payqrcodeform,{"hideclass":"modal view cashier fade in","showclass":"modal view cashier fade in"},function(){}.toEventHandler(this));this.getpaystatus(d.billid);}else{if(!M.isEmpty(d.msg)){alert(d.msg);}}},getpaystatus:function(billid){M._getjson('/Applet/getpaystatus',{'billid':billid},this.getpaystatus_finished.toEventHandler(this));},getpaystatus_finished:function(d){if(d.status=="success"){location.reload();}else{var _this=this;setTimeout(function(){_this.getpaystatus(d.req.billid)},10000)}},_setpayamount:function(){var buytype=this.context.payform.find('input[name=buytype]:checked').val();if(buytype=='all'){var payamount=3588;var discountamount=0;this.context.payform.find('div[tag=channellist]').hide();}else{this.context.payform.find('div[tag=channellist]').show();var month=this.context.payform.find('div[tag=channellist]').find('a[tag=setmonth].active').attr('value');if(month=='week'){month=0;}
var tpl_channellist=this.context.payform.find('div[tag=channellist]').find('input[name=channel][needpay=1]:checked');var channellength=tpl_channellist.length;var amount=M.math_format(this.chargesetting.baseprice)*month*channellength;var payamount=amount;for(var i=0;i<this.chargesetting.discountsetting.length;i++){var item=this.chargesetting.discountsetting[i];if(amount>=item.min&&amount<=item.max){payamount=amount*item.discount/10;}}
var discountamount=M.math_min(amount,payamount);}
this.context.payform.find('strong[tag=payamount]').html(payamount);if(discountamount>0){this.context.payform.find('span[tag=discountamount]').show().html('省¥'+discountamount);}else{this.context.payform.find('span[tag=discountamount]').hide();}},orderchannel_click:function(){var otacode=this.context.orderchannel.attr('channel');M._getjson('/Ota/getchargesetting',{'otacode':otacode},this.getchargesetting_finished.toEventHandler(this));},ota_buy:function(ele){var otacode=ele.parents("li").attr("ota");M._getjson('/Ota/getchargesetting',{'otacode':otacode},this.getchargesetting_finished.toEventHandler(this));},getchargesetting_finished:function(d){if(d.status=="success"){this.context.payform.find('div[tag=channellist]').find('input[name=channel]').attr('checked',false);var channel=d.data.channel;this.context.payform.find('div[tag=channellist]').find('input[name=channel]').each(function(){var value=$(this).val();if(channel.indexOf(value)!=-1){$(this).attr('checked','checked');}});this.context.payform.find('div[tag=channellist]').find('a[tag=setmonth]').removeClass('active');this.context.payform.find('div[tag=channellist]').find('a[tag=setmonth][value=3]').addClass('active');this.chargesetting=d.data.setting;this.context.payform.find('input[name=buytype]').attr('checked',false);this.context.payform.find('input[name=buytype][value=all]').attr('checked','checked');this._setpayamount();this.context.payform.find('input[tag=selectallinn]').parent().show();M.Popup(this.context.payform,{"hideclass":"modal view fade large","showclass":"modal view fade large in"},function(){}.toEventHandler(this));}else{if(!M.isEmpty(d.msg)){alert(d.msg);}}}});var appletorderpay;M.ready(function(){appletorderpay=new M.Page.OtaAppletPayPage();return appletorderpay;});